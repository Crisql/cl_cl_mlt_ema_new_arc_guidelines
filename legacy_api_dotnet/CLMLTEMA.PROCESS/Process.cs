using CLMLTEMA.MODELS;
using Newtonsoft.Json;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Reflection;
using System.Text;
using System.Web;
using System.Xml;
using System.Xml.Serialization;
using Azure.Storage;
using Azure.Storage.Blobs;
using CL.COMMON.Extensions;
using CL.DB;
using CL.DB.Extensions;
using CL.SL.Extensions;
using CL.STRUCTURES;
using CL.STRUCTURES.CLASSES.Exceptions;
using CL.STRUCTURES.CLASSES.LocalEntities;
using CL.STRUCTURES.CLASSES.PresentationEntities;
using CL.STRUCTURES.CLASSES.Rebound;
using CL.STRUCTURES.CLASSES.SAP;
using CL.STRUCTURES.CLASSES.ServiceLayer;
using CL.STRUCTURES.CLASSES.Udf;
using CL.STRUCTURES.INTERFACES;
using CL.UDFS;
using CLMLTEMA.COMMON;
using CLMLTEMA.MODELS.Filters;
using CLMLTEMA.MODELS.SAP;
using CrystalDecisions.CrystalReports.Engine;
using CrystalDecisions.Shared;
using ExcelDataReader;
using Newtonsoft.Json.Linq;
using OfficeOpenXml;
using Google.Apis.Auth.OAuth2;
using Google.Apis.Calendar.v3;
using Google.Apis.Calendar.v3.Data;
using Google.Apis.Services;
using Microsoft.Exchange.WebServices.Data;
using System.Data.Odbc;
using System.Data.SqlClient;
using System.Globalization;
using Google.Apis.Requests.Parameters;
using Microsoft.IdentityModel.Tokens;
using CL.COMMON;
using OfficeOpenXml.Style;
using System.Net.Mail;




namespace CLMLTEMA.PROCESS
{
    public class Process
    {
        #region General

        /// <summary>
        /// Retrieves the company ID from the current HTTP context.
        /// </summary>
        /// <returns>The company ID.</returns>
        private static int GetCompanyId()
        {
            return (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];
        }

        /// <summary>
        /// Retrieves the numbering series configuration for the specified document type, user, and company.
        /// </summary>
        /// <param name="_documentType">The identifier of the document type.</param>
        /// <param name="_userId">Optional user ID; if not provided, the current authenticated user is used.</param>
        /// <param name="_companyId">Optional company ID; if not provided, the current company context is used.</param>
        /// <returns>
        /// A <see cref="SeriesByUser"/> instance containing the configured series number.
        /// </returns>
        /// <exception cref="CLException">
        /// Thrown when no series is configured for the given user, company, and document type.
        /// </exception>
        private static SeriesByUser GetSerie(int _documentType, int _userId = -1, int _companyId = -1)
        {
            int UserId = _userId == -1 ? CL.COMMON.Core.GetClaimUserId() : _userId;
            int CompanyId = _companyId == -1 ? GetCompanyId() : _companyId;

            CLContext<SeriesByUser> oSerie = Services.Execute<SeriesByUser, FilterSeries, MainDBContext, ICLSingle>(
                "GetSerie",
                new FilterSeries()
                {
                    UserId = UserId,
                    CompanyId = CompanyId,
                    DocumentType = _documentType
                }).Get();

            if (oSerie is null || oSerie.Response.Data is null)
            {
                throw new CLException(
                    $"No se ha configurado ninguna serie de numeración para el usuario {GetUser(UserId).Response.Data.Email}, " +
                    $"en la compañía {GetCompanyById(CompanyId).Response.Data.Name}, " +
                    $"para el documento [{GetDocumentTypeMessage(_documentType)}]",
                    HttpStatusCode.Found);
            }

            return oSerie.Response.Data;
        }

        /// <summary>
        /// Returns the user-friendly message corresponding to a given document type enum value.
        /// </summary>
        /// <param name="_documentType">The integer value of the document type enum.</param>
        /// <returns>The descriptive message if found; otherwise, "Desconocido".</returns>
        private static string GetDocumentTypeMessage(int _documentType)
        {
            string _enumName = Enum.GetName(typeof(Constants.DocumentType), _documentType);
    
            if (string.IsNullOrEmpty(_enumName)) 
                return "Desconocido";

            var fieldInfo = typeof(Constants.DocumentTypeMessage).GetField(_enumName);

            return fieldInfo != null ? (string)fieldInfo.GetValue(null) : "Desconocido";
        }

        /// <summary>
        /// Retrieves the user context credentials for API access based on the provided resource, user, company, and license.
        /// If user or company IDs are not specified, they are resolved from the current user claims or HTTP context.
        /// </summary>
        /// <param name="_resource">Optional resource name used to scope the user context.</param>
        /// <param name="_userId">Optional user ID. Defaults to the authenticated user if not provided.</param>
        /// <param name="_companyId">Optional company ID. Defaults to the current HTTP context company key if not provided.</param>
        /// <param name="_licence">Optional license ID used to further qualify the context.</param>
        /// <returns>A <c>ClUserContext</c> object containing the resolved credentials and user context data.</returns>
        /// <remarks>
        /// Constructs a composite key and executes a service layer call to retrieve the context. Throws an exception if the result is null or invalid.
        /// </remarks>
        /// <exception cref="CLException">Thrown when the user context cannot be determined.</exception>
        private static ClUserContext GetUserCtx(string _resource = null, int _userId = -1, int _companyId = -1, int _licence = -1)
        {
            LogManager.Record($"CONFIGURING OBJECT TO REQUEST CREDENTIALS | RESOURCE: {_resource} | USER ID: {_userId} | COMPANY ID: {_companyId} | LICENCE ID: {_licence}");

            int userId = _userId == -1 ? CL.COMMON.Core.GetClaimUserId() : _userId;

            int companyKey = _companyId == -1
                ? (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey]
                : _companyId;

            CartesianEntity<int, int, string, int> oCartesianEntity = new CartesianEntity<int, int, string, int>()
            {
                AKey = companyKey,
                BKey = userId,
                CKey = _resource,
                DKey = _licence
            };

            LogManager.Record($"OBJECT CONFIGURED");

            LogManager.Enter();

            LogManager.Record($"REQUESTING RECORD");

            CLContext<ClUserContext> oClContext =
                Services.Execute<ClUserContext, CartesianEntity<int, int, string, int>, MainDBContext, ICLSingle>(
                    "GetUserContext",
                    oCartesianEntity).Get();

            LogManager.Record("REQUEST COMPLETED");

            if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                throw new CLException("User credentials cant be determinate", System.Net.HttpStatusCode.BadRequest);

            return oClContext.Response.Data;
        }

        /// <summary>
        /// Retrieves the user context credentials specifically for ODBC-based operations based on the provided resource, user, company, and license.
        /// </summary>
        /// <param name="_resource">Optional resource name used to scope the user context.</param>
        /// <param name="_userId">Optional user ID. Defaults to the authenticated user if not provided.</param>
        /// <param name="_companyId">Optional company ID. Defaults to the current HTTP context company key if not provided.</param>
        /// <param name="_licence">Optional license ID used to further qualify the context.</param>
        /// <returns>A <c>ClUserContextODBC</c> object containing credentials and user context required for ODBC operations.</returns>
        /// <remarks>
        /// Executes a service layer call using a composite key to retrieve ODBC-specific context data.
        /// </remarks>
        /// <exception cref="CLException">Thrown when the ODBC user context cannot be determined.</exception>
        private static ClUserContextODBC GetUserCtxODBC(string _resource = null, int _userId = -1, int _companyId = -1,
            int _licence = -1)
        {
            LogManager.Record($"CONFIGURING OBJECT TO REQUEST CREDENTIALS | RESOURCE: {_resource} | USER ID: {_userId} | COMPANY ID: {_companyId} | LICENCE ID: {_licence}");

            int userId = _userId == -1 ? CL.COMMON.Core.GetClaimUserId() : _userId;

            int companyKey = _companyId == -1
                ? (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey]
                : _companyId;

            CartesianEntity<int, int, string, int> oCartesianEntity = new CartesianEntity<int, int, string, int>()
            {
                AKey = companyKey,
                BKey = userId,
                CKey = _resource,
                DKey = _licence
            };

            LogManager.Record($"OBJECT CONFIGURED");

            LogManager.Enter();

            LogManager.Record($"REQUESTING RECORD");

            CLContext<ClUserContextODBC> oClContext =
                Services.Execute<ClUserContextODBC, CartesianEntity<int, int, string, int>, MainDBContext, ICLSingle>(
                    "GetUserContext",
                    oCartesianEntity).Get();

            LogManager.Record("REQUEST COMPLETED");

            if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                throw new CLException("User credentials cant be determinate", System.Net.HttpStatusCode.BadRequest);
            
            return oClContext.Response.Data;
        }

        /// <summary>
        /// Retrieves the user UI context by requesting credentials for a given resource, user, company, and license.
        /// If user or company IDs are not specified, they are resolved from the current HTTP context or user claims.
        /// </summary>
        /// <param name="_resource">Optional resource name to identify the UI context scope.</param>
        /// <param name="_userId">Optional user ID. If not specified, the value is taken from the user claims.</param>
        /// <param name="_companyId">Optional company ID. If not specified, it is taken from the current HTTP context.</param>
        /// <param name="_licence">Optional license ID used for credential context resolution.</param>
        /// <returns>The <c>ClUserUiContext</c> object containing user interface credentials and context information.</returns>
        /// <remarks>
        /// This method constructs a composite key and queries the service layer to retrieve user-specific UI configuration data.
        /// Throws an exception if no valid data is returned.
        /// </remarks>
        /// <exception cref="CLException">Thrown when user UI context cannot be determined or credentials are missing.</exception>
        public static ClUserUiContext GetUserUiCtx(string _resource = null, int _userId = -1, int _companyId = -1, int _licence = -1)
        {
            LogManager.Record($"CONFIGURING OBJECT TO REQUEST CREDENTIALS | RESOURCE: {_resource} | USER ID: {_userId} | COMPANY ID: {_companyId} | LICENCE ID: {_licence}");

            int userId = _userId == -1 ? CL.COMMON.Core.GetClaimUserId() : _userId;

            int companyKey = _companyId == -1
                ? (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey]
                : _companyId;

            CartesianEntity<int, int, string, int> oCartesianEntity = new CartesianEntity<int, int, string, int>()
            {
                AKey = companyKey,
                BKey = userId,
                CKey = _resource,
                DKey = _licence
            };

            LogManager.Record($"OBJECT CONFIGURED");

            LogManager.Enter();

            LogManager.Record($"REQUESTING RECORD");

            CLContext<ClUserUiContext> oClContext =
                Services.Execute<ClUserUiContext, CartesianEntity<int, int, string, int>, MainDBContext, ICLSingle>(
                    "GetUserContext",
                    oCartesianEntity).Get();

            LogManager.Record("REQUEST COMPLETED");

            if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                throw new CLException("User credentials cant be determinate", System.Net.HttpStatusCode.BadRequest);

            return oClContext.Response.Data;
        }

        /// <summary>
        /// Retrieves the connection mode configured for the current environment.
        /// </summary>
        /// <returns>
        /// A string indicating the connection mode used for database queries, which can be either "ODBC" or "SL",
        /// depending on the value configured in the Web.config file for the current environment.
        /// </returns>
        private static string GetConnectionMode()
        {
            string connectionMode =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "ConnectionMode");

            if (string.IsNullOrWhiteSpace(connectionMode)) {
                throw new Exception("CL - No se ha configurado un [ConnectionMode]");
            }

            return connectionMode;
        }

        /// <summary>
        /// Retrieves the database type from configuration settings.
        /// </summary>
        /// <returns>
        /// The configured database type as a string.
        /// </returns>
        /// <exception cref="Exception">
        /// Thrown if the "DBType" configuration key is missing or contains only whitespace.
        /// </exception>
        private static string GetDBType()
        {
            string dbType =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "DBType");

            if (string.IsNullOrWhiteSpace(dbType))
            {
                throw new Exception("CL - No se ha configurado un [DBType]");
            }

            return dbType;
        }


        /// <summary>
        /// Retrieves a unique identifier record based on the provided document key and table name.
        /// </summary>
        /// <param name="_documentKey"></param>
        /// <param name="_table"></param>
        /// <returns></returns>
        public static async Task<CLContext<CLMLTEMA.MODELS.UniqueId>> GetUniqueId(string _documentKey, string _table, int _userId = -1, int _companyId = -1)
        {
            LogManager.Record($"REQUEST UNIQUEID RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetUniqueId", _userId, _companyId);
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                //Agrega las demas asignaciones de loss parametros en el diccionario

                List<CLMLTEMA.MODELS.UniqueId> resultList = Common.ResolveSAPViewODBC<CLMLTEMA.MODELS.UniqueId>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@U_DocumentKey", $"{_documentKey ?? ""}"},
                        {"@Table", $"{_table}"},
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<CLMLTEMA.MODELS.UniqueId>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<CLMLTEMA.MODELS.UniqueId>()
                    {
                        Data = resultList.FirstOrDefault(),
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetUniqueId", _userId, _companyId).Get(new FilterUniqueId()
                {
                    U_DocumentKey = _documentKey ?? "",
                    Table = _table
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<CLMLTEMA.MODELS.UniqueId>();
                #endregion
            }

        }




        #endregion

        #region DBLocal

        #region Routes

        /// <summary>
        /// This method is used get routes records
        /// </summary>
        /// <param name="_routeName">This parameter is name of route</param>
        /// <param name="_userAssing">This parameter is assigned is user</param>
        /// <param name="_startDate">This parameter is start date filter</param>
        /// <param name="_endDate">This parameter is end date filter</param>
        /// <param name="_state">This parameter is state filter</param>
        /// <returns></returns>
        public static CLContext<IEnumerable<PresentationRoute>> GetRoutes(string _routeName, int _userAssing, DateTime _startDate, DateTime _endDate,int _state)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();
            int page = (int)Common.GetHeaderContext(PaginationRecords.Page);
            int pageSize = (int)Common.GetHeaderContext(PaginationRecords.PageSize);
            int skip = page * pageSize;

            CLContext<IEnumerable<PresentationRoute>> oClContext =
                Services.Execute<FilterRoutes,PresentationRoute, MainDBContext>("GetRoutes",new FilterRoutes()
                {
                    CompanyId = companyId,
                    StartDate = _startDate,
                    EndDate = _endDate,
                    State = _state,
                    Name = _routeName,
                    Take = pageSize,
                    Skip = skip,
                    UserAssing = _userAssing
                }).Get();
            
            CLContext<RecordsCount> oClContextCount =
                Services.Execute<FilterRoutes,RecordsCount, MainDBContext,ICLMaster,ICLSingle>("GetRoutesTotalRecords",new FilterRoutes()
                {
                    CompanyId = companyId,
                    StartDate = _startDate,
                    EndDate = _endDate,
                    State = _state,
                    Name = _routeName,
                    Take = pageSize,
                    Skip = skip,
                    UserAssing = _userAssing
                }).Get();

            Common.SetHeaderContext(PaginationRecords.RecodrsCount, oClContextCount.Response.Data.TotalRecords);

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;
        }

        public static CLContext<Route> GetRoute(int _id)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            RouteFilter oFilter = new RouteFilter()
            {
                Id = _id,
                CompanyId = companyId
            };

            CLContext<Route> oClContext =
                Services.Execute<Route, RouteFilter, MainDBContext, ICLSingle>("GetRoute", oFilter);

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;
        }

        public static CLContext<IEnumerable<RouteLine>> GetRouteLines(int _routeId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            RouteFilter oFilter = new RouteFilter()
            {
                Id = _routeId,
                CompanyId = companyId
            };

            CLContext<IEnumerable<RouteLine>> oClContext =
                Services.Execute<RouteFilter, RouteLine, MainDBContext>("GetRouteLines", oFilter).Get();

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;

        }


        /// <summary>
        /// 
        /// </summary>
        /// <param name="_cardCode"></param>
        /// <returns></returns>
        public static async Task<CLContext<TotalBPRouteDocuments>> GetTotalBPRouteDocuments(string _cardCode)
        {
            LogManager.Record($"REQUESTING TOTAL BP ROUTE DOCUMENTS... CARDCODE: {_cardCode}");


            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetTotalBPRouteDocuments");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<TotalBPRouteDocuments> resultList = Common.ResolveSAPViewODBC<TotalBPRouteDocuments>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@CardCode", $"{_cardCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED... RESPONSE: {JsonConvert.SerializeObject(resultList)}");

                return new CLContext<TotalBPRouteDocuments>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<TotalBPRouteDocuments>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetTotalBPRouteDocuments").Get(new FilterBaseByCardCode()
                {
                    CardCode = _cardCode
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");


                CLContext<TotalBPRouteDocuments> oclContext =  await requestModel.SendAsync<TotalBPRouteDocuments>();

                LogManager.Record($"REQUESTING COMPLETED... RESPONSE: {JsonConvert.SerializeObject(oclContext)}");

                return oclContext;
                #endregion
            }


        }



        public static CLContext<IEnumerable<RouteAdministrator>> GetRouteAdministrators(int _routeId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            RouteFilter oFilter = new RouteFilter()
            {
                Id = _routeId,
                CompanyId = companyId
            };

            CLContext<IEnumerable<RouteAdministrator>> oClContext =
                Services.Execute<RouteFilter, RouteAdministrator, MainDBContext>("GetRouteAdministrators", oFilter)
                    .Get();

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;
        }

        public static CLContext<Route> CreateRoute(RouteWithLines _routeWithLines)
        {
            LogManager.Record($"CREATING ROUTE...");

            string createdBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _routeWithLines.Route.CreatedBy = createdBy;
            _routeWithLines.Route.CompanyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            CLContext<Route> oClContext = _routeWithLines.Route.Post<Route, MainDBContext, ICLExclude, ICLSingle>(
                "PostRoute", "Company", "RouteFrequency", "IsActive", "RouteAssignment", "ActivationDate", "Status",
                "CloseDate", "CloseDetail", "CloseUser", "RouteAssignmentId");

            LogManager.Record($"ROUTE CREATED | RESPONSE: {JsonConvert.SerializeObject(oClContext)}");

            LogManager.Record($"CREATING ROUTE LINES...");

            int routeId = oClContext.Response.Data.Id;

            foreach (RouteLine line in _routeWithLines.RouteLines)
            {
                LogManager.Record($"CREATING ROUTE LINE...");

                line.RouteId = routeId;

                CLContext<RouteLine> oRouteLineContext =
                    line.Post<RouteLine, MainDBContext, ICLExclude, ICLSingle>("PostRouteLine", "Status", "IsActive",
                        "Route");

                LogManager.Record($"ROUTE LINE CREATED | MODEL: {JsonConvert.SerializeObject(oRouteLineContext)}");
            }

            return oClContext;
        }

        public static async System.Threading.Tasks.Task<CLContext<Route>> UpdateRoute(RouteWithLines _routeWithLines)
        {
            #region Actualizar ruta

            LogManager.Record($"UPDATING ROUTE...");

            string updatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _routeWithLines.Route.UpdatedBy = updatedBy;
            _routeWithLines.Route.CompanyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            CLContext<Route> oClContext = _routeWithLines.Route.Patch<Route, MainDBContext, ICLExclude, ICLSingle>(
                "PatchRoute", "Company", "RouteFrequency", "IsActive", "RouteAssignment", "ActivationDate", "Status",
                "CloseDate", "CloseDetail", "CloseUser", "RouteAssignmentId");

            LogManager.Record($"ROUTE UPDATED | RESPONSE: {JsonConvert.SerializeObject(oClContext)}");

            #endregion

            #region Actualizar citas de calendario de ruta

            // Se comenta esta asignacion de calendario

            //if (oClContext.Response.Data is object && oClContext.Response.Data.RouteAssignmentId != 0)
            //{
            //    LogManager.Record($"UPDATING ROUTE APPOINTMENTS...");

            //    await UpdateAppointments(oClContext.Response.Data.Id);
            //}

            #endregion

            #region Eliminar lineas de ruta que se quitaron

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            RouteFilter oFilter = new RouteFilter()
            {
                Id = _routeWithLines.Route.Id,
                CompanyId = companyId
            };

            CLContext<IEnumerable<RouteLine>> oRouteLinesCLContext =
                Services.Execute<RouteFilter, RouteLine, MainDBContext>("GetRouteLines", oFilter).Get();

            IEnumerable<RouteLine> dbRouteLines = oRouteLinesCLContext.Response.Data;

            List<int> routeLinesIdsToDelete = dbRouteLines.Aggregate(new List<int>(), (acc, val) =>
            {
                if (!_routeWithLines.RouteLines.Any(rl => rl.Id == val.Id))
                {
                    acc.Add(val.Id);
                }

                return acc;
            });

            foreach (int rlId in routeLinesIdsToDelete)
            {
                LogManager.Record($"REMOVING ROUTE LINE FROM DATABASE... | ID: {rlId}");

                CLContext<RouteLine> oDeletedRouteLinesContext =
                    Services.Execute<RouteLine, MainDBContext, int, ICLSingle>("DeleteRouteLine", rlId);

                LogManager.Record($"ROUTE LINE REMOVED FROM DATABASE");
            }

            #endregion

            #region Actualizar lineas de ruta

            LogManager.Record($"UPDATING ROUTE LINES...");

            List<RouteLine> routesLinesToUpdate = _routeWithLines.RouteLines.Aggregate(new List<RouteLine>(),
                (acc, val) =>
                {
                    if (val.Id != 0)
                    {
                        acc.Add(val);
                    }

                    return acc;
                });

            foreach (RouteLine line in routesLinesToUpdate)
            {
                LogManager.Record($"UPDATING ROUTE LINE... | MODEL: {JsonConvert.SerializeObject(line)}");

                line.RouteId = _routeWithLines.Route.Id;

                CLContext<RouteLine> oRouteLineContext =
                    line.Patch<RouteLine, MainDBContext, ICLExclude, ICLSingle>("PatchRouteLine", "Status", "IsActive",
                        "Route");

                LogManager.Record($"ROUTE LINE UPDATED");
            }

            #endregion

            #region Crear lineas de ruta nuevas

            LogManager.Record($"CREATING ROUTE LINES...");

            List<RouteLine> routesLinesToCreate = _routeWithLines.RouteLines.Aggregate(new List<RouteLine>(),
                (acc, val) =>
                {
                    if (val.Id == 0)
                    {
                        acc.Add(val);
                    }

                    return acc;
                });

            foreach (RouteLine line in routesLinesToCreate)
            {
                LogManager.Record($"CREATING ROUTE LINE...");

                line.RouteId = _routeWithLines.Route.Id;

                CLContext<RouteLine> oRouteLineContext =
                    line.Post<RouteLine, MainDBContext, ICLExclude, ICLSingle>("PostRouteLine", "Status", "IsActive",
                        "Route");

                LogManager.Record($"ROUTE LINE CREATED | MODEL: {JsonConvert.SerializeObject(oRouteLineContext)}");
            }

            #endregion

            return oClContext;
        }

        /// <summary>
        /// /Method to close route
        /// </summary>
        /// <param name="_route"></param>
        /// <param name="_routeId"></param>
        /// <returns></returns>
        public static async System.Threading.Tasks.Task<CLContext<Route>> CloseRoute(Route _route, int _routeId)
        {
            LogManager.Record("CLOSING ROUTE...");

            string currentUser = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            CLContext<Route> oClContext = Services.Execute<Route, MainDBContext, ICLInclude, ICLSingle>(
                "UpdateRouteStatus", new Route()
                {
                    Id = _routeId,
                    Status = (int)RouteStatus.CLOSED,
                    CompanyId = companyId,
                    CloseDetail = _route.CloseDetail,
                    UpdatedBy = currentUser,
                }, "Id", "Status", "CompanyId","CloseDetail", "UpdatedBy");

            if (oClContext.Response.Data is object)
            {
                LogManager.Record("DELETING INCOMPLETE APPOINTMENTS...");

                await DeleteIncompleteAppointments(_routeId);
            }

            return oClContext;
        }

        public static CLContext<RouteCalculationDetail> UpdateRouteCalculationDetails(
            RouteCalculationDetail _calculationDetails)
        {
            LogManager.Record("UPDATING ROUTE CALCULATION DETAILS...");

            _calculationDetails.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            return _calculationDetails.Post<RouteCalculationDetail, MainDBContext, ICLExclude, ICLSingle>(
                "UpdateRouteCalcDetails", "Route", "IsActive");
        }

        public static async System.Threading.Tasks.Task<CLContext<List<ProcessedRoute>>> CreateProcessedRoutes(
            List<ProcessedRoute> _processedRoutes)
        {
            List<ProcessedRoute>
                processedRoutes =
                    new List<ProcessedRoute>(
                        _processedRoutes); //JsonConvert.DeserializeObject<List<ProcessedRoute>>(JsonConvert.SerializeObject(_processedRoutes));

            for (int i = 0; i < _processedRoutes.Count; i++)
            {
                try
                {
                    // Creación de la ruta
                    CLContext<Route> oClContextCreatedRoute = CreateRoute(new RouteWithLines()
                    {
                        Route = _processedRoutes[i].Route,
                        RouteLines = _processedRoutes[i].RouteLines
                    });

                    if (!(oClContextCreatedRoute.Response.Data is object))
                    {
                        throw new Exception(oClContextCreatedRoute.Response.Message);
                    }

                    // Guardar estimaciones
                    if (_processedRoutes[i].Estimate)
                    {
                        CLContext<RouteCalculationDetail> oClContextRouteCalcDetail = UpdateRouteCalculationDetails(
                            new RouteCalculationDetail()
                            {
                                RouteId = oClContextCreatedRoute.Response.Data.Id,
                                Distance = _processedRoutes[i].Route.TotalEstimatedDistance,
                                Duration = _processedRoutes[i].Route.TotalEstimatedDuration,
                                Type = (int)RouteCalculationTypes.ESTIMATED,
                                JsonApi = _processedRoutes[i].EstimateJson ?? "[]"
                            });

                        if (!(oClContextRouteCalcDetail.Response.Data is object))
                        {
                            throw new Exception(oClContextRouteCalcDetail.Response.Message);
                        }
                    }

                    // Asignacion de la ruta a usuario, calendarizacion de la ruta (internamente)

                    CLContext<List<RouteAssignment>> oClContextRouteAssigment = await PostRouteAssignment(
                        new List<RouteAssignment>(){
                            new RouteAssignment()
                            {
                                RouteId = oClContextCreatedRoute.Response.Data.Id,
                                UserAssignId = _processedRoutes[i].UserAssigned,
                                IsActive = true,
                                RouteDownloadDate = null
                            }
                        });

                    if (!(oClContextRouteAssigment.Response.Data is object))
                    {
                        throw new Exception(oClContextRouteAssigment.Response.Message);
                    }

                    processedRoutes[i].Result = "Ruta creada exitosamente";

                    // Asignamos el Id para hacer el proceso de estimacion en la respuesta
                    processedRoutes[i].Route.Id = _processedRoutes[i].Route.Id;
                }
                catch (Exception ex)
                {
                    processedRoutes[i].Status = false;
                    processedRoutes[i].Result = ex.Message;
                }
            }

            return new CLContext<List<ProcessedRoute>>()
            {
                Response = new Response<List<ProcessedRoute>>()
                {
                    Data = processedRoutes,
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        public static CLContext<IEnumerable<User>> GetRouteAssignedUsers(int _routeId)
        {
            LogManager.Record("REQUESTING RECORDS...");
            return Services.Execute<User, MainDBContext, int>("GetRouteAssignedUsers", _routeId, "@RouteId");
        }

        public static async Task<CLContext<IEnumerable<PresentationRouteWithLines>>> GetUserAssignedRoutes(int _userId,
            string _imei)
        {
            List<PresentationRouteWithLines> routeWithLines = new List<PresentationRouteWithLines>();

            LogManager.Record($"REQUESTING RECORDS");

            RouteUserFilter filter = new RouteUserFilter()
            {
                UserId = _userId,
                CompanyId = GetCompanyId(),
                IMEI = _imei
            };

            CLContext<IEnumerable<PresentationRoute>> oClContextRoute = Services
                .Execute<RouteUserFilter, PresentationRoute, MainDBContext>("GetUserAssignedRoutes", filter).Get();

            LogManager.Record($"REQUESTING RECORDS LINES");

            // Incluir lineas de la ruta
            if (oClContextRoute.Response != null)
            {
                foreach (PresentationRoute oRoute in oClContextRoute.Response.Data)
                {
                    CLContext<IEnumerable<RouteLine>> oClContextLines = GetRouteLines(oRoute.Id);


                    List<Task<CLContext<TotalBPRouteDocuments>>> tasks = new List<Task<CLContext<TotalBPRouteDocuments>>>();


                    List<RouteLine> routeLines = oClContextLines?.Response?.Data?.ToList();
                    
                    List<RouteLine> lines = new List<RouteLine>();

                    // Start all tasks in parallel without waiting
                    foreach (RouteLine routeLine in routeLines)
                    {
                        CLContext<TotalBPRouteDocuments> tota = await GetTotalBPRouteDocuments(routeLine.CardCode);
                        if (tota.Response.Data.DocsTotal > 0)
                        {
                            lines.Add(routeLine);
                        }
                    }


                    if (lines != null && lines.Count > 0)
                    {
                        routeWithLines.Add(new PresentationRouteWithLines()
                        {
                            Route = oRoute,
                            RouteLines = lines
                        });
                    }
                }
            }

            LogManager.Record($"REQUESTED RECORDS");

            return new CLContext<IEnumerable<PresentationRouteWithLines>>()
            {
                Code = oClContextRoute.Code,
                Response = new Response<IEnumerable<PresentationRouteWithLines>>()
                {
                    Data = routeWithLines,
                    Message = oClContextRoute.Response.Message
                },
                value = routeWithLines
            };
        }

        public static CLContext<IEnumerable<PresentationRoute>> GetUserActiveRoutes(int _userId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            RouteActiveFilter filter = new RouteActiveFilter()
            {
                UserId = _userId,
                CompanyId = GetCompanyId()
            };

            CLContext<IEnumerable<PresentationRoute>> oClContext = Services
                .Execute<RouteActiveFilter, PresentationRoute, MainDBContext>("GetUserActiveRoutes", filter).Get();

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;
        }

        public static CLContext<Route> UpdateRouteStatus(int _routeId, int _newStatus)
        {
            LogManager.Record($"UPDATING ROUTE STATUS...");

            string currentUser = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            CLContext<Route> oClContext = Services.Execute<Route, MainDBContext, ICLInclude, ICLSingle>(
                "UpdateRouteStatus", new Route()
                {
                    Id = _routeId,
                    Status = _newStatus,
                    CompanyId = companyId,
                    UpdatedBy = currentUser
                }, "Id", "Status", "CompanyId", "UpdatedBy");

            LogManager.Record($"ROUTE STATUS UPDATED");

            return oClContext;
        }

        private static CLContext<RouteAssignment> GetRouteAssignmentByRouteId(int _routeId)
        {
            LogManager.Record($"REQUESTING ROUTE ASSIGNMENT... | ROUTE: {_routeId}");

            CLContext<RouteAssignment> oClContext =
                Services.Execute<RouteAssignment, MainDBContext, int, ICLSingle>("GetRouteAssignmentByRouteId",
                    _routeId,
                    "@RouteId");

            LogManager.Record("ROUTE ASSIGNMENT REQUESTED");

            return oClContext;
        }

        #endregion

        #region Files

        public static async Task<CLContext<List<ProcessedRoute>>> ProcessRouteTemplate(HttpPostedFile _postedFile)
        {
            LogManager.Record("READING TEMPLATES LINES...");

            MemoryStream fileStream = new MemoryStream();

            _postedFile.InputStream.CopyTo(fileStream);

            string fileExtention = Path.GetExtension(_postedFile.FileName);

            List<ProcessedRoute> processedRoutes = new List<ProcessedRoute>();

            using (IExcelDataReader Reader = (fileExtention.ToUpper() == ".CSV")
                       ? ExcelReaderFactory.CreateCsvReader(fileStream)
                       : ExcelReaderFactory.CreateReader(fileStream))
            {
                System.Data.DataSet FileDataSet = Reader.AsDataSet();

                if (FileDataSet.Tables.Count > 0)
                {
                    DataTable FileDataTable = FileDataSet.Tables[0];

                    if (FileDataTable.Rows.Count > 0)
                    {
                        ProcessedRoute processedRoute = null;

                        int routeType = 0;

                        bool hasErrors = false;

                        for (int i = 0; i < FileDataTable.Rows.Count; i++)
                        {
                            if (FileDataTable.Rows[i][0] != null)
                            {
                                if (FileDataTable.Rows[i][0].ToString() == "Nombre")
                                {
                                    processedRoute = null;

                                    if (FileDataTable.Rows.Count >= i + 1)
                                    {
                                        i++;
                                        try
                                        {
                                            processedRoute = new ProcessedRoute();

                                            int frequencyId = Int32.Parse(FileDataTable.Rows[i][1].ToString());

                                            int userAssignedId = Int32.Parse(FileDataTable.Rows[i][2].ToString());

                                            processedRoute.Route = new Route()
                                            {
                                                Name = FileDataTable.Rows[i][0].ToString(),
                                                RouteFrequencyId = frequencyId,
                                                ExpirationDate = DateTime.Parse(FileDataTable.Rows[i][3].ToString()),
                                                Type = (int)((FileDataTable.Rows[i][4].ToString() == "Entregas")
                                                    ? RouteType.DELIVERY
                                                    : RouteType.ORDER),
                                                Status = (int)RouteStatus.INACTIVE,
                                                TotalEstimatedDistance = 0,
                                                TotalEstimatedDuration = 0
                                            };

                                            routeType = processedRoute.Route.Type;
                                            processedRoute.UserAssigned = userAssignedId;
                                            processedRoute.Estimate = (FileDataTable.Rows[i][5].ToString() == "Sí");
                                            processedRoute.RouteLines = new List<RouteLine>();


                                            CLContext<UserAssign> oClContextUserAssign = GetUserAssign(userAssignedId);

                                            if (!(oClContextUserAssign is object))
                                                throw new Exception(
                                                    $"El usuario con el ID #{userAssignedId} no fue encontrado. Linea N°{i + 1}.");

                                            CLContext<RouteFrequency> oClContextFrequency =
                                                GetRouteFrequency(frequencyId);

                                            if (!(oClContextFrequency.Response.Data is object))
                                                throw new Exception(
                                                    $"La frecuencia con el ID #{frequencyId} no se encontro. Linea N°{i + 1}.");

                                            if (processedRoute.Route.ExpirationDate < DateTime.Today)
                                                throw new Exception(
                                                    $"La fecha de expiración de la ruta es menor a la fecha actual. Linea N°{i + 1}.");

                                            hasErrors = false;
                                            ;
                                        }
                                        catch (Exception ex)
                                        {
                                            processedRoute.Result = ex.Message;
                                            processedRoute.Status = false;
                                            hasErrors = true;
                                        }
                                    }

                                    if (processedRoute != null)
                                    {
                                        processedRoute.Status = !hasErrors;
                                        processedRoutes.Add(processedRoute);
                                    }
                                }
                                else if (FileDataTable.Rows[i][0].ToString() == "Codigo socio")
                                {
                                    try
                                    {
                                        do
                                        {
                                            i++;

                                            string cardCode = FileDataTable.Rows[i][0].ToString();

                                            CLContext<BusinessPartners> oClContextCustomer =
                                                await GetBusinessPartner(cardCode);

                                            if (!(oClContextCustomer.Response.Data is object))
                                                throw new Exception(
                                                    $"El socio de negocios '{cardCode}' no fue encontrado. Linea N°{i + 1}.");

                                            string addressId = FileDataTable.Rows[i][1].ToString();

                                            CLContext<BusinessPartnerLocation> oClContextBpLocation =
                                                await GetBusinessPartnerLocation(cardCode, addressId);

                                            if (!(oClContextBpLocation.Response.Data is object))
                                                throw new Exception(
                                                    $"La dirección '{addressId}' del socio '{cardCode}' no fue encontrada. Linea N°{i + 1}.");

                                            if ((routeType == (int)RouteType.ORDER &&
                                                 oClContextBpLocation.Response.Data.AddressType !=
                                                 (int)RouteType.ORDER) || (routeType == (int)RouteType.DELIVERY &&
                                                                           oClContextBpLocation.Response.Data
                                                                               .AddressType != (int)RouteType.DELIVERY))
                                            {
                                                throw new Exception(
                                                    $"El tipo de ubicación no coincide con el tipo de ruta. Linea N°{i + 1}.");
                                            }

                                            // Falta agregar mas parametros al crear el objeto
                                            RouteLine routeLine = new RouteLine()
                                            {
                                                Address = addressId,
                                                CardCode = cardCode,
                                                CardName = oClContextCustomer.Response.Data.CardName,
                                                Id = 0,
                                                Latitude = Double.Parse(oClContextBpLocation.Response.Data.Latitude),
                                                Longitude = Double.Parse(oClContextBpLocation.Response.Data.Longitude),
                                                Status = 2,
                                                RouteId = 0,
                                                AddressLineId =
                                                    Convert.ToInt32(oClContextBpLocation.Response.Data.AddressLineId),
                                                CheckStatus = (int)RouteCheckTypes.NOT_LINKED_TO_ROUTE,
                                                AddressType = oClContextBpLocation.Response.Data.AddressType
                                            };

                                            processedRoute.RouteLines.Add(routeLine);

                                            if (i + 1 >= FileDataTable.Rows.Count ||
                                                FileDataTable.Rows[i + 1][0].ToString() == "Nombre") break;
                                        } while (i < FileDataTable.Rows.Count);
                                    }
                                    catch (Exception ex)
                                    {
                                        processedRoute.Result = ex.Message;
                                        processedRoute.Status = false;
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        throw new Exception("La hoja está vacia");
                    }
                }
                else
                {
                    throw new Exception("El archivo no contiene una hojas valida");
                }
            }

            return new CLContext<List<ProcessedRoute>>()
            {
                Response = new Response<List<ProcessedRoute>>()
                {
                    Data = processedRoutes,
                    Message = String.Empty
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Generates a route planning Excel template populated with frequency, user, customer, and location metadata,
        /// then returns it as a base64-encoded file for download.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{DownloadBase64}"/> containing the file name, content type, base64 data, and extension.
        /// </returns>
        public static async Task<CLContext<MODELS.DownloadBase64>> DownloadRouteMassiveTemplateFile()
        {
            string fileName =
                CL.COMMON.Core.GetConfigKeyValue<string>(System.Reflection.MethodBase.GetCurrentMethod(), "RouteTemplateName");
            string fileExtension =
                CL.COMMON.Core.GetConfigKeyValue<string>(System.Reflection.MethodBase.GetCurrentMethod(),
                    "RouteTemplateExtension");
            string filePath =
                $"{CL.COMMON.Core.GetConfigKeyValue<string>(System.Reflection.MethodBase.GetCurrentMethod(), "FilesPath")}{fileName}.{fileExtension}";

            #region Obtener metadatos

            CLContext<IEnumerable<RouteFrequency>> oClContextFrequencies = GetRouteFrequencies(true);

            CLContext<IEnumerable<UserForRouteTemplate>> oClContextUsers = GetUsersForRouteTemplate();

            CLContext<List<BusinessPartners>> oClContextBusinessPartners = await GetBusinessPartners();

            #region Obtener ubicaciones de los socios

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BusinessPartnerLocation>> oClContextLocations;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetBusinessPartnersLocations");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartnerLocation> resultList = Common.ResolveSAPViewODBC<BusinessPartnerLocation>(contextODBC,
                    new Dictionary<string, object>());

                oClContextLocations = new CLContext<List<BusinessPartnerLocation>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartnerLocation>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetBusinessPartnersLocations").Get();

                oClContextLocations = await oSlRequestObject.SendAsync<List<BusinessPartnerLocation>>();
            }

            #endregion

            #endregion

            List<RouteFrequency> oFrequencies =
                oClContextFrequencies.Response?.Data.ToList() ?? new List<RouteFrequency>();
            List<UserForRouteTemplate> oUserForRouteTemplates =
                oClContextUsers.Response?.Data.ToList() ?? new List<UserForRouteTemplate>();
            List<BusinessPartnerLocation> oPartnerLocations =
                oClContextLocations.Response?.Data ?? new List<BusinessPartnerLocation>();
            List<BusinessPartners> oBusinessPartners =
                oClContextBusinessPartners.Response?.Data ?? new List<BusinessPartners>();

            string base64 = FileToBase64(AddMetadataToRouteTemplate(filePath, oFrequencies, oUserForRouteTemplates,
                oBusinessPartners, oPartnerLocations));

            return new CLContext<MODELS.DownloadBase64>
            {
                Response = new Response<MODELS.DownloadBase64>()
                {
                    Data = new MODELS.DownloadBase64()
                    {
                        FileName = fileName,
                        BlobType = "application/octet-stream",
                        Base64 = base64,
                        FileExtension = fileExtension
                    }
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Converts the contents of a stream to a Base64-encoded string.
        /// </summary>
        /// <param name="_file">The input stream to convert.</param>
        /// <returns>A Base64 string representing the stream's byte content.</returns>
        public static string FileToBase64(Stream _file)
        {
            try
            {
                byte[] array;

                MemoryStream oMemoryStream = new MemoryStream();

                _file.CopyTo(oMemoryStream);

                array = oMemoryStream.ToArray();

                return Convert.ToBase64String(array);
            }
            catch
            {
                throw;
            }
        }

        /// <summary>
        /// Loads an Excel template from disk, inserts metadata into its worksheets,
        /// and returns the modified file as a <see cref="MemoryStream"/>.
        /// </summary>
        /// <param name="_path">File path to the original Excel template.</param>
        /// <param name="_frequencies">List of route frequencies to populate in sheet 1.</param>
        /// <param name="_users">List of users to populate in sheet 2.</param>
        /// <param name="_customers">List of business partners to populate in sheet 3.</param>
        /// <param name="_customerLocations">List of partner locations to populate in sheet 4.</param>
        /// <returns>A memory stream containing the updated Excel package.</returns>
        public static MemoryStream AddMetadataToRouteTemplate(string _path, List<RouteFrequency> _frequencies,
            List<UserForRouteTemplate> _users, List<BusinessPartners> _customers,
            List<BusinessPartnerLocation> _customerLocations)
        {
            MemoryStream fileMemory = new MemoryStream();

            using (ExcelPackage p = new ExcelPackage(_path))
            {
                // Frecuencias
                ExcelWorksheet wsFrecuencies = p.Workbook.Worksheets[1];
                for (int i = 0; i < _frequencies.Count; i++)
                {
                    wsFrecuencies.Cells[i + 1, 1].Value = _frequencies[i].Id;
                    wsFrecuencies.Cells[i + 1, 2].Value = _frequencies[i].Description;
                }

                // Usuarios
                ExcelWorksheet wsUsers = p.Workbook.Worksheets[2];
                for (int i = 0; i < _users.Count; i++)
                {
                    wsUsers.Cells[i + 1, 1].Value = _users[i].AssignId;
                    wsUsers.Cells[i + 1, 2].Value = _users[i].UserEmail;
                }

                // Socios
                ExcelWorksheet wsPartners = p.Workbook.Worksheets[3];
                for (int i = 0; i < _customers.Count; i++)
                {
                    wsPartners.Cells[i + 1, 1].Value = _customers[i].CardCode;
                    wsPartners.Cells[i + 1, 2].Value = _customers[i].CardName;
                }

                // Direcciones
                ExcelWorksheet wsLocations = p.Workbook.Worksheets[4];
                for (int i = 0; i < _customerLocations.Count; i++)
                {
                    wsLocations.Cells[i + 1, 1].Value = _customerLocations[i].CardCode;
                    wsLocations.Cells[i + 1, 2].Value = _customerLocations[i].Address;
                }

                fileMemory = new MemoryStream(p.GetAsByteArray());
            }

            return fileMemory;
        }

        #endregion

        #region RouteAdministrators

        public static CLContext<IEnumerable<User>> GetRoutesAdministrators()
        {
            LogManager.Record($"OBTAINING COMPANY ID...");

            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            LogManager.Record($"COMPANY ID OBTAINED");

            LogManager.Record($"REQUESTING RECORDS...");

            return Services.Execute<User, MainDBContext, int>("GetRoutesAdministrators", companyId, "@CompanyId");
        }

        public static CLContext<bool> CreateRouteAdministrators(List<RouteAdministrator> _administrators, int _routeId)
        {
            #region Validaciones

            if ((_administrators is object) && _administrators.Any(ra => ra.RouteId != _routeId))
            {
                throw new Exception("Hay algunos administradores de ruta que no coinciden con la ruta indicada");
            }

            #endregion

            #region Obtener administradores actuales de la ruta

            LogManager.Record("OBTAINING ROUTE ADMINISTRATORS...");

            IEnumerable<RouteAdministrator> routeAdministrators = GetRouteAdministrators(_routeId).Response.Data;

            #endregion

            #region Eliminar todos los administradores de la ruta

            if (!(_administrators is object) || !_administrators.Any())
            {
                CLContext<Common.SingleValue<bool>> oClContext =
                    Services.Execute<Common.SingleValue<bool>, MainDBContext, int, ICLSingle>(
                        "DeleteRouteAdministrators", _routeId,
                        "@RouteId");
                return new CLContext<bool>()
                {
                    Response = new Response<bool>()
                    {
                        Data = oClContext.Response.Data?.Value ?? false,
                        Message = oClContext.Response.Message
                    },
                    Code = oClContext.Code
                };
            }

            #endregion

            #region Seleccionar y eliminar de base de datos los administradores de ruta que fueron removidos de la ruta

            if (routeAdministrators is object)
            {
                List<RouteAdministrator> routeAdminsToDelete = routeAdministrators.Aggregate(
                    new List<RouteAdministrator>(),
                    (_list, _administrator) =>
                    {
                        if (!_administrators.Any(ra => ra.UserId == _administrator.UserId))
                        {
                            _list.Add(_administrator);
                        }

                        return _list;
                    });

                foreach (RouteAdministrator ra in routeAdminsToDelete)
                {
                    Services.Execute<Common.SingleValue<bool>, MainDBContext, int, ICLSingle>(
                        "DeleteRouteAdministrator", ra.Id,
                        "@RouteAdminId");
                }
            }

            #endregion

            #region Agregar nuevos administradores a la ruta

            LogManager.Record("SENDING OBJECTS TO CREATE...");

            List<RouteAdministrator> administratorsToAdd = _administrators.Aggregate(new List<RouteAdministrator>(),
                (_list, _administrator) =>
                {
                    if (!routeAdministrators.Any(a => a.UserId == _administrator.UserId))
                    {
                        _list.Add(_administrator);
                    }

                    return _list;
                });

            string createdBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            bool allCreated = true;

            string errorMessage = String.Empty;

            foreach (RouteAdministrator admin in administratorsToAdd)
            {
                admin.CreatedBy = createdBy;
                CLContext<RouteAdministrator> oClContextRouteAdmin =
                    admin.Post<RouteAdministrator, MainDBContext, ICLExclude, ICLSingle>("PostRouteAdministrator",
                        "Route", "User", "IsActive");
                if (allCreated && !(oClContextRouteAdmin.Response.Data is object))
                {
                    allCreated = false;
                    errorMessage = oClContextRouteAdmin.Response.Message;
                }
            }

            #endregion

            return new CLContext<bool>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<bool>()
                {
                    Data = allCreated,
                    Message = allCreated
                        ? ""
                        : $"No se pudo agregar todo los administradores de la ruta. Detalles: {errorMessage}"
                }
            };
        }

        #endregion

        #region RoutesFrequencies

        /// <summary>
        /// Retrieves route frequency records.
        /// </summary>
        /// <param name="_onlyActive">
        /// True to return only active frequencies; false to return all frequencies.
        /// </param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{RouteFrequency}}"/> containing the requested route frequencies.
        /// </returns>
        public static CLContext<IEnumerable<RouteFrequency>> GetRouteFrequencies(bool _onlyActive)
        {
            LogManager.Record("REQUESTING RECORDS");

            if (_onlyActive)
            {
                return Services.Execute<RouteFrequency, MainDBContext>("GetActiveRouteFrequencies");
            }

            return Services.Execute<RouteFrequency, MainDBContext>("GetRoutesFrequencies");
        }

        /// <summary>
        /// Retrieves a single route frequency by its identifier.
        /// </summary>
        /// <param name="_frequencyId">The identifier of the route frequency to retrieve.</param>
        /// <returns>
        /// A <see cref="CLContext{RouteFrequency}"/> containing the matching route frequency.
        /// </returns>
        public static CLContext<RouteFrequency> GetRouteFrequency(int _frequencyId)
        {
            LogManager.Record("REQUESTING RECORD....");

            return Services.Execute<RouteFrequency, MainDBContext, int, ICLSingle>("GetRouteFrequency", _frequencyId,
                "@FrequencyId");
        }

        /// <summary>
        /// Retrieves the set of weekly frequency structures for route planning.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{Structures}}"/> containing the weekly frequency definitions.
        /// </returns>
        public static CLContext<IEnumerable<Structures>> GetRouteFrequenciesWeeks()
        {
            LogManager.Record("REQUESTING RECORD...");
            return GetStructureByType("RouteFrequenciesWeeks");
        }

        /// <summary>
        /// Creates a new route frequency record.
        /// </summary>
        /// <param name="_routeFrequency">The route frequency data to create.</param>
        /// <returns>
        /// A <see cref="CLContext{RouteFrequency}"/> containing the newly created route frequency.
        /// </returns>
        public static CLContext<RouteFrequency> CreateRouteFrequency(RouteFrequency _routeFrequency)
        {
            _routeFrequency.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            LogManager.Record("CREATING FREQUENCY...");

            CLContext<RouteFrequency> oClContext =
                _routeFrequency.Post<RouteFrequency, MainDBContext>("PostRouteFrequency");

            LogManager.Record("FREQUENCY CREATED");

            return oClContext;
        }

        /// <summary>
        /// Updates an existing route frequency record.
        /// </summary>
        /// <param name="_routeFrequency">The route frequency data to update.</param>
        /// <returns>
        /// A <see cref="CLContext{RouteFrequency}"/> containing the updated route frequency.
        /// </returns>
        public static CLContext<RouteFrequency> UpdateRouteFrequency(RouteFrequency _routeFrequency)
        {
            _routeFrequency.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            LogManager.Record("UPDATING FREQUENCY...");

            CLContext<RouteFrequency> oClContext =
                _routeFrequency.Patch<RouteFrequency, MainDBContext>("PatchRouteFrequency");

            LogManager.Record("FREQUENCY UPDATED");

            return oClContext;
        }

        #endregion

        #region RoutesHistories

        public static CLContext<IEnumerable<RouteHistory>> GetRouteHistories(int _routeId)
        {
            LogManager.Record("REQUESTING RECORDS...");
            return Services.Execute<RouteFilter, RouteHistory, MainDBContext>("GetRouteHistories", new RouteFilter()
            {
                Id = _routeId,
                CompanyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey])
            });
        }

        public async static Task<CLContext<IEnumerable<RouteHistory>>> PostRouteHistories(
            List<RouteHistory> _routeHistories)
        {
            List<RouteHistory> historiesResult = new List<RouteHistory>();
            string message = String.Empty;
            bool withError = false;

            LogManager.Record("READING HISTORY LIST...");

            foreach (RouteHistory routeHistory in _routeHistories)
            {
                CLContext<RouteHistory> oClContext = await PostRouteHistory(routeHistory);

                if (oClContext.Response?.Data != null)
                {
                    historiesResult.Add(oClContext.Response.Data);
                }
                else
                {
                    withError = true;
                    message += $" | {oClContext.Response?.Message}";
                }
            }

            LogManager.Record($"REQUEST LIST COMPLETED");

            return new CLContext<IEnumerable<RouteHistory>>()
            {
                Code = withError ? HttpStatusCode.BadRequest : HttpStatusCode.OK,
                value = historiesResult,
                Response = new Response<IEnumerable<RouteHistory>>()
                {
                    Message = withError ? message : "Historial de la ruta actualizado",
                    Data = historiesResult
                }
            };
        }

        public async static Task<CLContext<RouteHistory>> PostRouteHistory(RouteHistory _routeHistory)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _routeHistory.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            if (!String.IsNullOrEmpty(_routeHistory.Photos))
            {
                LogManager.Record($"UPLOADING PHOTOS TO AZURE");

                byte[] byteArray = Convert.FromBase64String(_routeHistory.Photos);

                using (MemoryStream stream = new MemoryStream(byteArray))
                {
                    string path = await UploadStreamToAzure(stream, $"MobilePhoto{_routeHistory.RouteId}", "jpeg","Routes/");
                    _routeHistory.Photos = path;
                }
            }

            CLContext<RouteHistory> oClContext =
                _routeHistory.Post<RouteHistory, MainDBContext, ICLExclude, ICLSingle>("PostRouteHistory", "Route",
                    "RouteLine");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Accesos directos

        public static CLContext<IEnumerable<Shorcuts>> GetShorcuts()
        {
            LogManager.Record("REQUESTING RECORD");

            CLContext<IEnumerable<Shorcuts>>
                oClContext = Services.Execute<Shorcuts, MainDBContext>("GetShorcuts").Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Mantenimiento de Series

        public static CLContext<SeriesByUserWithFESerie> PostSeries(SeriesByUserWithFESerie _serie)
        {
            LogManager.Record("REQUESTING POST SERIE BY USER");

            _serie.SeriesByUser.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<SeriesByUserWithFESerie> oClContextResponse = new CLContext<SeriesByUserWithFESerie>()
            {
                Response = new Response<SeriesByUserWithFESerie>()
                {
                    Data = new SeriesByUserWithFESerie()
                }
            };

            CLContext<SeriesByUser> clContext = Services.Execute<SeriesByUser, MainDBContext, ICLInclude, ICLSingle>(
                    "spCreateSerieByUser",
                    _serie.SeriesByUser,
                    new string[]
                    {
                        "UserAssingId", "CompanyId", "CreatedBy", "NoSerie", "DocumentType", "SerieType", "IsSerial",
                        "SerieDescription"
                    })
                .Post();

            LogManager.Record("REQUESTING COMPLETED");

            if (_serie.FESerie != null)
            {
                LogManager.Record("REQUESTING POST FE SERIE");
                _serie.FESerie.SeriesByUserId = clContext.Response.Data.Id;
                _serie.FESerie.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");
                CLContext<FESerie> clContextFESerie = Services.Execute<FESerie, MainDBContext, ICLInclude, ICLSingle>(
                        "PostFESerie",
                        _serie.FESerie,
                        new string[]
                        {
                            "SerieName", "BranchOffice", "CreatedBy", "Terminal", "NextNumber", "SeriesByUserId"
                        })
                    .Post();
                
                oClContextResponse.Response.Data.FESerie = clContextFESerie.Response.Data;
                
                LogManager.Record("REQUESTING COMPLETED");
            }
            
            oClContextResponse.Response.Data.SeriesByUser = clContext.Response.Data;

            return oClContextResponse;
        }

        public static CLContext<SeriesByUser> PatchSeries(SeriesByUser _serie)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            _serie.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<SeriesByUser> clContext = Services.Execute<SeriesByUser, MainDBContext, ICLInclude, ICLSingle>(
                    "spUpdateSerie",
                    _serie,
                    new string[]
                    {
                        "CompanyId", "DocumentType", "Id", "IsActive", "NoSerie", "UserAssingId", "UpdatedBy",
                        "SerieType"
                    })
                .Patch();

            LogManager.Record("REQUESTING COMPLETED");

            return clContext;
        }

        public static CLContext<Common.SingleValue<int>> DeleteSerie(int _idSerie)
        {
            LogManager.Record($"REQUESTING DELETE OBJECT");
            // Common.SingleValue<int>
            CLContext<Common.SingleValue<int>> clContext =
                Services.Execute<Common.SingleValue<int>, MainDBContext, int, ICLSingle>("DeleteSerieByUser", _idSerie)
                    .Patch();

            LogManager.Record("REQUESTED COMPLETED");

            return clContext;
        }

        public static CLContext<IEnumerable<SeriesByUser>> GetSeries(int _userId, int _companyId)
        {
            LogManager.Record("REQUESTING RECORDS");


            CLContext<IEnumerable<SeriesByUser>> oClContext =
                Services.Execute<SerieByUserFilter, SeriesByUser, MainDBContext>("GetSeriesByUser",
                    new SerieByUserFilter()
                    {
                        UserAssingId = _userId,
                        CompanyId = _companyId
                    }).Get();

            LogManager.Record("REQUESTING COMPLETED");

            return oClContext;
        }
        
        /// <summary>
        /// The method obtains information about the series assigned to a user to know if it is manual or automatic.
        /// </summary>
        /// <param name="_userAssingId"></param>
        /// <param name="_objectType"></param>
        /// <param name="_companyId"></param>
        /// <returns></returns>
        public static CLContext<SerialType> GetIsSerial(int _userAssingId, int _objectType, int _companyId)
        {
            LogManager.Record("REQUESTING RECORDS");


            CLContext<SerialType> oClContext =
                Services.Execute<SerialFilter, SerialType, MainDBContext, ICLMaster,ICLSingle>("GetIsSerial",
                    new SerialFilter()
                    {
                        UserAssingId = _userAssingId,
                        CompanyId = _companyId,
                        DocumentType = _objectType
                    }).Get();
            
            LogManager.Record("REQUESTING COMPLETED");
            
            return oClContext;
        }

        /// <summary>
        /// Asynchronously retrieves a list of SAP series based on the provided object code and company ID.
        /// </summary>
        /// <param name="_objectCode">The code of the object for which the SAP series are to be retrieved.</param>
        /// <param name="_companyId">The ID of the company for which the SAP series are to be retrieved.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{SeriesSAP}}"/> 
        /// containing the list of SAP series and the operation status.
        /// </returns>
        public static async Task<CLContext<List<SeriesSAP>>> GetSeriesSAP(string _objectCode, int _companyId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSeries", -1, _companyId);
                
                Dictionary<string, object> parameters = new Dictionary<string, object>
                {
                    { "@ObjectCode", _objectCode }
                };

                List<SeriesSAP> resultList = Common.ResolveSAPViewODBC<SeriesSAP>(contextODBC, parameters);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<SeriesSAP>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SeriesSAP>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetSeries", -1, _companyId).Get(new FilterSeriesByObjectCode
            {
                ObjectCode = _objectCode
            });
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<List<SeriesSAP>>();
            #endregion
        }

        /// <summary>
        /// Updates the next sequential number of an electronic invoicing series(FE Serie).
        /// Executes a PATCH against "UpdateSerieNextNumber" and logs the operation.
        /// </summary>
        /// <param name="_feSerie">
        /// Payload containing the FE series data to update. The operation uses:
        /// CompanyId, DocumentType, NextNumber, NoSerie, and UserAssingId.
        /// </param>
        public static CLContext<UpdateFESerie> PatchSerieNextNumber(UpdateFESerie _feSerie)
        {
            LogManager.Record($"REQUESTING PATCH FESERIE NEXT NUMBER... OBJECT: {JsonConvert.SerializeObject(_feSerie)}");

            CLContext<UpdateFESerie> clContext = Services.Execute<UpdateFESerie, MainDBContext, ICLInclude, ICLSingle>(
                    "UpdateSerieNextNumber",
                    _feSerie,
                    new string[]
                    {
                        "CompanyId", "DocumentType", "NextNumber", "NoSerie", "UserAssingId"
                    })
                .Patch();

            LogManager.Record("REQUESTING COMPLETED");

            return clContext;
        }


        #endregion

        #region Transactions Pinpad

        //Guarda la transaction de pinpad en la dblocal
        public static CLContext<PPTransaction> Sale(PPTransaction _ppTransaction)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<PPTransaction> ppTransaction =
                _ppTransaction.Post<PPTransaction, MainDBContext, ICLExclude, ICLSingle>("spCreateTransaction",
                    "Company", "IsActive");

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        //Metodo para anular tarjetas
        public static CLContext<PPVoidedTransaction> Cancel(PPVoidedTransaction _ppVoidedTransaction)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            if (_ppVoidedTransaction == null || String.IsNullOrEmpty(_ppVoidedTransaction.InvoiceNumber))
            {
                throw new Exception("Tarjeta anulada. No se pudo respaldar la transacción en base de datos.");
            }

            _ppVoidedTransaction.CompanyId = GetCompanyId();
            _ppVoidedTransaction.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<PPVoidedTransaction> ppTransaction =
                _ppVoidedTransaction.Post<PPVoidedTransaction, MainDBContext, ICLExclude, ICLSingle>(
                    "spCreateVoidedTransaction", "Company", "IsActive");

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        //Meotodo para obtener los datos del PPTransactions por el DocEntry
        public static CLContext<PPTransaction> GetPPTranByDocEntry(int _docEntry)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<PPTransaction> ppTransaction = Services
                .Execute<FilterPPTransactionDocEntry, PPTransaction, MainDBContext, ICLInclude, ICLSingle>(
                    "spGetPPByDocEntry", new FilterPPTransactionDocEntry
                    {
                        DocEntry = _docEntry
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        //Metodo obtener transacciones anuladas
        public static CLContext<IEnumerable<VoidedPresentation>> GetCanceledTransactions(FilterPPVoidTransaction _doc)
        {
            LogManager.Record("REQUESTING RECORDS");
            int companyId = GetCompanyId();

            CLContext<IEnumerable<VoidedPresentation>> ppTransaction = Services
                .Execute<FilterPPVoidTransaction, VoidedPresentation, MainDBContext>("spGetCanceledTransaction",
                    new FilterPPVoidTransaction()
                    {
                        CompanyId = companyId,
                        DateFrom = _doc.DateFrom,
                        DateTo = _doc.DateTo,
                        Email = _doc.Email,
                        Terminal = _doc.Terminal
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        public static async Task<CLContext<TotalTransaction>> GetTransactionsPinpadTotal(string _terminalId,
            decimal _rate)
        {
            CLContext<TotalTransaction> oClContext = new CLContext<TotalTransaction>();
            try
            {
                LogManager.Record($"REQUESTING RECORDS");

                CLContext<List<TypeCurrency>> oClContextCurrencies = await GetCurrencies(true);

                TypeCurrency localCurrency = oClContextCurrencies.Response.Data.FirstOrDefault(x => x.IsLocal);

                if (localCurrency == null)
                {
                    throw new Exception("There is no local currency.");
                }

                oClContext = Services
                    .Execute<TotalTransaction, FilterTransactionTotal, MainDBContext, ICLSingle>(
                        "spPinpadTransactionsTotal",
                        new FilterTransactionTotal()
                        {
                            LocalCurrency = localCurrency.Id,
                            TerminalId = _terminalId,
                            Rate = _rate
                        }).Get();

                return oClContext;
            }
            catch (SqlException ex)
            {
                if (ex.Number == 50010)
                {
                    return new CLContext<TotalTransaction>()
                    {
                        Code = oClContext.Code,
                        Response = new Response<TotalTransaction>()
                        {
                            Message = ex.Message,
                            Data = new TotalTransaction()
                            {
                                Total = -1
                            }
                        }
                    };
                }

                throw ex;
            }
        }

        public static CLContext<IEnumerable<VoidedPresentation>> GetPPTransactionByDocumentKey(string _documentKey)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<VoidedPresentation>> ppTransaction = Services
                .Execute<FilterPPTransactionDocumentKey, VoidedPresentation, MainDBContext>(
                    "spGetCanceledTransactionByDocumentKey", new FilterPPTransactionDocumentKey
                    {
                        DocumentKey = _documentKey,
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        public static CLContext<IEnumerable<VoidedPresentation>> GetPPTransactionDetails(string _documentKey)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<VoidedPresentation>> ppTransaction = Services
                .Execute<FilterPPTransactionDocumentKey, VoidedPresentation, MainDBContext>(
                    "spGetTransactionDetails", new FilterPPTransactionDocumentKey
                    {
                        DocumentKey = _documentKey,
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return ppTransaction;
        }

        #region Stored Transactions

        public static CLContext<IEnumerable<PPStoredTransaction>> GetPPStoredTransactions(string _user, int _companyId,
            string _terminalId,
            string _dateInit, string _dateEnd)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<PPStoredTransaction>> oClContext =
                Services.Execute<FilterPPStoredTransaction, PPStoredTransaction, MainDBContext>(
                    "GetPPStoredTransactions",
                    new FilterPPStoredTransaction()
                    {
                        SyncUser = _user,
                        CompanyId = _companyId,
                        TerminalId = _terminalId,
                        DateInit = _dateInit,
                        DateEnd = _dateEnd
                    }).Get();

            LogManager.Record("REQUESTING COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<PPStoredTransaction>> PostPPStoredTransactions(
            List<PPStoredTransaction> _ppStoredTransactions)
        {
            List<PPStoredTransaction> resultPpStoredTransactions = new List<PPStoredTransaction>();

            foreach (PPStoredTransaction ppStoredTransaction in _ppStoredTransactions)
            {
                LogManager.Record("REQUESTING POST OBJECT");

                ppStoredTransaction.CompanyId = GetCompanyId();
                ppStoredTransaction.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                ppStoredTransaction.IsActive = true;

                CLContext<PPStoredTransaction> resultPpStoredTransaction =
                    ppStoredTransaction.Post<PPStoredTransaction, MainDBContext, ICLExclude, ICLSingle>(
                        "CreateStoredTransaction", "Company");

                LogManager.Record("REQUEST COMPLETED");

                if (resultPpStoredTransaction.Response.Data is object)
                {
                    resultPpStoredTransactions.Add(resultPpStoredTransaction.Response.Data);
                }
            }

            return new CLContext<IEnumerable<PPStoredTransaction>>()
            {
                Code = HttpStatusCode.Created,
                value = resultPpStoredTransactions,
                Response = new Response<IEnumerable<PPStoredTransaction>>()
                {
                    Data = resultPpStoredTransactions
                }
            };
        }

        #endregion

        #endregion

        #region Pre Balances

        public static CLContext<IEnumerable<CommittedTransaction>> PostPreBalances(PPCashDeskClosing _ppCashDeskClosing)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();

            _ppCashDeskClosing.CompanyId = companyId;
            _ppCashDeskClosing.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<PPCashDeskClosing> ppCashDeskClosing =
                _ppCashDeskClosing.Post<PPCashDeskClosing, MainDBContext, ICLExclude, ICLSingle>(
                    "spCreateCashDeskClosing", "Company", "IsActive");

            CLContext<IEnumerable<CommittedTransaction>> oClContext = Services
                .Execute<FilterPPTransactions, CommittedTransaction, MainDBContext>("GetPPBalance",
                    new FilterPPTransactions
                    {
                        From = DateTime.Now.ToString("yyyy/MM/dd"),
                        To = DateTime.Now.ToString("yyyy/MM/dd"),
                        TransactionType = _ppCashDeskClosing.Type,
                        TerminalId = _ppCashDeskClosing.TerminalId,
                        CompanyId = companyId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Balances

        public static CLContext<IEnumerable<CommittedTransaction>> PostBalances(ACQTransaction _acqTransaction)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();

            _acqTransaction.OverACQ.TransactionType = Constants.TypeTransaction.BALANCE.GetType().Name;

            _acqTransaction.OverACQ.CompanyId = companyId;

            CLContext<PPBalance> ppbalance = _acqTransaction.OverACQ.Post<PPBalance, MainDBContext>("PostPPBalance");

            CLContext<IEnumerable<CommittedTransaction>> oClContext = Services
                .Execute<FilterPPTransactions, CommittedTransaction, MainDBContext>("GetPPBalance",
                    new FilterPPTransactions
                    {
                        From = _acqTransaction.BalanceRequest.From.ToString("yyyy/MM/dd"),
                        To = _acqTransaction.BalanceRequest.To.ToString("yyyy/MM/dd"),
                        TransactionType = _acqTransaction.BalanceRequest.DocumentType,
                        TerminalId = _acqTransaction.BalanceRequest.TerminalId,
                        CompanyId = companyId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<CommittedTransaction>> GetBalances(string _from, string _to,
            string _terminalId, string _documentType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();

            CLContext<IEnumerable<CommittedTransaction>> oClContext = Services
                .Execute<FilterPPTransactions, CommittedTransaction, MainDBContext>("GetPPBalance",
                    new FilterPPTransactions
                    {
                        From = _from,
                        To = _to,
                        TransactionType = _documentType,
                        TerminalId = _terminalId,
                        CompanyId = companyId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Terminals

        public static CLContext<Terminal> GetTerminalsById(int _id)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<Terminal> oClContext =
                Services.Execute<Terminal, MainDBContext, int, ICLSingle>("GetTerminalsById", _id).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Terminal>> GetTerminalsByComapany(int _companyId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Terminal>> oClContext =
                Services.Execute<Terminal, MainDBContext, int>("GetTerminalsByCompany", _companyId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<TerminalUserCompany>> GetTerminalsByUserCompany()
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();

            int userId = CL.COMMON.Core.GetClaimUserId();

            CLContext<IEnumerable<TerminalUserCompany>> oClContext =
                Services.Execute<FilterTermByUserIdAndCompanyId, TerminalUserCompany, MainDBContext>(
                    "GetTerminalForBalance", new FilterTermByUserIdAndCompanyId()
                    {
                        CompanyId = companyId,
                        UserId = userId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<TerminalUserCompany>> TerminalsByPermissionByUser()
        {
            LogManager.Record($"REQUESTING RECORDS");

            int companyId = GetCompanyId();

            int userId = CL.COMMON.Core.GetClaimUserId();

            CLContext<IEnumerable<TerminalUserCompany>> oClContext =
                Services.Execute<FilterTermByUserIdAndCompanyId, TerminalUserCompany, MainDBContext>(
                    "GetTerminalsByPermissionByUser", new FilterTermByUserIdAndCompanyId()
                    {
                        CompanyId = companyId,
                        UserId = userId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }


        public static CLContext<IEnumerable<TerminalsByUser>> GetTerminalsByUserId(int _userId, int _companyId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<TerminalsByUser>> oClContext =
                Services.Execute<FilterTermByUserIdAndCompanyId, TerminalsByUser, MainDBContext>(
                    "GetTerminalsByUserId", new FilterTermByUserIdAndCompanyId()
                    {
                        CompanyId = _companyId,
                        UserId = _userId
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Terminal>> GetTerminals()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Terminal>> oClContext =
                Services.Execute<Terminal, MainDBContext>("GetTerminals").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Terminal> PostTerminals(Terminal _terminal)
        {
            LogManager.Record($"REQUESTING RECORDS");

            _terminal.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Terminal> oClContext = _terminal.Post<Terminal, MainDBContext>("PostTerminals");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Terminal> PatchTerminals(Terminal _terminal)
        {
            LogManager.Record($"REQUESTING RECORDS");

            _terminal.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Terminal> oClContext = _terminal.Patch<Terminal, MainDBContext>("PatchTerminals");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<PPTerminalsId> PostTerminalsByUser(PPTerminalsByUser _terminalsByUser)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string ids = String.Empty;

            if (_terminalsByUser.TerminalsByUser != null && _terminalsByUser.TerminalsByUser.Count > 0)
            {
                ids = string.Join(";", _terminalsByUser.TerminalsByUser.Select(x => x.TerminalId).ToList());
            }

            PPTerminalsId oPpTerminalsId = new PPTerminalsId()
            {
                TerminalId = ids,
                UserId = _terminalsByUser.UserId.ToString(),
                CompanyId = _terminalsByUser.CompanyId.ToString(),
                TerminalDefaultCOL = _terminalsByUser.TerminalDefaultCOL,
                TerminalDefaultUSD = _terminalsByUser.TerminalDefaultUSD
            };

            CLContext<PPTerminalsId> oClContext =
                oPpTerminalsId.Patch<PPTerminalsId, MainDBContext>("PostTerminalByUsers");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Object SAP

        public static CLContext<IEnumerable<ObjectSap>> GetObject()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<ObjectSap>> oClContext =
                Services.Execute<ObjectSap, MainDBContext>("vGetObjectSAP").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Permission

        public static CLContext<IEnumerable<Permission>> GetFilteredPermissions(string _searchCriteria,
            bool _shouldBeActive)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Permission>> oClContext =
                Services.Execute<PermissionsFilter, Permission, MainDBContext>("GetPermissionsByFilter",
                    new PermissionsFilter()
                    {
                        SearchCriteria = _searchCriteria ?? string.Empty,
                        ShouldBeActive = _shouldBeActive
                    }).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Permission>> GetPermissions(bool _active)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Permission>> oClContext =
                Services.Execute<Permission, MainDBContext, bool>("GetPermissions", _active).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Permission> GetPermission(int _permissionId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<Permission> oClContext = Services
                .Execute<Permission, MainDBContext, int, ICLSingle>("GetPermission", _permissionId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Permission> PostPermission(Permission _permission)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _permission.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Permission> oClContext = _permission.Post<Permission, MainDBContext>("PostPermission");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Permission> PatchPermission(Permission _permission)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _permission.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Permission> oClContext = _permission.Patch<Permission, MainDBContext>("PatchPermission");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<PermissionByUser>> GetPermissionByUser()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<PermissionByUser>> oClContext = Services
                .Execute<FilterPermissionByUser, PermissionByUser, MainDBContext>("PermissionByUser",
                    new FilterPermissionByUser()
                    {
                        UserId = CL.COMMON.Core.GetClaimUserId(),
                        CompanyId = GetCompanyId()
                    }).Get();

            LogManager.Record("REQUESTING COMPLETED");

            return oClContext;
        }

        #endregion

        #region Menu

        public static CLContext<IEnumerable<Menu>> GetMenuOptions()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Menu>> response = Services.Execute<Menu, MainDBContext>("GetMenuOptions").Get();

            CLContext<IEnumerable<MenuOptionWeight>> menuOptWeightsRes =
                Services.Execute<MenuOptionWeight, MainDBContext>("GetMenuOptionsWeights").Get();

            List<MenuOptionWeight> oMenuOptWeightsRes = menuOptWeightsRes.Response.Data.ToList();

            List<string> menuOptionWeights = oMenuOptWeightsRes.FirstOrDefault()?.Weights.Split(',').ToList();

            List<Menu> oMenuOption = response.Response.Data.ToList();

            LogManager.Record($"REQUEST COMPLETED");

            LogManager.Record($"MAPPING RECORDS");

            List<Menu> parentMenuOptions = oMenuOption.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                if (_val.NextId.Equals(default))
                {
                    _acc.Add(_val);
                }

                return _acc;
            });

            List<Menu> childsMenuOptions = response.Response.Data.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                if (!_val.NextId.Equals(default))
                {
                    _acc.Add(_val);
                }

                return _acc;
            });

            parentMenuOptions.ForEach(_pO =>
            {
                List<Menu> pONodes = new List<Menu>();

                List<Menu> oMessyPoNodes =
                    childsMenuOptions.FindAll(_cM => _cM.Category.Equals(_pO.Category)).ToList();

                do
                {
                    oMessyPoNodes.ToList().ForEach(_mPon =>
                    {
                        if (_mPon.NextId.Equals(_mPon.Id))
                        {
                            pONodes.Add(_mPon);
                            oMessyPoNodes.Remove(_mPon);
                        }
                        else
                        {
                            Menu oFirstPon = pONodes.FirstOrDefault();

                            if (oFirstPon is object && oFirstPon.Id.Equals(_mPon.NextId))
                            {
                                pONodes = pONodes.Prepend(_mPon).ToList();
                                oMessyPoNodes.Remove(_mPon);
                            }
                        }
                    });
                } while (oMessyPoNodes.Any());

                _pO.Nodes = pONodes.ToList();
            });

            _ = menuOptionWeights ?? throw new Exception("CL Menu weight option is empty.");

            response.Response.Data = menuOptionWeights.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                Menu menuOption = parentMenuOptions.FirstOrDefault(_pO => _pO.Category.Equals(_val));

                if (menuOption is object)
                {
                    _acc.Add(menuOption);
                }

                return _acc;
            });

            LogManager.Record($"RECORDS MAPPED");

            return response;
        } 
        
        /// <summary>
        /// Retrieves a list of mobile menu options from the database and organizes them into a hierarchical structure.
        /// </summary>
        /// <param name="_language">The language code used to filter the menu options.</param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{Menu}}"/> containing the list of mobile menu options and the operation status.
        /// </returns>
        public static CLContext<IEnumerable<Menu>> GetMenuMobileOptions(string _language)
        {
             LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Menu>> response = Services.Execute< Menu,MainDBContext>("GetMenuMobileOptions").Get();

            CLContext<IEnumerable<MenuOptionWeight>> menuOptWeightsRes =
                Services.Execute<MenuOptionWeight, MainDBContext>("GetMenuOptionsWeights").Get();

            List<MenuOptionWeight> oMenuOptWeightsRes = menuOptWeightsRes.Response.Data.ToList();

            List<string> menuOptionWeights = oMenuOptWeightsRes.FirstOrDefault()?.Weights.Split(',').ToList();

            List<Menu> oMenuOption = response.Response.Data.ToList(); 
            oMenuOption = oMenuOption.FindAll(_m => _m.Language.Equals(_language)).ToList();

            LogManager.Record($"REQUEST COMPLETED");

            LogManager.Record($"MAPPING RECORDS");

            List<Menu> parentMenuOptions = oMenuOption.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                if (_val.NextId.Equals(default) && _val.Language.Equals(_language))
                {
                    _acc.Add(_val);
                }

                return _acc;
            });

            List<Menu> childsMenuOptions = response.Response.Data.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                if (!_val.NextId.Equals(default) &&_val.Language.Equals(_language))
                {
                    _acc.Add(_val);
                }

                return _acc;
            });

            parentMenuOptions.ForEach(_pO =>
            {
                List<Menu> pONodes = new List<Menu>();

                List<Menu> oMessyPoNodes =
                    childsMenuOptions.FindAll(_cM => _cM.Category.Equals(_pO.Category)).ToList();

                do
                {
                    oMessyPoNodes.ToList().ForEach(_mPon =>
                    {
                        if (_mPon.NextId.Equals(_mPon.Id))
                        {
                            pONodes.Add(_mPon);
                            oMessyPoNodes.Remove(_mPon);
                        }
                        else
                        {
                            Menu oFirstPon = pONodes.FirstOrDefault();

                            if (oFirstPon is object && oFirstPon.Id.Equals(_mPon.NextId))
                            {
                                pONodes = pONodes.Prepend(_mPon).ToList();
                                oMessyPoNodes.Remove(_mPon);
                            }
                        }
                    });
                } while (oMessyPoNodes.Any());

                _pO.Nodes = pONodes.ToList();
            });

            _ = menuOptionWeights ?? throw new Exception("CL Menu weight option is empty.");

            response.Response.Data = menuOptionWeights.Aggregate(new List<Menu>(), (_acc, _val) =>
            {
                Menu menuOption = parentMenuOptions.FirstOrDefault(_pO => _pO.Category.Equals(_val));

                if (menuOption is object)
                {
                    _acc.Add(menuOption);
                }

                return _acc;
            });

            LogManager.Record($"RECORDS MAPPED");

            return response;
        }

        #endregion

        #region Licenses
        
        /// <summary>
        /// This method is used to get licenses by user and company
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<UserLicense>> GetLicenseUser()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<UserLicense>> oClContext =
                Services.Execute<FilterLicenseUser, UserLicense, MainDBContext>("GetLicenseUser",
                    new FilterLicenseUser
                    {
                        CompanyId = GetCompanyId(),
                        UserId = CL.COMMON.Core.GetClaimUserId()
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves all licenses associated with a given company.
        /// </summary>
        /// <param name="_companyId">The identifier of the company whose licenses are being requested.</param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{CLMLTEMA.MODELS.License}}"/> containing the list of licenses for the specified company.
        /// </returns>
        public static CLContext<IEnumerable<CLMLTEMA.MODELS.License>> GetLicensesByCompany(int _companyId)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<CLMLTEMA.MODELS.License>> oClContext =
                Services.Execute<CLMLTEMA.MODELS.License, MainDBContext, int>("GetLicencesByCompany", _companyId).Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves all licenses in the system.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{CLMLTEMA.MODELS.License}}"/> containing the list of licenses.
        /// </returns>
        public static CLContext<IEnumerable<CLMLTEMA.MODELS.License>> GetLicences()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<CLMLTEMA.MODELS.License>> oClContext =
                Services.Execute<CLMLTEMA.MODELS.License, MainDBContext>("GetLicenses").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a single license by its identifier.
        /// </summary>
        /// <param name="_licenseId">The unique identifier of the license to fetch.</param>
        /// <returns>
        /// A <see cref="CLContext{CLMLTEMA.MODELS.License}"/> containing the requested license.
        /// </returns>
        public static CLContext<CLMLTEMA.MODELS.License> GetLicense(int _licenseId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<CLMLTEMA.MODELS.License> oClContext =
                Services.Execute<CLMLTEMA.MODELS.License, MainDBContext, int, ICLSingle>("GetLicense", _licenseId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Creates a new license record after ensuring the user is signed in.
        /// </summary>
        /// <param name="_license">The license data to create.</param>
        /// <returns>
        /// A task returning a <see cref="CLContext{CLMLTEMA.MODELS.License}"/> with the created license.
        /// </returns>
        public static async Task<CLContext<CLMLTEMA.MODELS.License>> PostLicense(CLMLTEMA.MODELS.License _license)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            await SignIn(_license);

            _license.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<CLMLTEMA.MODELS.License> oClContext =
                _license.Post<CLMLTEMA.MODELS.License, MainDBContext, ICLExclude, ICLSingle>("PostLicense", "Company");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Updates an existing license record after ensuring the user is signed in.
        /// </summary>
        /// <param name="_license">The license data to update.</param>
        /// <returns>
        /// A task returning a <see cref="CLContext{CLMLTEMA.MODELS.License}"/> with the updated license.
        /// </returns>
        public static async Task<CLContext<CLMLTEMA.MODELS.License>> PatchLicense(CLMLTEMA.MODELS.License _license)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            await SignIn(_license);

            _license.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<CLMLTEMA.MODELS.License> oClContext =
                _license.Patch<CLMLTEMA.MODELS.License, MainDBContext, ICLExclude, ICLSingle>("PatchLicense", "Company");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Roles

        public static CLContext<IEnumerable<Role>> GetRoles(bool _active)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Role>> oClContext =
                Services.Execute<Role, MainDBContext, bool>("GetRoles", _active).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Role> GetRole(int _roleId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<Role> oClContext =
                Services.Execute<Role, MainDBContext, int, ICLSingle>("GetRole", _roleId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Role> PostRole(Role _role)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _role.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Role> oClContext = _role.Post<Role, MainDBContext, ICLExclude, ICLSingle>("PostRole");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Role> PatchRole(Role _role)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _role.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Role> oClContext = _role.Patch<Role, MainDBContext>("PatchRole");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Permission>> GetPermissionsByRole(int _roleId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Permission>> oClContext = Services
                .Execute<Permission, MainDBContext, int>("GetPermissionsByRole", _roleId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Permission>> PatchPermissionsByRole(int _roleId,
            IEnumerable<Permission> _permissions)
        {
            LogManager.Record("BINDING ENTITIES");
            LogManager.Enter();
            LogManager.Record($"REQUESTING DELETE OBJECT");

            // CLContext<IEnumerable<Permission>> oClContext = Services
            //     .Execute<Permission, MainDBContext, int>("DeletePermissionsByRole", _roleId).Patch();

            LogManager.Record("REQUESTED COMPLETED");
            LogManager.Enter();

            if (_permissions is null)
            {
                return new CLContext<IEnumerable<Permission>>()
                {
                    Code = System.Net.HttpStatusCode.NoContent,
                };
            }

            string currentUserEmail = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _permissions.ToList().ForEach(_x =>
            {
                LogManager.Record($"REQUESING POST OBJECT {_x.Id}");

                _ = Services.Execute<PermsByRole, MainDBContext, ICLInclude, ICLSingle>(
                        "PostRolesPermission",
                        new PermsByRole()
                        {
                            PermissionId = _x.Id,
                            RoleId = _roleId,
                            IsActive = _x.IsActive,
                            CreatedBy = currentUserEmail
                        },
                        new string[]
                        {
                            "CreatedBy", "IsActive", "PermissionId", "RoleId"
                        })
                    .Post();

                LogManager.Record($"REQUEST COMPLETED");
                LogManager.Enter();
            });

            LogManager.Record("ENTITY BINDING ENDED");

            return new CLContext<IEnumerable<Permission>>()
            {
                Response = new Response<IEnumerable<Permission>>()
                {
                },
                Code = HttpStatusCode.OK
            };
        }

        #endregion

        #region Users

        public static User GetUserByCredentials(string _userEmail, string _userPassword)
        {
            LogManager.Record($"REQUESTING RECORD");

            User credentials = new User
            {
                Password = _userPassword,
                Email = _userEmail
            };

            User user = Services
                .Execute<User, MainDBContext, ICLInclude, ICLSingle>(
                    "SpGetUserByCredentials", credentials, new string[] { "Email", "Password" }).Get().Response.Data;

            LogManager.Record($"REQUETE COMPLETED");

            return user;
        }

        public static CLContext<IEnumerable<User>> GetUsers(bool _active)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<User>> oClContext =
                Services.Execute<User, MainDBContext, bool>("GetUsers", _active).Get();

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }


        public static CLContext<User> GetUser(int _id)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<User> oClContext =
                Services.Execute<User, MainDBContext, int, ICLSingle>("GetUser", _id).Get();

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }


        public static CLContext<User> PostUser(User _user)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _user.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<User> oClContext =
                _user.Post<User, MainDBContext, ICLExclude, ICLSingle>("PostUser", "TokenRecovery",
                    "TokenRecoveryEndDate");

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }

        public static CLContext<User> PatchUser(User _user)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _user.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<User> oClContext =
                _user.Patch<User, MainDBContext, ICLExclude, ICLSingle>("PatchUser", "TokenRecovery",
                    "TokenRecoveryEndDate");

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Role>> GetRolesByUser(int _userId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Role>> oClContext =
                Services.Execute<Role, MainDBContext, int>("GetRolesByUser", _userId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Role>> PatchRolesByUser(int _userId, int _companyId,
            IEnumerable<Role> _permissions)
        {
            LogManager.Record("BINDING ENTITIES");
            LogManager.Enter();
            LogManager.Record($"REQUESTING DELETE OBJECT");

            CLContext<IEnumerable<Role>> oClContext = Services.Execute<CartesianEntity<int, int>, Role, MainDBContext>(
                "DeleteRolesByUser", new CartesianEntity<int, int>()
                {
                    AKey = _companyId,
                    BKey = _userId,
                }).Patch();

            LogManager.Record("REQUESTED COMPLETED");
            LogManager.Enter();

            if (_permissions is null)
            {
                return oClContext;
            }

            string currentUserEmail = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _permissions.ToList().ForEach(_x =>
            {
                LogManager.Record($"REQUESING POST OBJECT {_x.Id}");

                // I discard this result because i dont need it
                oClContext = Services.Execute<CartesianEntity<int, int, int, string>, Role, MainDBContext>(
                    "PostUserRoleByCompany", new CartesianEntity<int, int, int, string>()
                    {
                        AKey = _companyId,
                        BKey = _userId,
                        CKey = _x.Id,
                        DKey = currentUserEmail
                    }).Patch();

                LogManager.Record($"REQUEST COMPLETED");
                LogManager.Enter();
            });

            LogManager.Record("ENTITY BINDING ENDED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Role>> GetUserRolesByCompany(int _userId, int _companyId,
            IEnumerable<Role> _permissions)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Role>> oClContext = Services
                .Execute<CartesianEntity<int, int>, Role, MainDBContext>("GetUserRolesbyCompany",
                    new CartesianEntity<int, int>()
                    {
                        AKey = _companyId,
                        BKey = _userId,
                    }).Get();

            LogManager.Record("REQUEST ENDED");

            return oClContext;
        }

        public static CLContext<UserAssign> PostUserAssign(UserAssign _userAssign)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _userAssign.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<UserAssign> oClContext =
                _userAssign.Post<UserAssign, MainDBContext, ICLExclude, ICLSingle>("PostUserAssign", "Company", "User",
                    "License");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<UserAssign> PatchUserAssign(UserAssign _userAssign)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _userAssign.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<UserAssign> oClContext =
                _userAssign.Patch<UserAssign, MainDBContext, ICLExclude, ICLSingle>("PatchUserAssign", "Company",
                    "User", "License");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<UserAssign>> GetUserAssigns(int _userId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<UserAssign>> oClContext =
                Services.Execute<UserAssign, MainDBContext, int>("GetUserAssigns", _userId).Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<UserAssign> GetUserAssign(int _assignationId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<UserAssign> oClContext =
                Services.Execute<UserAssign, MainDBContext, int, ICLSingle>("GetUserAssign", _assignationId).Get();

            return oClContext;
        }

        public static CLContext<UserAssign> GetUserAssign(int _userId, int _companyId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<UserAssign> oClContext =
                Services.Execute<UserAssign, FilterUserAssing, MainDBContext, ICLSingle>(
                    "GetUserAssingByUserAndCompany",
                    new FilterUserAssing()
                    {
                        UserId = _userId,
                        CompanyId = _companyId
                    }).Get();

            return oClContext;
        }

        public static CLContext<IEnumerable<UserAssign>> GetAssigns()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<UserAssign>> oClContext =
                Services.Execute<UserAssign, MainDBContext>("GetAssigns").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<User>> GetUsersByCompany()
        {
            LogManager.Record("REQUESTING RECORD");

            int companyId = GetCompanyId();

            CLContext<IEnumerable<User>> oClContext =
                Services.Execute<User, MainDBContext, int>("spGetUserByCompany", companyId).Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        private static CLContext<IEnumerable<UserForRouteTemplate>> GetUsersForRouteTemplate()
        {
            LogManager.Record("REQUESTING USERS FOR ROUTE TEMPLATES...");

            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            return Services.Execute<UserForRouteTemplate, MainDBContext, int>("GetUsersToRouteTemplate", companyId,
                "@CompanyId");
        }

        private static CLContext<User> GetUserByAssignment(int _userAssignmentId)
        {
            LogManager.Record($"REQUESTING USER BY ASSIGNMENT... | ASSIGNMENT: {_userAssignmentId}");

            CLContext<User> oClContextUser =
                Services.Execute<User, MainDBContext, int, ICLSingle>("GetUserByAssignment", _userAssignmentId,
                    "@UserAssignmentId");

            LogManager.Record($"USER BY ASSIGNMENT REQUESTED");

            return oClContextUser;
        }

        private static CLContext<UserCalendarCredentials> GetUserCalendarCredentials(int _userId)
        {
            LogManager.Record($"REQUESTING CALENDAR CREDENTIALS... | USER: {_userId}");

            CLContext<UserCalendarCredentials> oClContext =
                Services.Execute<UserCalendarCredentials, MainDBContext, int, ICLSingle>("GetUserCalendarCredentials",
                    _userId,
                    "@UserId");

            LogManager.Record("CALENDAR CREDENTIALS REQUESTED");

            return oClContext;
        }

        #endregion

        #region UserCompanies

        public static CLContext<IEnumerable<Company>> GetUserCompanies(int _userId)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<Company>> response =
                Services.Execute<Company, MainDBContext, int>("SpGetUserCompanies", _userId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return response;
        }

        public static CLContext<IEnumerable<Company>> GetUserActiveCompanies(int _userId)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<Company>> response =
                Services.Execute<Company, MainDBContext, int>("SpGetUserCompanies", _userId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return response;
        }

        #endregion

        #region Companies

        public static CLContext<IEnumerable<Company>> GetCompanies(bool _active)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<IEnumerable<Company>> oClContext =
                Services.Execute<Company, MainDBContext, bool>("GetCompanies", _active).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Company> GetCompanyById(int _companyId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<Company> oClContext = Services
                .Execute<Company, MainDBContext, int, ICLSingle>("SpGetCompanyById", _companyId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Company> PostCompany(Company _company)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _company.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Company> oClContext =
                _company.Post<Company, MainDBContext, ICLExclude, ICLSingle>("PostCompany", "Connection");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<Company> PatchCompany(Company _company)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _company.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<Company> oClContext =
                _company.Patch<Company, MainDBContext, ICLExclude, ICLSingle>("PatchCompany", "Connection");
            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }

        #endregion

        #region Settings

        public static CLContext<MODELS.Setting> PostSetting(MODELS.Setting _setting)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _setting.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<MODELS.Setting> oClContext =
                _setting.Post<MODELS.Setting, MainDBContext, ICLExclude, ICLSingle>("PostSettings");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<MODELS.Setting> PostSetting(List<MODELS.Setting> _settings)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            CLContext<MODELS.Setting> oClContext = null;

            string createdBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            foreach (MODELS.Setting setting in _settings)
            {
                setting.CreatedBy = createdBy;

                oClContext = setting.Post<MODELS.Setting, MainDBContext, ICLExclude, ICLSingle>("PostSettings");
            }

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<MODELS.Setting> PatchSetting(string _code, MODELS.Setting _setting)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _setting.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _setting.Code = _code;
            
            MapSettingSpecifiedProperties(ref _setting);
            
            CLContext<MODELS.Setting> oClContext = Services
                .Execute<MODELS.Setting, MainDBContext, ICLInclude, ICLSingle>(
                    "PatchSettings", _setting,
                    new string[] { "Code", "Json", "UpdatedBy", "IsActive" }).Patch();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Devuelve el valor de la configuracion que es de la compania actual
        /// </summary>
        /// <param name="_companyId"></param>
        /// <param name="_setting"></param>
        /// <returns></returns>
        private static JObject GetSettingValueByCompany(string _propToCheck, int _companyId, MODELS.Setting _setting)
        {
            JToken settingValue = JToken.Parse(_setting.Json);

            if (settingValue is JArray)
            {
                if (settingValue.Any())
                {
                    if (String.IsNullOrEmpty(_propToCheck))
                    {
                        return null;
                    }
                    
                    return JObject.FromObject(settingValue.FirstOrDefault(s => (int)s[_propToCheck] == _companyId));
                }

                return null;
            }

            return null;
        }

        /// <summary>
        /// Check if specified properties has empty value to get the stored value
        /// </summary>
        /// <param name="_setting">The setting to check</param>
        private static void MapSettingSpecifiedProperties(ref MODELS.Setting _setting)
        {
            string settingCode = _setting.Code;
            
            // Search the setting in the specified properties
            KeyValuePair<string, string>
                settingToMap = Constants.SettingsSpecifyPropertyToClean.FirstOrDefault(s => s.Key == settingCode);
                
            // Checks if the setting has properties that should be mapped
            if (!EqualityComparer<KeyValuePair<string, string>>.Default.Equals(settingToMap, default))
            {
                CLContext<MODELS.Setting> oClContextStoredSetting = GetSettingByCode(settingToMap.Key, false);
                
                JToken storedSettingJson = JToken.Parse(oClContextStoredSetting.Response.Data.Json);
                
                JToken settingJson = JToken.Parse(_setting.Json);

                DeepSettingJsonProperties(storedSettingJson, ref settingJson, settingToMap.Value.Split(':').ToList());

                _setting.Json = JsonConvert.SerializeObject(settingJson);
            }
        }
        
        public static CLContext<MODELS.Setting> PatchSetting(List<MODELS.Setting> _settings)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            CLContext<MODELS.Setting> oClContext = null;

            string UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            foreach (MODELS.Setting setting in _settings)
            {
                MODELS.Setting settingAux = setting;
                
                MapSettingSpecifiedProperties(ref settingAux);

                setting.UpdatedBy = UpdatedBy;

                oClContext = Services.Execute<MODELS.Setting, MainDBContext, ICLInclude, ICLSingle>("PatchSettings",
                    settingAux,
                    new string[] { "Code", "Json", "UpdatedBy", "IsActive" }).Patch();
            }

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<MODELS.Setting>> GetSetting()
        {
            LogManager.Record($"OBTENIENDO CONFIGURACION");

            CLContext<IEnumerable<MODELS.Setting>> oClContext =
                Services.Execute<MODELS.Setting, MainDBContext>("vGetSettings").Get();

            LogManager.Record($"RESPUESTA DE OBTENCION DE CONFIGURACION COMPLETED");

            if (oClContext.Response.Data is object)
            {
                List <MODELS.Setting> settings = oClContext.Response.Data.ToList();
                
                for (int i = 0; i < settings.Count(); i++)
                {
                    MODELS.Setting auxSetting = settings[i];
                    CleanSettingSpecifiedProperties(ref auxSetting);
                    settings[i] = auxSetting;
                }

                oClContext.Response.Data = settings;
            }
            
            return oClContext;
        }

        
        /// <summary>
        /// Recorre las propiedades del objeto Json de las configuraciones y obtiene el valor de la propiedad especificada en el path
        /// </summary>
        /// <param name="_oStoredSetting">Objeto Json que se usara para modificar las propiedades del otro objeto</param>
        /// <param name="_settingJsonCurrentProp">Objeto que se va a modificar si cumple con las codiciones</param>
        /// <param name="_propPath">Lista de propiedades del objeto</param>
        /// <returns></returns>
        private static bool DeepSettingJsonProperties(JToken _oStoredSetting, ref JToken _settingJsonCurrentProp,
            List<string> _propPath)
        {
            try
            {
                // If there are no properties I finalize the execution
                if (!_propPath.Any()) return true;

                // Get the next prop to validate
                string prop = _propPath[0];
                
                JToken oJToken;
                
                JToken oJTokenStoredSetting = null;
                
                if (_settingJsonCurrentProp.Type == JTokenType.Array)
                {
                    oJToken = _settingJsonCurrentProp;
                    oJTokenStoredSetting = _oStoredSetting;
                }
                else
                {
                    oJToken = _settingJsonCurrentProp[prop];
                    
                    if (_oStoredSetting.Type == JTokenType.Array)
                    {
                        foreach (JToken ss in _oStoredSetting)
                        {
                            if (_settingJsonCurrentProp.Value<int>("CompanyId") == ss.Value<int>("CompanyId"))
                            {
                                oJTokenStoredSetting = ss;
                                break;
                            }
                        }
                    }
                    else
                    {
                        oJTokenStoredSetting = _oStoredSetting[prop];             
                    }
                    
                    if (oJTokenStoredSetting == null) return true;
                    
                    _propPath.RemoveAt(0);
                }

                if (oJToken.Type == JTokenType.Array)
                {
                    if (oJToken.Any())
                    {
                        for (int i = 0; i < oJToken.Count(); i++)
                        {
                            JToken oAuxRecord = oJToken[i];
                            // The _oStoredSetting is an array
                            DeepSettingJsonProperties(oJTokenStoredSetting, ref oAuxRecord, new List<string>(_propPath));
                            oJToken[i] = oAuxRecord;
                        }
                    }

                }
                else if (oJToken.Type == JTokenType.Object)
                {
                    return DeepSettingJsonProperties(oJTokenStoredSetting, ref oJToken, new List<string>(_propPath));
                }
                else
                {
                    if (oJTokenStoredSetting == null) return true;

                    if (String.IsNullOrEmpty(_settingJsonCurrentProp.Value<string>(prop)))
                    {
                        _settingJsonCurrentProp[prop] = oJTokenStoredSetting[prop];
                    }
                }

                return true;
            }
            catch
            {
                return false;
            }
        }
        
        /// <summary>
        /// Recorre las propiedades del objeto Json de las configuraciones y le establece en vacio la propiedad indicada
        /// </summary>
        /// <param name="_settingJsonCurrentProp">Objeto Json de las configuraciones</param>
        /// <param name="_propPath">Lista de propiedades del objeto</param>
        /// <returns></returns>
        private static bool DeepCleaningOfProperties(ref JToken _settingJsonCurrentProp,
            List<string> _propPath)
        {
            try
            {
                // If there are no properties I finalize the execution
                if (!_propPath.Any()) return true;

                // Get the next prop to validate
                string prop = _propPath[0];
                
                JToken oJToken;
                    
                if (_settingJsonCurrentProp.Type == JTokenType.Array)
                {
                    oJToken = _settingJsonCurrentProp;
                }
                else
                {
                    _propPath.RemoveAt(0);
                    oJToken = _settingJsonCurrentProp[prop];
                }

                if (oJToken != null)
                {
                    if (oJToken.Type == JTokenType.Array)
                    {
                        if (oJToken.Any())
                        {
                            for (int i = 0; i < oJToken.Count(); i++)
                            {
                                JToken oAuxRecord = oJToken[i];
                                DeepCleaningOfProperties(ref oAuxRecord, new List<string>(_propPath));
                                oJToken[i] = oAuxRecord;
                            }
                        }

                    }
                    else if (oJToken.Type == JTokenType.Object)
                    {
                        return DeepCleaningOfProperties(ref oJToken, new List<string>(_propPath));
                    }
                    else
                    {
                        _settingJsonCurrentProp[prop] = string.Empty;
                    }
                }

                return true;
            }
            catch
            {
                return false;
            }
        }
        private static void CleanSettingSpecifiedProperties(ref MODELS.Setting _setting)
        {
            string settingCode = _setting.Code; 
            KeyValuePair<string, string>
                settingToMap = Constants.SettingsSpecifyPropertyToClean.FirstOrDefault(s => s.Key == settingCode);
                    
            if (!EqualityComparer<KeyValuePair<string, string>>.Default.Equals(settingToMap, default))
            {
                JToken settingJson = JToken.Parse(_setting.Json);

                DeepCleaningOfProperties(ref settingJson, settingToMap.Value.Split(':').ToList());
                
                _setting.Json = JsonConvert.SerializeObject(settingJson);
            }
        }

        /// <summary>
        /// Obtiene el objeto setting completo
        /// </summary>
        /// <param name="_code">Codigo de la configuración</param>
        /// <returns></returns>
        public static CLContext<MODELS.Setting> GetSettingByCode(string _code, bool _requestedFromUI)
        {
            LogManager.Record($"OBTENIENDO CONFIGURACION | CODIGO: {_code}");

            CLContext<IEnumerable<MODELS.Setting>> response =
                Services.Execute<MODELS.Setting, MainDBContext, string>("SpGetSettingByCode", _code).Get();

            LogManager.Record(
                $"RESPUESTA DE OBTENCION DE CONFIGURACION | REPUESTA: {JsonConvert.SerializeObject(response)}");

            MODELS.Setting setting = response.Response.Data.FirstOrDefault();

            if (setting == null)
            {
                response.Response.Message =
                    $"The requested setting '{_code}' does not exist | Detail: {response.Response.Message}";
            }

            // If the request if from UI, so, we need clean the settings specified properties
            if (_requestedFromUI)
            {
                CleanSettingSpecifiedProperties(ref setting);
            }

            return new CLContext<MODELS.Setting>
            {
                Code = response.Code,
                Response = new Response<MODELS.Setting>
                {
                    Data = setting,
                    Message = response.Response.Message
                }
            };
        }

        /// <summary>
        /// Obtiene el valor del objeto setting
        /// </summary>
        /// <param name="_code">Codigo de la configuración</param>
        /// <returns></returns>
        public static CLContext<T> GetSettingByCode<T>(string _code)
        {
            LogManager.Record($"OBTENIENDO VALOR DE CONFIGURACION | CODIGO: {_code}");

            CLContext<IEnumerable<MODELS.Setting>> response =
                Services.Execute<MODELS.Setting, MainDBContext, string>("SpGetSettingByCode", _code).Get();

            LogManager.Record(
                $"RESPUESTA DE OBTENCION DE VALOR DE CONFIGURACION | REPUESTA: {JsonConvert.SerializeObject(response)}");

            MODELS.Setting setting = response.Response.Data.FirstOrDefault();

            T settingValue = default;

            if (setting == null)
            {
                response.Response.Message =
                    $"The requested setting '{_code}' does not exist | Detail: {response.Response.Message}";
            }
            else
            {
                if (typeof(T).IsClass)
                {
                    settingValue = JsonConvert.DeserializeObject<T>(setting.Json,
                        new JsonSerializerSettings() { NullValueHandling = NullValueHandling.Ignore });
                }
                else
                {
                    settingValue = (T)Convert.ChangeType(setting.Json, typeof(T));
                }
            }

            return new CLContext<T>
            {
                Code = response.Code,
                Response = new Response<T>
                {
                    Data = settingValue,
                    Message = response.Response.Message
                }
            };
        }

        #endregion

        #region DB Resources

        public static CLContext<IEnumerable<DBResource>> GetDBResources()
        {
            CLContext<IEnumerable<DBResource>> cLContext =
                Services.Execute<DBResource, MainDBContext>("GetDbResources").Get();

            return cLContext;
        }

        public static CLContext<DBResource> GetDBResource(int id)
        {
            CLContext<DBResource> cLContext =
                Services.Execute<DBResource, MainDBContext, int, ICLSingle>("GetDbResource", id).Get();

            return cLContext;
        }

        public static CLContext<DBResource> GetDBResourceByCompany(int _resourceId, int _companyId)
        {
            CLContext<DBResource> cLContext =
                Services.Execute<DBResource, CartesianEntity<int, int>, MainDBContext, ICLSingle>(
                        "GetDbResourceByCompany",
                        new CartesianEntity<int, int> { AKey = _resourceId, BKey = _companyId })
                    .Get();

            return cLContext;
        }

        public static CLContext<IEnumerable<DBResource>> GetDBResourceByCompany(int _companyId)
        {
            CLContext<IEnumerable<DBResource>> cLContext =
                Services.Execute<DBResource, MainDBContext, int>("GetDbResourcesByCompany", _companyId, "@CompanyId")
                    .Get();

            return cLContext;
        }

        public static CLContext<DBResourceWithCompany> PostDbResource(DBResourceWithCompany _dBResource)
        {
            LogManager.Record("OBTENIENDO USUARIO ACTUAL");

            _dBResource.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            LogManager.Record("ENVIANDO A CREAR RECURSO");

            CLContext<DBResourceWithCompany> cLContext =
                _dBResource.Post<DBResourceWithCompany, MainDBContext, ICLExclude, ICLSingle>("PostDbResource");

            LogManager.Record($"RECURSO CREADO | RESPUESTA: {JsonConvert.SerializeObject(cLContext)}");

            return cLContext;
        }

        public static CLContext<DBResourceWithCompany> PatchDbResource(DBResourceWithCompany _dBResource)
        {
            _dBResource.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<DBResourceWithCompany> cLContext =
                _dBResource.Patch<DBResourceWithCompany, MainDBContext, ICLExclude, ICLSingle>(
                    "PatchDbResourceByCompany");

            return cLContext;
        }
        
        public static CLContext<DBResourceWithCompany> PatchDbResourceById(DBResourceWithCompany _dBResource)
        {
            _dBResource.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<DBResourceWithCompany> cLContext =
                _dBResource.Patch<DBResourceWithCompany, MainDBContext, ICLExclude, ICLSingle>(
                    "PatchDbResourceById");

            return cLContext;
        }
        
        public static CLContext<DBResourceWithCompany> PostDbResourceInDbResources(DBResourceWithCompany _dBResource)
        {
            LogManager.Record("OBTENIENDO USUARIO ACTUAL");

            _dBResource.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            LogManager.Record("ENVIANDO A CREAR RECURSO");

            CLContext<DBResourceWithCompany> cLContext =
                _dBResource.Post<DBResourceWithCompany, MainDBContext, ICLExclude, ICLSingle>("PostDbResources");

            LogManager.Record($"RECURSO CREADO | RESPUESTA: {JsonConvert.SerializeObject(cLContext)}");

            return cLContext;
        }
        
        public static CLContext<IEnumerable<DBResourceType>> GetDBResourceTypes()
        {
            CLContext<IEnumerable<DBResourceType>> cLContext =
                Services.Execute<DBResourceType, MainDBContext>("GetDbResourceTypes");

            return cLContext;
        }

        #endregion

        #region Connections

        public static CLContext<IEnumerable<Connection>> GetConnections()
        {
            LogManager.Record("REQUESTING CONNECTIONS");

            return Services.Execute<Connection, MainDBContext>("GetConnections").Get();
        }

        public static CLContext<Connection> GetConnection(int _id)
        {
            LogManager.Record($"REQUESTING CONNECTION | ID: {_id}");

            return Services.Execute<Connection, MainDBContext, int, ICLSingle>("GetConnection", _id).Get();
        }

        public static CLContext<Connection> CreateConnection(Connection _connection)
        {
            LogManager.Record("REQUESTING POST CONNECTION");

            _connection.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            return _connection.Post<Connection, MainDBContext>("PostConnection");
        }

        public static CLContext<Connection> UpdateConnection(Connection _connection)
        {
            LogManager.Record("REQUESTING POST CONNECTION");

            _connection.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            return _connection.Patch<Connection, MainDBContext>("PatchConnection");
        }

        #endregion

        #region Structures

        public static CLContext<IEnumerable<Structures>> GetStructureByType(string _structType)
        {
            LogManager.Record("REQUESTING ENUM TYPES");

            return Services.Execute<FilterStructures, Structures, MainDBContext>("GetStructureByType",
                new FilterStructures() { StructType = _structType }).Get();
        }

        #endregion

        #region PrintFormats

        /// <summary>
        /// This method is used to get cash closing ZPL
        /// </summary>
        /// <param name="_id">parameter id cash closing</param>
        /// <returns></returns>
        public static CLContext<FormatDocument> CashClosingToPrint(int _id)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<FormatDocument> oClContext = Services.Execute<FilterPrintCashClosing, FormatDocument, MainDBContext, ICLMaster, ICLSingle>("GetCashClosingZPL",new FilterPrintCashClosing()
            {
                Id = _id,
                CompanyId = GetCompanyId(),
                UserId = CL.COMMON.Core.GetClaimUserId()
            }).Get();
            
            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// This method is used to print payment received in mobile
        /// </summary>
        /// <param name="_docEntry">Internal number</param>
        /// <returns></returns>
        /// <exception cref="CLException">Generated exception when not found data</exception>
        public static async Task<CLContext<FormatDocument>> PaymentReceivedToPrint(int _docEntry, int _companyId)
        {
            LogManager.Record("REQUESTING RECORD");

            int userId = CL.COMMON.Core.GetClaimUserId();

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PaymentReceivedDocument>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetPrintZPL");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<PaymentReceivedDocument> resultList = Common.ResolveSAPViewODBC<PaymentReceivedDocument>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DocEntry", $"{_docEntry}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<PaymentReceivedDocument>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PaymentReceivedDocument>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetPrintZPL").Get(new FilterBaseDocument()
                {
                    DocEntry = _docEntry,
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<PaymentReceivedDocument>>();
                #endregion
            }


            if (oClContext.Response?.Data == null)
            {
                throw new CLException("CL - No se obtuvieron los datos del pago", HttpStatusCode.InternalServerError);
            }

            PaymentReceivedDocument header = oClContext.Response?.Data?.FirstOrDefault();

            List<PrintPaymentInvoice> list = new List<PrintPaymentInvoice>();
            
            foreach (PaymentReceivedDocument oInvoiceDocument in oClContext.Response?.Data)
            {
                list.Add(new PrintPaymentInvoice()
                {
                    DocNum = oInvoiceDocument.DocNumInv,
                    DocTotal = oInvoiceDocument.DocTotalInv
                });
            }

            string invoices = JsonConvert.SerializeObject(list);
            

            CLContext<MobileCompanyInformation> oClCompanyInformation = await GetCompanyInformation();

            MobileCompanyInformation oCompanyInformation = oClCompanyInformation?.Response?.Data;

            LogManager.Record("REQUESTING COMPANY INFORMATION COMPLETE");
            CLContext<FormatDocument> oContext = Services
                .Execute<PaymentReceivedPrint, FormatDocument, MainDBContext, ICLMaster, ICLSingle>("GetPrint",
                    new PaymentReceivedPrint()
                    {
                        CardCode = header.CardCode,
                        CardName = header.CardName,
                        CashSum = header.CashSum,
                        TransferSum = header.TransferSum,
                        CompanyDirection = oCompanyInformation.Direction,
                        CompanyIdentification = oCompanyInformation.Identification,
                        CompanyName = oCompanyInformation.CompanyName,
                        CompanyPhone = oCompanyInformation.Phone,
                        CreditSum = header.CreditSum,
                        DocTotal = header.DocTotal,
                        DocTotalInv = header.DocTotalInv,
                        DocDate = header.DocDate,
                        DocNumInv = header.DocNumInv,
                        DocNumPay = header.DocNumPay,
                        DocCurrency = header.DocCurrency,
                        DocCurrencyInv = header.DocCurrencyInv,
                        Phone1 = header.Phone1,
                        E_Mail = header.E_Mail,
                        UserId = userId,
                        CompanyId = _companyId,
                        PaymentInvoices = invoices
                    }).Get();
            
            LogManager.Record("REQUEST COMPLETED");
            
            return oContext;
        }
        
        /// <summary>
        /// This method is used to print invoices
        /// </summary>
        /// <param name="_docEntry"></param>
        /// <param name="_PreliminarEntry"></param>
        /// <param name="_documentType"></param>
        /// <param name="_payTotal"></param>
        /// <param name="_clave"></param>
        /// <returns></returns>
        /// <exception cref="CLException">Generated exception when not found data</exception>
        public static async Task<CLContext<FormatDocument>> DocumentToPrint(int _docEntry, int _PreliminarEntry, int _documentType, decimal _payTotal, string _clave)
        {
            LogManager.Record("REQUESTING RECORD");

            string code = string.Empty;

            if (_PreliminarEntry > 0)
            {
                _documentType = (int)Constants.ViewType.Draft;
                _docEntry = _PreliminarEntry;
            }

            switch (_documentType)
            {
                case (int)Constants.ViewType.SaleOffer:
                    code = "GetQuotationToPrint";
                    break;
                case (int)Constants.ViewType.SaleOrder:
                    code = "GetOrderToPrint";
                    break;
                case (int)Constants.ViewType.CashInvoice:
                case (int)Constants.ViewType.CreditInvoice:
                case (int)Constants.ViewType.ReserveInvoice:
                case (int)Constants.ViewType.CashReserveInvoice:
                    code = "GetArInvoiceToPrint";
                    break;
                case (int)Constants.ViewType.Delivery:
                    code = "GetDeliveryToPrint";
                    break;
                case (int)Constants.ViewType.CreditNote:
                    code = "GetCreditNoteToPrint";
                    break;
                case (int)Constants.ViewType.TransferRequest:
                    code = "GetTransferRequestToPrint";
                    break;
                case (int)Constants.ViewType.StockTransfer:
                    code = "GetStockTransferToPrint";
                    break;
                case (int)Constants.ViewType.Draft:
                    code = "GetPreToPrint";
                    break;
                case (int)Constants.ViewType.CashDownInvoice:
                case (int)Constants.ViewType.CreditDownInvoice:
                    code = "GetArDownPaymentToPrint";
                    break;
            }

            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<DocumentToPrint>> oClContextDocumentToPrint = new CLContext<List<DocumentToPrint>>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextDocumentToPrintODBC = GetUserCtxODBC($"ODBC_{code}");

                List<DocumentToPrint> resultDocumentToPrintList = Common.ResolveSAPViewODBC<DocumentToPrint>(contextDocumentToPrintODBC,
                new Dictionary<string, object>()
                {
                        { "@DocEntry", $"{_docEntry}" }
                });

                LogManager.Record($"RESOURCE ODBC: {contextDocumentToPrintODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");

                oClContextDocumentToPrint = new CLContext<List<DocumentToPrint>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<DocumentToPrint>>()
                    {
                        Data = resultDocumentToPrintList
                    },
                    value = resultDocumentToPrintList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObject = GetUserCtx($"SL_{code}").Get<FilterBaseDocEntry>(
                    new FilterBaseDocEntry()
                    {
                        DocEntry = _docEntry
                    });

                oClContextDocumentToPrint = await oSlRequestObject.SendAsync<List<DocumentToPrint>>();

                #endregion
            }

            if (oClContextDocumentToPrint.Response.Data == null || oClContextDocumentToPrint.Response.Data.Count <= 0)
            {
                throw new CLException("CL - No se obtuvieron los datos del documento", HttpStatusCode.InternalServerError);
            }
            
            CLContext<MobileCompanyInformation> oClCompanyInformation = await GetCompanyInformation();

            MobileCompanyInformation oCompanyInformation = oClCompanyInformation?.Response?.Data;
            int companyId = GetCompanyId();
            int userId = CL.COMMON.Core.GetClaimUserId();

            DocumentToPrint header = oClContextDocumentToPrint.Response.Data.FirstOrDefault();

            List<DocumentLinesToPrint> list = new List<DocumentLinesToPrint>();
            
            foreach (DocumentToPrint oDocument in oClContextDocumentToPrint.Response.Data)
            {
                list.Add(new DocumentLinesToPrint()
                {
                    UnitPrice = oDocument.UnitPrice,
                    Quantity = oDocument.Quantity,
                    TaxRate = oDocument.TaxRate,
                    Currency = oDocument.Currency,
                    DiscountPercent = oDocument.DiscountPercent,
                    ItemName = oDocument.ItemName,
                    LineTotal = oDocument.LineTotal
                });
            }

            string lines = JsonConvert.SerializeObject(list);

            CLContext<FormatDocument> oContext = Services
                .Execute<DocumentToPrintZPL, FormatDocument, MainDBContext, ICLMaster, ICLSingle>("GetPrintDocZPL",
                    new DocumentToPrintZPL()
                    {
                        CardCode = header.CardCode,
                        CardName = header.CardName,
                        Clave = _clave ?? header.ClaveFE,
                        CompanyDirection = oCompanyInformation?.Direction,
                        CompanyId = companyId,
                        CompanyIdentification = oCompanyInformation?.Identification,
                        CompanyName = oCompanyInformation?.CompanyName,
                        CompanyPhone =  oCompanyInformation?.Phone,
                        Discount = Convert.ToDecimal(oClContextDocumentToPrint.Response.Data.Sum(_element => _element.Discount)),
                        DocCurrency = header.DocCurrency,
                        DocDate = header.DocDate,
                        DocNum = header.DocNum,
                        DocTotal = header.DocTotal,
                        DocumentLines = lines,
                        DocumentType = _documentType,
                        EmailAddress = header.EmailAddress,
                        FederalTaxID = header.FederalTaxID,
                        NumFE = header.NumFE,
                        PayTotal = _payTotal,
                        Phone = header.Phone,
                        SubTotal = Convert.ToDecimal(oClContextDocumentToPrint.Response.Data.Sum(_element => _element.LineTotal)),
                        SalesPerson = header.SalesPerson,
                        Tax = header.Tax,
                        UserId = userId
                    }).Get();
            
            LogManager.Record("REQUEST COMPLETED");
            
            return oContext;
        }
        
        public static CLContext<PrintFormat> GetPrintFormatsByCompany(int _companyId)
        {
            CLContext<List<PrintFormat>> oClContextPrintFormat =
                GetSettingByCode<List<PrintFormat>>("PrintFormat");

            if (oClContextPrintFormat.Response.Data is object && oClContextPrintFormat.Response.Data.Count > 0)
            {
                PrintFormat companyPrintFormats =
                    oClContextPrintFormat.Response.Data.FirstOrDefault(_pf => _pf.CompanyId == _companyId);

                if (companyPrintFormats == null)
                {
                    throw new Exception($"Company Id {_companyId} with reports not configured");
                }

                return new CLContext<PrintFormat>
                {
                    Response = new Response<PrintFormat>
                    {
                        Data = companyPrintFormats,
                    },
                    Code = HttpStatusCode.OK
                };
            }
            else
            {
                return new CLContext<PrintFormat>
                {
                    Response = new Response<PrintFormat>
                    {
                        Message = oClContextPrintFormat.Response.Message
                    },
                    Code = HttpStatusCode.NoContent
                };
            }
        }

        /// <summary>
        /// Updates or creates print formats for a specific company, saving files locally and uploading them to Azure.
        /// </summary>
        /// <param name="_companyId">The ID of the company.</param>
        /// <param name="_printFormatsFiles">A list of key-value pairs containing the print format name and associated file.</param>
        /// <returns>A CLContext containing the updated print format details.</returns>
        public async static Task<CLContext<PrintFormat>> UpdateCompanyPrintFormats(int _companyId,
            List<KeyValuePair<string, HttpPostedFile>> _printFormatsFiles, bool active, string remoteServer, string path)
        {
            CLContext<List<PrintFormat>> oClContext = GetSettingByCode<List<PrintFormat>>(SettingCode.PrintFormat);

            MODELS.Setting printFormatsSetting = new MODELS.Setting();

            bool createSetting = false;

            List<PrintFormat> companiesPrintFormats = oClContext.Response.Data;

            if (companiesPrintFormats == null)
            {
                printFormatsSetting = new MODELS.Setting()
                {
                    View = "N/A",
                    Code = SettingCode.PrintFormat,
                    IsActive = true
                };

                companiesPrintFormats = new List<PrintFormat>();

                createSetting = true;
            }

            PrintFormat companyPrintFormat = companiesPrintFormats.FirstOrDefault(_pf => _pf.CompanyId == _companyId);

            bool isNew = false;

            if (companyPrintFormat == null)
            {
                companyPrintFormat = new PrintFormat()
                {
                    CompanyId = _companyId
                };

                isNew = true;
            }

            companyPrintFormat.Active = active;
            companyPrintFormat.RemoteServer = remoteServer;
            companyPrintFormat.Path = path;

            PropertyInfo[] printFormatsProps = companyPrintFormat.GetType().GetProperties();

            foreach (KeyValuePair<string, HttpPostedFile> printFormat in _printFormatsFiles)
            {
                LogManager.Record($"SAVING PRINT FORMAT {printFormat.Key} WITH NAME FILE {printFormat.Value.FileName}");

                string fileNameWithExtension = printFormat.Value.FileName;

                SavePrintFormatsFiles(printFormat.Value, _companyId, fileNameWithExtension);

                string[] azureFileName = printFormat.Value.FileName.Split('.');

                await UploadStreamToAzure(printFormat.Value.InputStream, $"{printFormat.Key}_{azureFileName[0]}", azureFileName[1], "Reports/");
                
                foreach (PropertyInfo prop in printFormatsProps)
                {
                    if (prop.Name.Equals(printFormat.Key))
                    {
                        prop.SetValue(companyPrintFormat, fileNameWithExtension);
                        break;
                    }
                }
            }

            LogManager.Record($"SAVING PRINT FORMATS SETTING");

            if (isNew)
            {
                companiesPrintFormats.Add(companyPrintFormat);
            }


            printFormatsSetting.Json = JsonConvert.SerializeObject(companiesPrintFormats);

            if (createSetting)
            {
                PostSetting(printFormatsSetting);
            }
            else
            {
                PatchSetting(SettingCode.PrintFormat, printFormatsSetting);
            }

            LogManager.Record($"PRINT FORMATS SETTING SAVED");

            return new CLContext<PrintFormat>
            {
                Response = new Response<PrintFormat>
                {
                    Data = companyPrintFormat
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Saves or updates a print format file for a specific company.  
        /// Creates the company directory if it does not exist, and overwrites any existing file with the same name.
        /// </summary>
        /// <param name="_file">The uploaded HTTP file to save. If null, the method does nothing.</param>
        /// <param name="_companyId">The identifier of the company under which the file will be stored.</param>
        /// <param name="_fileNameWithExtension">The filename (including extension) under which the file will be saved.</param>
        public static void SavePrintFormatsFiles(HttpPostedFile _file, int _companyId, string _fileNameWithExtension)
        {
            string path = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

            path += $"/Company-{_companyId}/";

            if (_file != null)
            {
                if (Directory.Exists(path))
                {
                    if (System.IO.File.Exists(path + _fileNameWithExtension))
                    {
                        System.IO.File.Delete(path + _fileNameWithExtension);
                        _file.SaveAs(path + _fileNameWithExtension);
                    }
                    else
                    {
                        _file.SaveAs(path + _fileNameWithExtension);
                    }
                }
                else
                {
                    Directory.CreateDirectory(path);
                    _file.SaveAs(path + _fileNameWithExtension);
                }

                LogManager.Record($"PRINT FORMAT {_fileNameWithExtension} SAVED");
            }
        }

        public static CLContext<DownloadBase64> DownloadPrintFormat(int _companyId, string _printFormatName)
        {
            PrintFormat printFormat = GetPrintFormatsByCompany(_companyId).Response.Data;

            // Valido que existan configurados los formatos de impresion
            if (printFormat == null)
            {
                return new CLContext<DownloadBase64>()
                {
                    Code = HttpStatusCode.NoContent,
                    Response = new Response<DownloadBase64>()
                };
            }

            PropertyInfo printFormatProp = printFormat.GetType().GetProperty(_printFormatName);

            // Valido que la propiedad exista
            if (printFormatProp == null)
            {
                return new CLContext<DownloadBase64>()
                {
                    Code = HttpStatusCode.NoContent,
                    Response = new Response<DownloadBase64>()
                };
            }

            string printFormatFileName = printFormatProp.GetValue(printFormat).ToString();

            string filesPath = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

            string printFormatFilePath = $"{filesPath}/Company-{_companyId}/{printFormatFileName}";

            string printFormatBase64 = CL.COMMON.Core.FileToBase64(printFormatFilePath);

            string[] fileNameAndExtension = printFormatFileName.Split('.');

            return new CLContext<DownloadBase64>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<DownloadBase64>()
                {
                    Data = new DownloadBase64()
                    {
                        Base64 = printFormatBase64,
                        BlobType = "application/octet-stream",
                        FileName = fileNameAndExtension[0],
                        FileExtension = fileNameAndExtension[1]
                    }
                }
            };
        }

        /// <summary>
        /// Retrieves the ZPL print format configuration used for offline printing.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{PrintFormatZPLOffline}"/> object containing the serialized ZPL format as a string.
        /// </returns>
        public static CLContext<PrintFormatZPLOfflineSerialice> PrintFormatZPLOffline()
        {
            LogManager.Record("REQUESTING PRINT FORMAT ZPL OFFLINE RECORDS");


            CLContext<IEnumerable<PrintFormatZPLOffline>> oClContext =
            Services.Execute<PrintFormatZPLOffline, MainDBContext>("GetPrintFormatZPLOffline").Get();


            PrintFormatZPLOfflineSerialice printFormatZPLOffline = new PrintFormatZPLOfflineSerialice()
            {
                FormatZPLOffline = JsonConvert.SerializeObject(oClContext.Response?.Data.FirstOrDefault())
            };

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<PrintFormatZPLOfflineSerialice>
            {
                Code = oClContext.Code,
                Response = new Response<PrintFormatZPLOfflineSerialice>
                {
                    Data = printFormatZPLOffline,
                    Message = oClContext.Response.Message
                }
            };
        }

        #endregion

        #region Reports

        public static CLContext<string> PrintVoucher(PrintPinpad _transaction)
        {
            try
            {
                string pdfBase64 = string.Empty;

                int companyId =
                    (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

                CLContext<PrintFormat> oClContextPrintFormat = GetPrintFormatsByCompany(companyId);

                if (oClContextPrintFormat.Response.Data is object)
                {
                    PropertyInfo printFormatProp =
                        oClContextPrintFormat.Response.Data.GetType().GetProperty("VoucherCancellation");

                    // Valido que la propiedad exista
                    if (printFormatProp == null)
                    {
                        throw new Exception($"Property VoucherCancellation does not exist");
                    }

                    string printFormatFileName =
                        printFormatProp.GetValue(oClContextPrintFormat.Response.Data)?.ToString();

                    if (string.IsNullOrEmpty(printFormatFileName))
                    {
                        throw new Exception($"Report VoucherCancellation not configured");
                    }

                    string filesPath = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

                    string printFormatFilePath = $"{filesPath}/Company-{companyId}/{printFormatFileName}";

                    Credential crystalCredentials = GetSettingByCode<Credential>("CrystalCredentials").Response.Data;

                    if (crystalCredentials == null)
                    {
                        throw new Exception("CL- You must set the 'CrystalCredentials' setting in the database");
                    }

                    LogManager.Record("Parameters DocumentKey: " + _transaction.DocumentKey + "RawData: " +
                                      _transaction.RawData);
                    _ = _transaction.RawData ?? throw new Exception("CL - You can not print an empty void transaction");

                    using (ReportDocument reportDocument = new ReportDocument())
                    {
                        reportDocument.Load(printFormatFilePath);

                        LogManager.Record($"Loaded Report From path: {printFormatFilePath}");

                        LogManager.Record(
                            $"Logging in Crystal | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        reportDocument.SetDatabaseLogon(crystalCredentials.User, crystalCredentials.Password);

                        LogManager.Record(
                            $"Login in Crystal successful | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        LogManager.Record("Mapping parameters");
                        LogManager.Record("@DocEntry " + _transaction.DocumentKey);
                        LogManager.Record("RawData " + _transaction.RawData);

                        reportDocument.SetParameterValue("@DocEntry", _transaction.DocumentKey);
                        reportDocument.SetParameterValue("RawData", _transaction.RawData);

                        LogManager.Record("Parameters mapped");

                        LogManager.Record($"Converting Stream to bytes...");

                        byte[] contentBytes = CL.COMMON.Core.StreamToBytes(reportDocument.ExportToStream(ExportFormatType.PortableDocFormat));

                        LogManager.Record("Stream converted to bytes");

                        LogManager.Record("Converting bytes to base 64");

                        pdfBase64 = Convert.ToBase64String(contentBytes);

                        LogManager.Record("Bytes converted to base 64");

                        LogManager.Record("Closing connection");

                        reportDocument.Close();
                        reportDocument.Dispose();
                    }

                    return new CLContext<string>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<string>()
                        {
                            Data = pdfBase64
                        }
                    };
                }
                else
                {
                    throw new Exception($"{oClContextPrintFormat.Response.Message}");
                }
            }
            catch
            {
                throw;
            }
        }

        public static CLContext<string> PrintReportPinpad(PrintPinpad _transaction, string printFormatName)
        {
            try
            {
                string pdfBase64 = string.Empty;

                int companyId =
                    (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

                CLContext<PrintFormat> oClContextPrintFormat = GetPrintFormatsByCompany(companyId);

                if (oClContextPrintFormat.Response.Data is object)
                {
                    PropertyInfo printFormatProp =
                        oClContextPrintFormat.Response.Data.GetType().GetProperty(printFormatName);

                    // Valido que la propiedad exista
                    if (printFormatProp == null)
                    {
                        throw new Exception($"Property {printFormatName} does not exist");
                    }

                    string printFormatFileName =
                        printFormatProp.GetValue(oClContextPrintFormat.Response.Data)?.ToString();

                    if (string.IsNullOrEmpty(printFormatFileName))
                    {
                        throw new Exception($"Report {printFormatName} not configured");
                    }

                    string filesPath = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

                    string printFormatFilePath = $"{filesPath}/Company-{companyId}/{printFormatFileName}";

                    Credential crystalCredentials = GetSettingByCode<Credential>("CrystalCredentials").Response.Data;

                    if (crystalCredentials == null)
                    {
                        throw new Exception("CL- You must set the 'CrystalCredentials' setting in the database");
                    }

                    LogManager.Record("Parameters DocumentKey: " + _transaction.DocumentKey + "RawData: " +
                                      _transaction.RawData);
                    _ = _transaction.RawData ?? throw new Exception("CL - You can not print an empty void transaction");

                    using (ReportDocument reportDocument = new ReportDocument())
                    {
                        reportDocument.Load(printFormatFilePath);

                        LogManager.Record($"Loaded Report From path: {printFormatFilePath}");

                        LogManager.Record(
                            $"Logging in Crystal | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        reportDocument.SetDatabaseLogon(crystalCredentials.User, crystalCredentials.Password);

                        LogManager.Record(
                            $"Login in Crystal successful | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        LogManager.Record("Mapping parameters");
                        LogManager.Record("@DocEntry " + _transaction.DocumentKey);
                        LogManager.Record("RawData " + _transaction.RawData);


                        reportDocument.SetParameterValue("@DocEntry", _transaction.DocumentKey);
                        reportDocument.SetParameterValue("RawData", _transaction.RawData);
                        reportDocument.SetParameterValue("IsACopy", _transaction.IsACopy);

                        LogManager.Record("Parameters mapped");

                        LogManager.Record($"Converting Stream to bytes...");

                        byte[] contentBytes = CL.COMMON.Core.StreamToBytes(reportDocument.ExportToStream(ExportFormatType.PortableDocFormat));

                        LogManager.Record("Stream converted to bytes");

                        LogManager.Record("Converting bytes to base 64");

                        pdfBase64 = Convert.ToBase64String(contentBytes);

                        LogManager.Record("Bytes converted to base 64");

                        LogManager.Record("Closing connection");

                        reportDocument.Close();
                        reportDocument.Dispose();
                    }

                    return new CLContext<string>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<string>()
                        {
                            Data = pdfBase64
                        }
                    };
                }
                else
                {
                    throw new Exception($"{oClContextPrintFormat.Response.Message}");
                }
            }
            catch
            {
                throw;
            }
        }

        public async static Task<CLContext<DownloadBase64>> PrintReport(int _docEntry, string _printFormatName)
        {
            string pdfBase64 = string.Empty;

            int companyId = (int)HttpContext.Current.Items[HttpContextItems.CompanyKey];

            CLContext<PrintFormat> oClContextPrintFormat = GetPrintFormatsByCompany(companyId);

            if (oClContextPrintFormat.Response.Data is object)
            {
                PropertyInfo printFormatProp = oClContextPrintFormat.Response.Data.GetType().GetProperty(_printFormatName);

                if (printFormatProp == null)
                {
                    throw new Exception($"Property {_printFormatName} does not exist");
                }

                string printFormatFileName = printFormatProp.GetValue(oClContextPrintFormat.Response.Data)?.ToString();

                if (string.IsNullOrEmpty(printFormatFileName))
                {
                    throw new Exception($"Report {_printFormatName} not configured");
                }

                string printFormatFilePath = String.Empty;

                if (oClContextPrintFormat.Response.Data.Active)
                {
                    printFormatFilePath = $"{oClContextPrintFormat.Response.Data.Path}/{printFormatFileName}";
                }
                else
                {
                    string filesPath = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

                    printFormatFilePath = $"{filesPath}/Company-{companyId}/{printFormatFileName}";
                }

                Credential crystalCredentials = GetSettingByCode<Credential>("CrystalCredentials").Response.Data;

                if (crystalCredentials == null)
                {
                    throw new Exception("You must set the 'CrystalCredentials' setting in the database");
                }

                if (oClContextPrintFormat.Response.Data.Active)
                {
                    using (var client = new HttpClient())
                    {
                        var request = new ReportParameters
                        {
                            Username = crystalCredentials.User,
                            Password = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(crystalCredentials.Password)),
                            UncPath = printFormatFilePath,
                            Parameters = new List<ReportParameter>()
                            {
                                new ReportParameter()
                                {
                                    Name = "@DocEntry",
                                    Value = _docEntry
                                }
                            }
                        };

                        LogManager.Record($"Report Path: {oClContextPrintFormat.Response.Data.RemoteServer}/api/ReportServices");

                        HttpResponseMessage response = await client.PostAsJsonAsync($"{oClContextPrintFormat.Response.Data.RemoteServer}/api/ReportServices", request);

                        if (response.IsSuccessStatusCode)
                        {
                            pdfBase64 = await response.Content.ReadAsStringAsync();
                            LogManager.Record("Server reponse ok");
                        }
                        else
                        {
                            LogManager.Record($"Error: {response.StatusCode}");
                            string error = await response.Content.ReadAsStringAsync();
                            LogManager.Record(error);
                            throw new Exception(error);
                        }
                    }
                }
                else
                {
                    using (ReportDocument reportDocument = new ReportDocument())
                    {
                        reportDocument.Load(printFormatFilePath);

                        LogManager.Record($"Loaded Report From path: {printFormatFilePath} ReportType: {_printFormatName}");

                        LogManager.Record(
                            $"Logging in Crystal | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        reportDocument.SetDatabaseLogon(crystalCredentials.User, crystalCredentials.Password);

                        LogManager.Record(
                            $"Login in Crystal successful | Credentials: {JsonConvert.SerializeObject(crystalCredentials)}");

                        LogManager.Record($"Applying parameter @DocEntry with '{_docEntry}'");

                        reportDocument.SetParameterValue("@DocEntry", _docEntry);

                        LogManager.Record("Applied Login and Parameter DocEntry: " + _docEntry);

                        LogManager.Record($"Converting Stream to bytes...");

                        byte[] contentBytes = CL.COMMON.Core.StreamToBytes(reportDocument.ExportToStream(ExportFormatType.PortableDocFormat));

                        LogManager.Record("Stream converted to bytes");

                        LogManager.Record("Converting bytes to base 64");

                        pdfBase64 = Convert.ToBase64String(contentBytes);

                        LogManager.Record("Bytes converted to base 64");

                        LogManager.Record("Closing connection");

                        reportDocument.Close();
                        reportDocument.Dispose();
                    }
                }

                return new CLContext<DownloadBase64>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<DownloadBase64>()
                    {
                        Data = new DownloadBase64()
                        {
                            BlobType = "application/pdf",
                            Base64 = pdfBase64
                        }
                    }
                };
            }
            else
            {
                throw new Exception($"{oClContextPrintFormat.Response.Message}");
            }
        }

        /// <summary>
        /// Generates a balance report in PDF format using Crystal Reports, based on the provided paydesk balance data.
        /// </summary>
        /// <param name="opaydeskBalance">An object containing balance values such as cash, cards, transfers, and metadata.</param>
        /// <param name="reporthPath">The file path to the Crystal Reports (.rpt) template.</param>
        /// <returns>A <c>MemoryStream</c> containing the generated PDF report.</returns>
        /// <remarks>
        /// The method loads a Crystal Reports template, injects report parameters from the <c>PaydeskBalance</c> object,
        /// and exports the report as a PDF stream. Crystal Reports credentials are loaded from application settings.
        /// </remarks>
        /// <exception cref="ReportLoadException">Thrown if the report file cannot be loaded (implicitly via <c>Load()</c>).</exception>
        /// <exception cref="Exception">May throw if any report parameter is invalid or the export fails.</exception>
        private static MemoryStream BalanceReport(PaydeskBalance opaydeskBalance, string reporthPath)
        {
            Credential crystalCredentials = GetSettingByCode<Credential>("CrystalCredentials").Response.Data;

            MemoryStream oReportStream = new MemoryStream();

            using (ReportDocument reportDocument = new ReportDocument())
            {
                reportDocument.Load(reporthPath);
                reportDocument.SetDatabaseLogon(crystalCredentials.User, crystalCredentials.Password);
                reportDocument.SetParameterValue("Fecha", DateTime.Now.Date);
                reportDocument.SetParameterValue("Cash", opaydeskBalance.CashAmount);
                reportDocument.SetParameterValue("Cards", opaydeskBalance.CardAmount);
                reportDocument.SetParameterValue("Transfer", opaydeskBalance.TransferAmount);
                reportDocument.SetParameterValue("INTERNAL_K", opaydeskBalance.UserSignature);
                reportDocument.SetParameterValue("Email", opaydeskBalance.Email);
                reportDocument.SetParameterValue("License", opaydeskBalance.License);
                reportDocument.SetParameterValue("CardsPinpadAmount", opaydeskBalance.CardAmountPinpad);
                reportDocument.SetParameterValue("ExchangeRate", opaydeskBalance.ExchangeRate);
                reportDocument.SetParameterValue("Currency", opaydeskBalance.Currency);
                reportDocument.SetParameterValue("SlpCode", opaydeskBalance.SlpCode);
                
                // Comentado por Isaac Herrera
                //reportAsByteArray = StreamToBytes(reportDocument.ExportToStream(ExportFormatType.PortableDocFormat));

                reportDocument.ExportToStream(ExportFormatType.PortableDocFormat).CopyTo(oReportStream);

                reportDocument.Close();
                reportDocument.Dispose();
            }
            // Comentado por Isaac Herrera
            //Convert.ToBase64String(reportAsByteArray);
            //return Convert.ToBase64String(reportAsByteArray);

            return oReportStream;
        }

        #endregion

        #region Items

        public static CLContext<IEnumerable<ValidateInventoryTable>> GetValidateInventoryTables()
        {
            LogManager.Record("REQUESTING VALIDATE INVENTORY TABLES");

            CLContext<IEnumerable<ValidateInventoryTable>> response =
                Services.Execute<ValidateInventoryTable, MainDBContext>("GetValidateInventoryTables");

            LogManager.Record("VALIDATE INVENTORY TABLES REQUESTED");

            return response;
        }

        public static CLContext<IEnumerable<ValidateInventoryTable>> GetMarginTables()
        {
            LogManager.Record("REQUESTING VALIDATE INVENTORY TABLES");

            CLContext<IEnumerable<ValidateInventoryTable>> oClContext =
                Services.Execute<ValidateInventoryTable, MainDBContext>("GetMarginTables");

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<FieldsBusinessPartner>> GetFieldsBusinessPartner()
        {
            LogManager.Record("REQUESTING FIELDS CONFIGURED BUSINESS PARTNET");

            CLContext<IEnumerable<FieldsBusinessPartner>> oClContext =
                Services.Execute<FieldsBusinessPartner, MainDBContext>("GetFieldsBusinessPartner");

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }
        
        public static CLContext<IEnumerable<ValidateAttachmnetsTable>> GetValidateAttachmentsTables()
        {
            LogManager.Record("REQUESTING VALIDATE INVENTORY TABLES");

            CLContext<IEnumerable<ValidateAttachmnetsTable>> response =
                Services.Execute<ValidateAttachmnetsTable, MainDBContext>("GetValidateAttachmentsTables");

            LogManager.Record("VALIDATE INVENTORY TABLES REQUESTED");

            return response;
        }

        /// <summary>
        /// Retrieves the validation results for automatic printing tables.
        /// </summary>
        /// <returns>
        /// A CLContext containing an enumerable list of ValidateAutomaticPrintingTable objects.
        /// </returns>
        public static CLContext<IEnumerable<ValidateAutomaticPrintingTable>> GetValidateAutomaticPrintingTables()
        {
            LogManager.Record("REQUESTING VALIDATE AUTOMATIC PRINTING TABLES");
            
            CLContext<IEnumerable<ValidateAutomaticPrintingTable>> oClContext =
                Services.Execute<ValidateAutomaticPrintingTable, MainDBContext>("GetValidateAutomaticPrintingTables");

            LogManager.Record("VALIDATE AUTOMATIC PRINTING TABLES REQUESTED");

            return oClContext;
        }

        #endregion

        #region Udfs

        public static CLContext<IEnumerable<CL.STRUCTURES.CLASSES.Udf.UdfCategory>> GetUdfCategories()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<CL.STRUCTURES.CLASSES.Udf.UdfCategory>> oClContext =
                CL.UDFS.Udf.GetUdfCategories<MainDBContext>("GetUdfCategories").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }


        /// <summary>
        /// This method obtains tipes of ufds or uds configured
        /// </summary>
        /// <param name="_companyId"></param>
        /// <param name="_category"></param>
        /// <param name="_isUdfLine"></param>
        /// <param name="_configured"></param>
        /// <param name="_group"></param>
        /// <returns></returns>
        /// <exception cref="Exception"></exception>
        public static async Task<CLContext<List<CL.STRUCTURES.CLASSES.Udf.UdfContext>>> GetUdfs(int _companyId,
            string _category, bool _isUdfLine, bool _configured, string _group)
        {
            int CompanyId = _companyId == -1 ? GetCompanyId() : _companyId;

            List<UdfContext> UDFs = new List<UdfContext>();

            string category = _category;

            #region Get category

            if (_isUdfLine)
            {
                CLContext<Common.SingleValue<string>> oClContextUdfLineCategory =
                    Services.Execute<Common.SingleValue<string>, MainDBContext, string, ICLSingle>(
                        "GetUdfLineCategoryByParentCategory", _category, "@ParentCategory");

                if (string.IsNullOrEmpty(oClContextUdfLineCategory.Response.Data
                        .Value)) // (!(oClContextUdfLineCategory.Response.Data is object))
                {
                    throw new Exception(
                        $"No se encuentra configurada una categoria de linea para la categoria '{_category}'");
                }

                category = oClContextUdfLineCategory.Response.Data.Value;
            }

            #endregion

            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (_configured)
            {
                #region Get UDFs

                CLContext<CL.STRUCTURES.CLASSES.Udf.UdfTransfer> oCLContextUdfs = CL.UDFS.Udf
                    .GetUdfConfigured<MainDBContext, FilterUdfs, ICLSingle>("GetUdfsDBOByCategory",
                        new FilterUdfs()
                        {
                            Category = category,
                            CompanyId = CompanyId
                        }).Get();


                if (!(oCLContextUdfs.Response.Data is object))
                {
                    return new CLContext<List<UdfContext>>()
                    {
                        Code = oCLContextUdfs.Code,
                        Response = new Response<List<UdfContext>>()
                        {
                            Message = oCLContextUdfs.Response.Message
                        }
                    };
                }

                UDFs.AddRange(JsonConvert.DeserializeObject<List<UdfContext>>(oCLContextUdfs.Response.Data.Udfs));

                if (!String.IsNullOrEmpty(_group))
                {
                    //When group has the value 'null' it indicates that the udfs are consulted without a group configured
                    UDFs = UDFs.Where(udf => udf.Group == (_group != "null" ? _group: null)).ToList();
                }

                #endregion
            }
            else
            {
                CLContext<List<UdfContext>> oClContextUdfs = new CLContext<List<UdfContext>>();

                if (connectionMode == SapConnectionType.ODBC)
                {
                    #region Query Via ODBC
                    ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetUdfByCategory", -1, CompanyId);

                    List<UdfContext> resultList = Common.ResolveSAPViewODBC<UdfContext>(contextODBC,
                        new Dictionary<string, object>()
                        {
                            { "@TableID", $"{category}" }
                        });
                    
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                    LogManager.Record($"REQUEST COMPLETED");
                    
                    oClContextUdfs = new CLContext<List<UdfContext>>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<List<UdfContext>>()
                        {
                            Data = resultList
                        },
                        value = resultList
                    };
                    #endregion
                }
                else
                {
                    #region Query Via SL
                    SLRequestObject oSlRequestObject = GetUserCtx("SL_GetUdfByCategory", -1, CompanyId).Get<FilterUdfsByTableId>(
                        new FilterUdfsByTableId()
                        {
                            TableID = category
                        });

                    oClContextUdfs = await CL.UDFS.Udf.GetUdfs(oSlRequestObject);
                    #endregion
                }

                #region Get UDFS

                if (!(oClContextUdfs.Response.Data is object))
                {
                    return oClContextUdfs;
                }

                UDFs.AddRange(
                    oClContextUdfs.Response.Data.Aggregate(
                        new List<UdfContext>(), (acc, val) =>
                            {
                                if (val.Values != null)
                                {
                                    UdfContext AccUDF = acc.Find(udf => udf.Name == val.Name);
                                    if (AccUDF is null)
                                    {
                                        val.MappedValues = new List<UdfInvoke>()
                                        {
                                            new UdfInvoke(){
                                                Description = val.DescriptionLines,
                                                Value = val.Values,
                                                IsActive = true
                                            }
                                        };
                                        val.Values = JsonConvert.SerializeObject( val.MappedValues.Select(mapvalue => mapvalue.Value).ToList());
                                        acc.Add(val);
                                    }
                                    else
                                    {
                                        AccUDF.MappedValues.Add(new UdfInvoke()
                                        {
                                            Description = val.DescriptionLines,
                                            Value = val.Values,
                                            IsActive = true
                                        });
                                        AccUDF.Values = JsonConvert.SerializeObject( AccUDF.MappedValues.Select(mapvalue => mapvalue.Value).ToList());
                                    }
                                }
                                else
                                {
                                    acc.Add(val);
                                }
                                return acc;
                            }
                        )
                    );

                #endregion
            }

            #region Get UDFs values by Database object

            if (_configured)
            {
                string dbType = GetDBType();

                LogManager.Record($"DATABASE TYPE: {dbType}");

                for (int c = 0; c < UDFs.Count; c++)
                {
                    try
                    {
                        //Identifica si campo udf se alimenta de selección de udf previo
                        int index = -1;
                        index = UDFs.FindIndex(element => element.TargetToOverride == UDFs[c].Name);

                        if (!String.IsNullOrEmpty(UDFs[c].DataSource) && index == -1)
                        {
                            string serializedValues = String.Empty;

                            if (connectionMode == SapConnectionType.ODBC)
                            {
                                #region Query Via ODBC

                                ClUserContextODBC oUserODBCContext = GetUserCtxODBC();

                                oUserODBCContext.Resource = $"\"{UDFs[c].DataSource}\"";

                                List<CL.STRUCTURES.CLASSES.Udf.UdfInvoke> resultList = Common.ResolveSAPViewODBC<CL.STRUCTURES.CLASSES.Udf.UdfInvoke>(oUserODBCContext);

                                LogManager.Record($"RESOURCE ODBC: {oUserODBCContext.Resource}");

                                serializedValues = JsonConvert.SerializeObject(
                                    resultList,
                                    new JsonSerializerSettings
                                    {
                                        DateTimeZoneHandling = DateTimeZoneHandling.Local
                                    });

                                #endregion
                            }
                            else
                            {
                                #region Query Via SL

                                ClUserContext oUserSLContext = GetUserCtx();

                                oUserSLContext.Resource = $"{((dbType == DBType.HANA) ? "sml" : "view")}.svc/{UDFs[c].DataSource}";

                                SLRequestObject requestSLModel = oUserSLContext.Get();

                                requestSLModel.Headers = new System.Collections.Generic.List<System.Collections.Generic.KeyValuePair<System.String, System.String>>
                                {
                                    new System.Collections.Generic.KeyValuePair<System.String, System.String>("Prefer", "odata.maxpagesize=0")
                                };

                                CLContext<List<CL.STRUCTURES.CLASSES.Udf.UdfInvoke>> oClcontext = await CL.UDFS.Udf.GetUdfInvokeDBO(requestSLModel);

                                serializedValues = JsonConvert.SerializeObject(
                                    oClcontext.Response.Data, 
                                    new JsonSerializerSettings { 
                                        DateTimeZoneHandling = DateTimeZoneHandling.Local 
                                    });

                                #endregion
                            }

                            UDFs[c].Values = serializedValues;
                        }
                    }
                    catch (Exception ex)
                    {
                        LogManager.Record($"Error al consultar UDFs [{ex.Message}]");
                    }
                }
            }

            #endregion


            return new CLContext<List<UdfContext>>()
            {
                Response = new Response<List<UdfContext>>()
                {
                    Data = UDFs,
                    Message = UDFs.Count > 0 ? "" : "No se econtraron UDFs"
                },
                Code = UDFs.Count > 0 ? HttpStatusCode.OK : HttpStatusCode.NoContent
            };
        }

        /// <summary>
        /// This method create or update a udf 
        /// </summary>
        /// <param name="_udfs"></param>
        /// <param name="_companyId"></param>
        /// <returns></returns>
        public static CLContext<CL.STRUCTURES.CLASSES.Udf.UdfTransfer> PostUdfs(
            CL.STRUCTURES.CLASSES.Udf.UdfTransfer _udfs, int _companyId)
        {
            _udfs.CompanyId = _companyId == -1
                ? Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey])
                : _companyId;

            CLContext<Common.SingleValue<bool>> oClContextUdfCategoryIsConfigured =
                Services.Execute<Common.SingleValue<bool>, FilterUdfs, MainDBContext, ICLSingle>(
                    "CheckIfUdfCategoryIsConfigured",
                    new FilterUdfs()
                    {
                        CompanyId = _udfs.CompanyId,
                        Category = _udfs.TableId
                    }).Get();

            bool isConfigured = oClContextUdfCategoryIsConfigured.Response.Data.Value;

            CLContext<CL.STRUCTURES.CLASSES.Udf.UdfTransfer> oClContext;

            if (!isConfigured)
            {
                LogManager.Record($"REQUESTING POST OBJECT");


                _udfs.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                oClContext = _udfs.PostUdf<MainDBContext, ICLExclude, ICLSingle>("PostUdf", "UDFList", "GroupList");

                LogManager.Record($"REQUEST COMPLETED");
            }
            else
            {
                LogManager.Record($"REQUESTING POST OBJECT");

                _udfs.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                oClContext = _udfs.PatchUdf<MainDBContext, ICLExclude, ICLSingle>("PatchUdf", "UDFList",  "GroupList");

                LogManager.Record($"REQUEST COMPLETED");

                return oClContext;
            }

            return oClContext;
        }
        
        /// <summary>
        /// This method obtains the groups configured to a udf
        /// </summary>
        /// <param name="_companyId"></param>
        /// <param name="_category"></param>
        /// <param name="_isActive"></param>
        /// <returns></returns>
        public static CLContext<List<GroupContext>> GetUdfGroups(int _companyId,
            string _category, bool _isActive)
        {
            int CompanyId = _companyId == -1 ? GetCompanyId() : _companyId;

            List<GroupContext> groups = new List<GroupContext>();

            #region Get UDFs

            CLContext<UdfTransfer> oCLContextUdfs = CL.UDFS.Udf
                .GetUdfConfigured<MainDBContext, FilterUdfs, ICLSingle>("GetUdfsDBOByCategory",
                    new FilterUdfs()
                    {
                        Category = _category,
                        CompanyId = CompanyId
                    }).Get();


            if (!(oCLContextUdfs.Response.Data is object))
            {
                return new CLContext<List<GroupContext>>()
                {
                    Code = oCLContextUdfs.Code,
                    Response = new Response<List<GroupContext>>()
                    {
                        Message = oCLContextUdfs.Response.Message
                    }
                };
            }

            groups.AddRange(JsonConvert.DeserializeObject<List<GroupContext>>(oCLContextUdfs.Response.Data.Groups));

            #endregion

            if (_isActive)
            {
                groups = groups.Where((group) => group.IsActive).ToList();

            }


            return new CLContext<List<GroupContext>>()
            {
                Response = new Response<List<GroupContext>>()
                {
                    Data = groups,
                    Message = groups.Count > 0 ? "" : "No se econtraron Grupos"
                },
                Code = groups.Count > 0 ? HttpStatusCode.OK : HttpStatusCode.NoContent
            };
        }

        #endregion

        #region Cierre de cajas

        /// <summary>
        /// Processes a cash closing operation for a paydesk, including report generation and data persistence.
        /// </summary>
        /// <param name="_opaydeskBalance">The paydesk balance information for the cash closing.</param>
        /// <returns>A <see cref="CLContext{PaydeskBalance}"/> with the processed cash closing data.</returns>
        public static async Task<CLContext<PaydeskBalance>> CashClosing(PaydeskBalance _opaydeskBalance)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            string filePath = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "FilesPath");

            _opaydeskBalance.Email = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _opaydeskBalance.UserId = CL.COMMON.Core.GetClaimUserId().ToString();

            int CompanyId = GetCompanyId();

            _opaydeskBalance.CompanyId = CompanyId;

            ClUserContext oClUserContext = GetUserCtx("GetUserSAP");

            string userCode = String.Empty;

            if (oClUserContext.License.Contains(@"\"))
            {
                userCode = oClUserContext.License.Split('\\')[1];
            }
            else
            {
                userCode = oClUserContext.License;
            }

            _opaydeskBalance.License = userCode;

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<UsersSAP> oContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query User SAP Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetUserSAP");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@UserCode", userCode ?? "" }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<UsersSAP> resultList = Common.ResolveSAPViewODBC<UsersSAP>(contextODBC, parametersODBC);

                UsersSAP result = resultList.FirstOrDefault();

                oContext = new CLContext<UsersSAP>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<UsersSAP>() { Data = result },
                    value = result
                };

                #endregion
            }
            else
            {
                #region Query User SAP Via Service Layer

                FilterUserSAP filter = new FilterUserSAP()
                {
                    UserCode = userCode
                };

                SLRequestObject oSlRequestObject = oClUserContext.Get<FilterUserSAP>(filter);

                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                oContext = await oSlRequestObject.SendAsync<UsersSAP>();

                #endregion
            }

            _opaydeskBalance.UserSignature = oContext.Response.Data.UserSignature.ToString();

            CLContext<List<PrintFormat>> olist = GetSettingByCode<List<PrintFormat>>("PrintFormat");

            PrintFormat oPrintFormat = olist.Response.Data.Find(x => x.CompanyId == CompanyId);

            if (oPrintFormat == null)
            {
                throw new CLException(
                    "CL - No se ha configurado ningún reporte de cierre de cajas para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            filePath = $@"{filePath}Company-{CompanyId}\{oPrintFormat.CashClosing}";

            MemoryStream oReportStream = BalanceReport(_opaydeskBalance, filePath);

            _opaydeskBalance.UrlReport = await UploadStreamToAzure(oReportStream, _opaydeskBalance.Email, "pdf","CashClosing/");

            _opaydeskBalance.CreatedBy = _opaydeskBalance.Email;

            CLContext<PaydeskBalance> clContext =
                Services.Execute<PaydeskBalance, MainDBContext, ICLInclude, ICLSingle>("PostPaydeskBalance",
                    _opaydeskBalance,
                    new string[]
                    {
                        "CardAmount", "CardAmountPinpad", "CashAmount", "CashflowEgress",
                        "CashflowIncomme", "CompanyId", "CreatedBy", "ExchangeRate", "Terminal", "TransferAmount",
                        "UrlReport",
                        "UserId",
                        "UserSignature"
                    }).Post();

            LogManager.Record("REQUEST COMPLETED");

            return clContext;
        }

        public static async Task<CLContext<string>> GetReport(string url)
        {
            LogManager.Record("REQUESTING RECORDS");

            string report = await Common.Download(url);

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<string>()
                { Code = HttpStatusCode.OK, Response = new Response<string>() { Data = report } };
        }

        public static CLContext<IEnumerable<PaydeskBalance>> GetCashClosing(string _user, DateTime _dateFrom,
            DateTime _dateTo)
        {
            LogManager.Record("REQUESTING RECORDS");

            int CompanyId = GetCompanyId();

            CLContext<IEnumerable<PaydeskBalance>> oClContext =
                Services.Execute<FilterCashClosing, PaydeskBalance, MainDBContext>("spGetCashClosing",
                    new FilterCashClosing()
                    {
                        CompanyId = CompanyId,
                        DateFrom = _dateFrom,
                        DateTo = _dateTo,
                        User = _user,
                    }).Get();

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        public static async Task<CLContext<string>> SendCashClosing(SendClashClosingReport _closingReport)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            CLContext<List<EmailCredential>> credentials = GetSettingByCode<List<EmailCredential>>(SettingCode.Account);

            int companyId = GetCompanyId();

            EmailCredential oEmailCredential =
                credentials.Response.Data.Find(element => element.CompanyId == companyId);

            if (oEmailCredential == null)
            {
                throw new CLException("CL - No se ha configurado la información de correo para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            string report = await Common.Download(_closingReport.UrlReport);

            CL.COMMON.Core.SendEmail(
                new CL.STRUCTURES.CLASSES.Email.EmailCredential()
                {
                    Account = oEmailCredential.Account,
                    Host = oEmailCredential.Host,
                    Port = oEmailCredential.Port,
                    Password = oEmailCredential.Password,
                    Subject = oEmailCredential.Subject,
                    Ssl = oEmailCredential.Ssl,
                    User = oEmailCredential.User,
                    IdCompany = oEmailCredential.CompanyId
                },
                new CL.STRUCTURES.CLASSES.Email.EmailDetails()
                {
                    Body = _closingReport.Body,
                    EmailFiles = new List<CL.STRUCTURES.CLASSES.Email.EmailFile>() { 
                        new CL.STRUCTURES.CLASSES.Email.EmailFile()
                        {
                            Base64 = report,
                            Extention = "pdf",
                            FileName = $"Reporte de cierre de caja.pdf",
                            FileType = "application/pdf"
                        } 
                    },
                    EmailsTo = new List<string>()
                    {
                        _closingReport.To
                    },
                    Subject = _closingReport.Subject
                }
            );

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<string>() { Code = HttpStatusCode.OK };
        }

        #endregion

        #region Azure

        public static BlobServiceClient GetBlobServiceClient()
        {
            string accountName = CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AccountName");

            string accountKey = CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AccountKey");

            StorageSharedKeyCredential sharedKeyCredential = new StorageSharedKeyCredential(accountName, accountKey);

            string blobUri = "https://" + accountName + ".blob.core.windows.net";

            return new BlobServiceClient(new Uri(blobUri), sharedKeyCredential);
        }

        /// <summary>
        /// Uploads a stream to Azure Blob Storage with a timestamped filename.
        /// </summary>
        /// <param name="_stream">The stream to be uploaded.</param>
        /// <param name="_fileName">The base name of the file.</param>
        /// <param name="_fileExtension">The file extension.</param>
        /// <param name="_additionalPath">Optional additional path within the workspace.</param>
        /// <returns>The absolute URI of the uploaded file.</returns>
        public static async Task<string> UploadStreamToAzure(Stream _stream, string _fileName, string _fileExtension, string _additionalPath = "")
        {
            BlobServiceClient blobService = GetBlobServiceClient();

            string fileNameWithExtension =
                $"{_fileName}.{_fileExtension}";

            string containerName =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AzureContainerName");

            string workspace =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AzureWorkspace");

            BlobContainerClient containerClient = blobService.GetBlobContainerClient(containerName);

            fileNameWithExtension =
                String.Format("{0}_{1}", DateTime.Now.ToString("yyMMddHHmmss"), fileNameWithExtension);
            int CompanyId = GetCompanyId();
            string _bdName = GetCompanyById(CompanyId).Response.Data.DatabaseCode;

            string workspaceWithFileName = String.Format("{0}{1}/{2}{3}", workspace,_bdName, _additionalPath, fileNameWithExtension);

            BlobClient blobClient = containerClient.GetBlobClient(workspaceWithFileName);

            _stream.Position = 0;

            await blobClient.UploadAsync(_stream);

            return blobClient.Uri.AbsoluteUri;
        }

        public static MemoryStream DownloadAzureFile(string _fileName)
        {
            BlobServiceClient blobService = GetBlobServiceClient();

            string containerName =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AzureContainerName");

            string workspace =
                CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "AzureWorkspace");

            BlobContainerClient containerClient = blobService.GetBlobContainerClient(containerName);

            string workspaceWithFileName = String.Format("{0}{1}", workspace, _fileName);

            BlobClient blobClient = containerClient.GetBlobClient(workspaceWithFileName);

            MemoryStream fileStream = new MemoryStream();

            blobClient.DownloadTo(fileStream);

            return fileStream;
        }

        #endregion

        #region Udfs Desarrollo

        public static CLContext<IEnumerable<UdfDevelopment>> GetUdfsDevelopment(string _tables)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<UdfDevelopment>> oClContext =
                Services.Execute<FilterUdfsByTable, UdfDevelopment, MainDBContext>("GetUdfsDevelopment",
                    new FilterUdfsByTable()
                    {
                        Tables = _tables
                    });

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Password

        /// <summary>
        /// Sends a recovery email to the specified user email address.
        /// </summary>
        /// <param name="_userEmail">The user's email address to send the recovery token to.</param>
        /// <returns>
        /// A <see cref="CLContext{Boolean}"/> indicating whether the email was sent successfully.
        /// </returns>
        public static CLContext<bool> GetSendRecovery(string _userEmail)
        {
            try
            {
                LogManager.Record($"REQUESTING RECORDS");

                CLContext<EmailCredential> oClContextEmailCredentials =
                    GetSettingByCode<EmailCredential>(SettingCode.DefaultSendEmailCredentials);

                EmailCredential oEmailCredential = oClContextEmailCredentials.Response.Data;

                if (!(oEmailCredential is object))
                {
                    throw new Exception(
                        "There are not a default account to send emails. Please configure it with the key 'DefaultSendEmailCredentials'");
                }

                string token = CL.AUTH.Services.SendRecoveryEmail(
                    new System.Collections.Generic.Dictionary<System.String, System.String>(),
                    new CL.STRUCTURES.CLASSES.Email.EmailCredential()
                    {
                        Subject = null,
                        User = oEmailCredential.User,
                        Account = oEmailCredential.Account,
                        Host = oEmailCredential.Host,
                        Password = oEmailCredential.Password,
                        Port = oEmailCredential.Port,
                        Ssl = oEmailCredential.Ssl
                    },
                    CL.AUTH.Services.ValidateRecovery<MainDBContext>("GetValidateEmailRecovery", _userEmail),
                    CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "RecoveryUrl"));

                LogManager.Record($"UPDATING RECOVERY TOKEN");

                CLContext<RecoveryPassword> oClContext =
                    Services.Execute<RecoveryPassword, MainDBContext, ICLInclude, ICLSingle>(
                        "PatchTokenRecovery", new RecoveryPassword()
                        {
                            Token = token,
                            Email = _userEmail
                        }, "Token", "Email");

                LogManager.Record($"REQUEST COMPLETED");
            }
            catch (Exception e)
            {
                LogManager.Record($"[ERROR] - {e.Message}");
            }

            return new CLContext<bool>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<bool>()
                {
                    Data = true,
                    Message = "Correo enviado exitosamente"
                },
                value = true
            };
        }

        /// <summary>
        /// Updates the user's password using a recovery token.
        /// </summary>
        /// <param name="_password">The new password to be set.</param>
        /// <param name="_token">The recovery token associated with the user.</param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{RecoveryPassword}}"/> indicating the result of the password update.
        /// </returns>
        public static CLContext<IEnumerable<RecoveryPassword>> PatchRecoveryPassword(string _password, string _token)
        {
            LogManager.Record($"UPDATING RECOVERY PASSWORD...");

            return CL.AUTH.Services.ChangePassword<RecoveryPassword, MainDBContext>("PatchRecoveryPassword", _token,
                _password);
        }

        /// <summary>
        /// Updates the user's password using their current credentials.
        /// </summary>
        /// <param name="_changePassword">An object containing the user's email, old password, and new password.</param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{ChangePassword}}"/> containing the result of the password change operation.
        /// </returns>
        public static CLContext<IEnumerable<ChangePassword>> PatchChangePassword(ChangePassword _changePassword)
        {
            LogManager.Record($"UPDATING PASSWORD...");
            return CL.AUTH.Services.ChangePassword<ChangePassword, MainDBContext>("PatchChangePassword",
                _changePassword.Email, _changePassword.OldPassword, _changePassword.NewPassword);
        }

        #endregion

        #region Local Printer

        /// <summary>
        /// Creates a new local printer record in the database using the provided printer information.
        /// The creator's email is automatically populated from the current user context.
        /// </summary>
        /// <param name="_localPrinter">The <c>LocalPrinter</c> object containing printer details to be stored.</param>
        /// <returns>A <c>CLContext&lt;LocalPrinter&gt;</c> containing the result of the insertion operation.</returns>
        /// <remarks>
        /// Fields such as <c>UpdatedBy</c> and <c>UserAssing</c> are excluded during the post operation.
        /// </remarks>
        public static CLContext<LocalPrinter> PostLocalPrinter(LocalPrinter _localPrinter)
        {
            LogManager.Record($"REQUESTING RECORDS");

            _localPrinter.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<LocalPrinter> oClContext =
                _localPrinter.Post<LocalPrinter, MainDBContext, ICLExclude, ICLSingle>("PostLocalPrinter", "PrinterName", "UpdatedBy",
                    "IsActive", "UserAssing");


            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Updates an existing local printer record with new values. The updater's email is set from the current user context.
        /// </summary>
        /// <param name="_localPrinter">The <c>LocalPrinter</c> object with updated printer information.</param>
        /// <returns>A <c>CLContext&lt;LocalPrinter&gt;</c> representing the result of the patch operation.</returns>
        /// <remarks>
        /// Fields like <c>CreatedBy</c> are excluded from the update.
        /// </remarks>
        public static CLContext<LocalPrinter> PatchLocalPrinter(LocalPrinter _localPrinter)
        {
            LogManager.Record($"REQUESTING RECORDS");

            _localPrinter.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<LocalPrinter> oClContext =
                _localPrinter.Patch<LocalPrinter, MainDBContext, ICLExclude, ICLSingle>("PatchLocalPrinter", "Id", "PrinterName", "CreatedBy",
                    "IsActive", "UserAssing");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Updates only the printer name for an existing local printer record.
        /// The updater's email is set from the current user context.
        /// </summary>
        /// <param name="_printerName">A <c>SelectedPrinterName</c> object containing the new printer name and identifier.</param>
        /// <returns>A <c>CLContext&lt;SelectedPrinterName&gt;</c> with the result of the patch operation.</returns>
        /// <remarks>
        /// This operation targets the <c>PatchPrinterNameLocal</c> service to update printer identification data.
        /// </remarks>
        public static CLContext<SelectedPrinterName> PatchPrinterNameLocalPrinter(SelectedPrinterName _printerName)
        {
            LogManager.Record($"REQUESTING RECORDS");

            _printerName.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<SelectedPrinterName> oClContext = _printerName.Patch<SelectedPrinterName, MainDBContext>("PatchPrinterNameLocal");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves the local printer assigned to the specified user.
        /// </summary>
        /// <param name="_userAssingId">The ID of the user assigned to the local printer.</param>
        /// <returns>A <c>CLContext&lt;LocalPrinter&gt;</c> containing the printer configuration for the user.</returns>
        /// <remarks>
        /// Uses the <c>GetLocalPrinterByUserAssing</c> service call to query the database based on user assignment.
        /// </remarks>
        public static CLContext<LocalPrinter> GetLocalPrinter(int _userAssingId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<LocalPrinter> oClContext =
                Services.Execute<LocalPrinter, MainDBContext, int, ICLSingle>("GetLocalPrinterByUserAssing", _userAssingId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Chart

        /// <summary>
        /// Retrieves dataset label and color of specific dataset
        /// </summary>
        /// <param name="_chartId">ID of the chart to which the dataset belongs</param>
        /// <param name="_dataSetId">ID of the dataset to which the color and label belong </param>
        /// <returns></returns>
        public static CLContext<ChartDataSetLabel> GetDataSetLabelById(int _chartId, int _dataSetId)
        {
            LogManager.Record($"REQUESTING DATASET LABEL");

            CLContext<ChartDataSetLabel> oClContext =
                Services.Execute<ChartDataSetLabel, CartesianEntity<int, int>, MainDBContext, ICLSingle>("GetDataSetLabelById",
                    new CartesianEntity<int, int>()
                    {
                        AKey = _chartId,
                        BKey = _dataSetId
                    }).Get();

            LogManager.Record($"REQUESTE  DATASET LABEL COMPLETED| RESULT: {JsonConvert.SerializeObject(oClContext)}");

            return oClContext;
        }

        /// <summary>
        /// Retrieves data set from SAP database
        /// </summary>
        /// <param name="_dataSetResource"> Name of resourse</param>
        /// <returns></returns>
        public static async Task<List<DataSetValue>> GetSapDataSet(string dataSetResource)
        {
            LogManager.Record("REQUESTING SAP DATA SET");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<DataSetValue>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{dataSetResource}");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<DataSetValue> resultList =
                    Common.ResolveSAPViewODBC<DataSetValue>(contextODBC);

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<DataSetValue>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<DataSetValue>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx($"SL_{dataSetResource}").Get();

                LogManager.Record($"URL: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<DataSetValue>>();

                #endregion
            }

            return oClContext.Response.Data;
        }

        /// <summary>
        /// Retrieves charts data
        /// </summary>
        /// <returns>A collections of charts</returns>
        public static async Task<CLContext<List<Chart>>> GetCharts()
        {
            LogManager.Record($"REQUESTING CHARTS");

            List<ChartConfiguration> chartsConfiguration =
                Services.Execute<ChartConfiguration, MainDBContext>("GetCharts").Get().Response.Data.ToList();


            if (chartsConfiguration.Count == 0)
            {
                return new CLContext<List<Chart>>()
                {
                    Response = new Response<List<Chart>>()
                    {
                        Data = new List<Chart>(),
                        Message = string.Empty
                    },
                    Code = HttpStatusCode.OK
                };
            }

            CLContext<IEnumerable<ChartLabels>> oClContextChartLabels = new CLContext<IEnumerable<ChartLabels>>();

            List<DataSetValue> dataSetValues = new List<DataSetValue>();

            CLContext<ChartDataSetLabel> oClContextChartDataSetLabel = new CLContext<ChartDataSetLabel>();

            List<Chart> charts = new List<Chart>();

            Chart chartBody = new Chart();

            Data chartData = new Data();

            ChartDataSet chartDataSet = new ChartDataSet();

            List<DataSetValue> chartDataSetById;

            int previousDataSetId = 0;

            List<int> dataSetsIds;

            LogManager.Record($"REQUESTING CHARTLABELS AND CHARTDATASET");
            foreach (ChartConfiguration chartConfiguration in chartsConfiguration)
            {
                LogManager.Record($"CHART TO PROCESS | CHART: {JsonConvert.SerializeObject(chartConfiguration)}");

                switch (chartConfiguration.DataSetResourceType)
                {
                    case DataSetsTypes.SapDataSet:
                        dataSetValues = await GetSapDataSet(chartConfiguration.DataSetResource);
                        break;
                    case DataSetsTypes.LocalDataSet:
                        dataSetValues = Services.Execute<DataSetValue, MainDBContext>(chartConfiguration.DataSetResource).Get().Response.Data.ToList();
                        LogManager.Record($"REQUESTE CHART LOCAL DATASET | RESULT: {JsonConvert.SerializeObject(dataSetValues)}");
                        break;
                }

                oClContextChartLabels = Services.Execute<ChartLabels, MainDBContext>(chartConfiguration.LabelsResource).Get();

                LogManager.Record($"REQUESTE CHARTLABEL | RESULT: {JsonConvert.SerializeObject(oClContextChartLabels)}");

                chartBody.type = chartConfiguration.Type;

                //The labels that the chart will have are added to the object
                oClContextChartLabels.Response.Data.ToList().ForEach(chartLabel =>
                {
                    chartData.labels.Add(chartLabel.Label);

                });

                //You get the ids of the different datasets that the chart will have
                dataSetsIds = dataSetValues.Select(data => data.DataSetId).Distinct().ToList();

                dataSetsIds.ForEach(dataSetId =>
                {
                    //Filter datasets by specific ID
                    chartDataSetById = dataSetValues.Where(dataSet => dataSet.DataSetId == dataSetId).ToList();

                    chartDataSetById.ForEach(_chartDataSet =>
                    {
                        chartDataSet.data.Add(_chartDataSet.Value);

                    });

                    oClContextChartDataSetLabel = GetDataSetLabelById(chartConfiguration.ChartId, dataSetId);

                    chartDataSet.label = oClContextChartDataSetLabel.Response.Data.DataSetLabel;
                    chartDataSet.backgroundColor = oClContextChartDataSetLabel.Response.Data.Color.Split(',').ToList();

                    chartData.datasets.Add(chartDataSet);
                    chartDataSet = new ChartDataSet();
                });

                chartBody.type = chartConfiguration.Type;
                chartBody.data = chartData;
                chartBody.Title = chartConfiguration.Title;

                charts.Add(chartBody);

                chartBody = new Chart();
                chartData = new Data();
            }

            CLContext<List<Chart>> clContext = new CLContext<List<Chart>>()
            {
                Response = new Response<List<Chart>>()
                {
                    Data = charts
                }
            };

            return clContext;
        }

        #endregion

        #region Padron

        /// <summary>
        /// Retrieves information from the external Hacienda service using the provided identification number.
        /// </summary>
        /// <param name="_identification">The identification number to query.</param>
        /// <returns>A <see cref="CLContext{String}"/> containing the raw response from the Hacienda service.</returns>
        /// <exception cref="CLException">
        /// Thrown when the Hacienda service URL is not configured for the current company.
        /// </exception>
        public static async Task<CLContext<string>> GetPadron(string _identification)
        {
            string res = null;

            List<SettingUrlFormat> companiesUrlFormat = GetSettingByCode<List<SettingUrlFormat>>("Route").Response.Data;

            int oCompanyId = GetCompanyId();

            SettingUrlFormat urlPadron =
                companiesUrlFormat.FirstOrDefault(setting => setting.CompanyId == oCompanyId);

            if (urlPadron == null || String.IsNullOrEmpty(urlPadron.PortServiceHacienda))
            {
                throw new CLException("CL Setting Route url Hacienda no encontrado.", HttpStatusCode.NotFound);
            }

            using (HttpClient http = new HttpClient())
            {
                res = await http.GetStringAsync($"{urlPadron.PortServiceHacienda}{_identification}");
            }

            return new CLContext<string>()
            {
                value = "Respuesta",
                Code = System.Net.HttpStatusCode.OK,
                Response = new Response<string>() { Data = res, Message = "Padron Hacienda" }
            };
        }

        #endregion

        #region Recatcha

        /// <summary>
        /// Method to validate recatcha
        /// </summary>
        /// <param name="_recaptchaToken">Token recaptcha</param>
        /// <exception cref="CLException"></exception>
        public static async System.Threading.Tasks.Task ValidRecatcha(string _recaptchaToken)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            string secretKey = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "SecretKeyRecaptcha");
            string url = CL.COMMON.Core.GetConfigKeyValue<string>(MethodBase.GetCurrentMethod(), "UrlRecaptcha");

            if (!string.IsNullOrEmpty(secretKey))
            {
                using (HttpClient htpp = new HttpClient())
                {
                    FormUrlEncodedContent formData = new FormUrlEncodedContent(new[]
                    {
                        new KeyValuePair<string, string>("secret", secretKey),
                        new KeyValuePair<string, string>("response", _recaptchaToken)
                    });

                    HttpRequestMessage request = new HttpRequestMessage(HttpMethod.Post, url);
                    request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
                    request.Content = formData;

                    HttpResponseMessage response = await htpp.SendAsync(request);

                    string jsonResponse = await response.Content.ReadAsStringAsync();

                    LogManager.Record(
                        $"DATA RECAPTCHA: {jsonResponse} STATUS: {response.StatusCode} {response.ReasonPhrase}");

                    if (response.IsSuccessStatusCode)
                    {
                        Recaptcha oRecaptcha = JsonConvert.DeserializeObject<Recaptcha>(jsonResponse);

                        if (!oRecaptcha.success)
                        {
                            throw new CLException("CL - La validación del reCAPTCHA no fue exitosa.",
                                HttpStatusCode.InternalServerError);
                        }
                    }
                    else
                    {
                        throw new CLException("CL - La validación del reCAPTCHA no fue exitosa.",
                            HttpStatusCode.InternalServerError);
                    }
                }
            }

            LogManager.Record("REQUEST COMPLETED");
        }

        #endregion

        #region Tapp

        public static async Task<CLContext<string>> OpenTappInvoice(string _bridgeId, string _invoiceId,
            string _invoiceDate, string _identification, string _userId)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>("Points");

            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException("CL - No se ha encontrado ningún setting con el código Tapp.",
                    HttpStatusCode.BadRequest);
            }

            TappConfigBase oTappConfigBase = oClContext.Response.Data.Tapp;

            int oCompanyId = GetCompanyId();

            TappConfig tapp = oClContext.Response.Data.Tapp.TappConfigs.Find(_x => _x.CompanyId == oCompanyId);

            if (tapp == null)
            {
                throw new CLException("CL - No se ha configurado el plan de lealtad de tapp para la compañia en curso.",
                    HttpStatusCode.BadRequest);
            }

            string apiUrl =
                $"{oTappConfigBase.Url}getcurrenttapper?register_id={tapp.Register}&tapp_bridge_id={_bridgeId}&invoice_id={_invoiceId}&invoiceDate={_invoiceDate}&store_id={tapp.Store}&identification={_identification}&pos_user_id={_userId}";

            LogManager.Record($"TAPP - URL: {apiUrl}");

            HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.GET, apiUrl,
                null, new Dictionary<string, string>()
                {
                    { "x-token", tapp.Token }
                });

            string response = await oResponseMessage.Content.ReadAsStringAsync();

            LogManager.Record(
                $"TAPP - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

            LogManager.Record("REQUEST COMPLETED");

            if (oResponseMessage.IsSuccessStatusCode)
            {
                return new CLContext<string>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<string>()
                    {
                        Data = response,
                        Message = ""
                    }
                };
            }

            return new CLContext<string>()
            {
                Code = oResponseMessage.StatusCode,
                Response = new Response<string>()
                {
                    Data = null,
                    Message = oResponseMessage.ReasonPhrase
                }
            };
        }

        public static async Task<CLContext<TappResponse>> CloseTappInvoice(TappCloseInvoice _tappCloseInvoice)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException($"CL - No se ha encontrado ningún setting con el código ${SettingCode.Points}.",
                    HttpStatusCode.InternalServerError);
            }

            TappConfigBase oTappConfigBase = oClContext.Response.Data.Tapp;

            int oCompanyId = GetCompanyId();

            TappConfig tapp = oClContext.Response.Data.Tapp.TappConfigs.Find(_x => _x.CompanyId == oCompanyId);

            if (tapp == null)
            {
                throw new CLException("CL - No se ha configurado el plan de lealtad de tapp para la compañia en curso.",
                    HttpStatusCode.InternalServerError);
            }

            _tappCloseInvoice.register_id = tapp.Register;
            _tappCloseInvoice.store_id = tapp.Store;

            string apiUrl = $"{oTappConfigBase.Url}closeinvoice";
            string body = JsonConvert.SerializeObject(_tappCloseInvoice);

            LogManager.Record($"TAPP - URL: {apiUrl}   MODEL: ${body}");

            HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST, apiUrl,
                body, new Dictionary<string, string>()
                {
                    { "x-token", tapp.Token }
                });

            string response = await oResponseMessage.Content.ReadAsStringAsync();

            LogManager.Record(
                $"TAPP - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

            LogManager.Record("REQUEST COMPLETED");

            if (oResponseMessage.IsSuccessStatusCode)
            {
                await UpdateInvoice(new ARInvoiceTapp()
                {
                    DocEntry = Convert.ToInt32(_tappCloseInvoice.invoice_id),
                    U_EMA_withTransactionTapp = 1
                });

                return new CLContext<TappResponse>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<TappResponse>()
                    {
                        Data = JsonConvert.DeserializeObject<TappResponse>(response),
                        Message = ""
                    }
                };
            }

            return new CLContext<TappResponse>()
            {
                Code = oResponseMessage.StatusCode,
                Response = new Response<TappResponse>()
                {
                    Data = null,
                    Message = $"{oResponseMessage.ReasonPhrase} {response}"
                }
            };
        }

        /// <summary>
        ///Method to create notecredit with tap
        /// </summary>
        /// <param name="_arInvoice">Model to creditnote</param>
        /// <param name="docEntryNc">Docentry of creditnote</param>
        /// <exception cref="Exception"></exception>
        public static async System.Threading.Tasks.Task CreateNoteCreditTapp(ARCreditMemo _arInvoice, int docEntryNc)
        {
            LogManager.Record("INICIANDO CREACION DE NOTA DE CREDITO EN TAPP");

            try
            {
                CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

                if (oClContext.Response == null || oClContext.Response.Data == null)
                {
                    LogManager.Record($"CL - No se ha encontrado ningún setting con el código ${SettingCode.Points}.");
                }

                TappConfigBase oTappConfigBase = oClContext.Response?.Data?.Tapp;

                int oCompanyId = GetCompanyId();

                TappConfig tapp =
                    oClContext.Response?.Data?.Tapp?.TappConfigs.Find(_x => _x.CompanyId == oCompanyId);

                if (tapp == null)
                {
                    throw new Exception("No se ha configurado el plan de lealtad de tapp para la compañia en curso.");
                }

                CLContext<List<TypeCurrency>> oClContextCurrencies = await GetCurrencies(false);

                TypeCurrency localCurrency = oClContextCurrencies.Response.Data.First(c => c.IsLocal);

                CreditNoteTapp creditNoteTapp = new CreditNoteTapp();
                creditNoteTapp.register_id = tapp?.Register;
                creditNoteTapp.invoice_id = _arInvoice.DocumentLines[0]?.BaseEntry?.ToString();
                creditNoteTapp.amount = _arInvoice.DocCurrency == localCurrency.Id
                    ? _arInvoice.DocTotal
                    : _arInvoice.DocTotalFC;
                creditNoteTapp.credit_note_id = docEntryNc.ToString();
                creditNoteTapp.tapp_bridge_id = _arInvoice.DocumentKey;

                creditNoteTapp.products = new List<CreditNoteLinesTapp>();

                foreach (ARCreditMemoRows line in _arInvoice.DocumentLines)
                {
                    creditNoteTapp.products.Add(new CreditNoteLinesTapp()
                    {
                        product_code = line.ItemCode,
                        product_description = line.ItemDescription,
                        quantity = Convert.ToDecimal(line.Quantity),
                        subtotal = line.LineTotal
                    });
                }

                string body = JsonConvert.SerializeObject(creditNoteTapp);

                string apiUrl = $"{oTappConfigBase?.Url}invoicepos/posCreditNote";

                LogManager.Record($"URL {apiUrl}   MODEL ENVIADO: {body}");

                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST,
                    apiUrl,
                    body, new Dictionary<string, string>()
                    {
                        { "x-token", tapp.Token }
                    });

                LogManager.Record("FINALIZACION DE CREACION DE NOTA DE CREDITO EN TAPP");

                string result = await oResponseMessage.Content.ReadAsStringAsync();

                if (oResponseMessage.IsSuccessStatusCode)
                {
                    LogManager.Record(
                        $"RESPUESTA CORRECTA: {result}  CODE: {oResponseMessage.StatusCode} {oResponseMessage.ReasonPhrase}");
                }
                else
                {
                    LogManager.Record(
                        $"RESPUESTA ERRONEA: {result}  CODE: {oResponseMessage.StatusCode} {oResponseMessage.ReasonPhrase}");
                }
            }
            catch (Exception e)
            {
                LogManager.Record($"Error en tapp {e.Message}");
            }
        }

        #endregion

        #region Lealto

        private static async System.Threading.Tasks.Task LoginLealto(LealtoConfigBase _lealtoConfigBase,
            LealtoConfig _lealtoConfig)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            string url = $"{_lealtoConfigBase.UrlBase}{_lealtoConfig.Ambiente}{_lealtoConfigBase.UrlLogin}";

            LogManager.Record($"LEALTO : URL: {url}");

            HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST,
                url, JsonConvert.SerializeObject(new LealtoLogin()
                {
                    username = _lealtoConfig.User,
                    password = _lealtoConfig.Password
                }), new Dictionary<string, string>()
                {
                    { "x-api-key", _lealtoConfig.ApiKey }
                });

            string response = await oResponseMessage.Content.ReadAsStringAsync();

            LogManager.Record(
                $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

            if (!oResponseMessage.IsSuccessStatusCode)
            {
                throw new CLException(
                    $"CL - Error al loguearse con lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                    HttpStatusCode.NotFound);
            }


            InfoLoginData oLoginResponse = JsonConvert.DeserializeObject<InfoLoginData>(response);

            _lealtoConfig.IdSucursal = oLoginResponse.data.id_sucursal;
            _lealtoConfig.Token = oLoginResponse.data.token;

            LogManager.Record("REQUEST COMPLETED");
        }

        public static async Task<CLContext<InfoUserDataUI>> ConsultPoints(string _identificacion)
        {
            LogManager.Record("REQUESTING RECORDS");

            InfoUserData oInfoUserData = null;
            InfoCompanyData oInfoCompanyData = null;
            InfoPointsData oInfoPointsData = null;

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

            //Verificamos que exista el setting de lealto
            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException("CL - No se encontro ningún setting con el código de Lealto",
                    HttpStatusCode.NotFound);
            }

            LealtoConfigBase oLealtoConfigBase = oClContext.Response.Data.Lealto;

            int oCompanyId = GetCompanyId();

            LealtoConfig oLealtoConfig = oLealtoConfigBase.LealtoConfigs.Find(_x => _x.CompanyId == oCompanyId);

            //Verificamos que exista una config de lealto para esta compañia en curso
            if (oLealtoConfig == null)
            {
                throw new CLException(
                    "CL - No se ha configurado el plan de lealtad de lealto para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            //Verificamos si necesitamos loguearnos
            if (string.IsNullOrEmpty(oLealtoConfig.Token))
            {
                await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                ResetToken(oClContext.Response.Data);
            }

            string url =
                $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlUser}{_identificacion}";

            LogManager.Record($"LEALTO : URL: {url}");

            //Consultamos la data del usuario
            int repeatData = 0;

            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.GET,
                    url, null, new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al consultar la información en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        HttpStatusCode.NotFound);
                }
                else
                {
                    oInfoUserData = JsonConvert.DeserializeObject<InfoUserData>(response);

                    break;
                }
            }

            ///Si no existe ningun usuario con la cedula, retornamos aqui
            if (oInfoUserData.data == null || oInfoUserData.data.Count == 0)
            {
                return new CLContext<InfoUserDataUI>()
                {
                    Code = HttpStatusCode.NotFound,
                    Response = new Response<InfoUserDataUI>()
                    {
                        Data = null,
                        Message = $"No se encontró ningún usuario con la identificación: {_identificacion}"
                    }
                };
            }

            url =
                $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlPoints}{oInfoUserData?.data[0].id}";

            //Consultamos los datos de los puntos
            repeatData = 0;
            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.GET,
                    url, null, new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al consultar puntos en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        HttpStatusCode.NotFound);
                }
                else
                {
                    oInfoPointsData = JsonConvert.DeserializeObject<InfoPointsData>(response);

                    break;
                }
            }

            url = $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlConfigCompany}";

            //Consultamos los datos de la compañia
            repeatData = 0;
            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.GET,
                    url, null, new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al consultar datos de la compañia en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        HttpStatusCode.NotFound);
                }
                else
                {
                    oInfoCompanyData = JsonConvert.DeserializeObject<InfoCompanyData>(response);

                    break;
                }
            }

            LogManager.Record("REQUESTING COMPLETED");

            return new CLContext<InfoUserDataUI>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<InfoUserDataUI>()
                {
                    Data = new InfoUserDataUI()
                    {
                        identificacion = oInfoUserData.data[0].identificacion,
                        nombre = oInfoUserData.data[0].nombre,
                        apellidos = oInfoUserData.data[0].apellidos,
                        porc_acumulacion_puntos =
                            oInfoPointsData?.data.userData.presentLevel.porc_acumulacion_puntos.ToString(),
                        RedemptionFloor = oInfoCompanyData?.data.cashback.RedemptionFloor ?? 0,
                        id_sucursal = oLealtoConfig.IdSucursal,
                        id_usuario = oInfoUserData.data[0].id,
                        pointsAvailable = oInfoPointsData?.data.userData.pointsAvailable ?? 0
                    }
                }
            };
        }

        private static void ResetToken(LoyaltyPlan _loyaltyPlan)
        {
            PatchSetting(SettingCode.Points, new MODELS.Setting()
            {
                Code = SettingCode.Points,
                IsActive = true,
                Json = JsonConvert.SerializeObject(_loyaltyPlan)
            });
        }

        public static async Task<CLContext<InfoAccumulatedPointsDataUI>> AccumulatedPoints(
            InvoicePointsBase _oinvoicePointsBase)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            InfoAccumulatedPointsData oInfoAccumulatedPointsData = null;

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

            //Verificamos que exista el setting de lealto
            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException("CL - No se encontro ningún setting con el código de Lealto",
                    HttpStatusCode.NotFound);
            }

            LealtoConfigBase oLealtoConfigBase = oClContext.Response.Data.Lealto;

            int oCompanyId = GetCompanyId();

            LealtoConfig oLealtoConfig = oLealtoConfigBase.LealtoConfigs.Find(_x => _x.CompanyId == oCompanyId);

            if (oLealtoConfig == null)
            {
                throw new CLException(
                    "CL - No se ha configurado el plan de lealtad de lealto para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            //Url de conexion
            string url =
                $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlAccumulationPoints}";

            LogManager.Record($"LEALTO : URL: {url}");
            string body = JsonConvert.SerializeObject(_oinvoicePointsBase);

            int repeatData = 0;

            //Repetimos solo dos veces en caso de que el token se venciera
            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST,
                    url, body, new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al acumular puntos en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        HttpStatusCode.NotFound);
                }
                else
                {
                    oInfoAccumulatedPointsData = JsonConvert.DeserializeObject<InfoAccumulatedPointsData>(response);

                    break;
                }
            }

            //Guardamos el numero de factura en SAP
            await UpdateInvoice(new ARInvoiceAccumulate()
            {
                DocEntry = Convert.ToInt32(_oinvoicePointsBase.numero_factura),
                U_EMA_numTransaccion_acumular = oInfoAccumulatedPointsData?.numero_factura.ToString()
            });

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<InfoAccumulatedPointsDataUI>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<InfoAccumulatedPointsDataUI>()
                {
                    Data = new InfoAccumulatedPointsDataUI()
                    {
                        puntos_disponibles = oInfoAccumulatedPointsData?.puntos_disponibles ?? 0
                    },
                    Message = ""
                }
            };
        }

        public static async Task<CLContext<InfoRedeemPointsUI>> RedeemPoints(
            InvoiceRedeemPoint _oInvoiceRedeemPoint)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            InfoRedeemPoints oInfoRedeemPoints = null;

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

            //Verificamos que exista el setting de lealto
            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException("CL - No se encontro ningún setting con el código de Lealto",
                    HttpStatusCode.NotFound);
            }

            LealtoConfigBase oLealtoConfigBase = oClContext.Response.Data.Lealto;

            int oCompanyId = GetCompanyId();

            LealtoConfig oLealtoConfig = oLealtoConfigBase.LealtoConfigs.Find(_x => _x.CompanyId == oCompanyId);

            if (oLealtoConfig == null)
            {
                throw new CLException(
                    "CL - No se ha configurado el plan de lealtad de lealto para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            //Url de conexion
            string url = $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlRedimirPoints}";

            LogManager.Record($"LEALTO : URL: {url}");

            int repeatData = 0;

            //Repetimos solo dos veces en caso de que el token se venciera
            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST,
                    url, JsonConvert.SerializeObject(_oInvoiceRedeemPoint), new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al redimir puntos en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        HttpStatusCode.NotFound);
                }
                else
                {
                    oInfoRedeemPoints = JsonConvert.DeserializeObject<InfoRedeemPoints>(response);

                    break;
                }
            }

            //Guardamos el numero de factura en SAP
            await UpdateInvoice(new ARInvoiceRedeem()
            {
                DocEntry = Convert.ToInt32(_oInvoiceRedeemPoint.numero_factura),
                U_EMA_numTransaccion_redimir = oInfoRedeemPoints?.numero_factura.ToString()
            });

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<InfoRedeemPointsUI>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<InfoRedeemPointsUI>()
                {
                    Data = new InfoRedeemPointsUI()
                    {
                        puntos_disponibles_sin_bloqueo = oInfoRedeemPoints?.puntos_disponibles_sin_bloqueo ?? 0
                    },
                    Message = ""
                }
            };
        }

        private static async System.Threading.Tasks.Task CancelLoyaltyTransactions(string _idTransaccion)
        {
            LogManager.Record("REQUESTING POST OBJECT");


            LoyaltyTransactionsCancel oTransactionsCancel = new LoyaltyTransactionsCancel()
            { id_transaccion = _idTransaccion };

            CLContext<LoyaltyPlan> oClContext = GetSettingByCode<LoyaltyPlan>(SettingCode.Points);

            //Verificamos que exista el setting de lealto
            if (oClContext.Response == null || oClContext.Response.Data == null)
            {
                throw new CLException("CL - No se encontro ningún setting con el código de Lealto",
                    HttpStatusCode.NotFound);
            }

            LealtoConfigBase oLealtoConfigBase = oClContext.Response.Data.Lealto;

            int oCompanyId = GetCompanyId();

            LealtoConfig oLealtoConfig = oLealtoConfigBase.LealtoConfigs.Find(_x => _x.CompanyId == oCompanyId);

            if (oLealtoConfig == null)
            {
                throw new CLException(
                    "CL - No se ha configurado el plan de lealtad de lealto para la compañia en curso.",
                    HttpStatusCode.NotFound);
            }

            //Url de conexion
            string url =
                $"{oLealtoConfigBase.UrlBase}{oLealtoConfig.Ambiente}{oLealtoConfigBase.UrlCancelarTransaccion}";

            int repeatData = 0;

            //Repetimos solo dos veces en caso de que el token se venciera
            while (repeatData < 2)
            {
                HttpResponseMessage oResponseMessage = await Common.ExecuteHttpAsync((int)Constants.MethodHttp.POST,
                    url, JsonConvert.SerializeObject(oTransactionsCancel), new Dictionary<string, string>()
                    {
                        { "x-api-key", oLealtoConfig.ApiKey },
                        { "Authorization", oLealtoConfig.Token }
                    });

                string response = await oResponseMessage.Content.ReadAsStringAsync();

                LogManager.Record(
                    $"LEALTO - STATUS: {oResponseMessage.StatusCode} | MESSAGE: {oResponseMessage.ReasonPhrase} | RESPONSE :{response}");

                if (!oResponseMessage.IsSuccessStatusCode && oResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                {
                    //Obtenemos el token
                    await LoginLealto(oLealtoConfigBase, oLealtoConfig);

                    ResetToken(oClContext.Response.Data);

                    repeatData++;
                }
                else if (!oResponseMessage.IsSuccessStatusCode)
                {
                    throw new CLException(
                        $"CL - Error al cancelar transacción en lealto, detalle: {oResponseMessage.StatusCode} - {oResponseMessage.ReasonPhrase}",
                        oResponseMessage.StatusCode);
                }
                else
                {
                    break;
                }
            }

            LogManager.Record("REQUEST COMPLETED");
        }

        #endregion

        #region Log Events

        /// <summary>
        /// Retrieves a filtered and paginated list of log events.
        /// </summary>
        /// <param name="_filter">Text filter to search events.</param>
        /// <param name="_event">Specific event type to filter.</param>
        /// <param name="_from">Start date range.</param>
        /// <param name="_to">End date range.</param>
        /// <param name="_skip">Number of records to skip.</param>
        /// <param name="_take">Number of records to return.</param>
        /// <returns>A context with the filtered log events.</returns>
        public static async Task<CLContext<IEnumerable<LogEvent>>> GetLogEvent(string _filter, string _event,
            DateTime _from, DateTime _to, int _skip, int _take)
        {
            LogManager.Record($"REQUESTING RECORD");

            LogEventFilter filter = new LogEventFilter()
            {
                Filter = _filter,
                Event = _event,
                From = _from,
                To = _to,
                Skip = _skip,
                Take = _take
            };

            CLContext<IEnumerable<LogEvent>> oClContext = Services
                .Execute<LogEventFilter, LogEvent, MainDBContext>("GetLogEvents", filter).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a single log event by its ID.
        /// </summary>
        /// <param name="_id">Log event ID.</param>
        /// <returns>A context containing the log event.</returns>
        public static async Task<CLContext<LogEvent>> GetLogEvent(int _id)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<LogEvent> oClContext = Services
                .Execute<LogEvent, MainDBContext, int, ICLSingle>("GetLogEventById", _id).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Creates a new log event entry.
        /// </summary>
        /// <param name="_logEvent">The log event to insert.</param>
        /// <returns>A context containing the inserted log event.</returns>
        public static CLContext<LogEvent> PostLogEvent(LogEvent _logEvent)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _logEvent.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<LogEvent> oClContext = Services.Execute<LogEvent, MainDBContext, ICLInclude, ICLSingle>(
                    "PostLogEvent",
                    _logEvent, new string[]
                    {
                        "CreatedBy", "Detail", "DocumentKey", "Event", "View"
                    })
                .Post();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Inserts a list of log events.
        /// </summary>
        /// <param name="_logEvents">Collection of log events to insert.</param>
        /// <returns>A context with the successfully inserted log events.</returns>
        public static CLContext<IEnumerable<LogEvent>> PostLogEvents(IEnumerable<LogEvent> _logEvents)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            List<LogEvent> logEvents = new List<LogEvent>();

            foreach (LogEvent logEvent in _logEvents)
            {
                CLContext<LogEvent> oClContext = PostLogEvent(logEvent);

                if (oClContext.Response?.Data != null)
                {
                    logEvents.Add(oClContext.Response.Data);
                }
            }

            LogManager.Record($"REQUEST COMPLETED");

            return new CLContext<IEnumerable<LogEvent>>()
            {
                Response = new Response<IEnumerable<LogEvent>>()
                {
                    Data = logEvents
                }
            };
        }

        /// <summary>
        /// Updates an existing log event.
        /// </summary>
        /// <param name="_logEvent">The log event with updated information.</param>
        /// <returns>A context with the updated log event.</returns>
        public static async Task<CLContext<LogEvent>> PatchLogEvent(LogEvent _logEvent)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _logEvent.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<LogEvent> oClContext = _logEvent.Patch<LogEvent, MainDBContext>("PatchLogEvent");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Geo Roles

        public static CLContext<IEnumerable<GeoRole>> GetGeoRoles(bool _active)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<GeoRole>> oClContext =
                Services.Execute<GeoRole, MainDBContext, bool>("GetGeoRoles", _active).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoRole> GetGeoRole(int _geoRoleId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<GeoRole> oClContext =
                Services.Execute<GeoRole, MainDBContext, int, ICLSingle>("GetGeoRole", _geoRoleId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoRole> PostGeoRole(GeoRole _geoRole)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _geoRole.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<GeoRole> oClContext = _geoRole.Post<GeoRole, MainDBContext, ICLExclude, ICLSingle>("PostGeoRole");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoRole> PatchGeoRole(GeoRole _geoRole)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _geoRole.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<GeoRole> oClContext = _geoRole.Patch<GeoRole, MainDBContext>("PatchGeoRole");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<GeoConfig>> GetGeoConfigsByGeoRole(int _geoRoleId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<GeoConfig>> oClContext = Services
                .Execute<GeoConfig, MainDBContext, int>("GetGeoConfigsByGeoRole", _geoRoleId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<GeoConfig>> PatchGeoConfigsByGeoRole(int _geoRoleId,
            IEnumerable<GeoConfig> _geoConfigs)
        {
            LogManager.Record("BINDING ENTITIES");
            LogManager.Enter();
            LogManager.Record($"REQUESTING DELETE OBJECT");

            CLContext<IEnumerable<GeoConfig>> oClContext = Services
                .Execute<GeoConfig, MainDBContext, int>("DeleteGeoConfigsByGeoRole", _geoRoleId).Patch();

            LogManager.Record("REQUESTED COMPLETED");
            LogManager.Enter();

            if (_geoConfigs is null)
            {
                return new CLContext<IEnumerable<GeoConfig>>()
                {
                    Code = System.Net.HttpStatusCode.NoContent,
                };
            }

            string currentUserEmail = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _geoConfigs.Where(x => x.IsActive).ToList().ForEach(_x =>
            {
                LogManager.Record($"REQUESING POST OBJECT {_x.Id}");

                // I discard this result because i dont need it
                // _ = Services.Execute<CartesianEntity<int, int, string>, GeoConfig, MainDBContext>(
                //     "PostGeoRolesByGeoConfigs", new CartesianEntity<int, int, string>()
                //     {
                //         AKey = _x.Id,
                //         BKey = _geoRoleId,
                //         CKey = currentUserEmail
                //     },"").Patch();
                GeoConfigByGeoRole oGeoConfigByGeoRole = new GeoConfigByGeoRole()
                {
                    GeoConfigId = _x.Id,
                    GeoRoleId = _geoRoleId,
                    CreatedBy = currentUserEmail,
                    IsActive = _x.IsActive
                };

                CLContext<GeoConfigByGeoRole> clContext = Services
                    .Execute<GeoConfigByGeoRole, MainDBContext, ICLInclude, ICLSingle>(
                        "PostGeoRolesByGeoConfigs",
                        oGeoConfigByGeoRole,
                        new string[]
                        {
                            "CreatedBy", "GeoConfigId", "GeoRoleId", "IsActive"
                        })
                    .Post();

                LogManager.Record($"REQUEST COMPLETED");
                LogManager.Enter();
            });

            LogManager.Record("ENTITY BINDING ENDED");

            return oClContext;
        }

        public static CLContext<IEnumerable<Role>> GetGeoRolesByUser(int _userId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<Role>> oClContext =
                Services.Execute<Role, MainDBContext, int>("GetGeoRolesByUser", _userId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<GeoRole>> PatchGeoRolesByUser(int _userId, int _companyId,
            IEnumerable<GeoRole> _geoRoles)
        {
            LogManager.Record("BINDING ENTITIES");
            LogManager.Enter();
            LogManager.Record($"REQUESTING DELETE OBJECT");

            CLContext<IEnumerable<GeoRole>> oClContext =
                Services.Execute<CartesianEntity<int, int>, GeoRole, MainDBContext>("DeleteGeoRolesByUser",
                    new CartesianEntity<int, int>()
                    {
                        AKey = _userId,
                        BKey = _companyId
                    }).Patch();

            LogManager.Record("REQUESTED COMPLETED");
            LogManager.Enter();

            if (_geoRoles is null)
            {
                return oClContext;
            }

            string currentUserEmail = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            _geoRoles.ToList().ForEach(_x =>
            {
                LogManager.Record($"REQUESING POST OBJECT {_x.Id}");

                // I discard this result because i dont need it
                oClContext = Services.Execute<CartesianEntity<int, int, int, string>, GeoRole, MainDBContext>(
                    "PostUserGeoRoleByCompany", new CartesianEntity<int, int, int, string>()
                    {
                        AKey = _companyId,
                        BKey = _userId,
                        CKey = _x.Id,
                        DKey = currentUserEmail
                    }).Patch();

                LogManager.Record($"REQUEST COMPLETED");
                LogManager.Enter();
            });

            LogManager.Record("ENTITY BINDING ENDED");

            return oClContext;
        }

        public static CLContext<IEnumerable<GeoRole>> GetUserGeoRolesByCompany(int _userId, int _companyId,
            IEnumerable<GeoRole> _geoRoles)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<GeoRole>> oClContext = Services
                .Execute<CartesianEntity<int, int>, GeoRole, MainDBContext>("GetUserGeoRolesbyCompany",
                    new CartesianEntity<int, int>()
                    {
                        AKey = _companyId,
                        BKey = _userId,
                    }).Get();

            LogManager.Record("REQUEST ENDED");

            return oClContext;
        }

        #endregion

        #region Geo Config

        public static CLContext<IEnumerable<GeoConfig>> GetGeoConfigs()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<GeoConfig>> oClContext =
                Services.Execute<GeoConfig, MainDBContext>("GetGeoConfigs").Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoConfig> GetGeoConfig(int _geoConfigId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<GeoConfig> oClContext = Services
                .Execute<GeoConfig, MainDBContext, int, ICLSingle>("GetGeoConfig", _geoConfigId).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoConfig> PostGeoConfig(GeoConfig _geoConfig)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            _geoConfig.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<GeoConfig> oClContext = _geoConfig.Post<GeoConfig, MainDBContext>("PostGeoConfig");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<GeoConfig> PatchGeoConfig(GeoConfig _geoConfig)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _geoConfig.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            CLContext<GeoConfig> oClContext = _geoConfig.Patch<GeoConfig, MainDBContext>("PatchGeoConfig");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static CLContext<IEnumerable<GeoConfigByUser>> GetGeoConfigsByUser(int _userId, int _companyId)
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<GeoConfigByUser>> oClContext = Services
                .Execute<FilterGeoConfigByUser, GeoConfigByUser, MainDBContext>("GetGeoConfigsByUser",
                    new FilterGeoConfigByUser()
                    {
                        UserId = (_userId == -1 || _userId == 0) ? CL.COMMON.Core.GetClaimUserId() : _userId,
                        CompanyId = (_companyId == -1 || _companyId == 0) ? GetCompanyId() : _companyId
                    }).Get();

            LogManager.Record("REQUESTING COMPLETED");

            return oClContext;
        }

        #endregion

        #region Route Assignment

        public static CLContext<IEnumerable<PresentationRoute>> GetAssignedRoutes(int _assignId)
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<PresentationRoute>> oClContext =
                Services.Execute<PresentationRoute, MainDBContext, int>("GetAssignedRoutes", _assignId, "@AssignId");

            LogManager.Record($"REQUESTED RECORDS");

            return oClContext;
        }

        public static CLContext<IEnumerable<RouteAssignment>> GetRouteAssignment(int _routeId)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<IEnumerable<RouteAssignment>> oClContext =
                Services.Execute<RouteAssignment, MainDBContext, int>("GetRouteAssignment", _routeId, "@RouteId");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        public static async System.Threading.Tasks.Task<CLContext<List<RouteAssignment>>> PostRouteAssignment(
            List<RouteAssignment> _routeAssignments)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            List<RouteAssignment> routeAssigmentList = new List<RouteAssignment>();

            foreach (var routeAssigment in _routeAssignments)
            {
                routeAssigment.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                CLContext<RouteAssignment> oClContext =
                    routeAssigment.Post<RouteAssignment, MainDBContext, ICLExclude, ICLSingle>("PostRouteAssignment",
                        "UserAssign");

                if(oClContext.Response.Data is object)
                {
                    routeAssigmentList.Add(oClContext.Response.Data);
                }
            }

            LogManager.Record($"REQUEST COMPLETED");

            return new CLContext<List<RouteAssignment>>()
            {
                Code = HttpStatusCode.OK,
                value = routeAssigmentList,
                Response = new Response<List<RouteAssignment>>()
                {
                    Data = routeAssigmentList
                }
            };
        }


        public static async System.Threading.Tasks.Task<CLContext<List<RouteAssignment>>> PatchRouteAssignment(
            List<RouteAssignment> _routeAssignments)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            List<RouteAssignment> routeAssigmentList = new List<RouteAssignment>();

            foreach (var routeAssigment in _routeAssignments)
            {
                routeAssigment.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                CLContext<RouteAssignment> oClContext =
                    routeAssigment.Patch<RouteAssignment, MainDBContext, ICLExclude, ICLSingle>("PatchRouteAssignment",
                        "UserAssign");

                if (oClContext.Response.Data is object)
                {
                    routeAssigmentList.Add(oClContext.Response.Data);
                }
            }

            LogManager.Record($"REQUEST COMPLETED");

            return new CLContext<List<RouteAssignment>>()
            {
                Code = HttpStatusCode.OK,
                value = routeAssigmentList,
                Response = new Response<List<RouteAssignment>>()
                {
                    Data = routeAssigmentList
                }
            };
        }

        public static CLContext<bool> CreateRouteAssignments(List<RouteAssignment> _assigns, int _routeId)
        {
            #region Validaciones

            if ((_assigns is object) && _assigns.Any(ra => ra.RouteId != _routeId))
            {
                throw new Exception("Hay algunos usuarios de ruta que no coinciden con la ruta indicada");
            }

            #endregion

            #region Obtener usuarios actuales de la ruta

            LogManager.Record("OBTAINING ROUTE ASSIGNMENT USERS...");

            IEnumerable<RouteAssignment> routeAssignments = GetRouteAssignment(_routeId).Response.Data;

            #endregion

            #region Eliminar todos los usuarios de la ruta

            if (!(_assigns is object) || !_assigns.Any())
            {
                CLContext<Common.SingleValue<bool>> oClContext =
                    Services.Execute<Common.SingleValue<bool>, MainDBContext, int, ICLSingle>(
                        "DeleteRouteAssignments", _routeId,
                        "@RouteId");
                return new CLContext<bool>()
                {
                    Response = new Response<bool>()
                    {
                        Data = oClContext.Response.Data?.Value ?? false,
                        Message = oClContext.Response.Message
                    },
                    Code = oClContext.Code
                };
            }

            #endregion

            #region Seleccionar y eliminar de base de datos los usuarios de ruta que fueron removidos de la ruta

            if (routeAssignments is object)
            {
                List<RouteAssignment> routeAssignmentsToDelete = routeAssignments.Aggregate(
                    new List<RouteAssignment>(),
                    (_list, _assignment) =>
                    {
                        if (!_assigns.Any(ra => ra.UserAssignId == _assignment.UserAssignId))
                        {
                            _list.Add(_assignment);
                        }

                        return _list;
                    });

                foreach (RouteAssignment ra in routeAssignmentsToDelete)
                {
                    Services.Execute<Common.SingleValue<bool>, MainDBContext, int, ICLSingle>(
                        "DeleteRouteAssignment", ra.Id,
                        "@RouteAssignmentId");
                }
            }

            #endregion

            #region Agregar nuevos usuarios a la ruta

            LogManager.Record("SENDING OBJECTS TO CREATE...");

            List<RouteAssignment> assignmentToAdd = _assigns.Aggregate(new List<RouteAssignment>(),
                (_list, _assignment) =>
                {
                    if (!routeAssignments.Any(a => a.UserAssignId == _assignment.UserAssignId))
                    {
                        _list.Add(_assignment);
                    }

                    return _list;
                });

            string createdBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            bool allCreated = true;

            string errorMessage = String.Empty;

            foreach (RouteAssignment assign in assignmentToAdd)
            {
                assign.CreatedBy = createdBy;
                CLContext<RouteAssignment> oClContextRouteAssignment =
                    assign.Post<RouteAssignment, MainDBContext, ICLExclude, ICLSingle>("PostRouteAssignment",
                        "Route", "UserAssign");
                if (allCreated && !(oClContextRouteAssignment.Response.Data is object))
                {
                    allCreated = false;
                    errorMessage = oClContextRouteAssignment.Response.Message;
                }
            }

            #endregion

            return new CLContext<bool>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<bool>()
                {
                    Data = allCreated,
                    Message = allCreated
                        ? ""
                        : $"No se pudo agregar todo los usuarios de la ruta. Detalles: {errorMessage}"
                }
            };
        }

        #endregion

        #region Guide Tour Groups

        public static CLContext<IEnumerable<GuideTourGroup>> GetGuideTourGroups()
        {
            LogManager.Record("REQUESTING GUIDE TOURS GROUPS...");

            CLContext<IEnumerable<GuideTourGroup>> oClContextGuideTourGroups =
                Services.Execute<GuideTourGroup, MainDBContext>("GetGuideTourGroups");

            LogManager.Record("GUIDE TOUR GROUPS REQUESTED");

            return oClContextGuideTourGroups;
        }

        public static CLContext<IEnumerable<GuideTourGroup>> GetGuideTourGroupByCode(string _groupCode)
        {
            LogManager.Record($"REQUESTING GUIDE TOURS GROUPS... | CODE: {_groupCode}");

            CLContext<IEnumerable<GuideTourGroup>> oClContextGuideTourGroups =
                Services.Execute<GuideTourGroup, MainDBContext, string>("GetGuideTourGroupsByCode", _groupCode,
                    "@Code");

            LogManager.Record("GUIDE TOUR GROUPS REQUESTED");

            return oClContextGuideTourGroups;
        }

        public static CLContext<IEnumerable<GuideTourStep>> GetGuideTourStepsByGroupCode(string _groupCode)
        {
            LogManager.Record($"REQUESTING GUIDE TOUR STEPS... | GROUP CODE: {_groupCode}");

            CLContext<IEnumerable<GuideTourStep>> oClContextGuideTourSteps =
                Services.Execute<GuideTourStep, MainDBContext, string>("GetGuideTourStepsByGroupCode", _groupCode,
                    "@GroupCode");

            LogManager.Record("GUIDE TOUR STEPS REQUESTED");

            return oClContextGuideTourSteps;
        }

        #endregion

        #region Guide tour steps

        public static CLContext<IEnumerable<GuideTourStep>> GetGuideTourSteps()
        {
            LogManager.Record("REQUESTING GUIDE TOUR STEPS...");

            CLContext<IEnumerable<GuideTourStep>> oClContextGuideTourSteps =
                Services.Execute<GuideTourStep, MainDBContext>("GetGuideTourSteps");

            LogManager.Record("GUIDE TOUR STEPS REQUESTED");

            return oClContextGuideTourSteps;
        }

        #endregion

        #region Citas Outlook

        private static async Task<ExchangeService> GetExchangeService(UserCalendarCredentials _UCC)
        {
            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            CLContext<SchedulingSetting[]> oClContextSchedulingSettings =
                GetSettingByCode<SchedulingSetting[]>("SchedulingConfiguration");

            if (!(oClContextSchedulingSettings.Response.Data is object)) return null;

            SchedulingSetting scheduling =
                oClContextSchedulingSettings.Response.Data.FirstOrDefault(s => s.CompanyId == companyId);

            if (!(scheduling is object) || !scheduling.UseScheduling) return null;

            ExchangeService service = null;

            if (!String.IsNullOrEmpty(scheduling.OutlookServiceURL))
            {
                TimeZoneInfo timeZone = TimeZoneInfo.GetSystemTimeZones()
                    .FirstOrDefault(tz => tz.Id == "Central America Standard Time");

                service = new ExchangeService(ExchangeVersion.Exchange2013, timeZone);

                service.Credentials = new WebCredentials(_UCC.Email, _UCC.EmailPassword);

                service.Url = new Uri(scheduling.OutlookServiceURL);

                service.UseDefaultCredentials = false;
                // try
                // {
                //     AuthenticationResult token = await GetEWSUserToken();
                //
                //     if (!(token is object)) return null;
                //
                //     //Para obtener esta URL debe ejecutar el metodo de AutodiscoverUrl de la Clase ExchangeService.
                //     service.Url = new Uri(scheduling.OutlookServiceURL);
                //     service.Credentials = new OAuthCredentials(token.AccessToken);
                //     service.ImpersonatedUserId = new ImpersonatedUserId(ConnectingIdType.SmtpAddress, _UCC.Email);
                // }
                // catch (Exception e)
                // {
                //     throw new Exception($"An error occurs requesting user token. Details: {e.Message}");
                // }
            }

            return service;
        }

        private static async System.Threading.Tasks.Task AssignOutlookAppointment(int _routeId, RouteAssignment _RAA,
            UserCalendarCredentials _UCC)
        {
            try
            {
                CLContext<IEnumerable<RouteInfoForAppointment>> oClContextRouteInfo =
                    Services.Execute<RouteInfoForAppointment, MainDBContext, int>("GetRouteInfoForAppointment",
                        _routeId, "@RouteId");


                if ((oClContextRouteInfo.Response.Data is object) && oClContextRouteInfo.Response.Data.Any())
                {
                    List<RouteInfoForAppointment> routes = oClContextRouteInfo.Response.Data.ToList();

                    DateTime routeExpirationDate = routes[0].ExpirationDate;

                    if (routeExpirationDate <= DateTime.Today) throw new Exception("La ruta ha expirado");

                    ExchangeService service = await GetExchangeService(_UCC);

                    if (service == null)
                        throw new Exception(
                            "No se le pueden aplicar el proceso de calendarización, debido a que la compañía aun no lo ha configurado");

                    Appointment appointment = null;

                    CalendarAppointment CalAppointment = null;

                    string allocator = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                    List<int> days = CastFrequencyDaysToInt(routes[0].Days.Split('.').ToList());

                    List<int> weeks = CastFrequencyWeeksToInt(routes[0].Weeks.Split('.').ToList());

                    DayOfTheWeek[] dow = SetDaysOfTheWeek<DayOfTheWeek>(days);

                    DateTime startDate = GetStartDateOfRecurrence(DateTime.Today, days, weeks);

                    if (weeks.Count < 4)
                    {
                        bool isOneWeek = weeks.Count == 1;

                        List<DateTime> startDates =
                            GetAllStartDatesOfRecurrence(startDate, routeExpirationDate, days, weeks, isOneWeek);

                        foreach (RouteInfoForAppointment route in routes)
                        {
                            List<int> visitingTime = GetRoutePointVisitingTime(route.VisitingTime);

                            foreach (DateTime iDate in startDates)
                            {
                                DateTime date = iDate.AddHours(visitingTime.First()).AddMinutes(visitingTime.Last());

                                appointment = SetInstanceOfAppointment(service, date, dow, route, days,
                                    routeExpirationDate);

                                appointment.Save(SendInvitationsMode.SendToNone);

                                CalAppointment = new CalendarAppointment()
                                {
                                    AppointmentId = appointment.Id.UniqueId,
                                    RouteAssignmentId = _RAA.Id,
                                    Domain = 1,
                                    CreatedBy = allocator,
                                    Status = 1,
                                    RouteLineId = route.RouteLineId
                                };

                                SaveCalendarAppointment(CalAppointment);
                            }
                        }
                    }
                    else
                    {
                        foreach (RouteInfoForAppointment route in routes)
                        {
                            if (startDate >= route.ExpirationDate)
                                throw new Exception(
                                    "Fecha de inicio de la ruta supera la fecha de expiración de la ruta");

                            List<int> visitingTime = GetRoutePointVisitingTime(route.VisitingTime);

                            DateTime date = startDate.AddHours(visitingTime.First()).AddMinutes(visitingTime.Last());

                            appointment = SetInstanceOfAppointment(service, date, dow, route, days,
                                route.ExpirationDate, false);

                            appointment.Save(SendInvitationsMode.SendToNone);

                            CalAppointment = new CalendarAppointment()
                            {
                                AppointmentId = appointment.Id.UniqueId,
                                RouteAssignmentId = _RAA.Id,
                                Domain = 1,
                                CreatedBy = allocator,
                                Status = 1,
                                RouteLineId = route.RouteLineId
                            };

                            SaveCalendarAppointment(CalAppointment);
                        }
                    }
                }
            }
            catch (ServiceRequestException ex)
            {
                throw new Exception(
                    "Ocurrió un error al tratar de agendar las citas, verifique que el correo y contraseña del usuario asignado a la ruta sean correctos, ó desactive la calendarización de esté usuario." +
                    ex.Message);
            }
            catch (Exception ex)
            {
                throw new Exception(
                    "Ocurrió un error al tratar de agendar las citas, por favor vuelva a reasignar la ruta nuevamente. Detalle: " +
                    ex.Message);
            }
        }

        private static Appointment SetInstanceOfAppointment(ExchangeService service, DateTime _startDate,
            DayOfTheWeek[] _dow, RouteInfoForAppointment _routeInfoFor,
            List<int> _days, DateTime _expirationDate, bool _hasNumberOfOcurrences = true)
        {
            string routeType = GetRouteType(_routeInfoFor.Type);

            string appointmentBody =
                $"<div style='text-align:center; border:1px solid black; padding:20px;'><p><b>{_routeInfoFor.Name.ToUpper()}</b></p></div>" +
                $"<div style='text-align:center; border:1px solid black; padding:30px;'><p style='margin:10px 0px;'><b>TIPO DE RUTA:</b> {routeType}</p><br>" +
                $"<p style='margin:10px 0px;'><b>PARA:</b> {_routeInfoFor.CardName.ToUpper()}</p><br>" +
                $"<p style='margin:10px 0px;'><b>UBICACION EN GOOGLE MAPS:</b> <a href='https://www.google.com/maps/@{_routeInfoFor.Latitude},{_routeInfoFor.Longitude},19z?hl=es' style='text-decoration:none;'>{_routeInfoFor.Address.ToUpper()}</a></p></div>";

            Appointment appointment = new Appointment(service);

            TimeZoneInfo timeZone = TimeZoneInfo.GetSystemTimeZones()
                .FirstOrDefault(tz => tz.Id == "Central America Standard Time");

            List<int> endDate = GetRoutePointVisitingTime(_routeInfoFor.VisitEndTime);

            appointment.Subject = _routeInfoFor.Name;

            appointment.Body = appointmentBody;

            appointment.Start = _startDate;

            appointment.StartTimeZone = timeZone;

            appointment.IsAllDayEvent = false;

            appointment.End = _startDate.Date.AddHours(endDate.First()).AddMinutes(endDate.Last());

            appointment.EndTimeZone = timeZone;

            appointment.Location = _routeInfoFor.Address;

            appointment.ReminderMinutesBeforeStart = 60;

            appointment.Recurrence = new Recurrence.WeeklyPattern(_startDate.Date, 1, _dow);

            if (_hasNumberOfOcurrences)
            {
                appointment.Recurrence.NumberOfOccurrences = GetNumberOfOccurrences(_startDate, _expirationDate, _days);
            }
            else
            {
                appointment.Recurrence.EndDate = _expirationDate.Date.AddDays(-1);
            }

            return appointment;
        }

        private static T[] SetDaysOfTheWeek<T>(List<int> _days)
        {
            return _days.Select(d => (T)Enum.Parse(typeof(T), d.ToString())).ToArray();
        }

        private static async System.Threading.Tasks.Task UnassignOutlookAppointment(RouteAssignment _RAA,
            UserCalendarCredentials _UCC)
        {
            ExchangeService service = await GetExchangeService(_UCC);

            if (service != null)
            {
                CLContext<IEnumerable<CalendarAppointment>> oClContextCalendarAppts =
                    GetRouteAssignmentCalendarAppointments(_RAA.Id);

                if ((oClContextCalendarAppts.Response.Data is object) && oClContextCalendarAppts.Response.Data.Any())
                {
                    List<CalendarAppointment> appointmentIds = oClContextCalendarAppts.Response.Data.ToList();

                    List<ItemId> ids = new List<ItemId>();

                    foreach (CalendarAppointment item in appointmentIds)
                    {
                        ids.Add(item.AppointmentId);
                    }

                    int deleteMode =
                        CL.COMMON.Core.GetConfigKeyValue<int>(System.Reflection.MethodBase.GetCurrentMethod(),
                            "TypeOfDeletionAppointment");

                    service.DeleteItems(ids, (DeleteMode)deleteMode, SendCancellationsMode.SendToNone,
                        AffectedTaskOccurrence.SpecifiedOccurrenceOnly);

                    foreach (CalendarAppointment appt in appointmentIds)
                    {
                        UpdateCalendarApptStatus(appt);
                    }
                }
            }
        }

        private static async System.Threading.Tasks.Task UpdateOutlookAppointment(int _routeId, RouteAssignment _RAA,
            UserCalendarCredentials _UCC)
        {
            try
            {
                await UnassignOutlookAppointment(_RAA, _UCC);

                await AssignOutlookAppointment(_routeId, _RAA, _UCC);
            }
            catch (Exception ex)
            {
                throw new Exception("Ocurrió un error al intentar modificar las citas. Detalle: " + ex.Message);
            }
        }

        private static async System.Threading.Tasks.Task DeleteIncompleteOutlookAppointments(int _routeId,
            RouteAssignment _RAA, UserCalendarCredentials _UCC)
        {
            try
            {
                ExchangeService service = await GetExchangeService(_UCC);

                if (service != null)
                {
                    CLContext<IEnumerable<CalendarAppointment>> oClContextCalendarAppts =
                        GetRouteAssignmentCalendarAppointments(_RAA.Id);

                    if ((oClContextCalendarAppts.Response.Data is object) &&
                        oClContextCalendarAppts.Response.Data.Any())
                    {
                        List<CalendarAppointment> appointmentIds = oClContextCalendarAppts.Response.Data.ToList();

                        List<ItemId> ids = new List<ItemId>();

                        DateTime currentDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);

                        Appointment appointment = Appointment.Bind(service, appointmentIds.Last().AppointmentId,
                            new PropertySet(AppointmentSchema.LastOccurrence, ItemSchema.ParentFolderId));

                        CalendarView view = new CalendarView(currentDate, appointment.LastOccurrence.End)
                        {
                            PropertySet = new PropertySet(BasePropertySet.IdOnly, AppointmentSchema.Start,
                                AppointmentSchema.AppointmentType)
                        };

                        FindItemsResults<Appointment>
                            items = service.FindAppointments(appointment.ParentFolderId, view);

                        CalendarAppointment UA = null;

                        foreach (Appointment item in items)
                        {
                            bool IsCompleted = false;

                            if (item.AppointmentType == AppointmentType.Occurrence)
                            {
                                Appointment master = Appointment.BindToRecurringMaster(service, item.Id,
                                    new PropertySet(BasePropertySet.IdOnly));

                                UA = appointmentIds.Find(a => a.AppointmentId == master.Id.UniqueId);

                                if (UA != null && item.Start >= currentDate)
                                {
                                    if (item.Start == currentDate)
                                    {
                                        int checkStatus = GetRouteLineCheckStatus(UA.RouteLineId);

                                        IsCompleted = checkStatus == 0 || checkStatus == 1;
                                    }

                                    if (!IsCompleted)
                                    {
                                        ids.Add(item.Id);
                                    }
                                }
                            }
                        }

                        if (ids.Count > 0)
                        {
                            int deleteMode = CL.COMMON.Core.GetConfigKeyValue<int>(
                                System.Reflection.MethodBase.GetCurrentMethod(), "TypeOfDeletionAppointment");

                            service.DeleteItems(ids, (DeleteMode)deleteMode, SendCancellationsMode.SendToNone,
                                AffectedTaskOccurrence.SpecifiedOccurrenceOnly);
                        }

                        foreach (CalendarAppointment item in appointmentIds)
                        {
                            UpdateCalendarApptStatus(item);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw new Exception("Hubo un error al desasignar las citas por cierre de ruta. Detalle: " + ex.Message);
            }
        }

        #endregion

        #region Citas Gmail

        private static CalendarService GetCalendarService()
        {
            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            CLContext<SchedulingSetting[]> oClContextSchedulingSettings =
                GetSettingByCode<SchedulingSetting[]>("SchedulingConfiguration");

            if (!(oClContextSchedulingSettings.Response.Data is object)) return null;

            SchedulingSetting scheduling =
                oClContextSchedulingSettings.Response.Data.FirstOrDefault(s => s.CompanyId == companyId);

            if (!(scheduling is object) || !scheduling.UseScheduling) return null;

            ServiceAccountCredential credential = null;

            CalendarService service = null;

            string applicationName = "ClvsRoute";

            if (!String.IsNullOrEmpty(scheduling.GmailServiceAccount) &&
                !String.IsNullOrEmpty(scheduling.GmailServiceAccountPassword))
            {
                string serviceAccountPrivateKey = scheduling.GmailServiceAccountPassword;

                serviceAccountPrivateKey = serviceAccountPrivateKey.Replace("\\n", "\n");

                credential = new ServiceAccountCredential(
                    new ServiceAccountCredential.Initializer(scheduling.GmailServiceAccount)
                    {
                        Scopes = new[] { CalendarService.Scope.Calendar }
                    }.FromPrivateKey(serviceAccountPrivateKey)
                );

                service = new CalendarService(new BaseClientService.Initializer()
                {
                    HttpClientInitializer = credential,
                    ApplicationName = applicationName,
                });
            }

            return service;
        }

        private static void AssignGmailAppointment(int _routeId, RouteAssignment _RAA, UserCalendarCredentials _UCC)
        {
            CLContext<IEnumerable<RouteInfoForAppointment>> oClContextRouteInfo =
                Services.Execute<RouteInfoForAppointment, MainDBContext, int>("GetRouteInfoForAppointment",
                    _routeId, "@RouteId");


            if ((oClContextRouteInfo.Response.Data is object) && oClContextRouteInfo.Response.Data.Any())
            {
                List<RouteInfoForAppointment> routes = oClContextRouteInfo.Response.Data.ToList();
                DateTime routeExpiratioDate = routes[0].ExpirationDate;

                if (routeExpiratioDate <= DateTime.Today) throw new Exception("La ruta ha expirado");

                CalendarService service = GetCalendarService();

                if (service == null)
                    throw new Exception(
                        "No se le pueden aplicar el proceso de calendarización, debido a que la compañía aun no lo ha configurado");

                string allocator = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

                List<int> days = CastFrequencyDaysToInt(routes[0].Days.Split('.').ToList());

                List<int> weeks = CastFrequencyWeeksToInt(routes[0].Weeks.Split('.').ToList());

                List<string> dow = SetDaysOfTheWeek<GmailCalendarDaysOfWeek>(days).Select(d => d.ToString()).ToList();

                DateTime startDate = GetStartDateOfRecurrence(DateTime.Today, days, weeks);

                if (weeks.Count < 4)
                {
                    bool isOneWeek = weeks.Count == 1;

                    List<DateTime> startDates =
                        GetAllStartDatesOfRecurrence(startDate, routeExpiratioDate, days, weeks, isOneWeek);

                    foreach (RouteInfoForAppointment route in routes)
                    {
                        List<int> visitingTime = GetRoutePointVisitingTime(route.VisitingTime);

                        foreach (DateTime iDate in startDates)
                        {
                            DateTime date = iDate.AddHours(visitingTime.First()).AddMinutes(visitingTime.Last());

                            Event appointment = SetGmailAppointment(date, dow, route, days, routeExpiratioDate);

                            Event appointmentCreated = service.Events.Insert(appointment, _UCC.Email).Execute();

                            CalendarAppointment CA = new CalendarAppointment()
                            {
                                AppointmentId = appointmentCreated.Id,
                                RouteAssignmentId = _RAA.Id,
                                Domain = 2,
                                CreatedBy = allocator,
                                Status = 1,
                                RouteLineId = route.RouteLineId
                            };

                            SaveCalendarAppointment(CA);
                        }
                    }
                }
                else
                {
                    foreach (RouteInfoForAppointment route in routes)
                    {
                        if (startDate >= route.ExpirationDate)
                            throw new Exception("Fecha de inicio de la ruta supera la fecha de expiración de la ruta");

                        List<int> visitingTime = GetRoutePointVisitingTime(route.VisitingTime);

                        DateTime date = startDate.AddHours(visitingTime.First()).AddMinutes(visitingTime.Last());

                        Event appointment = SetGmailAppointment(date, dow, route, days, routeExpiratioDate, false);

                        Event appointmentCreated = service.Events.Insert(appointment, _UCC.Email).Execute();

                        CalendarAppointment CA = new CalendarAppointment()
                        {
                            AppointmentId = appointmentCreated.Id,
                            RouteAssignmentId = _RAA.Id,
                            Domain = 2,
                            CreatedBy = allocator,
                            Status = 1,
                            RouteLineId = route.RouteLineId
                        };

                        SaveCalendarAppointment(CA);
                    }
                }
            }
        }

        private static Event SetGmailAppointment(DateTime _startDate, List<string> _dow,
            RouteInfoForAppointment _routeInfoFor,
            List<int> _days, DateTime _expirationDate, bool _hasNumberOfOcurrences = true)
        {
            string routeType = GetRouteType(_routeInfoFor.Type);

            string appointmentBody =
                $"<div style='text-align:center; border:1px solid black; padding:7px;'><p><b>{_routeInfoFor.Name.ToUpper()}</b></p></div>" +
                $"<div style='text-align:center; border:1px solid black; padding:7px;'><p style='margin:10px 0px;'><b>TIPO DE RUTA:</b> {routeType}</p><br>" +
                $"<p style='margin:10px 0px;'><b>PARA:</b> {_routeInfoFor.CardName.ToUpper()}</p><br>" +
                $"<p style='margin:10px 0px;'><b>UBICACION EN GOOGLE MAPS:</b> <a href='https://www.google.com/maps/@{_routeInfoFor.Latitude},{_routeInfoFor.Longitude},19z?hl=es' style='text-decoration:none;'>{_routeInfoFor.Address.ToUpper()}</a></p></div>";

            string FREQ = "WEEKLY";

            string FREQ_DAYS = string.Join(",", _dow);

            List<int> endDate = GetRoutePointVisitingTime(_routeInfoFor.VisitEndTime);

            Event appointment = new Event();

            appointment.Start = new EventDateTime() { DateTime = _startDate, TimeZone = "America/Costa_Rica" };

            appointment.End = new EventDateTime()
            {
                DateTime = _startDate.Date.AddHours(endDate.First()).AddMinutes(endDate.Last()),
                TimeZone = "America/Costa_Rica"
            };

            appointment.Summary = _routeInfoFor.Name;

            appointment.Description = appointmentBody;

            appointment.Location = _routeInfoFor.Address;

            if (_hasNumberOfOcurrences)
            {
                string FREQ_COUNT = GetNumberOfOccurrences(_startDate, _expirationDate, _days).ToString();

                string RRULE = $"RRULE:FREQ={FREQ};COUNT={FREQ_COUNT};BYDAY={FREQ_DAYS};INTERVAL=1";

                appointment.Recurrence = new List<string>() { RRULE };
            }
            else
            {
                DateTime lastOccurence = _expirationDate.Date;

                string FREQ_UNTIL = lastOccurence.ToString("yyyyMMdd");

                string RRULE = $"RRULE:FREQ={FREQ};BYDAY={FREQ_DAYS};UNTIL={FREQ_UNTIL};INTERVAL=1";

                appointment.Recurrence = new List<string>() { RRULE };
            }

            return appointment;
        }

        private static void UnassignGmailAppointment(RouteAssignment _RAA, UserCalendarCredentials _UCC)
        {
            CalendarService service = GetCalendarService();

            if (service != null)
            {
                CLContext<IEnumerable<CalendarAppointment>> oClContextCalendarAppts =
                    GetRouteAssignmentCalendarAppointments(_RAA.Id);

                if ((oClContextCalendarAppts.Response.Data is object) && oClContextCalendarAppts.Response.Data.Any())
                {
                    List<CalendarAppointment> appointmentIds = oClContextCalendarAppts.Response.Data.ToList();

                    foreach (CalendarAppointment item in appointmentIds)
                    {
                        try
                        {
                            service.Events.Delete(_UCC.Email, item.AppointmentId).Execute();
                        }
                        catch (Google.GoogleApiException ex)
                        {
                            if (ex.Error.Code == 410)
                            {
                                continue;
                            }
                            else
                            {
                                throw ex;
                            }
                        }
                    }

                    foreach (CalendarAppointment data in appointmentIds)
                    {
                        UpdateCalendarApptStatus(data);
                    }
                }
            }
        }

        private static void DeleteIncompleteGmailAppointments(int _routeId, RouteAssignment _RAA,
            UserCalendarCredentials _UCC)
        {
            try
            {
                CalendarService service = GetCalendarService();

                if (service != null)
                {
                    CLContext<IEnumerable<CalendarAppointment>> oClContextCalendarAppts =
                        GetRouteAssignmentCalendarAppointments(_RAA.Id);

                    if ((oClContextCalendarAppts.Response.Data is object) &&
                        oClContextCalendarAppts.Response.Data.Any())
                    {
                        List<CalendarAppointment> appointmentIds = oClContextCalendarAppts.Response.Data.ToList();

                        List<string> ids = new List<string>();

                        DateTime currentDate = DateTime.Today;

                        int lastRouteLineId = 0;

                        bool deleteAllRecurrence = false;

                        foreach (CalendarAppointment ev in appointmentIds)
                        {
                            if (ev.RouteLineId != lastRouteLineId)
                            {
                                deleteAllRecurrence = false;
                            }

                            if (!deleteAllRecurrence)
                            {
                                lastRouteLineId = ev.RouteLineId;

                                Events evInstances = service.Events.Instances(_UCC.Email, ev.AppointmentId).Execute();

                                foreach (Event occurence in evInstances.Items)
                                {
                                    bool IsCompleted = false;

                                    DateTime occurenceStart =
                                        ConvertGmailAppointmentDateToDateTime(occurence.Start.Date);

                                    if (occurenceStart >= currentDate)
                                    {
                                        if (occurenceStart == currentDate)
                                        {
                                            int checkStatus = GetRouteLineCheckStatus(ev.RouteLineId);

                                            IsCompleted = checkStatus == 0 || checkStatus == 1;

                                            deleteAllRecurrence = true;
                                        }

                                        if (!IsCompleted)
                                        {
                                            ids.Add(occurence.Id);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                ids.Add(ev.AppointmentId);
                            }
                        }

                        if (ids.Count > 0)
                        {
                            foreach (string evId in ids)
                            {
                                try
                                {
                                    service.Events.Delete(_UCC.Email, evId).Execute();
                                }
                                catch (Google.GoogleApiException ex)
                                {
                                    if (ex.Error.Code == 410)
                                    {
                                        continue;
                                    }
                                    else
                                    {
                                        throw ex;
                                    }
                                }
                            }
                        }

                        foreach (CalendarAppointment item in appointmentIds)
                        {
                            UpdateCalendarApptStatus(item);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw new Exception("Hubo un error al desasignar las citas por cierre de ruta. Detalle: " + ex.Message);
            }
        }

        private static void UpdateGmailAppointment(int _routeId, RouteAssignment _RAA, UserCalendarCredentials _UCC)
        {
            try
            {
                UnassignGmailAppointment(_RAA, _UCC);

                AssignGmailAppointment(_routeId, _RAA, _UCC);
            }
            catch (Exception ex)
            {
                throw new Exception("Ocurrió un error al intentar modificar las citas. Detalle: " + ex.Message);
            }
        }

        #endregion

        #region Citas - Metodos compartidos

        private static async System.Threading.Tasks.Task AssignAppointment(int _routeId)
        {
            CLContext<RouteAssignment> oClContextRouteAssign = GetRouteAssignmentByRouteId(_routeId);

            if (!(oClContextRouteAssign.Response.Data is object)) return;

            RouteAssignment routeAssign = oClContextRouteAssign.Response.Data;

            CLContext<User> oClContextUser = GetUserByAssignment(routeAssign.UserAssignId);

            if (!(oClContextUser.Response.Data is object)) return;

            if (!oClContextUser.Response.Data.UseScheduling) return;

            CLContext<UserCalendarCredentials> oClContextUserCalendarCredentials =
                GetUserCalendarCredentials(routeAssign.UserAssignId);

            if (!(oClContextUserCalendarCredentials.Response.Data is object)) return;

            UserCalendarCredentials userCredentials = oClContextUserCalendarCredentials.Response.Data;

            MethodBase method = MethodBase.GetCurrentMethod();

            string userAdmin = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            string userAffected = userCredentials.Email;

            LogManager.Record(
                $"[{method.DeclaringType.FullName}.{method.Name}] -- USER ASSIGNED APPOINTMENT: {userAffected}, USER ALLOCATOR APPOINTMENT: {userAdmin} | ROUTE ASSIGNED ID: {routeAssign.Id}");

            if (userCredentials.EmailType == (int)UserEmailDomain.Gmail)
            {
                AssignGmailAppointment(_routeId, routeAssign, userCredentials);
            }
            else
            {
                await AssignOutlookAppointment(_routeId, routeAssign, userCredentials);
            }
        }

        //private static async System.Threading.Tasks.Task UnassignAppointment(int _routeAssignId)
        //{
        //    CLContext<RouteAssignment> oClContextRouteAssignment = GetRouteAssignment(_routeAssignId);

        //    if (!(oClContextRouteAssignment.Response.Data is object)) return;

        //    RouteAssignment routeAssign = oClContextRouteAssignment.Response.Data;

        //    CLContext<User> oClContextUser = GetUserByAssignment(routeAssign.UserAssignId);

        //    if (!(oClContextUser.Response.Data is object)) return;

        //    if (!oClContextUser.Response.Data.UseScheduling) return;

        //    CLContext<UserCalendarCredentials> oClContextUserCalendarCredentials =
        //        GetUserCalendarCredentials(routeAssign.UserAssignId);

        //    if (!(oClContextUserCalendarCredentials.Response.Data is object)) return;

        //    UserCalendarCredentials userCredentials = oClContextUserCalendarCredentials.Response.Data;

        //    MethodBase method = MethodBase.GetCurrentMethod();

        //    string userAdmin = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

        //    string userAffected = userCredentials.Email;

        //    LogManager.Record(
        //        $"[{method.DeclaringType.FullName}.{method.Name}] -- USER UNASSIGNED APPOINTMENT: {userAffected}, USER REMOVER APPOINTMENT: {userAdmin} | ROUTE ASSIGNED ID: {routeAssign.Id}");

        //    if (userCredentials.EmailType == (int)UserEmailDomain.Gmail)
        //    {
        //        UnassignGmailAppointment(routeAssign, userCredentials);
        //    }
        //    else
        //    {
        //        await UnassignOutlookAppointment(routeAssign, userCredentials);
        //    }
        //}

        private static async System.Threading.Tasks.Task DeleteIncompleteAppointments(int _routeId)
        {
            CLContext<RouteAssignment> oClContextRouteAssign = GetRouteAssignmentByRouteId(_routeId);

            if (!(oClContextRouteAssign.Response.Data is object)) return;

            RouteAssignment routeAssign = oClContextRouteAssign.Response.Data;

            CLContext<User> oClContextUser = GetUserByAssignment(routeAssign.UserAssignId);

            if (!(oClContextUser.Response.Data is object)) return;

            if (!oClContextUser.Response.Data.UseScheduling) return;

            CLContext<UserCalendarCredentials> oClContextUserCalendarCredentials =
                GetUserCalendarCredentials(routeAssign.UserAssignId);

            if (!(oClContextUserCalendarCredentials.Response.Data is object)) return;

            UserCalendarCredentials userCredentials = oClContextUserCalendarCredentials.Response.Data;

            MethodBase method = System.Reflection.MethodBase.GetCurrentMethod();

            string userAdmin = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            string userAffected = userCredentials.Email;

            LogManager.Record(
                $"[{method.DeclaringType.FullName}.{method.Name}] -- USER CANCELED APPOINTMENT: {userAffected}, USER REMOVER APPOINTMENT: {userAdmin} | ROUTE ASSIGNED ID: {routeAssign.Id}");

            if (userCredentials.EmailType == (int)UserEmailDomain.Gmail)
            {
                DeleteIncompleteGmailAppointments(_routeId, routeAssign, userCredentials);
            }
            else
            {
                await DeleteIncompleteOutlookAppointments(_routeId, routeAssign, userCredentials);
            }
        }

        private static async System.Threading.Tasks.Task UpdateAppointments(int _routeId)
        {
            CLContext<RouteAssignment> oClContextRouteAssign = GetRouteAssignmentByRouteId(_routeId);

            if (!(oClContextRouteAssign.Response.Data is object)) return;

            RouteAssignment routeAssign = oClContextRouteAssign.Response.Data;

            CLContext<User> oClContextUser = GetUserByAssignment(routeAssign.UserAssignId);

            if (!(oClContextUser.Response.Data is object)) return;

            if (!oClContextUser.Response.Data.UseScheduling) return;

            CLContext<UserCalendarCredentials> oClContextUserCalendarCredentials =
                GetUserCalendarCredentials(routeAssign.UserAssignId);

            if (!(oClContextUserCalendarCredentials.Response.Data is object)) return;

            UserCalendarCredentials userCredentials = oClContextUserCalendarCredentials.Response.Data;

            MethodBase method = MethodBase.GetCurrentMethod();

            string userAdmin = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            string userAffected = userCredentials.Email;

            LogManager.Record(
                $"[{method.DeclaringType.FullName}.{method.Name}] -- USER MODIFIED APPOINTMENT: {userAdmin}, USER MODIFIER APPOINTMENT: {userAffected} | ROUTE ASSIGNED ID: {routeAssign.Id}");

            if (userCredentials.EmailType == (int)UserEmailDomain.Gmail)
            {
                UpdateGmailAppointment(_routeId, routeAssign, userCredentials);
            }
            else
            {
                await UpdateOutlookAppointment(_routeId, routeAssign, userCredentials);
            }
        }

        private static List<DateTime> GetAllStartDatesOfRecurrence(DateTime _startDate, DateTime _routeExpirationDate,
            List<int> _days, List<int> _weeks, bool _oneWeekAMonth = false)
        {
            List<DateTime> startDates = new List<DateTime>();

            DateTime startDateClone = _startDate;

            int year = _startDate.Year;

            if (_oneWeekAMonth)
            {
                int initMonth = DateTime.Today.Month; //Mes en que se asigna la ruta

                int day = _startDate.Day;

                for (int month = _startDate.Month; month <= 13; month++)
                {
                    if (month > 12)
                    {
                        day = 1;
                        month = 1;
                        initMonth = 1; //Primer mes del siguiente año.
                        year++;
                    }

                    if (month > initMonth)
                    {
                        startDateClone = GetStartDateOfRecurrence(new DateTime(year, month, 1), _days, _weeks);
                    }
                    else
                    {
                        startDateClone = GetStartDateOfRecurrence(new DateTime(year, month, day), _days, _weeks);
                    }

                    if (startDateClone >= _routeExpirationDate) break;

                    startDates.Add(startDateClone);

                    if (month == _routeExpirationDate.Month && year == _routeExpirationDate.Year) break;
                }
            }
            else
            {
                DateTime FirstRecurrence = new DateTime(_startDate.Year, _startDate.Month, (_weeks[0] * 7));

                int initMonth = FirstRecurrence.Month;

                int day = 0;

                bool finishLoop = false;

                bool isVerifyDate = true; //The first date that this method resive is the initial date of recurrence

                for (int month = _startDate.Month; month <= 12; month++)
                {
                    for (int week = 0; week < _weeks.Count; week++)
                    {
                        if (week > 0)
                        {
                            day = (_weeks[week] * 7) - 6;

                            day = day < startDateClone.Day ? startDateClone.Day : day;
                        }

                        if (!isVerifyDate)
                            startDateClone =
                                GetStartDateOfRecurrence(new DateTime(startDateClone.Year, startDateClone.Month, day),
                                    _days, _weeks);

                        if (_weeks.Count != 4 && startDateClone.Day > 28) break;

                        if (startDateClone >= _routeExpirationDate)
                        {
                            finishLoop = true;
                            break;
                        }

                        if (FirstRecurrence < startDateClone && startDateClone.Month == initMonth && week == 0)
                            continue;

                        startDates.Add(startDateClone);

                        isVerifyDate = false;
                    }

                    if (month == 12)
                    {
                        month = 0;
                        year++;
                    }

                    ;

                    day = (7 * _weeks[0]) - 6;

                    startDateClone = new DateTime(year, month + 1, day);

                    if (finishLoop) break;
                }
            }

            return startDates;
        }

        private static int GetNumberOfOccurrences(DateTime _startDate, DateTime _expirationDate, List<int> _days)
        {
            int numberOfOcurrences = 0;

            int week = GetWeekOfDate(_startDate);

            int lastDayOfWeek = 7 * week;

            for (int i = _startDate.Day; i <= lastDayOfWeek; i++)
            {
                DateTime auxDate = new DateTime(_startDate.Year, _startDate.Month, i);

                if (auxDate >= _expirationDate) break;

                if (_days.Contains(Convert.ToInt32(auxDate.DayOfWeek))) numberOfOcurrences++;
            }

            return numberOfOcurrences;
        }

        private static int GetWeekOfDate(DateTime _date)
        {
            int week = 0;

            int day = _date.Day;

            for (int w = 1; w <= 4; w++)
            {
                if (day <= (w * 7))
                {
                    week = w;
                    break;
                }
            }

            return week;
        }

        private static List<int> CastFrequencyWeeksToInt(List<string> _weeks)
        {
            if (_weeks.Any(w => w == "0")) // "0" Significa todas las semanas
            {
                return new List<int> { 1, 2, 3, 4 };
            }

            return _weeks.Select(w => Convert.ToInt32(w)).ToList();
        }

        private static List<int> CastFrequencyDaysToInt(List<string> _days)
        {
            return _days.Select(str_d => Convert.ToInt32(str_d)).ToList();
        }

        private static DateTime GetStartDateOfRecurrence(DateTime _initDate, List<int> _days, List<int> _weeks)
        {
            DateTime AppointmentStartDate = new DateTime();

            DateTime Aux;

            bool hasStartDate = false;

            int DaysOfMonth = DateTime.DaysInMonth(_initDate.Year, _initDate.Month);

            foreach (int week in _weeks)
            {
                int initialDayOfWeek = (week * 7) - 6;

                int lastDayOfWeek = initialDayOfWeek + 6;

                for (int dayOfMonth = initialDayOfWeek; dayOfMonth <= DaysOfMonth; dayOfMonth++)
                {
                    Aux = new DateTime(_initDate.Year, _initDate.Month, dayOfMonth);

                    if (Aux.Day > lastDayOfWeek) break;

                    if (Aux >= _initDate)
                    {
                        if (_days.Contains(Convert.ToInt32(Aux.DayOfWeek)))
                        {
                            AppointmentStartDate = Aux;

                            hasStartDate = true;

                            break;
                        }
                    }
                }

                if (hasStartDate) break;
            }

            if (!hasStartDate)
            {
                int month, year;

                if (_initDate.Month == 12)
                {
                    year = _initDate.Year + 1;

                    month = 1;
                }
                else
                {
                    year = _initDate.Year;

                    month = _initDate.Month + 1;
                }

                DaysOfMonth = DateTime.DaysInMonth(year, month);

                foreach (int week in _weeks)
                {
                    int initialDayOfWeek = (week * 7) - 6;

                    int lastDayOfWeek = initialDayOfWeek + 6;

                    for (int dayOfMonth = initialDayOfWeek; dayOfMonth < DaysOfMonth; dayOfMonth++)
                    {
                        Aux = new DateTime(year, month, dayOfMonth);

                        if (Aux.Day > lastDayOfWeek) break;

                        if (_days.Contains(Convert.ToInt32(Aux.DayOfWeek)))
                        {
                            AppointmentStartDate = Aux;

                            hasStartDate = true;

                            break;
                        }
                    }

                    if (hasStartDate) break;
                }
            }

            return AppointmentStartDate;
        }

        private static string GetRouteType(int _routeType)
        {
            CLContext<IEnumerable<Structures>> oClContextStructures = GetStructureByType("RouteTypes");

            if (!(oClContextStructures.Response.Data is object)) return "Indefinido";

            Structures oRouteType =
                oClContextStructures.Response.Data.FirstOrDefault(s => s.Key == _routeType.ToString());

            if (!(oRouteType is object)) return "Indefinido";

            return oRouteType.Description;
        }

        private static DateTime ConvertGmailAppointmentDateToDateTime(string _date)
        {
            string[] parts = _date.Split('-');

            return new DateTime(Convert.ToInt32(parts[0]), Convert.ToInt32(parts[1]), Convert.ToInt32(parts[2]));
        }

        private static List<int> GetRoutePointVisitingTime(string _visitingTime)
        {
            List<int> visitTime = new List<int>();

            if (String.IsNullOrEmpty(_visitingTime))
            {
                visitTime.Add(0);
                visitTime.Add(0);
            }
            else
            {
                visitTime = _visitingTime.Split(':').Select(h => Convert.ToInt32(h)).ToList();
            }

            return visitTime;
        }

        private static void SaveCalendarAppointment(CalendarAppointment _CA)
        {
            LogManager.Record($"SAVING CALENDAR APPOINTMENT... | MODEL: {JsonConvert.SerializeObject(_CA)}");

            CLContext<CalendarAppointment> oClContext =
                _CA.Post<CalendarAppointment, MainDBContext, ICLExclude, ICLSingle>("CreateCalendarAppointment",
                    "RouteLine", "RouteAssignment", "IsActive");

            LogManager.Record($"CALENDAR APPOINTMENT SAVED | RESPONSE: {JsonConvert.SerializeObject(oClContext)}");
        }

        private static CLContext<IEnumerable<CalendarAppointment>> GetRouteAssignmentCalendarAppointments(
            int _routeAssignmentId)
        {
            LogManager.Record($"REQUESTING CALENDAR APPOINTMENTS... | ROUTE ASSIGNMENT: {_routeAssignmentId}");

            CLContext<IEnumerable<CalendarAppointment>> oClContext =
                Services.Execute<CalendarAppointment, MainDBContext, int>("GetCalendarAppointmentsByRouteAssignment",
                    _routeAssignmentId, "@RouteAssignmentId");

            LogManager.Record($"CALENDAR APPOINTMENTS REQUESTED");

            return oClContext;
        }

        private static void UpdateCalendarApptStatus(CalendarAppointment _appointment)
        {
            LogManager.Record($"UPDATING APPOINTMENT STATUS... | APPT ID: {_appointment.Id}");

            _appointment.UpdatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            Services.Execute<CalendarAppointment, MainDBContext, ICLInclude, ICLSingle>("UpdateCalendarApptStatus",
                _appointment,
                "Id", "UpdatedBy");

            LogManager.Record($"APPOINTMENT STATUS UPDATED | APPT ID: {_appointment.Id}");
        }

        private static int GetRouteLineCheckStatus(int _routeLineId)
        {
            LogManager.Record($"REQUESTING CHECK STATUS | ROUTE LINE: {_routeLineId}");

            CLContext<Common.SingleValue<int>> oClContext =
                Services.Execute<Common.SingleValue<int>, MainDBContext, int, ICLSingle>("GetRouteLineCheckStatus",
                    _routeLineId,
                    "@RouteLineId");

            if (!(oClContext.Response.Data is object)) throw new Exception("Check status value was not obtained");

            return oClContext.Response.Data.Value;
        }

        #endregion

        #region DiscountHierarchies

        public static CLContext<IEnumerable<DiscountHierarchy>> GetDiscountHierarchies()
        {
            int companyId = Convert.ToInt32(HttpContext.Current.Items[HttpContextItems.CompanyKey]);

            LogManager.Record($"REQUESTING DISCOUNT HIERARCHIES... | COMPANY: {companyId}");

            CLContext<IEnumerable<DiscountHierarchy>> oClContext =
                Services.Execute<DiscountHierarchy, MainDBContext, int>("GetCompanyDiscountHierarchies", companyId,
                    "@CompanyId");

            LogManager.Record($"DISCOUNT HIERARCHIES REQUESTED");

            return oClContext;
        }

        public static CLContext<IEnumerable<DiscountHierarchy>> GetDiscountHierarchiesByCompany(int _companyId)
        {
            LogManager.Record($"REQUESTING DISCOUNT HIERARCHIES... | COMPANY: {_companyId}");

            CLContext<IEnumerable<DiscountHierarchy>> oClContext =
                Services.Execute<DiscountHierarchy, MainDBContext, int>("GetCompanyDiscountHierarchies", _companyId,
                    "@CompanyId");

            LogManager.Record($"DISCOUNT HIERARCHIES REQUESTED");

            return oClContext;
        }

        private static CLContext<IEnumerable<DiscountHierarchy>> GetDiscountHierarchiesToAplicate(int _companyId)
        {
            LogManager.Record($"REQUESTING DISCOUNT HIERARCHIES TO APLICATE... | COMPANY: {_companyId}");

            CLContext<IEnumerable<DiscountHierarchy>> oClContext =
                Services.Execute<DiscountHierarchy, MainDBContext, int>("GetDiscountHierarchiesToAplicate", _companyId,
                    "@CompanyId");

            LogManager.Record($"DISCOUNT HIERARCHIES TO APLICATE REQUESTED");

            return oClContext;
        }

        public static CLContext<List<DiscountHierarchy>> UpdateDiscountHierarchies(
            List<DiscountHierarchy> _discountHierarchies)
        {
            LogManager.Record($"UPDATING DISCOUNT HIERARCHIES...");

            List<DiscountHierarchy> oDiscountHierarchies = new List<DiscountHierarchy>();

            string updatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            foreach (DiscountHierarchy discount in _discountHierarchies)
            {
                discount.UpdatedBy = updatedBy;

                CLContext<DiscountHierarchy> oClContext =
                    Services.Execute<DiscountHierarchy, MainDBContext, ICLInclude, ICLSingle>(
                        "UpdateDiscountHierarchies", discount, "IsActive", "Id", "UpdatedBy", "Hierarchy");

                if (oClContext.Response.Data is object)
                {
                    oDiscountHierarchies.Add(oClContext.Response.Data);
                }
            }

            LogManager.Record($"DISCOUNT HIERARCHIES UPDATED");

            return new CLContext<List<DiscountHierarchy>>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<DiscountHierarchy>>()
                {
                    Data = oDiscountHierarchies,
                    Message = ""
                }
            };
        }

        #endregion

        #region Version

        /// <summary>
        /// Validates the version information for all configured resources.
        /// Queries each resource via ODBC if the connection mode is set to “ODBC.”
        /// </summary>
        /// <exception cref="Exception">
        /// Thrown when no versioning system has been configured (i.e., the resource list is null).
        /// </exception>
        public static void ValidateResourcesVersions()
        {

            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<MinifiedResource>> oClContext =
                Services.Execute<MinifiedResource, MainDBContext>("GetResourceList").Get();

            LogManager.Record($"REQUESTE COMPLETED");

            if (oClContext.Response.Data is object)
            {
                LogManager.Record($"REQUESTING RECORDS");

                string connectionMode = GetConnectionMode();

                LogManager.Record($"CONNECTION MODE: {connectionMode}");

                foreach (MinifiedResource resource in oClContext.Response.Data)
                {

                    #region Query Via ODBC

                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        ClUserContextODBC contextODBC = GetUserCtxODBC(resource.DBObject);

                        List<ResourceVersion> resultList = Common.ResolveSAPViewODBC<ResourceVersion>(contextODBC);

                        LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                        LogManager.Record("REQUEST COMPLETED");
                    }

                    #endregion
                }
            }
            else
            {
                throw new Exception("CL - No se ha configurado sistema de versiones");
            }
        }

        #endregion

        #endregion

        #region SAP

        #region Users SAP

        /// <summary>
        /// This method is used to get users SAP
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<UsersSAP>>> GetUserSap()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetAllUsersSAP");

                List<UsersSAP> resultList = Common.ResolveSAPViewODBC<UsersSAP>(contextODBC);
            
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<UsersSAP>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UsersSAP>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetAllUsersSAP").Get();
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<UsersSAP>>();
            #endregion
        }
        
        #endregion
        
        #region Activities

        /// <summary>
        /// Retrieves a list of contact person activities based on the provided card code.
        /// </summary>
        /// <param name="_cardCode">The card code to retrieve contact person activities for.</param>
        /// <returns>A CLContext object containing a list of contact person activities.</returns>
        public static async Task<CLContext<List<ContactPersonActivities>>> GetContactPerson(string _cardCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetContactPerson");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ContactPersonActivities> resultList = Common.ResolveSAPViewODBC<ContactPersonActivities>(contextODBC,
                    new Dictionary<string, object>()
                    {
                       {"@CardCode", $"{_cardCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<ContactPersonActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ContactPersonActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetContactPerson").Get<FilterBaseByCardCode>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<ContactPersonActivities>>();
            #endregion
        }

        /// <summary>
        /// This method is used to get contact type activities
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<TypeActivities>>> GetTypeActivities()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetTypeActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<TypeActivities> resultList = Common.ResolveSAPViewODBC<TypeActivities>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<TypeActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TypeActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetTypeActivities").Get();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<TypeActivities>>();
            #endregion
        }

        /// <summary>
        /// This method is used to get subject of activities
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<SubjectActivities>>> GetSubjectActivities()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSubjectActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<SubjectActivities> resultList = Common.ResolveSAPViewODBC<SubjectActivities>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<SubjectActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SubjectActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetSubjectActivities").Get();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<SubjectActivities>>();
            #endregion
        }

        /// <summary>
        /// This method is used to get location activities
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<LocationActivities>>> GetLocationActivities()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetLocationActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<LocationActivities> resultList = Common.ResolveSAPViewODBC<LocationActivities>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<LocationActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<LocationActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetLocationActivities").Get();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<LocationActivities>>();
            #endregion
        }

        /// <summary>
        /// This method is used to get recurrence activities
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<RecurrenceActivities>> GetRecurrenceActivities()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<RecurrenceActivities>> oClContext =
                Services.Execute<RecurrenceActivities, MainDBContext>("GetRecurrenceActivities").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get priority activities
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<Priority>> GetPriorityActivities()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<Priority>> oClContext =
                Services.Execute<Priority, MainDBContext>("GetPriorityActivities").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get option actividad
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<OptionActivities>> GetOptionActivities()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<OptionActivities>> oClContext =
                Services.Execute<OptionActivities, MainDBContext>("GetOptionActivities").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get day of week
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<DayWeekActivities>> GetDayOfWeek()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<DayWeekActivities>> oClContext =
                Services.Execute<DayWeekActivities, MainDBContext>("GetDayOfWeek").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get week
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<WeekActivities>> GetWeek()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<WeekActivities>> oClContext =
                Services.Execute<WeekActivities, MainDBContext>("GetWeek").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get Month
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<MonthActivities>> GetMonth()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<MonthActivities>> oClContext =
                Services.Execute<MonthActivities, MainDBContext>("GetMonth").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }
        
        /// <summary>
        /// This method is used to get Month
        /// </summary>
        /// <returns></returns>
        public static CLContext<IEnumerable<ObjectSAPActivities>> GetObjectSAPActivities()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<ObjectSAPActivities>> oClContext =
                Services.Execute<ObjectSAPActivities, MainDBContext>("GetObjectSAPActivities").Get();

            LogManager.Record("REQUESTING RECORDS");

            return oClContext;
        }

        /// <summary>
        /// This method is used to get documents to activities
        /// </summary>
        /// <param name="_documentType"></param>
        /// <returns></returns>
        public static async Task<CLContext<List<DocumentsActivities>>> GetDocumentsActivities(int _documentType, int _docNum)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string resourceName = string.Empty;

            // Switch único para determinar el nombre del recurso
            switch (_documentType)
            {
                case (int)Constants.DocumentType.InvoicesFE:
                    resourceName = "GetARInvoiceActivities";
                    break;
                case (int)Constants.DocumentType.SalesOrders:
                    resourceName = "GetSaleOrderActivities";
                    break;
                case (int)Constants.DocumentType.SalesQuotations:
                    resourceName = "GetSaleQuotationActivities";
                    break;
                case (int)Constants.DocumentType.CreditNotes:
                    resourceName = "GetCreditMemoActivities";
                    break;
                case (int)Constants.DocumentType.PurchaseInvoice:
                    resourceName = "GetAPInvoiceActivities";
                    break;
                case (int)Constants.DocumentType.OutgoingPayment:
                    resourceName = "GetOutgoingPaymentsActivities";
                    break;
                case (int)Constants.DocumentType.IncomingPayments:
                    resourceName = "GetIncomingPaymentsActivities";
                    break;
                case (int)Constants.DocumentType.PurchaseOrder:
                    resourceName = "GetPurchaseOrderActivities";
                    break;
                case (int)Constants.DocumentType.GoodIssue:
                    resourceName = "GetGoodIssueActivities";
                    break;
                case (int)Constants.DocumentType.GoodReceipt:
                    resourceName = "GetGoodReceiptActivities";
                    break;
                case (int)Constants.DocumentType.GoodReceiptPO:
                    resourceName = "GetGoodReceiptPOActivities";
                    break;
                case (int)Constants.DocumentType.GoodReturn:
                    resourceName = "GetGoodReturnActivities";
                    break;
                case (int)Constants.DocumentType.Delivery:
                    resourceName = "GetDeliveryNotesActivities";
                    break;
                case (int)Constants.DocumentType.Drafts:
                    resourceName = "GetDraftsActivities";
                    break;
                case (int)Constants.DocumentType.InventoryTransferRequest:
                    resourceName = "GetInvTransferRequestActivities";
                    break;
                case (int)Constants.DocumentType.InventoryTransfer:
                    resourceName = "GetInventoryTransferActivities";
                    break;
            }

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resourceName}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<DocumentsActivities> resultList = Common.ResolveSAPViewODBC<DocumentsActivities>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DocNum", _docNum}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<DocumentsActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<DocumentsActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                FilterDocumentActivities oFilterDocumentActivities = new FilterDocumentActivities() { DocNum = _docNum };

                SLRequestObject oRequestObject = GetUserCtx($"SL_{resourceName}").Get(oFilterDocumentActivities);

                LogManager.Record($"RESOURCE: {oRequestObject.Url_Request}");
                LogManager.Record($"REQUESTING COMPLETED");

                return await oRequestObject.SendAsync<List<DocumentsActivities>>();

                #endregion
            }
        }
        
        /// <summary>
        /// This method is used to obtain a list of items for the activity screen
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<ItemsActivities>>> GetItemsActivities(string _description)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemsActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsActivities> resultList = Common.ResolveSAPViewODBC<ItemsActivities>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@Description", $"{_description}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<ItemsActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemsActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetItemsActivities").Get<FilterItemsActivities>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<ItemsActivities>>();
            #endregion
        }

        /// <summary>
        /// This method is used to obtain a list of filtered activities
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<SearchDocumentsActivities>>> GetSearchActivities(string _dateFrom, string _dateTo, int _activityCode = 0, string _cardCode = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSearchActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<SearchDocumentsActivities> resultList = Common.ResolveSAPViewODBC<SearchDocumentsActivities>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DateFrom", $"{_dateFrom}"}, {"@DateTo", $"{_dateTo}"}, {"@ActivityCode", $"{_activityCode}"},
                        {"@CardCode", $"{_cardCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<SearchDocumentsActivities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SearchDocumentsActivities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetSearchActivities").Get<FilterSearchActivities>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<SearchDocumentsActivities>>();
            #endregion



        }

        /// <summary>
        /// This method is used to obtain detail activity
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<Activities>>> GetDetailActivity(int _activityCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetDetailActivity");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Activities> resultList = Common.ResolveSAPViewODBC<Activities>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ActivityCode", $"{_activityCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<Activities>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Activities>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetDetailActivity").Get<FilterDetailActivity>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<Activities>>();
            #endregion

        }

        /// <summary>
        /// This method is used to obtain activity status
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<ActivityStates>>> GetActivityStates()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetActivityStates");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ActivityStates> resultList = Common.ResolveSAPViewODBC<ActivityStates>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<ActivityStates>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ActivityStates>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetActivityStates").Get();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<ActivityStates>>();
            #endregion

        }

        /// <summary>
        /// Retrieves a list of countries based on a specified filter.
        /// </summary>
        /// <param name="_FilterCountry">The filter criteria for retrieving countries.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="CountriesActivity"/> that match the filter criteria.
        /// </returns>
        public static async Task<CLContext<List<CountriesActivity>>> GetCountriesActivityByFilter(string _filterCountry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetCountriesActivity");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<CountriesActivity> resultList = Common.ResolveSAPViewODBC<CountriesActivity>(contextODBC,
                    new Dictionary<string, object>()
                    {
                    {"@FilterCountry", $"{_filterCountry}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<CountriesActivity>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<CountriesActivity>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetCountriesActivity").Get<FilterCountriesActivity>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<CountriesActivity>>();
            #endregion
        }

        /// <summary>
        /// Retrieves a list of states for a given country code.
        /// </summary>
        /// <param name="CountryCode">The code of the country for which states are to be retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="StatesCountriesActivity"/> corresponding to the specified country code.
        /// </returns>
        public static async Task<CLContext<List<StatesCountriesActivity>>> GetStatesCountriesActivity(string CountryCode)
         {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStatesCountriesActivity");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<StatesCountriesActivity> resultList = Common.ResolveSAPViewODBC<StatesCountriesActivity>(contextODBC,
                    new Dictionary<string, object>()
                    {
                         { "@CountryCode", CountryCode }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<StatesCountriesActivity>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<StatesCountriesActivity>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetStatesCountriesActivity").Get<FilterStatesCountriesActivity>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<StatesCountriesActivity>>();
            #endregion
        }


        /// <summary>
        /// Retrieves a specific country activity based on the provided filter criteria.
        /// </summary>
        /// <param name="FilterCountry">The filter criteria used to identify the country activity.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with the country activity that matches the filter criteria.
        /// </returns>
        public static async Task<CLContext<CountriesActivity>> GetCountryActivity(string FilterCountry)
         {

            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetCountryActivity");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<CountriesActivity> resultList = Common.ResolveSAPViewODBC<CountriesActivity>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@FilterCountry", FilterCountry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<CountriesActivity>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<CountriesActivity>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetCountryActivity").Get<FilterCountriesActivity>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<CountriesActivity>();
            #endregion
        }


        /// <summary>
        /// This method is used to update activities
        /// </summary>
        /// <param name="_activities"></param>
        /// <returns></returns>
        public static async Task<CLContext<Activities>> PatchActivities(Activities _activities)
        {
            LogManager.Record("REQUESTING POST OBJECT");
            
            string removeHeaderProperties = "Duration,ActivityCode,CardName";

            SLRequestObject oSlRequestObject = GetUserCtx("PatchActivities")
                .Patch(_activities, _fieldsToRemoveInHeaders: removeHeaderProperties);
            
            LogManager.Record($"URL: {oSlRequestObject.Url_Request} MODEL: {oSlRequestObject.Content}");
            
            LogManager.Record("REQUESTING POST OBJECT");

            return await oSlRequestObject.SendAsync<Activities>();
        }
        
        /// <summary>
        /// This method is used to create activities
        /// </summary>
        /// <param name="_activities"></param>
        /// <returns></returns>
        public static async Task<CLContext<Activities>> PostActivities(Activities _activities)
        {
            LogManager.Record("REQUESTING POST OBJECT");
            
            string removeHeaderProperties = "Duration,ActivityCode,CardName";

            SLRequestObject oSlRequestObject = GetUserCtx("PostActivities")
                .Post(_activities, _fieldsToRemoveInHeaders: removeHeaderProperties);
            
            LogManager.Record($"URL: {oSlRequestObject.Url_Request} MODEL: {oSlRequestObject.Content}");
            
            LogManager.Record("REQUESTING POST OBJECT");

            return await oSlRequestObject.SendAsync<Activities>();
        }
        
        /// <summary>
        /// Retrieves a list of business partner addresses based on the provided card code and optional pattern.
        /// </summary>
        /// <param name="CardCode">The unique identifier for the business partner whose addresses are to be retrieved.</param>
        /// <param name="Pattern">An optional pattern to filter the addresses. If not provided, all addresses for the given card code are retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="BPAddresses"/> corresponding to the specified card code and pattern.
        /// </returns>
        public static async Task<CLContext<List<BPAddresses>>> GetBPAddressesActivities(string CardCode, string Pattern = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBPAddressActivities");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BPAddresses> resultList = Common.ResolveSAPViewODBC<BPAddresses>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@CardCode", CardCode },
                        { "@Pattern", Pattern }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<BPAddresses>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BPAddresses>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }

            #region Query Via SL

            SLRequestObject requestModel = GetUserCtx("SL_GetBPAddressActivities").Get(new FilterAddress()
            {
                CardCode = CardCode,
                Pattern = Pattern ?? ""
            });

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<BPAddresses>>();

            #endregion

        }

        #endregion

        #region Countrys

        /// <summary>
        /// The method obtains all the countries registered in SAP
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<Countrys>>> GetCountrys()
        {
            LogManager.Record("REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetCountries");
            
                List<Countrys> resultList = Common.ResolveSAPViewODBC<Countrys>(contextODBC);
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<Countrys>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Countrys>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetCountries").Get();

                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

                return await oSlRequestObject.SendAsync<List<Countrys>>();
                #endregion
            }

            
        }
        
        /// <summary>
        /// The method obtains the states of a country registered in SAP
        /// <param name="_country"></param>
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<States>>> GetStates(string _country)
        {
            LogManager.Record("REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStates");
            
                List<States> resultList = Common.ResolveSAPViewODBC<States>(contextODBC, new Dictionary<string, object>()
                {
                    {"@Country", $"{_country}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<States>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<States>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetStates").Get<FilterStates>();
                
                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");
                
                return await oSlRequestObject.SendAsync<List<States>>();
                #endregion
            }
            
        }
        
        #endregion

        #region Delivery

        /// <summary>
        /// Method to create delivery
        /// </summary>
        /// <param name="_delivery">Model delivery</param>
        /// <returns></returns>
        public static async Task<CLContext<Delivery>> PostDelivery(Delivery _delivery, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            CLContext<Delivery> existingDocumentResponse =
                await CheckIfDocumentExistByDocumentKey(_delivery, SapDocumenType.Delivery, userId, companyId);

            if (existingDocumentResponse != null)
            {
                return existingDocumentResponse;
            }

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _delivery.AttachmentEntry = documentAttachment?.AbsoluteEntry;


            CLContext<Delivery> createdDocumentFromDraftResponse = await CheckIfDocumentComesFromDraft(_delivery, SapDocumenType.Delivery, userId, companyId);

            if (createdDocumentFromDraftResponse != null)
            {
                return createdDocumentFromDraftResponse;
            }

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_delivery, Constants.DocumentType.Delivery, userId, companyId);

            CLContext<Delivery> deliveryResponse;
            
            if (queryConditionApply.IsApply)
            {
                _delivery.DocObjectCode = ((int)Constants.DocumentType.Delivery).ToString();

                _delivery.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });

                deliveryResponse = await PostDraft(_delivery);
            }
            else
            {
                SLRequestObject oSlRequestObject = BuildSalesDocumentSLRequestObject(Constants.DocumentType.Delivery,
                    true, _delivery, "PostDelivery", userId, companyId, true);

                deliveryResponse = await oSlRequestObject.SendAsync<Delivery>();
            }

            if (deliveryResponse.Code == HttpStatusCode.NoContent)
            {
                return await ValidateAndNotifyAuthorization(_delivery, SapDocumenType.Delivery, queryConditionApply, userId, companyId);
            }

            return deliveryResponse;
        }

        /// <summary>
        /// Retrieves a list of delivery notes from SAP, filtered by sales employee, date range, document number, status, currency, business partner code, and business partner name.
        /// </summary>
        /// <param name="_slpCode">
        /// The sales employee code to filter the delivery notes.
        /// </param>
        /// <param name="_dateInit">
        /// The start date (inclusive) of the date range to filter delivery notes, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_dateEnd">
        /// The end date (inclusive) of the date range to filter delivery notes, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_docNum">
        /// The document number to filter the delivery notes. Use 0 to ignore this filter.
        /// </param>
        /// <param name="_docStatus">
        /// The document status to filter the delivery notes (e.g., "O" for open, "C" for closed).
        /// </param>
        /// <param name="_docCurrency">
        /// The document currency to filter the delivery notes (e.g., "USD", "CRC").
        /// </param>
        /// <param name="_cardCode">
        /// The business partner code to filter the delivery notes.
        /// </param>
        /// <param name="_cardName">
        /// The business partner name to filter the delivery notes.
        /// </param>
        /// <returns>
        /// A <see cref="Task{TResult}"/> representing the asynchronous operation, with a <see cref="CLContext{T}"/> result
        /// containing a list of <see cref="Delivery"/> objects that match the specified criteria.
        /// </returns>
        /// <remarks>
        /// This method queries the SAP data source for delivery notes using the provided filters.
        /// </remarks>
        public static async Task<CLContext<List<Delivery>>> GetDeliveryNotes(
            int _slpCode,
            string _dateInit,
            string _dateEnd,
            int _docNum,
            string _docStatus,
            string _docCurrency,
            string _cardCode,
            string _cardName)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetDeliveryNotesByFilters");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Delivery> resultList = Common.ResolveSAPViewODBC<Delivery>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@SlpCode", _slpCode},
                        {"@DateInit", $"{_dateInit ?? ""}"},
                        {"@DateEnd", $"{_dateEnd ?? ""}"},
                        {"@DocNum", _docNum},
                        {"@DocStatus", $"{_docStatus ?? ""}"},
                        {"@DocCurrency", $"{_docCurrency ?? ""}"},
                        {"@CardCode", $"{_cardCode ?? ""}"},
                        {"@CardName", $"{_cardName ?? ""}"}
                    });

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<Delivery>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Delivery>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("GetDeliveryNotesByFilters").Get(new FilterDeliveryNotes()
                {
                    SlpCode = _slpCode,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    DocNum = _docNum,
                    DocStatus = _docStatus ?? "",
                    DocCurrency = _docCurrency ?? "",
                    CardCode = _cardCode ?? "",
                    CardName = _cardName ?? ""
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<Delivery>>();

                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves a delivery document and its associated lines from the database based on the provided document entry.
        /// </summary>
        /// <param name="DocEntry">The unique identifier for the delivery document to be retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with the delivery document and its lines. If no records are found, a <see cref="CLException"/> is thrown.
        /// </returns>
        /// <exception cref="CLException">Thrown when no delivery records are found for the given document entry.</exception>
        public static async Task<CLContext<Delivery>> GetDelivery(int DocEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<Delivery> oClContext = new CLContext<Delivery>();
            CLContext<List<DeliveryRows>> oClContextLines = new CLContext<List<DeliveryRows>>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetDeliveryByDocEntry");

                List<Delivery> resultList = Common.ResolveSAPViewODBC<Delivery>(contextODBC,
                new Dictionary<string, object>()
                {
                        { "@DocEntry", $"{DocEntry}" }
                });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");

                LogManager.Record($"REQUEST COMPLETED");


                oClContext = new CLContext<Delivery>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<Delivery>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetDeliveryNotesRows");

                Dictionary<string, object> parametersLines = new Dictionary<string, object>
                {
                    { "@DocEntry", DocEntry }
                };

                List<DeliveryRows> resultListLines = Common.ResolveSAPViewODBC<DeliveryRows>(contextODBCLines, parametersLines);

                oClContextLines = new CLContext<List<DeliveryRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<DeliveryRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObject = GetUserCtx($"SL_GetDeliveryByDocEntry").Get<FilterBaseDocEntry>(
                new FilterBaseDocEntry()
                {
                    DocEntry = DocEntry
                });

                oClContext = await oSlRequestObject.SendAsync<Delivery>();

                SLRequestObject oSlRequestObjectLines = GetUserCtx($"SL_GetDeliveryNotesRows").Get<FilterBaseDocEntry>(
                new FilterBaseDocEntry()
                {
                    DocEntry = DocEntry
                });

                oClContextLines = await oSlRequestObjectLines.SendAsync<List<DeliveryRows>>();

                #endregion
            }

            //Se obtienen las unidades de medida
            if (oClContextLines.Response.Data is object && oClContextLines.Response.Data.Count > 0)
            {
                foreach (DeliveryRows row in oClContextLines.Response.Data)
                {
                    row.UoMMasterData = await GetUomMasterDataFilter(row.ItemCode, row.WarehouseCode,
                        oClContext.Response.Data.PriceList,
                        "N");

                    row.LinesCurrenciesList =
                        await GetAdditionalCurrencies(row.ItemCode, oClContext.Response.Data.PriceList);
                }
            }
            
            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();
            
            oClContext.Response.Data.DocumentLines.AddRange(oClContextLines.Response.Data);

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }
        
        #endregion

        #region Entrada de Inventario

        public static async Task<CLContext<GoodsReceipt>> CreateInventoryEntries(GoodsReceipt _goodsReceipt, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _goodsReceipt.PaymentGroupCode =
                !string.IsNullOrEmpty(_goodsReceipt.Udfs.Find(_x => _x.Name == "U_ListNum")?.Value)
                    ? int.Parse((_goodsReceipt.Udfs.Find(_x => _x.Name == "U_ListNum")?.Value)): -1;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_goodsReceipt.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.InventoryEntry);

            if (uniques.Response.Data != null)
            {
                return new CLContext<GoodsReceipt>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReceipt>()
                    {
                        Data = new GoodsReceipt()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            string removeLinesProperties = "Udfs,TaxCode,LineStatus";
            string removeHeaderProperties = "Udfs,DocNum,DocEntry,DocCurrency";

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _goodsReceipt.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject oSlRequestObject = GetUserCtx("PostGenInventoryEntries").Post(_goodsReceipt,
                _fieldsToRemoveInLines: removeLinesProperties, _fieldsToRemoveInHeaders: removeHeaderProperties);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<GoodsReceipt>();
        }

        /// <summary>
        /// Retrieves inventory transfer requests (entry requests) filtered by document number,
        /// date range, salesperson, and status. Chooses ODBC or Service Layer based on connection mode.
        /// </summary>
        /// <param name="_docNum">Document number filter.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <param name="_slpCode">Salesperson code filter.</param>
        /// <param name="_docStatus">Document status filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{TransfersRequests}"/>.
        /// </returns>
        public static async Task<CLContext<List<TransfersRequests>>> GetInventoryEntryRequest(
            int _docNum,
            string _dateInit,
            string _dateEnd,
            int _slpCode,
            string _docStatus)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInventoryEntryRequest");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocNum", _docNum },
                    { "@DateInit", _dateInit ?? "" },
                    { "@DateEnd", _dateEnd ?? "" },
                    { "@SlpCode", _slpCode },
                    { "@DocStatus", _docStatus ?? "" }
                };

                List<TransfersRequests> resultList =
                    Common.ResolveSAPViewODBC<TransfersRequests>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<TransfersRequests>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TransfersRequests>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterTransferRequests filter = new FilterTransferRequests
                {
                    DocNum = _docNum,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    SlpCode = _slpCode,
                    DocStatus = _docStatus ?? ""
                };

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetInventoryEntryRequest").Get<FilterTransferRequests>(filter);

                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                return await oSlRequestObject.SendAsync<List<TransfersRequests>>();

                #endregion
            }
        }

        #endregion

        #region Salida de Inventario

        public static async Task<CLContext<GoodsIssue>> CreateInventoryOuput(GoodsIssue _goodsIssue, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _goodsIssue.PaymentGroupCode =
                !string.IsNullOrEmpty(_goodsIssue.Udfs.Find(_x => _x.Name == "U_ListNum")?.Value)
                    ? int.Parse((_goodsIssue.Udfs.Find(_x => _x.Name == "U_ListNum")?.Value)) : -1;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_goodsIssue.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.InventoryOuput);

            if (uniques.Response.Data != null)
            {
                return new CLContext<GoodsIssue>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsIssue>()
                    {
                        Data = new GoodsIssue()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            string removeLineProperties = "Udfs,TaxCode,LineStatus";
            string removeHeaderProperties = "Udfs,DocEntry,DocNum,DocCurrency";

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _goodsIssue.AttachmentEntry = documentAttachment?.AbsoluteEntry; 

            SLRequestObject oSlRequestObject = GetUserCtx("PostGenInventoryExits")
                .Post(_goodsIssue, _fieldsToRemoveInLines: removeLineProperties,
                    _fieldsToRemoveInHeaders: removeHeaderProperties);

           
            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<GoodsIssue>();
        }

        /// <summary>
        /// Retrieves inventory exit (outbound transfer) requests filtered by document number,
        /// date range, salesperson, and status. Chooses ODBC or Service Layer based on connection mode.
        /// </summary>
        /// <param name="_docNum">Document number filter.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <param name="_slpCode">Salesperson code filter.</param>
        /// <param name="_docStatus">Document status filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{TransfersRequests}"/>.
        /// </returns>
        public static async Task<CLContext<List<TransfersRequests>>> GetInvetoryExistsRequest(
            int _docNum,
            string _dateInit,
            string _dateEnd,
            int _slpCode,
            string _docStatus)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInvetoryExistsRequest");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocNum", _docNum },
                    { "@DateInit", _dateInit ?? "" },
                    { "@DateEnd", _dateEnd ?? "" },
                    { "@SlpCode", _slpCode },
                    { "@DocStatus", _docStatus ?? "" }
                };

                List<TransfersRequests> resultList =
                    Common.ResolveSAPViewODBC<TransfersRequests>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<TransfersRequests>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TransfersRequests>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterTransferRequests filter = new FilterTransferRequests
                {
                    DocNum = _docNum,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    SlpCode = _slpCode,
                    DocStatus = _docStatus ?? ""
                };

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetInvetoryExistsRequest").Get<FilterTransferRequests>(filter);

                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                return await oSlRequestObject.SendAsync<List<TransfersRequests>>();

                #endregion
            }
        }
        #endregion

        #region Inventory Transfer Requests

        /// <summary>
        /// Creates a stock transfer request by first checking if a document already exists using a unique key.
        /// If it exists, returns the existing document; otherwise, saves the attachments and submits the new request.
        /// </summary>
        /// <param name="_stockTransferRequest">The stock transfer request object to be created.</param>
        /// <param name="_attachment">Document attachment metadata.</param>
        /// <param name="_attachmentFiles">List of files to attach to the document.</param>
        /// <param name="pUserId">Optional user ID. If not provided, the user ID is retrieved from the context.</param>
        /// <param name="pCompanyId">Optional company ID related to the request.</param>
        /// <returns>An asynchronous task returning a <c>CLContext</c> containing the created or existing <c>StockTransferRequest</c> object.</returns>
        /// <remarks>
        /// This method checks for an existing stock transfer document based on the <c>U_DocumentKey</c>.
        /// If found, it returns the existing document. Otherwise, it attaches files and sends a new POST request.
        /// </remarks>
        /// <exception cref="Exception">Thrown when external service calls fail or input validation errors occur.</exception>
        public static async Task<CLContext<StockTransferRequest>> CreateStockTransfersRequest(
            StockTransferRequest _stockTransferRequest, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles, int pUserId = -1, int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;

            LogManager.Record("CHECK SERIES CONFIGURED");

            SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.InventoryTransferRequest, pUserId, pCompanyId);

            _stockTransferRequest.Series = oSerie.NoSerie;

            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_stockTransferRequest.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.TransfersRequest);

            if (uniques.Response.Data != null)
            {
                return new CLContext<StockTransferRequest>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransferRequest>()
                    {
                        Data = new StockTransferRequest()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransferRequest.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            string removeLineProperties =
                "Udfs,LineNum,Stock,ManSerNum,ManBtchNum,DistNumber,SysNumber,BinAbs,BinActivat,LocationsFrom,LocationsTo,BaseEntry,BaseType,BaseLine,LineStatus";
            string removeHeaderProperties = "Udfs,DocStatus,ConfirmationEntry,DocObjectCode";


            SLRequestObject oSlRequestObject = GetUserCtx("PostStockTransferRequest").Post(_stockTransferRequest,
                _fieldsToRemoveInLines: removeLineProperties, _fieldsToRemoveInHeaders: removeHeaderProperties,
                _lineObjectName: "StockTransferLines");

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<StockTransferRequest>();
        }

        public static async Task<CLContext<StockTransferRequest>> UpdateStockTansfersRequest(
            StockTransferRequest _stockTransferRequest,DocumentAttachment _attachment,IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransferRequest.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            string removeLineProperties =
                "Udfs,LineNum,Stock,ManSerNum,ManBtchNum,DistNumber,SysNumber,BinAbs,BinActivat,LocationsFrom,LocationsTo,BaseEntry,BaseType,BaseLine,LineStatus";
            string removeHeaderProperties = "Udfs,DocStatus,DocEntry,DocNum,ConfirmationEntry,DocObjectCode";

            SLRequestObject oSlRequestObject = GetUserCtx("PatchStockTransferRequest").Patch(_stockTransferRequest,
                _fieldsToRemoveInLines: removeLineProperties, _fieldsToRemoveInHeaders: removeHeaderProperties,
                _lineObjectName: "StockTransferLines");

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>()
            {
                new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true")
            };

            oSlRequestObject.Headers = headers;

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<StockTransferRequest>();
        }

        /// <summary>
        /// Retrieves a list of stock transfer requests filtered by document number, date range, salesperson, and status.
        /// </summary>
        /// <param name="_docNum">Document number filter.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <param name="_slpCode">Salesperson code filter.</param>
        /// <param name="_docStatus">Document status filter.</param>
        /// <returns>A <see cref="CLContext{List{TransfersRequests}}"/> with the list of transfer requests.</returns>
        public static async Task<CLContext<List<TransfersRequests>>> GetTransfersRequest(int _docNum, string _dateInit, string _dateEnd, int _slpCode, string _docStatus)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetTransferRequests");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocNum", _docNum },
                    { "@DateInit", _dateInit ?? "" },
                    { "@DateEnd", _dateEnd ?? "" },
                    { "@SlpCode", _slpCode },
                    { "@DocStatus", _docStatus ?? "" }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<TransfersRequests> resultList = Common.ResolveSAPViewODBC<TransfersRequests>(contextODBC, parametersODBC);

                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<TransfersRequests>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TransfersRequests>>() { Data = resultList },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterTransferRequests filter = new FilterTransferRequests
                {
                    DocNum = _docNum,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    SlpCode = _slpCode,
                    DocStatus = _docStatus ?? ""
                };

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetTransferRequests").Get<FilterTransferRequests>(filter);

                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                return await oSlRequestObject.SendAsync<List<TransfersRequests>>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves the stock transfer request header with lines and bin locations (if action is COPY).
        /// </summary>
        /// <param name="_docEntry">Document entry identifier.</param>
        /// <param name="_accion">Action type to determine if bin locations should be loaded.</param>
        /// <returns>A <see cref="CLContext{StockTransferRequest}"/> with the transfer request data.</returns>
        public static async Task<CLContext<StockTransferRequest>> GetTransfersRequestHeader(int _docEntry, string _accion)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<StockTransferRequest> oClContext = null;
            CLContext<List<StockTransferRequestRows>> oClContextLines = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Header and Lines Via ODBC

                //Header
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetRansferRequestHeader");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocEntry", _docEntry }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<StockTransferRequest> resultList = Common.ResolveSAPViewODBC<StockTransferRequest>(contextODBC, parametersODBC);

                StockTransferRequest result = resultList.FirstOrDefault();

                oClContext = new CLContext<StockTransferRequest>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransferRequest>() { Data = result },
                    value = result
                };

                //Lineas
                ClUserContextODBC contextODBCLines = GetUserCtxODBC($"ODBC_GetTransferRequestLines");

                Dictionary<string, object> parametersODBCLines = new Dictionary<string, object>
                {
                    { "@DocEntry", _docEntry }
                };

                LogManager.Record($"RESOURCE: {contextODBCLines.Resource}");

                List<StockTransferRequestRows> resultListLines = Common.ResolveSAPViewODBC<StockTransferRequestRows>(contextODBCLines, parametersODBCLines);

                oClContextLines = new CLContext<List<StockTransferRequestRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<StockTransferRequestRows>>() { Data = resultListLines },
                    value = resultListLines
                };

                #endregion
            }
            else
            {
                #region Query Header and Lines Via Service Layer

                //Header
                FilterBaseDocEntry filterHeader = new FilterBaseDocEntry
                {
                    DocEntry = _docEntry
                };

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetRansferRequestHeader").Get<FilterBaseDocEntry>(filterHeader);

                LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

                oClContext = await oSlRequestObject.SendAsync<StockTransferRequest>();

                //Lineas
                FilterBaseDocEntry filterLines = new FilterBaseDocEntry
                {
                    DocEntry = _docEntry
                };

                SLRequestObject oSlRequestObjectLines = GetUserCtx("SL_GetTransferRequestLines").Get<FilterBaseDocEntry>(filterLines);

                LogManager.Record($"URL: {oSlRequestObjectLines.Url_Request}");

                oClContextLines = await oSlRequestObjectLines.SendAsync<List<StockTransferRequestRows>>();

                #endregion
            }

            oClContext.Response.Data.StockTransferLines = oClContextLines.Response.Data;

            //Ubicaciones
            if (_accion == PreloadedDocumentActions.COPY)
            {
                foreach (StockTransferRequestRows item in oClContext.Response.Data.StockTransferLines)
                {
                    //Consultamos solo si es un almacen con ubicaciones esto para las ubicaciones de origen
                    if (item.BinActivat == "Y")
                    {
                        CLContext<List<WarehouseBinLocation>> oClContextBinLocationFrom = null;

                        if (connectionMode == SapConnectionType.ODBC)
                        {
                            #region Query LocationsFrom Via ODBC

                            ClUserContextODBC contextODBCLocFrom = GetUserCtxODBC($"ODBC_GetWarehousesBinLocationFrom");

                            Dictionary<string, object> parametersODBCLocFrom = new Dictionary<string, object>
                            {
                                { "@ItemCode", item.ItemCode ?? "" },
                                { "@WhsCode", item.FromWarehouseCode ?? "" }
                            };

                            List<WarehouseBinLocation> resultListLocFrom = Common.ResolveSAPViewODBC<WarehouseBinLocation>(contextODBCLocFrom, parametersODBCLocFrom);

                            oClContextBinLocationFrom = new CLContext<List<WarehouseBinLocation>>()
                            {
                                Code = HttpStatusCode.OK,
                                Response = new Response<List<WarehouseBinLocation>>() { Data = resultListLocFrom },
                                value = resultListLocFrom
                            };

                            #endregion
                        }
                        else
                        {
                            #region Query LocationsFrom Via Service Layer

                            FilterBaseWhsCodeItemCode filterFrom = new FilterBaseWhsCodeItemCode()
                            {
                                ItemCode = HttpUtility.UrlEncode(item.ItemCode),
                                WhsCode = item.FromWarehouseCode
                            };

                            SLRequestObject oSlRequestObjectBinLocationFrom = GetUserCtx("SL_GetWarehousesBinLocationFrom").Get<FilterBaseWhsCodeItemCode>(filterFrom);

                            LogManager.Record($"URL: {oSlRequestObjectBinLocationFrom.Url_Request}");

                            oClContextBinLocationFrom = await oSlRequestObjectBinLocationFrom.SendAsync<List<WarehouseBinLocation>>();

                            #endregion
                        }

                        item.LocationsFrom = oClContextBinLocationFrom.Response.Data;
                    }

                    //Ubicaciones destino
                    CLContext<List<Location>> oClContextBinLocationTo = null;

                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        #region Query LocationsTo Via ODBC

                        ClUserContextODBC contextODBCLocTo = GetUserCtxODBC($"ODBC_GetWarehousesBinLocationTo");

                        Dictionary<string, object> parametersODBCLocTo = new Dictionary<string, object>
                        {
                            { "@WhsCode", item.WarehouseCode ?? "" }
                        };

                        List<Location> resultListLocTo = Common.ResolveSAPViewODBC<Location>(contextODBCLocTo, parametersODBCLocTo);

                        oClContextBinLocationTo = new CLContext<List<Location>>()
                        {
                            Code = HttpStatusCode.OK,
                            Response = new Response<List<Location>>() { Data = resultListLocTo },
                            value = resultListLocTo
                        };

                        #endregion
                    }
                    else
                    {
                        #region Query LocationsTo Via Service Layer

                        FilterBaseWhsCode filterTo = new FilterBaseWhsCode()
                        {
                            WhsCode = item.WarehouseCode
                        };

                        SLRequestObject oSlRequestObjectBinLocationTo = GetUserCtx("SL_GetWarehousesBinLocationTo").Get<FilterBaseWhsCode>(filterTo);

                        LogManager.Record($"URL: {oSlRequestObjectBinLocationTo.Url_Request}");

                        oClContextBinLocationTo = await oSlRequestObjectBinLocationTo.SendAsync<List<Location>>();

                        #endregion
                    }

                    item.LocationsTo = oClContextBinLocationTo.Response.Data;
                }
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Creates a draft for an inventory transfer request.
        /// </summary>
        /// <param name="_stockTransferRequest">The stock transfer request object containing the details of the transfer.</param>
        /// <param name="_attachment">The document attachment associated with the stock transfer request.</param>
        /// <param name="_attachmentFiles">A collection of files to be attached to the stock transfer request.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{StockTransferRequestDraft}"/>
        /// containing the created stock transfer request draft and the operation status.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found after the draft creation operation.</exception>
         public static async Task<CLContext<StockTransferRequestDraft>> PostInventoryTransferRequestsDrafts(StockTransferRequest _stockTransferRequest, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _stockTransferRequest.DocObjectCode = ((int)Constants.DocumentType.InventoryTransferRequest).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransferRequest.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_stockTransferRequest.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<StockTransferRequestDraft>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransferRequestDraft>()
                    {
                        Data = new StockTransferRequestDraft()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion
            //Objeto creado para mappear el stock transfer request del objeto de sap
            StockTransferRequestDraft MappedStockTransferRequestDraft = new StockTransferRequestDraft()
            {
                DocObjectCode = _stockTransferRequest.DocObjectCode,
                DocDate = _stockTransferRequest.DocDate,
                DueDate = _stockTransferRequest.DueDate,
                DocumentLines = _stockTransferRequest.StockTransferLines,
                Comments = _stockTransferRequest.Comments,
                Udfs = _stockTransferRequest.Udfs,
                AttachmentEntry = _stockTransferRequest.AttachmentEntry,
                ConfirmationEntry = _stockTransferRequest.ConfirmationEntry,
                DocEntry = _stockTransferRequest.DocEntry,
                DocNum = _stockTransferRequest.DocNum,
                Filler = _stockTransferRequest.FromWarehouse,
                TaxDate = _stockTransferRequest.TaxDate,
                ToWhsCode = _stockTransferRequest.ToWarehouse,
                SalesPersonCode = _stockTransferRequest.SalesPersonCode,
                DocStatus = _stockTransferRequest.DocStatus
            };

            CLContext<StockTransferRequestDraft> slResponse = null;
            
            slResponse = await PostDraft<StockTransferRequestDraft>(MappedStockTransferRequestDraft);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<StockTransferRequestDraft> oClContext = await ResolveCreatedDocument<StockTransferRequestDraft>(slResponse,
                    SapDocumenType.Draft,
                    _stockTransferRequest.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
                return oClContext;
            }
            
            return slResponse;
        } 
        
        /// <summary>
        /// Updates an existing inventory transfer request draft with the provided details.
        /// </summary>
        /// <param name="_stockTransferRequest">The stock transfer request object containing the updated details.</param>
        /// <param name="_attachment">The document attachment associated with the stock transfer request.</param>
        /// <param name="_attachmentFiles">A collection of files to be attached to the stock transfer request.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{StockTransferRequestDraft}"/>
        /// containing the updated stock transfer request draft and the operation status.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found after the update operation.</exception>
        public static async Task<CLContext<StockTransferRequestDraft>> PatchInventoryTransferRequestsDrafts(StockTransferRequest _stockTransferRequest, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            
            _stockTransferRequest.DocObjectCode = ((int)Constants.DocumentType.InventoryTransferRequest).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransferRequest.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_stockTransferRequest.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<StockTransferRequestDraft>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransferRequestDraft>()
                    {
                        Data = new StockTransferRequestDraft()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion
            //Objeto creado para mappear el stock transfer request del objeto de sap
            StockTransferRequestDraft MappedStockTransferRequestDraft = new StockTransferRequestDraft()
            {
                DocObjectCode = _stockTransferRequest.DocObjectCode,
                DocDate = _stockTransferRequest.DocDate,
                DueDate = _stockTransferRequest.DueDate,
                DocumentLines = _stockTransferRequest.StockTransferLines,
                Comments = _stockTransferRequest.Comments,
                Udfs = _stockTransferRequest.Udfs,
                AttachmentEntry = _stockTransferRequest.AttachmentEntry,
                ConfirmationEntry = _stockTransferRequest.ConfirmationEntry,
                DocEntry = _stockTransferRequest.DocEntry,
                DocNum = _stockTransferRequest.DocNum,
                Filler = _stockTransferRequest.FromWarehouse,
                TaxDate = _stockTransferRequest.TaxDate,
                ToWhsCode = _stockTransferRequest.ToWarehouse,
                SalesPersonCode = _stockTransferRequest.SalesPersonCode,
                DocStatus = _stockTransferRequest.DocStatus
            };

            CLContext<StockTransferRequestDraft> slResponse = null;
            
            slResponse = await PatchDraft(MappedStockTransferRequestDraft);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<StockTransferRequestDraft> oClContext = await ResolveCreatedDocument<StockTransferRequestDraft>(slResponse,
                    SapDocumenType.Draft,
                    _stockTransferRequest.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
                return oClContext;
            }
            
            return slResponse;
        }
        #endregion

        #region Stock Transfer

        /// <summary>
        /// Creates a stock transfer document. First checks for an existing document using a unique key,
        /// and if none is found, processes attachments and submits the new stock transfer.
        /// </summary>
        /// <param name="_stockTransfer">The stock transfer object to be created.</param>
        /// <param name="_attachment">Document attachment metadata.</param>
        /// <param name="_attachmentFiles">Files to attach to the transfer document.</param>
        /// <param name="pUserId">Optional user ID. If not provided, the user ID is retrieved from the context.</param>
        /// <param name="pCompanyId">Optional company ID associated with the stock transfer.</param>
        /// <returns>An asynchronous task returning a <c>CLContext</c> containing the created or existing <c>StockTransfer</c> object.</returns>
        /// <remarks>
        /// This method checks for an existing stock transfer (OWTR table) based on the <c>U_DocumentKey</c>.
        /// If it exists, the document is returned without creating a new one.
        /// If not, the method processes conditional line field exclusions, handles file attachments,
        /// and sends the stock transfer to the external system.
        /// </remarks>
        /// <exception cref="Exception">Thrown when external service calls fail or data validation fails.</exception>
        public static async Task<CLContext<StockTransfer>> CreateStockTransfers(StockTransfer _stockTransfer, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles, int pUserId = -1, int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;

            LogManager.Record("CHECK SERIES CONFIGURED");

            SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.InventoryTransfer, pUserId, pCompanyId);

            _stockTransfer.Series = oSerie.NoSerie;

            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_stockTransfer.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.StockTransfer);

            if (uniques.Response.Data != null)
            {
                return new CLContext<StockTransfer>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransfer>()
                    {
                        Data = new StockTransfer()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion


            Dictionary<string, Func<JProperty, bool>> dictionary = new Dictionary<string, Func<JProperty, bool>>();

            Func<JProperty, bool> resultUdfs = new Func<JProperty, bool>(_property => true);

            dictionary.Add("Udfs", resultUdfs);

            if (_stockTransfer.StockTransferLines.Exists(x => x.BaseEntry == 0))
            {
                Func<JProperty, bool> result = new Func<JProperty, bool>(_property =>
                    _property.Value == null || Convert.ToInt32(_property.Value) == -1);

                dictionary.Add("BaseEntry", result);
                dictionary.Add("BaseType", result);
                dictionary.Add("BaseLine", result);
            }

            string removeHeaderProperties = "Udfs,LineStatus,DocObjectCode,ConfirmationEntry";

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransfer.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject oSlRequestObject =
                GetUserCtx("PostStockTransfer").Post(_stockTransfer, _lineFlushConditions: dictionary,
                    _fieldsToRemoveInHeaders: removeHeaderProperties, _lineObjectName: "StockTransferLines");

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<StockTransfer>();
        }

        /// <summary>
        /// Retrieves warehouse locations for transfers filtered by warehouse code.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_whsCode">The warehouse code filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{Location}"/> with warehouse locations.
        /// </returns>
        public static async Task<CLContext<List<Location>>> GetLocationForTansfers(string _whsCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetLocationForTansfers");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@WhsCode", _whsCode ?? "" }
                };

                List<Location> resultList =
                     Common.ResolveSAPViewODBC<Location>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<Location>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Location>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterLocationForTransfer filter = new FilterLocationForTransfer
                {
                    WhsCode = _whsCode ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetLocationForTansfers").Get<FilterLocationForTransfer>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<Location>>();

                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves warehouse locations for transfers with pagination support.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_whsCode">The warehouse code filter.</param>
        /// <param name="_location">The location code or name filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{Location}"/> with warehouse locations.
        /// </returns>
        public static async Task<CLContext<List<Location>>> GetLocationForTansfersPagination(string _whsCode, string _location)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetLocationForTansfersModal");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@WhsCode", _whsCode ?? "" },
                    { "@Location", _location ?? "" }
                };

                List<Location> resultList =
                     Common.ResolveSAPViewODBC<Location>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<Location>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Location>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterLocationForTransferPagination filter = new FilterLocationForTransferPagination
                {
                    WhsCode = _whsCode ?? "",
                    Location = _location ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetLocationForTansfersModal").Get<FilterLocationForTransferPagination>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<Location>>();

                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves a list of stock transfer requests based on the specified filtering criteria.
        /// </summary>
        /// <param name="_docNum">The document number to filter the stock transfer requests.</param>
        /// <param name="_dateInit">The start date for filtering the stock transfer requests (format: YYYY-MM-DD).</param>
        /// <param name="_dateEnd">The end date for filtering the stock transfer requests (format: YYYY-MM-DD).</param>
        /// <param name="_slpCode">The sales representative code used to filter the stock transfer requests.</param>
        /// <param name="_docStatus">The status of the document (e.g., Open, Closed) used to filter the stock transfer requests.</param>
        /// <returns>
        /// An asynchronous task that returns a context containing a list of stock transfer requests
        /// filtered by the provided criteria.
        /// </returns>
        public static async Task<CLContext<List<TransfersRequests>>> GetStockTransferRequest(int _docNum, string _dateInit, string _dateEnd, int _slpCode, string _docStatus)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStockTransferRequest");
            
                List<TransfersRequests> resultList = Common.ResolveSAPViewODBC<TransfersRequests>(contextODBC, new Dictionary<string, object>()
                {
                    {"@DocNum", $"{_docNum}"},
                    {"@DateInit", $"{_dateInit}"},
                    {"@DateEnd", $"{_dateEnd}"},
                    {"@SlpCode", $"{_slpCode}"},
                    {"@DocStatus", $"{_docStatus}"},
                });
            
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<TransfersRequests>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TransfersRequests>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetStockTransferRequest").Get<FilterTransferRequests>();
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<TransfersRequests>>();
            #endregion
        }

        /// <summary>
        /// Asynchronously retrieves a <see cref="CLContext{StockTransfer}"/> containing stock transfer headers
        /// based on the provided document entry.
        /// </summary>
        /// <param name="_docEntry">The document entry identifier used to filter the stock transfer records.</param>
        /// <param name="_accion">An action string (currently unused).</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{StockTransfer}"/> object with the stock transfer data.</returns>
        public static async Task<CLContext<StockTransfer>> GetStockTransfersHeader(int _docEntry, string _accion)
        {
            LogManager.Record("REQUESTING RECORDS");
    
            SLRequestObject requestCodeModel = GetUserCtx("GetStockTRansferRequestByDocEntry").Get(
                new FilterStockTransferRequestByDocEntry()
                {
                    DocEntry = _docEntry
                });
 
            LogManager.Record($"RESOURCE: {requestCodeModel.Url_Request}");
 
            CLContext<StockTransfer> oClStatusContext = await requestCodeModel.SendAsync<StockTransfer>();
 
            LogManager.Record($"REQUEST COMPLETED");
            return oClStatusContext;
        }
        
        public static async Task<CLContext<StockTransfer>> PatchStockTansfers(StockTransfer _stockTransfer, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            string oRemoveLineProperties = "BaseType,BaseEntry,BaseLine,Udfs,TaxRate,LineTotal,ManBtchNum,ManSerNum,UoMMasterData,FatherCode,LineStatus,WhsName,LinesCurrenciesList,OnHand,InventoryItem,LineNum";

            // Eliminacion de U_DocumentKey
            _stockTransfer.Udfs.Remove(_stockTransfer.Udfs.Find(udf=>udf.Name.Equals("U_DocumentKey")));
            
            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _stockTransfer.StockTransferLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);

            if (hasClosedLines)
            {
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineNum", "");
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineStatus", "");
            }

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "Series",
                "DocNum",
                "Udfs",
                "DocTotal",
                "DocEntry",
                "PriceList",
                "DocStatus",
                "TipoDocE",
                "IdType",
                "Identification",
                "Email",
                "DocObjectCode",
                "SalesPersonName",
                "DueDate",
                "ConfirmationEntry"
            };
            DateTime dateCompare= new DateTime(0001, 01, 01, 00, 00, 00, 000);
            
            if (_stockTransfer.TaxDate.Equals(dateCompare))
            {
                oRemoveHeaderProperties.Add("TaxDate");
            }
            if (_stockTransfer.DocDate.Equals(dateCompare))
            {
                oRemoveHeaderProperties.Add("DocDate");
            }
            string headerProperties = string.Join(",", oRemoveHeaderProperties);

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransfer.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject requestModel = GetUserCtx("PatchStockTransfer").Patch(
                _stockTransfer,
                _fieldsToRemoveInLines: oRemoveLineProperties, 
                _fieldsToRemoveInHeaders: headerProperties,
                _lineObjectName: "StockTransferLines"
            );

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            headers.Add(new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true"));

            requestModel.Headers = headers;

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");


            return await requestModel.SendAsync<StockTransfer>();
        }
        
        /// <summary>
        /// Retrieves a list of Unit of Measure (UoM) master data based on the specified parameters.
        /// </summary>
        /// <param name="_itemCode">The code of the item for which UoM data is being requested.</param>
        /// <param name="_whsCode">The warehouse code associated with the item.</param>
        /// <param name="_priceList">The price list identifier to filter the UoM data.</param>
        /// <param name="_prchseItem">A flag indicating whether the item is a purchase item.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{UoMMasterData}}"/> 
        /// containing the list of UoM master data.
        /// </returns>
         public static async Task<CLContext<StockTransferDraft>> PostStockTransfersDrafts(StockTransfer _stockTransfer, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            
            _stockTransfer.DocObjectCode = ((int)Constants.DocumentType.InventoryTransfer).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransfer.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_stockTransfer.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<StockTransferDraft>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockTransferDraft>()
                    {
                        Data = new StockTransferDraft()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

           
            List<StockTransfersRows> stockTransferRowsList = _stockTransfer.StockTransferLines.Select(row => new StockTransfersRows
            {
                ItemCode = row.ItemCode,
                FromWarehouseCode = row.FromWarehouseCode,
                WarehouseCode = row.WarehouseCode,
                Quantity = row.Quantity,
                Udfs = row.Udfs,
                BaseEntry = row.BaseEntry,
                BaseLine = row.BaseLine,
                LineStatus = row.LineStatus,
                DocumentLinesBinAllocations = row.StockTransferLinesBinAllocations.Select(allocation => new StockTransferDraftLinesBinAllocations
                {
                    BinAbsEntry = allocation.BinAbsEntry,
                    Quantity = allocation.Quantity,
                    BaseLineNumber = allocation.BaseLineNumber,
                    SerialAndBatchNumbersBaseLine = allocation.SerialAndBatchNumbersBaseLine,
                    BinActionType = allocation.BinActionType
                }).ToList(),
                BaseType = row.BaseType,
                BatchNumbers = row.BatchNumbers,
                ItemDescription = row.ItemDescription,
                SerialNumbers = row.SerialNumbers
            }).ToList();
           
            
            StockTransferDraft mappedStockTransferDraft = new StockTransferDraft()
            {
                DocObjectCode = _stockTransfer.DocObjectCode,
                DocDate = _stockTransfer.DocDate,
                DueDate = _stockTransfer.DueDate,
                DocumentLines = stockTransferRowsList,
                Comments = _stockTransfer.Comments,
                Udfs = _stockTransfer.Udfs,
                AttachmentEntry = _stockTransfer.AttachmentEntry,
                ConfirmationEntry = _stockTransfer.ConfirmationEntry,
                DocEntry = _stockTransfer.DocEntry,
                DocNum = _stockTransfer.DocNum,
                Filler = _stockTransfer.FromWarehouse,
                TaxDate = _stockTransfer.TaxDate,
                ToWhsCode = _stockTransfer.ToWarehouse,
                SalesPersonCode = _stockTransfer.SalesPersonCode
            };

            CLContext<StockTransferDraft> slResponse = null;
            
            slResponse = await PostDraft<StockTransferDraft>(mappedStockTransferDraft);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<StockTransferDraft> oClContext = await ResolveCreatedDocument<StockTransferDraft>(slResponse,
                    SapDocumenType.Draft,
                    _stockTransfer.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
                return oClContext;
            }
            
            return slResponse;
        }
        
        
         /// <summary>
         /// Updates an existing stock transfer draft with the provided details.
         /// </summary>
         /// <param name="_stockTransfer">The stock transfer object containing the updated details.</param>
         /// <param name="_attachment">The document attachment associated with the stock transfer.</param>
         /// <param name="_attachmentFiles">A collection of files to be attached to the stock transfer.</param>
         /// <returns>
         /// A task representing the asynchronous operation, with a <see cref="CLContext{StockTransferDraft}"/>
         /// containing the updated stock transfer draft and the operation status.
         /// </returns>
         /// <exception cref="CLException">Thrown when no records are found after the update operation.</exception>
         public static async Task<CLContext<StockTransferDraft>> PatchStockTransfersDrafts(StockTransfer _stockTransfer, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
         {
             LogManager.Record("REQUESTING PATCH OBJECT");
             _stockTransfer.DocObjectCode = ((int)Constants.DocumentType.InventoryTransfer).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _stockTransfer.AttachmentEntry = documentAttachment?.AbsoluteEntry;

             List<StockTransfersRows> stockTransferRowsList = _stockTransfer.StockTransferLines.Select(row => new StockTransfersRows
             {
                 ItemCode = row.ItemCode,
                 FromWarehouseCode = row.FromWarehouseCode,
                 WarehouseCode = row.WarehouseCode,
                 Quantity = row.Quantity,
                 Udfs = row.Udfs,
                 BaseEntry = row.BaseEntry,
                 BaseLine = row.BaseLine,
                 LineStatus = row.LineStatus,
                 DocumentLinesBinAllocations = row.StockTransferLinesBinAllocations.Select(allocation => new StockTransferDraftLinesBinAllocations()
                 {
                     BinAbsEntry = allocation.BinAbsEntry,
                     Quantity = allocation.Quantity,
                     BaseLineNumber = allocation.BaseLineNumber,
                     SerialAndBatchNumbersBaseLine = allocation.SerialAndBatchNumbersBaseLine,
                     BinActionType = allocation.BinActionType
                 }).ToList(),
                 BaseType = row.BaseType,
                 BatchNumbers = row.BatchNumbers,
                 ItemDescription = row.ItemDescription,
                 SerialNumbers = row.SerialNumbers
             }).ToList();
             StockTransferDraft mappedStockTransferDraft = new StockTransferDraft()
             {
                 DocObjectCode = _stockTransfer.DocObjectCode,
                 DocDate = _stockTransfer.DocDate,
                 DueDate = _stockTransfer.DueDate,
                 DocumentLines = stockTransferRowsList,
                 Comments = _stockTransfer.Comments,
                 Udfs = _stockTransfer.Udfs,
                 AttachmentEntry = _stockTransfer.AttachmentEntry,
                 ConfirmationEntry = _stockTransfer.ConfirmationEntry,
                 DocEntry = _stockTransfer.DocEntry,
                 DocNum = _stockTransfer.DocNum,
                 Filler = _stockTransfer.FromWarehouse,
                 TaxDate = _stockTransfer.TaxDate,
                 ToWhsCode = _stockTransfer.ToWarehouse,
                 SalesPersonCode = _stockTransfer.SalesPersonCode
             };
             CLContext<StockTransferDraft> slResponse = null;
             slResponse = await PatchDraft(mappedStockTransferDraft);
            
             if (slResponse.Code == HttpStatusCode.NoContent)
             {
                 CLContext<StockTransferDraft> oClContext = await ResolveCreatedDocument<StockTransferDraft>(slResponse,
                     SapDocumenType.Draft,
                     _stockTransfer.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                 if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                 {
                     throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                 }
                 oClContext.Response.Data.ConfirmationEntry = 0;
                 return oClContext;
             }
             return slResponse;
         }
         
         /// <summary>
         /// Method to obtain bin locations from a specific warehouse based on the item code.
         /// </summary>
         /// <param name="_whsCode">Warehouse code to filter the bin locations.</param>
         /// <param name="_itemCode">Item code to filter the bin locations for that specific item.</param>
         /// <returns>
         /// A task representing the context containing the list of bin locations for the specified warehouse and item code.
         /// </returns>
        public static async Task<CLContext<List<WarehouseBinLocation>>> GetWarehousesBinLocationFrom(string _whsCode, string _itemCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            
            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetWarehousesBinLocationFrom");
            
                List<WarehouseBinLocation> resultList = Common.ResolveSAPViewODBC<WarehouseBinLocation>(contextODBC, new Dictionary<string, object>()
                {
                    {"@ItemCode", $"{_itemCode}"},
                    {"@WhsCode", $"{_whsCode}"}
                });
            
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<WarehouseBinLocation>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<WarehouseBinLocation>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObjectBinLocationFrom = GetUserCtx("SL_GetWarehousesBinLocationFrom").Get(
                new FilterBaseWhsCodeItemCode()
                {
                    ItemCode = _itemCode,
                    WhsCode = _whsCode
                });
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObjectBinLocationFrom.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObjectBinLocationFrom.SendAsync<List<WarehouseBinLocation>>();
            #endregion
        }
        #endregion

        #region Purchase Orders

        /// <summary>
        /// Method to create purchase order
        /// </summary>
        /// <param name="_purchaseOrder">Model to create</param>
        /// <returns></returns>
        public static async Task<CLContext<PurchaseOrder>> PostPurchaseOrder(PurchaseOrder _purchaseOrder, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();

            int companyId = GetCompanyId();
            
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.PurchaseOrder);

            if (uniques.Response.Data != null)
            {
                return new CLContext<PurchaseOrder>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<PurchaseOrder>()
                    {
                        Data = new PurchaseOrder()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _purchaseOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            #region Validar si aplica query autorizacion

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_purchaseOrder, Constants.DocumentType.PurchaseOrder, userId, companyId);
            
            #endregion

            //Validar documento base preliminar
            int lineWithBaseType = _purchaseOrder.DocumentLines.Find(_x => _x.BaseType == -1)?.BaseEntry ?? -1;
            int lineWithBaseEntry = _purchaseOrder.DocumentLines.Find(_x => _x.BaseEntry > 0)?.BaseType ?? 0;

            CLContext<PurchaseOrder> slResponse = null;
            CLContext<DraftStatus> oClContextDraft=null;
            if (lineWithBaseType > 0)
            {
                //Obtener status del documento preliminar
                oClContextDraft = await ValidateStatusDraft(lineWithBaseType);
            }
            
            if (lineWithBaseEntry == -1 && lineWithBaseType > 0 && oClContextDraft!=null &&oClContextDraft.Response!=null &&oClContextDraft.Response.Data!=null)
            {
                #region Documento base preliminar

                //Obtener status del documento preliminar
                 oClContextDraft = await ValidateStatusDraft(lineWithBaseType);

                if (oClContextDraft is null || oClContextDraft.Response is null ||
                    oClContextDraft.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                _purchaseOrder.DocEntry = lineWithBaseType;

                // Pasar el documento en firme
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = lineWithBaseType
                    }
                };

                CLContext<ApprovalRequest> oClConfirmContext = null;

                //Validar si es autorzazion simulada
                if (oClContextDraft.Response.Data?.Status == null &&
                    oClContextDraft.Response.Data?.U_EMA_Approval_Status != null)
                {
                    //Status draft
                    switch (oClContextDraft.Response.Data.U_EMA_Approval_Status)
                    {
                        case Approval_Status.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                                    SapDocumenType.PurchaseOrder,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case Approval_Status.Rejected:
                            //Validar si tiene autorizaciones 
                            if (queryConditionApply.IsApply)
                            {
                                //patch draft
                                _purchaseOrder.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Pending,
                                    FieldType = "String"
                                });

                                _purchaseOrder.DocObjectCode = ((int)Constants.DocumentType.InvoicesFE).ToString();

                                CLContext<PurchaseOrder> oClContextPatchDraft =
                                    await PatchDraft<PurchaseOrder>(_purchaseOrder);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    slResponse = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                                        SapDocumenType.Draft,
                                        _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                }
                            }
                            else
                            {
                                //patch draft
                                _purchaseOrder.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Approved,
                                    FieldType = "String"
                                });

                                _purchaseOrder.DocObjectCode = ((int)Constants.DocumentType.PurchaseOrder).ToString();

                                CLContext<PurchaseOrder> oClContextPatchDraft =
                                    await PatchDraft<PurchaseOrder>(_purchaseOrder);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                    if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                    {
                                        slResponse = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                                            SapDocumenType.PurchaseOrder,
                                            _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }
                                }
                            }

                            break;
                    }
                }
                else // draft auto
                {
                    //status draft auto
                    switch (oClContextDraft.Response.Data.Status)
                    {
                        case StatusDraft.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                                    SapDocumenType.PurchaseOrder,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case StatusDraft.Rejected:
                            _purchaseOrder.DocObjectCode = ((int)Constants.DocumentType.PurchaseOrder).ToString();

                            CLContext<PurchaseOrder> oClContextPatchDraft =
                                await PatchDraft<PurchaseOrder>(_purchaseOrder);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {
                                oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                {
                                    //Validar si con patch draft crea documento en firme o sigue pendiente de autorizacion 

                                    #region Validar creacion documento en firme

                                    CLContext<PurchaseOrder> oClContext = await ResolveCreatedDocument<PurchaseOrder>(
                                        slResponse,
                                        SapDocumenType.PurchaseOrder,
                                        _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                                    if (oClContext is null || oClContext.Response is null ||
                                        oClContext.Response.Data is null)
                                    {
                                        return await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                                            SapDocumenType.Draft,
                                            _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }


                                    return oClContext;

                                    #endregion
                                }
                            }

                            break;
                    }
                }

                return slResponse;

                #endregion
            }
                else
                {


                    string removeLinesProperties = "BaseType,BaseEntry,BaseLine,LineNum,TaxRate,Udfs,UoMMasterData,LineStatus,VATLiable";
                    string removeHeaderProperties = "DocNum,DocEntry,DocTotal,Udfs,PriceList,DocStatus,DocObjectCode";

                    SLRequestObject oSlRequestObject = GetUserCtx("PostPurchaseOrder").Post(_purchaseOrder,
                        _fieldsToRemoveInHeaders: removeHeaderProperties,
                        _fieldsToRemoveInLines: removeLinesProperties);

                   

                    if (queryConditionApply.IsApply)
                    {
                        _purchaseOrder.DocObjectCode = ((int)Constants.DocumentType.PurchaseOrder).ToString();

                        _purchaseOrder.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Status",
                            Value = "arsPending",
                            FieldType = "String"
                        });

                        slResponse = await PostDraft<PurchaseOrder>(_purchaseOrder);
                    }
                    else
                    {
                        LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                        LogManager.Record($"REQUEST COMPLETED");

                        LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

                        // Add headear to prevent error on autorization process

                        oSlRequestObject.Headers = new ParameterCollection()
                        {
                            { new KeyValuePair<string, string>("Prefer", "return-no-content") }
                        };

                        slResponse = await oSlRequestObject.SendAsync<PurchaseOrder>();
                    }

                    if (slResponse.Code == HttpStatusCode.NoContent)
                    {
                        #region Validar si el tipo de documento aplica para autorizacion

                        bool apply = await TypeOfDocumentAppliesForAuthorizationProcess(_purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "",
                                                                                     Constants.DocumentType.PurchaseOrder);

                    #endregion

                    string table =
                            (apply || queryConditionApply.IsApply)
                                ? SapDocumenType.Draft
                                : SapDocumenType.PurchaseOrder;

                        CLContext<PurchaseOrder> oClContext = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                            table,
                            _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                        if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                        {
                            throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                        }
                        if (apply)
                        {
                            NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                            try
                            {
                                CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                                if (oCLContextSetting.Response.Data != null)
                                {
                                    List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                    oDraftsSetting = settingList.Find(_setting => _setting.CompanyId==companyId);
                                    if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                    {
                                        await SendNotifyAutoritation(oClContext.Response.Data.DocEntry, companyId, true, queryConditionApply);
                                    }
                                }
                            }
                            catch (Exception e)
                            {
                                LogManager.Record($"Error: {e.Message}");
                            }
                        }

                        return oClContext;
                    }

                }
                return slResponse;

        }

        /// <summary>
        /// Method to update purchase order
        /// </summary>
        /// <param name="_purchaseOrder"></param>
        /// <returns></returns>
        public static async Task<CLContext<PurchaseOrder>> PatchPurchaseOrder(PurchaseOrder _purchaseOrder,DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _purchaseOrder.DocumentLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);

            if (hasClosedLines)
            {
                //Elimino las lineas que esten cerradas
                _purchaseOrder.DocumentLines = _purchaseOrder.DocumentLines
                    .Where(l => l.LineStatus != LineStatus.bost_Close).ToList();
            }

            string removeLinesProperties = "BaseType,BaseEntry,BaseLine,TaxRate,Udfs,UoMMasterData,LineStatus,VATLiable";

            string removeHeaderProperties = "DocNum,DocEntry,DocTotal,PriceList,DocStatus,DocObjectCode";

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _purchaseOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject oSlRequestObject = GetUserCtx("PatchPurchaseOrder")
                .Patch(_purchaseOrder, _fieldsToRemoveInHeaders: removeHeaderProperties,
                    _fieldsToRemoveInLines: removeLinesProperties);

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            if (!hasClosedLines)
            {
                headers.Add(new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true"));
            }

            oSlRequestObject.Headers = headers;

            LogManager.Record($"URL: {oSlRequestObject.Url_Request} MODEL: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<PurchaseOrder>();
        }
        
        /// <summary>
        /// Method to obtain purchase orders based on specific filters.
        /// </summary>
        /// <param name="_slpCode">Sales employee code to filter purchase orders.</param>
        /// <param name="_dateFrom">Start date for filtering purchase orders.</param>
        /// <param name="_dateTo">End date for filtering purchase orders.</param>
        /// <param name="_docNum">Document number to search for a specific purchase order.</param>
        /// <param name="_docStatus">Document status to filter purchase orders.</param>
        /// <param name="_cardCode">Optional. Business partner code to filter purchase orders.</param>
        /// <param name="_cardName">Optional. Business partner name to filter purchase orders.</param>
        /// <returns>
        /// A task representing the context containing the filtered list of purchase orders.
        /// </returns>
        public static async Task<CLContext<List<PurchaseOrder>>> GetPurchaseOrders(int _slpCode, string _dateFrom,
            string _dateTo, int _docNum, string _docStatus, string _cardCode = "", string _cardName = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            
            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseOrders");
            
                List<PurchaseOrder> purchaseOrders = Common.ResolveSAPViewODBC<PurchaseOrder>(contextODBC, new Dictionary<string, object>
                {
                    { "@SlpCode", _slpCode },
                    { "@DateFrom", _dateFrom },
                    { "@DateTo", _dateTo },
                    { "@DocNum", _docNum },
                    { "@DocStatus", _docStatus },
                    { "@CardCode", _cardCode },
                    { "@CardName", _cardName }
                });
            
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<PurchaseOrder>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PurchaseOrder>>()
                    {
                        Data = purchaseOrders
                    },
                    value = purchaseOrders
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseOrders").Get<FilterPurchaseDocuments>();

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<PurchaseOrder>>();
            #endregion
        }

        /// <summary>
        /// Method to obtain a specific purchase order based on the document entry.
        /// </summary>
        /// <param name="_docEntry">The unique identifier (DocEntry) of the purchase order.</param>
        /// <returns>
        /// A task representing the context containing the requested purchase order.
        /// </returns>
        public static async Task<CLContext<PurchaseOrder>> GetPurchaseOrder(int _docEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<PurchaseOrder> oClContext = new CLContext<PurchaseOrder>();
            CLContext<List<PurchaseOrderRows>> oClContextRows = new CLContext<List<PurchaseOrderRows>>();
            CLContext<List<WithholdingTaxCode>> oClContextWithholding = new CLContext<List<WithholdingTaxCode>>();
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseOrder");
                
                List<PurchaseOrder> resultList = Common.ResolveSAPViewODBC<PurchaseOrder>(contextODBC, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<PurchaseOrder>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<PurchaseOrder>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                
                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetPurchaseOrderRows");

                List<PurchaseOrderRows> resultListLines = Common.ResolveSAPViewODBC<PurchaseOrderRows>(contextODBCLines, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextRows = new CLContext<List<PurchaseOrderRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PurchaseOrderRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };
                
                ClUserContextODBC contextODBCWithholdingTax = GetUserCtxODBC("ODBC_WithholdingTaxByPurchaseOrder");
            
                List<WithholdingTaxCode> resultListWithholdingTax = Common.ResolveSAPViewODBC<WithholdingTaxCode>(contextODBCWithholdingTax, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE WITHHOLDING TAX ODBC: {contextODBCWithholdingTax.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextWithholding = new CLContext<List<WithholdingTaxCode>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<WithholdingTaxCode>>()
                    {
                        Data = resultListWithholdingTax
                    },
                    value = resultListWithholdingTax
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseOrder").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContext = await oSlRequestObject.SendAsync<PurchaseOrder>();
                
                SLRequestObject oSlRequestObjectRows = GetUserCtx("SL_GetPurchaseOrderRows").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE LINES SL: {oSlRequestObjectRows.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContextRows = await oSlRequestObjectRows.SendAsync<List<PurchaseOrderRows>>();
                
                SLRequestObject oSlRequestObjectWithholdingTax = GetUserCtx("SL_WithholdingTaxByPurchaseOrder").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE WITHHOLDING TAX SL: {oSlRequestObjectWithholdingTax.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContextWithholding = await oSlRequestObjectWithholdingTax.SendAsync<List<WithholdingTaxCode>>();
                #endregion
            }

            oClContext.Response.Data.DocumentLines = oClContextRows.Response.Data;
            oClContext.Response.Data.WithholdingTaxDataCollection = oClContextWithholding.Response.Data;

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA

            if (oClContextRows.Response.Data is object && oClContextRows.Response.Data.Count > 0)
            {
                foreach (PurchaseOrderRows item in oClContext.Response.Data.DocumentLines)
                {
                    if (!String.IsNullOrEmpty(item.WarehouseCode))
                    {
                        item.UoMMasterData = await GetUomMasterDataFilter(item.ItemCode, item.WarehouseCode,
                                                oClContext.Response.Data.PriceList,
                                                "Y");
                    }
                }
            }

            #endregion
            
            return oClContext;
        }
        /// <summary>
        /// Method to create draft order
        /// </summary>
        /// <param name="_purchaseOrder"></param>
        /// <returns></returns>
        public static async Task<CLContext<PurchaseOrder>> PostPurchaseOrderDrafts(PurchaseOrder _purchaseOrder,DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<PurchaseOrder>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<PurchaseOrder>()
                    {
                        Data = new PurchaseOrder()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _purchaseOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<PurchaseOrder> slResponse = null;
            
            slResponse = await PostDraft<PurchaseOrder>(_purchaseOrder);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<PurchaseOrder> oClContext = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                    SapDocumenType.Draft,
                    _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;

    
                return oClContext;
            }
            
            return slResponse;
        }
        
        /// <summary>
        /// Method to update draft order
        /// </summary>
        /// <param name="_purchaseOrder"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<PurchaseOrder>> PatchPurchaseOrderDrafts(PurchaseOrder _purchaseOrder,DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _purchaseOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            _purchaseOrder.DocObjectCode = ((int)Constants.DocumentType.PurchaseOrder).ToString();
            CLContext<PurchaseOrder> slResponse = await PatchDraft(_purchaseOrder);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<PurchaseOrder> oClContext = await ResolveCreatedDocument<PurchaseOrder>(slResponse,
                    SapDocumenType.Draft,
                    _purchaseOrder.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
                return oClContext;
            }
            return slResponse;
        }

        #endregion

        #region UomMasterData

        /// <summary>
        /// Retrieves a list of Unit of Measure (UoM) master data based on the specified parameters.
        /// </summary>
        /// <param name="_itemCode">The code of the item for which UoM data is being requested.</param>
        /// <param name="_whsCode">The warehouse code associated with the item.</param>
        /// <param name="_priceList">The price list identifier to filter the UoM data.</param>
        /// <param name="_prchseItem">A flag indicating whether the item is a purchase item.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{UoMMasterData}}"/> 
        /// containing the list of UoM master data.
        /// </returns>
        public static async Task<CLContext<List<UoMMasterData>>> GetUomMasterData(string _itemCode,
            string _whsCode, int _priceList, string _prchseItem)
        {
            LogManager.Record($"REQUESTING OUM MASTER DATA");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<UoMMasterData>> oCLContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetUomMasterData");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<UoMMasterData> resultList = Common.ResolveSAPViewODBC<UoMMasterData>(contextODBC,
                new Dictionary<string, object>()
                {
                    {"@ItemCode", _itemCode},
                    {"@WhsCode", _whsCode},
                    {"@PriceList", _priceList},
                    {"@PrchseItem", _prchseItem}
                });

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = new CLContext<List<UoMMasterData>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UoMMasterData>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetUomMasterData").Get<FilterItem>(new FilterItem()
                {
                    ItemCode = _itemCode,
                    WhsCode = _whsCode,
                    PriceList = _priceList,
                    PrchseItem = _prchseItem
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = await requestModel.SendAsync<List<UoMMasterData>>();

                #endregion

            }

            return oCLContext;
        }

        /// <summary>
        /// Retrieves the last purchase price of a specific item from the database.
        /// </summary>
        /// <param name="_itemCode">The item code to search for the last purchase price.</param>
        /// <returns>A CLContext containing the last purchase price and item data.</returns>
        public static async Task<CLContext<ItemDataForInvoiceGoodReceipt>> GetItemLastPurchagePrice(string _itemCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemLastPurchagePrice");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemDataForInvoiceGoodReceipt> resultList = Common.ResolveSAPViewODBC<ItemDataForInvoiceGoodReceipt>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<ItemDataForInvoiceGoodReceipt>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ItemDataForInvoiceGoodReceipt>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetItemLastPurchagePrice").Get<FilterBaseItemCode>( new FilterBaseItemCode()
                {
                    ItemCode = _itemCode
                });

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<ItemDataForInvoiceGoodReceipt>();
            #endregion

        }

        /// <summary>
        /// Retrieves the average price of a specific item from the database.
        /// </summary>
        /// <param name="_itemCode">The item code to search for the average price.</param>
        /// <returns>A CLContext containing the average price and item data.</returns>
        public static async Task<CLContext<ItemDataForInvoiceGoodReceipt>> GetItemAVGPrice(string _itemCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemAVGPrice");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemDataForInvoiceGoodReceipt> resultList = Common.ResolveSAPViewODBC<ItemDataForInvoiceGoodReceipt>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<ItemDataForInvoiceGoodReceipt>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ItemDataForInvoiceGoodReceipt>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetItemAVGPrice").Get<FilterBaseItemCode>( new FilterBaseItemCode()
                {
                    ItemCode = _itemCode
                });

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<ItemDataForInvoiceGoodReceipt>();
            #endregion
        }

        #endregion

        #region MasterData

        /// <summary>
        /// Retrieves master data records for the specified entity type (e.g., BusinessPartners or ItemSearch)
        /// using either ODBC or Service Layer based on the connection configuration.
        /// </summary>
        /// <typeparam name="T">
        /// The entity type to retrieve data for. Supported types are <see cref="BusinessPartners"/> and <see cref="ItemSearch"/>.
        /// </typeparam>
        /// <param name="_filterValue">
        /// The value used to filter the results. For BusinessPartners, it's typically a name or code;
        /// for items, it could be an item code or description.
        /// </param>
        /// <returns>
        /// A <see cref="CLContext{List{T}}"/> object containing the filtered master data results or an empty list if no results were found.
        /// </returns>
        public static async Task<CLContext<List<T>>> GetMasterData<T>(string _filterValue) where T : class
        {
            LogManager.Record($"REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            

            SLRequestObject requestModel = null;
            ClUserContextODBC contextODBC = null;

            if (typeof(T) == typeof(BusinessPartners))
            {
                if (connectionMode == SapConnectionType.ODBC)
                {
                    #region Query Via ODBC
                    contextODBC = GetUserCtxODBC("ODBC_GetBPMaterData");
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                    
                    List<T> resultList = Common.ResolveSAPViewODBC<T>(contextODBC, new Dictionary<string, object>()
                    {
                        {"@FilterBusinessPartner", $"{_filterValue}"}
                    });
                
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                    LogManager.Record("REQUEST COMPLETED");

                    return new CLContext<List<T>>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<List<T>>()
                        {
                            Data = resultList
                        },
                        value = resultList
                    };
                    #endregion
                }
                else
                {
                    #region Query Via SL
                    requestModel = GetUserCtx("SL_GetBPMaterData").Get<FilterSearchMasterDataBusinessPartner>();

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                    
                    return await requestModel.SendAsync<List<T>>();
                    #endregion

                }
                
            }

            if (typeof(T) == typeof(ItemSearch))
            {
                CLContext<List<T>> oClContextItems = new CLContext<List<T>>();
                
                if (connectionMode == SapConnectionType.ODBC)
                {
                    #region Query Via ODBC
                    contextODBC = GetUserCtxODBC("ODBC_GetItemsMaterData");
            
                    List<T> resultList = Common.ResolveSAPViewODBC<T>(contextODBC, new Dictionary<string, object>()
                    {
                        {"@FilterItem", $"{_filterValue}"}
                    });
                
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                    

                    oClContextItems = new CLContext<List<T> >()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<List<T> >()
                        {
                            Data = resultList
                        },
                        value = resultList
                    };

                    #endregion
                }
                else
                {
                    #region Query Via SL
                    requestModel = GetUserCtx("SL_GetItemsMaterData").Get<FilterSearchMasterDataItem>();

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                    oClContextItems = await requestModel.SendAsync<List<T>>();
                    #endregion
                }
                
                LogManager.Record("REQUEST COMPLETED");

                if (oClContextItems.Response.Data is object && oClContextItems.Response.Data.Count > 0)
                {
                    List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                        GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
                    
                    int oCompanyId = GetCompanyId();

                    SettingTypeaheadFormat pattern =
                        companiesTypeaheadFormat.FirstOrDefault(_tf => _tf.CompanyId == oCompanyId);

                    foreach (ItemSearch oItemsModel in oClContextItems.Response?.Data as List<ItemSearch>)
                    {
                        oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern?.ItemPattern, oItemsModel.ItemCode,
                            oItemsModel.ItemName, "", oItemsModel.BarCode,
                            "", "");
                    }
                }

                return oClContextItems;
            }

            return new CLContext<List<T>>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<T>>()
                {
                    Data = new List<T>()
                },
                value = new List<T>()
            };
        }
        /// <summary>
        /// Retrieves a single master data record of the specified type using a filter value.
        /// </summary>
        /// <typeparam name="T">
        /// The type of master data to retrieve. Supported types are <see cref="ItemsModel"/> and <see cref="BusinessPartners"/>.
        /// </typeparam>
        /// <param name="_filterValue">
        /// The filter value used to search the master data
        /// </param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing the first matching record of type <typeparamref name="T"/>,
        /// or null if no data was found.
        /// </returns>
        public static async Task<CLContext<T>> GetMasterDataOne<T>(string _filterValue) where T : class
        {
            LogManager.Record($"REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            
            SLRequestObject requestModel = null;
            ClUserContextODBC contextODBC = null;
            List<T> resultList = null;

            if (typeof(T) == typeof(ItemsModel))
            {
                if (connectionMode == SapConnectionType.ODBC)
                {
                    #region Query Via ODBC
                    contextODBC = GetUserCtxODBC("ODBC_GetItemsMaterDataByItemCode");
            
                    resultList = Common.ResolveSAPViewODBC<T>(contextODBC, new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_filterValue}"}
                    });
                
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");

                    #endregion
                }
                else
                {
                    #region Query Via SL
                    requestModel = GetUserCtx("SL_GetItemsMaterDataByItemCode").Get<FilterMasterDataItem>();

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                    #endregion
                }
                
            }

            if (typeof(T) == typeof(BusinessPartners))
            {
                if (connectionMode == SapConnectionType.ODBC)
                {
                    #region Query Via ODBC
                    contextODBC = GetUserCtxODBC("ODBC_GetBPMaterDataByCardCode");
            
                    resultList = Common.ResolveSAPViewODBC<T>(contextODBC, new Dictionary<string, object>()
                    {
                        {"@CardCode", $"{_filterValue}"}
                    });
                
                    LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");

                    #endregion
                }
                else
                {
                    #region Query Via SL
                    requestModel = GetUserCtx("SL_GetBPMaterDataByCardCode").Get<FilterMasterDataBusinessPartners>();

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                    #endregion
                }
                
            }

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
               return new CLContext<T>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<T>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                CLContext<List<T>> oClContext = await requestModel.SendAsync<List<T>>();

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<T>()
                {
                    Code = oClContext.Code,
                    Response = new Response<T>()
                    {
                        Data = oClContext.Response.Data.FirstOrDefault(),
                        Message = oClContext.Response.Message
                    }
                };
                #endregion
            }
            
        }
        
        /// <summary>
        /// Retrieves detailed inventory information for a specific item.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_itemCode">The item code to retrieve inventory details for.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{ItemInventoryDetail}"/> with inventory details.
        /// </returns>
        public static async Task<CLContext<List<ItemInventoryDetail>>> GetItemInventoryDetails(string _itemCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetItemInventoryDetails");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@ItemCode", _itemCode ?? "" }
                };

                List<ItemInventoryDetail> resultList =
                     Common.ResolveSAPViewODBC<ItemInventoryDetail>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<ItemInventoryDetail>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemInventoryDetail>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterMasterDataItem filter = new FilterMasterDataItem
                {
                    ItemCode = _itemCode ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetItemInventoryDetails").Get<FilterMasterDataItem>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<ItemInventoryDetail>>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves a list of business partners that are pending activation, filtered by a date range and customer identifier.
        /// </summary>
        /// <param name="_dateFrom">
        /// The start date (inclusive) of the range to filter business partners, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_dateTo">
        /// The end date (inclusive) of the range to filter business partners, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_customer">
        /// The customer identifier to filter the business partners.
        /// </param>
        /// <returns>
        /// A <see cref="Task{TResult}"/> representing the asynchronous operation, with a <see cref="CLContext{T}"/> result
        /// containing a list of <see cref="BusinessPartners"/> objects that match the specified criteria.
        /// </returns>
        /// <remarks>
        /// This method queries the data source for business partners that need to be activated, using the provided date range and customer filter.
        /// </remarks>
        public static async Task<CLContext<List<BusinessPartners>>> GetBusinessPartnerToActivate(string _dateFrom, string _dateTo, string _customer)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetBusinessPartnerToActivate");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DateFrom", $"{_dateFrom ?? ""}"},
                        {"@DateTo", $"{_dateTo ?? ""}"},
                        {"@Customer", $"{_customer ?? ""}"}
                    });

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<BusinessPartners>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetBusinessPartnerToActivate").Get(new FilterBusinessPartnerToActivate()
                {
                    DateFrom = _dateFrom ?? "",
                    DateTo = _dateTo ?? "",
                    Customer = _customer ?? ""
                });

                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await oSlRequestObject.SendAsync<List<BusinessPartners>>();

                #endregion
            }
        }

        #endregion

        #region ConsolidationBP
        /// <summary>
        /// Retrieves a list of business partners for consolidation purposes, filtered by business partner type and one or more currencies.
        /// </summary>
        /// <param name="_cardType">
        /// The type of business partner to filter by (e.g., "Customer", "Supplier").
        /// </param>
        /// <param name="_currency">
        /// An array of currency codes (e.g., "USD", "CRC") to filter the business partners.
        /// </param>
        /// <returns>
        /// A <see cref="Task{TResult}"/> representing the asynchronous operation, with a <see cref="CLContext{T}"/> result
        /// containing a list of <see cref="BusinessPartners"/> objects that match the specified type and currencies.
        /// </returns>
        /// <remarks>
        /// This method is typically used to obtain business partners for financial or operational consolidation, based on the specified filters.
        /// </remarks>
        public static async Task<CLContext<List<BusinessPartners>>> GetConsolidationBP(string _cardType, string[] _currency)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string resourceName = string.Empty;

            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                Dictionary<string, object> parametersODBC = new Dictionary<string, object>();

                // Determinar nombre del recurso y parámetros según cantidad de monedas
                if (_currency.Length > 1)
                {
                    resourceName = "GetConsolidationBPByTwoCurrency";
                    parametersODBC.Add("@CardType", $"{_cardType ?? ""}");
                    parametersODBC.Add("@CurrencyOne", $"{_currency[0] ?? ""}");
                    parametersODBC.Add("@CurrencyTwo", $"{_currency[1] ?? ""}");
                }
                else
                {
                    resourceName = "GetConsolidationBP";
                    parametersODBC.Add("@CardType", $"{_cardType ?? ""}");
                    parametersODBC.Add("@Currency", $"{_currency[0] ?? ""}");
                }

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resourceName}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC, parametersODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<BusinessPartners>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = null;

                if (_currency.Length > 1)
                {
                    FilterConsolidationBusinessPartnerByTwoCurrency filter =
                        new FilterConsolidationBusinessPartnerByTwoCurrency()
                        {
                            CardType = _cardType,
                            CurrencyOne = HttpUtility.UrlEncode(_currency[0]),
                            CurrencyTwo = HttpUtility.UrlEncode(_currency[1])
                        };
                    resourceName = "SL_GetConsolidationBPByTwoCurrency";
                    requestModel = GetUserCtx(resourceName).Get(filter);
                }
                else
                {
                    FilterConsolidationBusinessPartner filter = new FilterConsolidationBusinessPartner()
                    {
                        CardType = _cardType,
                        Currency = HttpUtility.UrlEncode(_currency[0])
                    };

                    resourceName = "SL_GetConsolidationBP";
                    requestModel = GetUserCtx(resourceName).Get(filter);
                }

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<BusinessPartners>>();

                #endregion
            }
        }
        #endregion

        #region Taxes

        /// <summary>
        /// Retrieves a list of sales taxes for accounts receivable.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{SalesTaxes}}"/> 
        /// containing the list of sales taxes.
        /// </returns>
        public static async Task<CLContext<List<SalesTaxes>>> GetTaxesAR()
        {
            LogManager.Record($"REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();
            
            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            
            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetTaxesAR");
                
                List<SalesTaxes> resultList = Common.ResolveSAPViewODBC<SalesTaxes>(contextODBC);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");
                
                return new CLContext<List<SalesTaxes>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesTaxes>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetTaxesAR").Get();

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<List<SalesTaxes>>();
            #endregion
        }

        /// <summary>
        /// Retrieves a list of sales taxes for accounts payable.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{SalesTaxes}}"/> 
        /// containing the list of sales taxes.
        /// </returns>
        public static async Task<CLContext<List<SalesTaxes>>> GetTaxesAP()
        {
            LogManager.Record($"REQUESTING RECORDS");
            
            string connectionMode = GetConnectionMode();
            
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetTaxesAP");

                List<SalesTaxes> resultList = Common.ResolveSAPViewODBC<SalesTaxes>(contextODBC);
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<SalesTaxes>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesTaxes>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetTaxesAP").Get();

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<List<SalesTaxes>>();
            #endregion
        }

        #endregion

        #region SigIn

        /// <summary>
        /// Authenticates against the Service Layer using the provided license credentials.
        /// Retrieves the stored password if not present, then sends a POST to the "Login" endpoint.
        /// </summary>
        /// <param name="_license">
        /// The <see cref="CLMLTEMA.MODELS.License"/> containing CompanyId, Id, and optional Password/User information.
        /// </param>
        /// <returns>
        /// A <see cref="Task"/> that completes when the sign-in process finishes.
        /// </returns>
        /// <exception cref="CLException">
        /// Thrown if the credentials are invalid (HTTP 401) or if any network/processing error occurs.
        /// </exception>
        private static async System.Threading.Tasks.Task SignIn(CLMLTEMA.MODELS.License _license)
        {
            LogManager.Record("REQUESTING RECORDS");

            HttpResponseMessage oHttpResponseMessage = null;
            HttpClient oHttpClient = null;

            CLContext<TestLicence> oClContextLicense = Services
                .Execute<TestLicence, FilterTestLicense, MainDBContext, ICLSingle>("GetSignIn",
                    new FilterTestLicense()
                    {
                        Id = _license.Id,
                        CompanyId = _license.CompanyId
                    }).Get();

            if (string.IsNullOrEmpty(_license.Password))
            {
                _license.Password = oClContextLicense.Response.Data.Password;
            }

            try
            {
                ServicePointManager.Expect100Continue = false;
                HttpClientHandler handler = new HttpClientHandler
                    { AutomaticDecompression = DecompressionMethods.GZip | DecompressionMethods.Deflate };
                oHttpClient = new HttpClient(handler);
                oHttpClient.DefaultRequestHeaders.Accept.Clear();
                oHttpClient.Timeout = TimeSpan.FromSeconds(3600);
                oHttpClient.BaseAddress = new Uri(oClContextLicense.Response.Data.SLUrl);
                HttpRequestMessage Request = new HttpRequestMessage(new HttpMethod("POST"), "Login");
                StringContent oStringContent = new StringContent(JsonConvert.SerializeObject(new LoginContent()
                {
                    CompanyDB = oClContextLicense.Response.Data.DBCode,
                    Password = _license.Password,
                    UserName = _license.User
                }), null, "application/json");
                oStringContent.Headers.ContentType.CharSet = "";
                Request.Content = oStringContent;

                oHttpResponseMessage = await oHttpClient.SendAsync(Request);

                LogManager.Record($"REQUEST COMPLETED");

                if (!oHttpResponseMessage.IsSuccessStatusCode)
                {
                    if (oHttpResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                    {
                        throw new CLException($"Credenciales incorrectos", HttpStatusCode.Forbidden);
                    }
                    else
                    {
                        throw new CLException($"{oHttpResponseMessage.ReasonPhrase}",
                            oHttpResponseMessage.StatusCode);
                    }
                }
            }
            catch (Exception ex)
            {
                throw new CLException($"CL - {ex.Message}", HttpStatusCode.InternalServerError);
            }
            finally
            {
                if (oHttpClient is object) oHttpClient.Dispose();
                if (oHttpResponseMessage is object) oHttpResponseMessage.Dispose();
            }
        }

        /// <summary>
        /// Logs in to the Service Layer using the provided user context and returns the session ID.
        /// </summary>
        /// <param name="_clUser"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<string> LoginSL(ClUserContext _clUser)
        {
            LogManager.Record("SEND LOGIN");

            HttpResponseMessage oHttpResponseMessage = null;
            HttpClient oHttpClient = null;

            try
            {
                ServicePointManager.Expect100Continue = false;
                HttpClientHandler handler = new HttpClientHandler
                { AutomaticDecompression = DecompressionMethods.GZip | DecompressionMethods.Deflate };
                oHttpClient = new HttpClient(handler);
                oHttpClient.DefaultRequestHeaders.Accept.Clear();
                oHttpClient.Timeout = TimeSpan.FromSeconds(3600);
                oHttpClient.BaseAddress = new Uri(_clUser.SLUrl);

                HttpRequestMessage Request = new HttpRequestMessage(HttpMethod.Post, "Login");

                StringContent oStringContent = new StringContent(
                    JsonConvert.SerializeObject(new LoginContent()
                    {
                        CompanyDB = _clUser.DBCode,
                        Password = _clUser.Password,
                        UserName = _clUser.License
                    }),
                    Encoding.UTF8,
                    "application/json"
                );
                Request.Content = oStringContent;

                oHttpResponseMessage = await oHttpClient.SendAsync(Request);

                string result = await oHttpResponseMessage.Content.ReadAsStringAsync();


                if (!oHttpResponseMessage.IsSuccessStatusCode)
                {
                    if (oHttpResponseMessage.StatusCode == HttpStatusCode.Unauthorized)
                    {
                        throw new CLException($"Credenciales incorrectos", HttpStatusCode.Forbidden);
                    }
                    else
                    {
                        throw new CLException($"{oHttpResponseMessage.ReasonPhrase}",
                            oHttpResponseMessage.StatusCode);
                    }
                }

                dynamic jsonResponse = JsonConvert.DeserializeObject(result);

                string sessionId = jsonResponse.SessionId;

                LogManager.Record($"LOGIN COMPLETED");
                return sessionId;
            }
            catch (Exception ex)
            {
                throw new CLException($"CL - {ex.Message}", HttpStatusCode.InternalServerError);
            }
            finally
            {
                if (oHttpClient is object) oHttpClient.Dispose();
                if (oHttpResponseMessage is object) oHttpResponseMessage.Dispose();
            }
        }


        #endregion

        #region Mercancias

        /// <summary>
        /// Method to create purchase delivery notes
        /// </summary>
        /// <param name="_goodsReceiptPo"></param>
        /// <returns></returns>
        public static async Task<CLContext<GoodsReceiptPO>> PostPurchaseDeliveryNotes(GoodsReceiptPO _goodsReceiptPo, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();

            int companyId = GetCompanyId();
            
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId


            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.GoodReceiptPO);

            if (uniques.Response.Data != null)
            {
                return new CLContext<GoodsReceiptPO>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReceiptPO>()
                    {
                        Data = new GoodsReceiptPO()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }
            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _goodsReceiptPo.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            #endregion

            #region Validar si aplica query autorizacion

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_goodsReceiptPo, Constants.DocumentType.GoodReceiptPO, userId, companyId);

            #endregion

            //Validar documento base preliminar
            int lineWithBaseType = _goodsReceiptPo.DocumentLines.Find(_x => _x.BaseType == -1)?.BaseEntry ?? -1;
            int lineWithBaseEntry = _goodsReceiptPo.DocumentLines.Find(_x => _x.BaseEntry > 0)?.BaseType ?? 0;

            CLContext<GoodsReceiptPO> slResponse = null;

            if (lineWithBaseEntry == -1 && lineWithBaseType > 0)
            {
                #region Documento base preliminar

                //Obtener status del documento preliminar
                CLContext<DraftStatus> oClContextDraft = await ValidateStatusDraft(lineWithBaseType);

                if (oClContextDraft is null || oClContextDraft.Response is null ||
                    oClContextDraft.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                _goodsReceiptPo.DocEntry = lineWithBaseType;

                // Pasar el documento en firme
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = lineWithBaseType
                    }
                };

                CLContext<ApprovalRequest> oClConfirmContext = null;

                //Validar si es autorzazion simulada
                if (oClContextDraft.Response.Data?.Status == null &&
                    oClContextDraft.Response.Data?.U_EMA_Approval_Status != null)
                {
                    //Status draft
                    switch (oClContextDraft.Response.Data.U_EMA_Approval_Status)
                    {
                        case Approval_Status.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<GoodsReceiptPO>(slResponse,
                                    SapDocumenType.GoodReceiptPO,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case Approval_Status.Rejected:
                            //Validar si tiene autorizaciones 
                            if (queryConditionApply.IsApply)
                            {
                                //patch draft
                                _goodsReceiptPo.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Pending,
                                    FieldType = "String"
                                });

                                _goodsReceiptPo.DocObjectCode = ((int)Constants.DocumentType.GoodReceiptPO).ToString();

                                CLContext<GoodsReceiptPO> oClContextPatchDraft =
                                    await PatchDraft<GoodsReceiptPO>(_goodsReceiptPo);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    slResponse = await ResolveCreatedDocument<GoodsReceiptPO>(slResponse,
                                        SapDocumenType.Draft,
                                        _goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                }
                            }
                            else
                            {
                                //patch draft
                                _goodsReceiptPo.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Approved,
                                    FieldType = "String"
                                });

                                _goodsReceiptPo.DocObjectCode = ((int)Constants.DocumentType.GoodReceiptPO).ToString();

                                CLContext<GoodsReceiptPO> oClContextPatchDraft =
                                    await PatchDraft<GoodsReceiptPO>(_goodsReceiptPo);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                    if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                    {
                                        slResponse = await ResolveCreatedDocument<GoodsReceiptPO>(slResponse,
                                            SapDocumenType.GoodReceiptPO,
                                            _goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }
                                }
                            }

                            break;
                    }
                }
                else // draft auto
                {
                    //status draft auto
                    switch (oClContextDraft.Response.Data.Status)
                    {
                        case StatusDraft.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<GoodsReceiptPO>(slResponse,
                                    SapDocumenType.GoodReceiptPO,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case StatusDraft.Rejected:
                            _goodsReceiptPo.DocObjectCode = ((int)Constants.DocumentType.PurchaseOrder).ToString();

                            CLContext<GoodsReceiptPO> oClContextPatchDraft =
                                await PatchDraft<GoodsReceiptPO>(_goodsReceiptPo);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {
                                oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                {
                                    //Validar si con patch draft crea documento en firme o sigue pendiente de autorizacion 

                                    #region Validar creacion documento en firme

                                    CLContext<GoodsReceiptPO> oClContext = await ResolveCreatedDocument<GoodsReceiptPO>(
                                        slResponse,
                                        SapDocumenType.GoodReceiptPO,
                                        _goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                                    if (oClContext is null || oClContext.Response is null ||
                                        oClContext.Response.Data is null)
                                    {
                                        return await ResolveCreatedDocument<GoodsReceiptPO>(slResponse,
                                            SapDocumenType.Draft,
                                            _goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }


                                    return oClContext;

                                    #endregion
                                }
                            }

                            break;
                    }
                }

                return slResponse;

                #endregion
            }
            else
            {

            Dictionary<string, Func<JProperty, bool>> lineFlushCondition =
                new Dictionary<string, Func<JProperty, bool>>();

            if (_goodsReceiptPo.DocumentLines.Exists(x => x.BaseEntry == null))
            {
                Func<JProperty, bool> result = new Func<JProperty, bool>(_property =>
                    _property.Value == null || Convert.ToInt32(_property.Value) == -1);

                lineFlushCondition.Add("BaseEntry", result);
                lineFlushCondition.Add("BaseType", result);
                lineFlushCondition.Add("BaseLine", result);
            }

            string removeHeaderProperties = "DocEntry,DocNum,Series,Udfs,DocTotal,PriceList,DocObjectCode";
            string removeLineProperties = "TaxRate, Udfs,LineNum,UoMMasterData,LineStatus,VATLiable";

            SLRequestObject oSlRequestObject = GetUserCtx("PostPurchaseDeliveryNotes")
                .Post(_goodsReceiptPo, removeHeaderProperties, removeLineProperties, null, null, null, null,
                    lineFlushCondition);

        

            if (queryConditionApply.IsApply)
            {
                _goodsReceiptPo.DocObjectCode = ((int)Constants.DocumentType.GoodReceiptPO).ToString();

                _goodsReceiptPo.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });

                slResponse = await PostDraft<GoodsReceiptPO>(_goodsReceiptPo);
            }
            else
            {
                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

                // Add headear to prevent error on autorization process

                oSlRequestObject.Headers = new ParameterCollection()
                {
                    { new KeyValuePair<string, string>("Prefer", "return-no-content") }
                };

                slResponse = await oSlRequestObject.SendAsync<GoodsReceiptPO>();
            }

            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                #region Validar si el tipo de documento aplica para autorizacion

                bool apply = await TypeOfDocumentAppliesForAuthorizationProcess(_goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "",
                                                                                     Constants.DocumentType.GoodReceiptPO);

                #endregion

                string table =
                (apply || queryConditionApply.IsApply)
                    ? SapDocumenType.Draft
                    : SapDocumenType.GoodReceiptPO;

                CLContext<GoodsReceiptPO> oClContext = await ResolveCreatedDocument<GoodsReceiptPO>(slResponse, table,
                    _goodsReceiptPo.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                if (apply)
                {
                    NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                    try
                    {
                        CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                        if (oCLContextSetting.Response.Data != null)
                        {
                            List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                            oDraftsSetting = settingList.Find(_setting => _setting.CompanyId==companyId);
                            if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                            {
                                await SendNotifyAutoritation(oClContext.Response.Data.DocEntry, companyId, true, queryConditionApply);
                            }
                        }
                    }
                    catch (Exception e)
                    {
                        LogManager.Record($"Error: {e.Message}");
                    }
                }


                return oClContext;

            }
        }
        return slResponse;

        }
        
        /// <summary>
        /// Retrieves a list of purchase delivery notes based on the specified criteria.
        /// </summary>
        /// <param name="_slpCode">The sales representative's code.</param>
        /// <param name="_dateFrom">The start date for filtering purchase delivery notes (format: YYYY-MM-DD).</param>
        /// <param name="_dateTo">The end date for filtering purchase delivery notes (format: YYYY-MM-DD).</param>
        /// <param name="_docNum">The document number of the purchase delivery note.</param>
        /// <param name="_docStatus">The status of the document (e.g., Open, Closed).</param>
        /// <param name="_cardCode">The business partner's code (optional).</param>
        /// <param name="_cardName">The business partner's name (optional).</param>
        /// <returns>
        /// An asynchronous task that returns a context containing a list of purchase delivery notes
        /// matching the specified criteria.
        /// </returns>
        public static async Task<CLContext<List<GoodsReceiptPO>>> GetPurchaseDeliveryNotes(int _slpCode, string _dateFrom,
            string _dateTo, int _docNum, string _docStatus, string _cardCode = "", string _cardName = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseDeliveryNotes");

                List<GoodsReceiptPO> resultList = Common.ResolveSAPViewODBC<GoodsReceiptPO>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@SlpCode", $"{_slpCode}" }, 
                        { "@DateFrom", $"{_dateFrom}" },
                        { "@DateTo", $"{_dateTo}" },
                        { "@DocNum", $"{_docNum}" },
                        { "@DocStatus", $"{_docStatus}" },
                        { "@CardCode", $"{_cardCode}" },
                        { "@CardName", $"{_cardName}" }
                    });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<GoodsReceiptPO>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<GoodsReceiptPO>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseDeliveryNotes").Get<FilterPurchaseDocuments>();
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<List<GoodsReceiptPO>>();
            #endregion
        }
        
        /// <summary>
        /// Method to retrieve a Goods Receipt Purchase Order (GRPO) based on the provided document entry.
        /// </summary>
        /// <param name="_docEntry">The unique document entry identifier for the GRPO.</param>
        /// <returns>
        /// A task representing the context containing the requested GRPO.
        /// </returns>
        public static async Task<CLContext<GoodsReceiptPO>> GetGoodsReceipt(int _docEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<GoodsReceiptPO> oClContext = new CLContext<GoodsReceiptPO>();
            CLContext<List<GoodsReceiptPORows>> oClContextRows = new CLContext<List<GoodsReceiptPORows>>();
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetGoodsReceiptByDocEntry");
            
                List<GoodsReceiptPO> resultList = Common.ResolveSAPViewODBC<GoodsReceiptPO>(contextODBC, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<GoodsReceiptPO>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReceiptPO>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                
                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetGoodsReceiptRows");
            
                List<GoodsReceiptPORows> resultListLines = Common.ResolveSAPViewODBC<GoodsReceiptPORows>(contextODBCLines, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextRows = new CLContext<List<GoodsReceiptPORows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<GoodsReceiptPORows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetGoodsReceiptByDocEntry").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContext = await oSlRequestObject.SendAsync<GoodsReceiptPO>();
                
                SLRequestObject oSlRequestObjectRows = GetUserCtx("SL_GetGoodsReceiptRows").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE LINES SL: {oSlRequestObjectRows.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextRows = await oSlRequestObjectRows.SendAsync<List<GoodsReceiptPORows>>();
                #endregion
            }
            
            oClContext.Response.Data.DocumentLines = oClContextRows.Response.Data;

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA
            if (oClContextRows.Response.Data is object && oClContextRows.Response.Data.Count > 0)
            {
                foreach (GoodsReceiptPORows item in oClContext.Response.Data.DocumentLines)
                {
                    if (!String.IsNullOrEmpty(item.WarehouseCode))
                    {
                        item.UoMMasterData = await GetUomMasterDataFilter(item.ItemCode, item.WarehouseCode,
                            oClContext.Response.Data.PriceList,
                            "Y");
                    }
                }
            }
            #endregion

            return oClContext;
        }

        public static async Task<CLContext<GoodsReceiptPO>> PurchaseDeliveryNotesXml(HttpRequest _httpRequest)
        {
            string WhsCode = _httpRequest.Form["WhsCode"];
            string UserId = _httpRequest.Form["UserId"];
            int PriceList = Convert.ToInt32(_httpRequest.Form["PriceList"]);
            List<HttpPostedFile> postedFiles = new List<HttpPostedFile>
            {
                _httpRequest.Files[$"file"]
            };

            if (postedFiles.Any(x => ((x.ContentType != "text/xml"))))
            {
                throw new Exception("Solo se pueden subir archivos xml");
            }

            byte[] _contentBytes;
            _contentBytes = CL.COMMON.Core.StreamToBytes(postedFiles[0].InputStream);

            MODELS.File file = new MODELS.File
            {
                Content = postedFiles[0].InputStream,
                Name = postedFiles[0].FileName,
                Type = postedFiles[0].ContentType,
                Base64 = Convert.ToBase64String(_contentBytes)
            };

            return await ParseXML(file, WhsCode, UserId, PriceList);
        }
        
        /// <summary>
        /// Method to load documento xml
        /// </summary>
        /// <param name="file">File to load</param>
        /// <param name="WhsCode">Warehouse to load docuement</param>
        /// <param name="userId">User logged</param>
        /// <param name="_priceList">Price list to load document</param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        private static async Task<CLContext<GoodsReceiptPO>> ParseXML(MODELS.File file, string WhsCode, string userId,
            int _priceList)
        {
            try
            {
                XmlWriterSettings oXmlWriterSettings = new XmlWriterSettings();

                XmlSerializer oXmlSerializer = new XmlSerializer(typeof(GoodsReceipt), null, null,
                    new XmlRootAttribute("GoodsReceipt"), null);

                string decodedXML = DecodeStringFromBase64(file.Base64);

                string _byteOrderMarkUtf8 = Encoding.UTF8.GetString(Encoding.UTF8.GetPreamble());

                if (decodedXML.StartsWith(_byteOrderMarkUtf8, StringComparison.Ordinal))
                {
                    decodedXML = decodedXML.Remove(0, _byteOrderMarkUtf8.Length);
                }


                XmlDocument doc = new XmlDocument();
                doc.LoadXml(decodedXML);

                XmlElement myElement = doc.DocumentElement;

                XmlAttributeCollection attrColl = myElement.Attributes;

                GoodsReceiptPO _goodsReceipt = new GoodsReceiptPO();

                List<GoodsReceiptPORows> oLines = new List<GoodsReceiptPORows>();

                List<LineaDetalle> oLinesXml = new List<LineaDetalle>();

                Emisor oEmisorXml = new Emisor();

                for (int j = 0; j < myElement.ChildNodes.Count; j++) // DETALLESERVICIO
                {
                    Dictionary<string, string> pairedData = new Dictionary<string, string>();

                    for (int c = 0; c < myElement.ChildNodes[j].ChildNodes.Count; c++) //LineaDetalle
                    {
                        XmlNode xmlElement = myElement.ChildNodes[j].ChildNodes[c];

                        if (myElement.ChildNodes[j].ChildNodes[c].Name.Equals("LineaDetalle"))
                        {
                            Dictionary<string, string> linesData = new Dictionary<string, string>();

                            for (int k = 0; k < myElement.ChildNodes[j].ChildNodes[c].ChildNodes.Count; k++)
                            {
                                if (k > 0)
                                {
                                    if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name
                                        .Equals(myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k - 1].Name))
                                    {
                                    }
                                    else
                                    {
                                        if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name.Equals("Impuesto"))
                                        {
                                            for (int l = 0;
                                                 l < myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].ChildNodes
                                                     .Count;
                                                 l++) //Listaimpuesto 
                                            {
                                                if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].ChildNodes[l]
                                                    .Name.Equals("Tarifa"))
                                                {
                                                    linesData.Add(
                                                        myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k]
                                                            .ChildNodes[l].Name,
                                                        xmlElement.ChildNodes[k].ChildNodes[l].FirstChild?.InnerText);
                                                }

                                                if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].ChildNodes[l]
                                                    .Name.Equals("Exoneracion"))
                                                {
                                                    for (int n = 0;
                                                         n < myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k]
                                                             .ChildNodes[l].ChildNodes.Count;
                                                         n++) //ListaExoneracion
                                                    {
                                                        if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k]
                                                            .ChildNodes[l].ChildNodes[n].Name
                                                            .Equals("PorcentajeExoneracion"))
                                                        {
                                                            linesData.Add(
                                                                myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k]
                                                                    .ChildNodes[l].ChildNodes[n].Name,
                                                                xmlElement.ChildNodes[k].ChildNodes[l].ChildNodes[n]
                                                                    .FirstChild?.InnerText);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name
                                                 .Equals("Descuento"))
                                        {
                                            for (int l = 0;
                                                 l < myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].ChildNodes
                                                     .Count;
                                                 l++) // 
                                            {
                                                if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].ChildNodes[l]
                                                    .Name.Equals("MontoDescuento"))
                                                {
                                                    linesData.Add(
                                                        myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k]
                                                            .ChildNodes[l].Name,
                                                        xmlElement.ChildNodes[k].ChildNodes[l].FirstChild?.InnerText);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            linesData.Add(myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name,
                                                xmlElement.ChildNodes[k].FirstChild?.InnerText);
                                        }
                                    }
                                }
                                else
                                {
                                    linesData.Add(myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name,
                                        xmlElement.ChildNodes[k].FirstChild?.InnerText);
                                }
                            }

                            LineaDetalle oLineDetalleXML = new LineaDetalle();
                            Type o_Type = oLineDetalleXML.GetType();
                            Boolean isFound = false; // Solo mapea campos que estan en el modelo de LineaDetalle

                            foreach (KeyValuePair<string, string> item in linesData)
                            {
                                isFound = false;
                                foreach (PropertyInfo property in oLineDetalleXML.GetType().GetProperties())
                                {
                                    if (property.Name.Equals(item.Key))
                                    {
                                        isFound = true;
                                    }
                                }

                                if (isFound)
                                {
                                    o_Type.GetProperty(item.Key).SetValue(oLineDetalleXML, item.Value, null);
                                }
                            }

                            oLinesXml.Add(oLineDetalleXML);
                        }

                        if (myElement.ChildNodes[j].Name.Equals("Emisor"))
                        {
                            if (myElement.ChildNodes[j].ChildNodes[c].Name.Equals("Identificacion"))
                            {
                                for (int k = 0; k < myElement.ChildNodes[j].ChildNodes[c].ChildNodes.Count; k++)
                                {
                                    if (myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name.Equals("Numero"))
                                    {
                                        pairedData.Add(myElement.ChildNodes[j].ChildNodes[c].ChildNodes[k].Name,
                                            xmlElement.ChildNodes[k].FirstChild?.InnerText);
                                    }
                                }
                            }
                        }
                    }

                    Emisor oEmisor = new Emisor();
                    Type o_Type2 = oEmisor.GetType();
                    Boolean isFound2 = false; // Solo mapea campos que estan en el modelo de LineaDetalle
                    foreach (KeyValuePair<string, string> item in pairedData)
                    {
                        //oType.GetProperty(item.Key).SetValue(oEmisor, item.Value, null);
                        isFound2 = false;
                        foreach (PropertyInfo property in oEmisor.GetType().GetProperties())
                        {
                            if (property.Name.Equals(item.Key))
                            {
                                isFound2 = true;
                            }
                        }

                        if (isFound2)
                        {
                            o_Type2.GetProperty(item.Key).SetValue(oEmisor, item.Value, null);
                        }
                    }

                    if (!string.IsNullOrEmpty(oEmisor.Numero))
                    {
                        oEmisorXml = oEmisor;
                    }
                }

                if (oLinesXml.Count > 0)
                {
                    CLContext<BusinessPartners> oCLContext = await GetBusinessPartnerbyNameXmlSL(oEmisorXml.Numero);

                    if (oCLContext.Response.Data != null)
                    {
                        _goodsReceipt.CardCode = oCLContext.Response.Data.CardCode;
                        _goodsReceipt.CardName = oCLContext.Response.Data.CardName;
                    }


                    foreach (LineaDetalle linexml in oLinesXml)
                    {
                        CLContext<GoodsReceiptPORows> oCLContextLine =
                            await GetItembyItemNameXml(linexml.Detalle.Replace("'", "''"));

                        double impuesto = string.IsNullOrEmpty(linexml.PorcentajeExoneracion)
                            ? Convert.ToDouble(linexml.Tarifa)
                            : Convert.ToDouble(linexml.PorcentajeExoneracion);

                        CLContext<SalesTaxes> oCLContextTaxes = await GetTaxCode(impuesto);

                        List<UoMMasterData> oUoMlList = new List<UoMMasterData>();

                        if (oCLContextLine.Response.Data != null)
                        {
                            oUoMlList = await GetUomMasterDataFilter(oCLContextLine.Response.Data.ItemCode, WhsCode,
                                _priceList,
                                "Y");
                        }

                        GoodsReceiptPORows line = new GoodsReceiptPORows
                        {
                            U_DescriptionItemXml = linexml.Detalle != null ? linexml.Detalle : string.Empty,
                            ItemCode = oCLContextLine.Response.Data != null
                                ? oCLContextLine.Response.Data.ItemCode
                                : string.Empty,
                            ItemDescription = oCLContextLine.Response.Data != null
                                ? oCLContextLine.Response.Data.ItemDescription
                                : string.Empty,
                            UnitPrice = Convert.ToDecimal(linexml.PrecioUnitario),
                            //LineTotal = Convert.ToDecimal(linexml.MontoTotal),
                            TaxRate = string.IsNullOrEmpty(linexml.PorcentajeExoneracion)
                                ? Convert.ToDecimal(linexml.Tarifa)
                                : Convert.ToDecimal(linexml.PorcentajeExoneracion),
                            TaxCode = oCLContextTaxes.Response.Data != null
                                ? oCLContextTaxes.Response.Data.TaxCode
                                : string.Empty,
                            Quantity = Convert.ToDecimal(linexml.Cantidad),
                            WarehouseCode = WhsCode,
                            DiscountPercent = GetDiscoountPercentForXMLEntry(linexml.PrecioUnitario,
                                linexml.MontoDescuento, linexml.Cantidad),
                            UoMMasterData = oUoMlList
                        };

                        oLines.Add(line);
                    }

                    _goodsReceipt.DocumentLines = oLines;

                    return new CLContext<GoodsReceiptPO>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<GoodsReceiptPO>()
                        {
                            Data = _goodsReceipt,
                            Message = ""
                        }
                    };
                }
                else
                {
                    throw new CLException($"CL- No se obtuvieron líneas del xml", HttpStatusCode.Found);
                }
            }
            catch (Exception e)
            {
                throw new CLException($"CL {e.Message}", HttpStatusCode.BadRequest);
            }
        }

        /// <summary>
        /// Retrieves a business partner from SAP using the Service Layer, based on the provided identification number (cedula).
        /// </summary>
        /// <param name="_cedula">
        /// The identification number (cedula) of the business partner to search for.
        /// </param>
        /// <returns>
        /// A <see cref="Task{TResult}"/> representing the asynchronous operation, with a <see cref="CLContext{T}"/> result
        /// containing the <see cref="BusinessPartners"/> object if found, or <c>null</c> if not found.
        /// </returns>
        /// <remarks>
        /// This method queries the SAP Service Layer for a business partner whose identification matches the specified cedula.
        /// </remarks>
        public static async Task<CLContext<BusinessPartners>> GetBusinessPartnerbyNameXmlSL(string _cedula)
        {
            LogManager.Record("REQUESTING RECORDS");

            _cedula = _cedula.Trim();

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetBpByCedula");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@LicTradNum", $"{_cedula}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<BusinessPartners>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<BusinessPartners>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetBpByCedula").Get(new BusinessPartnerFilter
                {
                    LicTradNum = _cedula
                });

                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");
                LogManager.Record($"REQUESTING COMPLETED");

                return await oSlRequestObject.SendAsync<BusinessPartners>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves item information by its XML name identifier.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_itemNameXml">The item name as it appears in XML documents.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="GoodsReceiptPORows"/> with the item data.
        /// </returns>
        public static async Task<CLContext<GoodsReceiptPORows>> GetItembyItemNameXml(string _itemNameXml)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetItemByItemName");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@ItemNameXml", _itemNameXml ?? "" }
                };

                List<GoodsReceiptPORows> resultList =
                     Common.ResolveSAPViewODBC<GoodsReceiptPORows>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<GoodsReceiptPORows>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReceiptPORows>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                ItemXmlFilter filter = new ItemXmlFilter
                {
                    ItemNameXml = _itemNameXml ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetItemByItemName").Get<ItemXmlFilter>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<GoodsReceiptPORows>();

                #endregion
            }
        }

        /// <summary>
        /// Asynchronously retrieves the tax code associated with a given tax rate.
        /// </summary>
        /// <param name="_taxRate">The tax rate for which the corresponding tax code is to be retrieved.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{SalesTaxes}"/>
        /// object which includes the tax code data associated with the specified tax rate.
        /// </returns>
        public static async Task<CLContext<SalesTaxes>> GetTaxCode(double _taxRate)
        {
            LogManager.Record($"REQUESTING  OUM MASTER DATA");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<SalesTaxes> oCLContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetTaxCodeByRate");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<SalesTaxes> resultList = Common.ResolveSAPViewODBC<SalesTaxes>(contextODBC,
                new Dictionary<string, object>()
                {
                    {"@Rate", _taxRate}
                });

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = new CLContext<SalesTaxes>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesTaxes>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetTaxCodeByRate").Get(new TaxeFilter()
                {
                    Rate = _taxRate
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = await requestModel.SendAsync<SalesTaxes>();

                #endregion
            }

            return oCLContext;
        }

        private static decimal GetDiscoountPercentForXMLEntry(string _unitPrice, string _lineTotalDiscount,
            string _cantidad)
        {
            decimal discountPercent = 0;

            if (string.IsNullOrEmpty(_lineTotalDiscount))
                return discountPercent;

            if (string.IsNullOrEmpty(_unitPrice))
                return discountPercent;

            if (string.IsNullOrEmpty(_cantidad))
                return discountPercent;


            double total = Convert.ToDouble(_unitPrice);
            double discount = Convert.ToDouble(_lineTotalDiscount);
            double cantidad = Convert.ToDouble(_cantidad);

            return (decimal)((discount / (total * cantidad)) * 100);
        }

        /// <summary>
        /// Retrieves a list of Unit of Measure (UoM) master data filtered by the specified parameters.
        /// </summary>
        /// <param name="_itemCode">The code of the item for which UoM data is being requested.</param>
        /// <param name="_whsCode">The warehouse code to filter the UoM data.</param>
        /// <param name="_priceList">The price list identifier to filter the UoM data.</param>
        /// <param name="_prchseItem">A flag indicating whether the item is a purchase item.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a list of <see cref="UoMMasterData"/> objects if data is found; otherwise, null.</returns>
        public static async Task<List<UoMMasterData>> GetUomMasterDataFilter(string _itemCode,
            string _whsCode, int _priceList, string _prchseItem)
        {
            LogManager.Record($"REQUESTING  OUM MASTER DATA");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<UoMMasterData>> oCLContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetUomMasterData");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<UoMMasterData> resultList = Common.ResolveSAPViewODBC<UoMMasterData>(contextODBC,
                    new Dictionary<string, object>()
                    {
                         {"@ItemCode", _itemCode},
                        {"@WhsCode", _whsCode},
                        {"@PriceList", _priceList},
                        {"@PrchseItem", _prchseItem}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = new CLContext<List<UoMMasterData>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UoMMasterData>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetUomMasterData").Get(new FilterItem()
                {
                    ItemCode = _itemCode,
                    WhsCode = _whsCode,
                    PriceList = _priceList,
                    PrchseItem = _prchseItem
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = await requestModel.SendAsync<List<UoMMasterData>>();

                #endregion
            }
            
            if (oCLContext.Response.Data != null && oCLContext.Response.Data.Count > 0)
            {
                return oCLContext.Response.Data;
            }

            return null;
        }

        /// <summary>
        /// Decodes a Base64‐encoded string into its UTF‐8 representation.
        /// Returns the original input if it is null or empty.
        /// </summary>
        /// <param name="base64EncodedText">
        /// The text encoded in Base64 format.
        /// </param>
        /// <returns>
        /// The decoded UTF‐8 string, or the original input if it was null or empty.
        /// </returns>
        private static string DecodeStringFromBase64(string base64EncodedText)
        {
            if (String.IsNullOrEmpty(base64EncodedText))
            {
                return base64EncodedText;
            }

            byte[] base64EncodedBytes = Convert.FromBase64String(base64EncodedText);
            return System.Text.Encoding.UTF8.GetString(base64EncodedBytes);
        }

        /// <summary>
        /// Posts a purchase return document to the backend, handling:
        /// 1. Unique‐ID lookup to avoid duplicates.
        /// 2. Saving of any attached files.
        /// 3. Authorization logic and draft processing (approve/reject).
        /// 4. Final submission or draft creation/patch based on validation rules.
        /// </summary>
        /// <param name="_goodsReturn">
        /// The <see cref="GoodsReturn"/> object containing header and line data for the return.
        /// </param>
        /// <param name="_attachment">
        /// Metadata for a single document attachment.
        /// </param>
        /// <param name="_attachmentFiles">
        /// The collection of HTTP‐posted files to attach to the return.
        /// </param>
        /// <returns>
        /// A <see cref="Task{CLContext}"/> whose result is a <see cref="CLContext{GoodsReturn}"/>
        /// containing the posted or retrieved return document.
        /// </returns>
        public static async Task<CLContext<GoodsReturn>> PostPurchaseReturns(GoodsReturn _goodsReturn,DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();
            
            int companyId = GetCompanyId();
            
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.GoodReturn);

            if (uniques.Response.Data != null)
            {
                return new CLContext<GoodsReturn>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReturn>()
                    {
                        Data = new GoodsReturn()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _goodsReturn.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            #endregion
            #region Validar si aplica query autorizacion

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_goodsReturn, Constants.DocumentType.GoodReturn, userId, companyId);

            #endregion
              //Validar documento base preliminar
            int lineWithBaseType = _goodsReturn.DocumentLines.Find(_x => _x.BaseType == -1)?.BaseEntry ?? -1;
            int lineWithBaseEntry = _goodsReturn.DocumentLines.Find(_x => _x.BaseEntry > 0)?.BaseType ?? 0;

            CLContext<GoodsReturn> slResponse = null;

            if (lineWithBaseEntry == -1 && lineWithBaseType > 0)
            {
                #region Documento base preliminar

                //Obtener status del documento preliminar
                CLContext<DraftStatus> oClContextDraft = await ValidateStatusDraft(lineWithBaseType);

                if (oClContextDraft is null || oClContextDraft.Response is null ||
                    oClContextDraft.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                _goodsReturn.DocEntry = lineWithBaseType;

                // Pasar el documento en firme
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = lineWithBaseType
                    }
                };

                CLContext<ApprovalRequest> oClConfirmContext = null;

                //Validar si es autorzazion simulada
                if (oClContextDraft.Response.Data?.Status == null &&
                    oClContextDraft.Response.Data?.U_EMA_Approval_Status != null)
                {
                    //Status draft
                    switch (oClContextDraft.Response.Data.U_EMA_Approval_Status)
                    {
                        case Approval_Status.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<GoodsReturn>(slResponse,
                                    SapDocumenType.GoodReturn,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case Approval_Status.Rejected:
                            //Validar si tiene autorizaciones 
                            if (queryConditionApply.IsApply)
                            {
                                //patch draft
                                _goodsReturn.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Pending,
                                    FieldType = "String"
                                });

                                _goodsReturn.DocObjectCode = ((int)Constants.DocumentType.GoodReturn).ToString();

                                CLContext<GoodsReturn> oClContextPatchDraft =
                                    await PatchDraft<GoodsReturn>(_goodsReturn);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    slResponse = await ResolveCreatedDocument<GoodsReturn>(slResponse,
                                        SapDocumenType.Draft,
                                        _goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                }
                            }
                            else
                            {
                                //patch draft
                                _goodsReturn.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Approved,
                                    FieldType = "String"
                                });

                                _goodsReturn.DocObjectCode = ((int)Constants.DocumentType.GoodReturn).ToString();

                                CLContext<GoodsReturn> oClContextPatchDraft =
                                    await PatchDraft<GoodsReturn>(_goodsReturn);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                    if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                    {
                                        slResponse = await ResolveCreatedDocument<GoodsReturn>(slResponse,
                                            SapDocumenType.GoodReturn,
                                            _goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }
                                }
                            }

                            break;
                    }
                }
                else // draft auto
                {
                    //status draft auto
                    switch (oClContextDraft.Response.Data.Status)
                    {
                        case StatusDraft.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<GoodsReturn>(slResponse,
                                    SapDocumenType.GoodReturn,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case StatusDraft.Rejected:
                            _goodsReturn.DocObjectCode = ((int)Constants.DocumentType.GoodReturn).ToString();

                            CLContext<GoodsReturn> oClContextPatchDraft =
                                await PatchDraft<GoodsReturn>(_goodsReturn);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {
                                oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                {
                                    //Validar si con patch draft crea documento en firme o sigue pendiente de autorizacion 

                                    #region Validar creacion documento en firme

                                    CLContext<GoodsReturn> oClContext = await ResolveCreatedDocument<GoodsReturn>(
                                        slResponse,
                                        SapDocumenType.GoodReturn,
                                        _goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                                    if (oClContext is null || oClContext.Response is null ||
                                        oClContext.Response.Data is null)
                                    {
                                        return await ResolveCreatedDocument<GoodsReturn>(slResponse,
                                            SapDocumenType.Draft,
                                            _goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }


                                    return oClContext;

                                    #endregion
                                }
                            }

                            break;
                    }
                }

                return slResponse;

                #endregion
            }
            else
            {
                Dictionary<string, Func<JProperty, bool>> lineFlushCondition =
                    new Dictionary<string, Func<JProperty, bool>>();

                if (_goodsReturn.DocumentLines.Exists(x => x.BaseEntry == null))
                {
                    Func<JProperty, bool> result = new Func<JProperty, bool>(_property =>
                        _property.Value == null || Convert.ToInt32(_property.Value) == -1);

                    lineFlushCondition.Add("BaseEntry", result);
                    lineFlushCondition.Add("BaseType", result);
                }
                

                string oHeaderProperties = "Udfs,DocTotal,DocObjectCode,PriceList";

                string oLinesProperties = "Udfs,UoMMasterData,TaxRate,LineStatus,VATLiable";

                SLRequestObject oSlRequestObject = GetUserCtx("PostPurchaseReturns").Post(_goodsReturn,
                    _fieldsToRemoveInHeaders: oHeaderProperties, _fieldsToRemoveInLines: oLinesProperties,_lineFlushConditions:lineFlushCondition);


                if (queryConditionApply.IsApply)
                {
                    _goodsReturn.DocObjectCode = ((int)Constants.DocumentType.GoodReturn).ToString();

                    _goodsReturn.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                    {
                        Name = "U_EMA_Approval_Status",
                        Value = Approval_Status.Pending,
                        FieldType = "String"
                    });

                    slResponse = await PostDraft<GoodsReturn>(_goodsReturn);
                }
                else
                {
                    LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                    LogManager.Record($"REQUEST COMPLETED");

                    LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

                    // Add headear to prevent error on autorization process

                    oSlRequestObject.Headers = new ParameterCollection()
                    {
                        { new KeyValuePair<string, string>("Prefer", "return-no-content") }
                    };

                    slResponse = await oSlRequestObject.SendAsync<GoodsReturn>();
                }

                if (slResponse.Code == HttpStatusCode.NoContent)
                {
                    #region Validar si el tipo de documento aplica para autorizacion

                    bool apply = await TypeOfDocumentAppliesForAuthorizationProcess(_goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "",
                                                                                     Constants.DocumentType.GoodReturn);
                    #endregion

                    string table =
                        (apply || queryConditionApply.IsApply)
                            ? SapDocumenType.Draft
                            : SapDocumenType.GoodReturn;

                    CLContext<GoodsReturn> oClContext = await ResolveCreatedDocument<GoodsReturn>(slResponse, table,
                        _goodsReturn.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                    if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                    {
                        throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                    }
                    if (apply)
                    {
                        NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                        try
                        {
                            CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                            if (oCLContextSetting.Response.Data != null)
                            {
                                List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                oDraftsSetting = settingList.Find(_setting => _setting.CompanyId==companyId);
                                if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                {
                                    await SendNotifyAutoritation(oClContext.Response.Data.DocEntry, companyId, true, queryConditionApply);
                                }
                            }
                        }
                        catch (Exception e)
                        {
                            LogManager.Record($"Error: {e.Message}");
                        }
                    }


                    return oClContext;

                }
            }

            return slResponse;
            
        }
        
        /// <summary>
        /// Retrieves a list of purchase returns based on the specified filters.
        /// </summary>
        /// <param name="_slpCode">The sales representative code to filter the purchase returns.</param>
        /// <param name="_dateFrom">The start date for filtering records.</param>
        /// <param name="_dateTo">The end date for filtering records.</param>
        /// <param name="_docNum">The document number to filter the purchase returns.</param>
        /// <param name="_docStatus">The status of the document to filter.</param>
        /// <param name="_cardCode">The business partner code (optional).</param>
        /// <param name="_cardName">The business partner name (optional).</param>
        /// <returns>
        /// A task representing the asynchronous operation that returns a CLContext containing a list of purchase returns.
        /// </returns>
        public static async Task<CLContext<List<GoodsReturn>>> GetPurchaseReturns(int _slpCode, string _dateFrom,
            string _dateTo, int _docNum, string _docStatus, string _cardCode = "", string _cardName = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseReturns");
                
                List<GoodsReturn> resultList = Common.ResolveSAPViewODBC<GoodsReturn>(contextODBC, new Dictionary<string, object>()
                {
                    {"@SlpCode", $"{_slpCode}"},
                    {"@DateFrom", $"{_dateFrom}"},
                    {"@DateTo", $"{_dateTo}"},
                    {"@DocNum", $"{_docNum}"},
                    {"@DocStatus", $"{_docStatus}"},
                    {"@CardCode", $"{_cardCode}"},
                    {"@CardName", $"{_cardName}"}
                });
            
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<GoodsReturn>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<GoodsReturn>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            LogManager.Record("REQUESTING RECORDS");

            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseReturns").Get<FilterPurchaseDocuments>();

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<GoodsReturn>>();
            #endregion
        }
        
        /// <summary>
        /// Retrieves a specific purchase return based on the provided document entry.
        /// </summary>
        /// <param name="_docEntry">The document entry identifier of the purchase return.</param>
        /// <returns>
        /// A task representing the asynchronous operation that returns a CLContext containing the purchase return details.
        /// </returns>
        public static async Task<CLContext<GoodsReturn>> GetPurchaseReturn(int _docEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<GoodsReturn> oClContext = new CLContext<GoodsReturn>();
            CLContext<List<GoodsReturnRows>> oClContextRows = new CLContext<List<GoodsReturnRows>>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseReturnByDocEntry");

                List<GoodsReturn> resultList = Common.ResolveSAPViewODBC<GoodsReturn>(contextODBC, new Dictionary<string, object>()
                {
                    { "@DocEntry", $"{_docEntry}" }
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContext = new CLContext<GoodsReturn>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<GoodsReturn>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                
                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetPurchaseReturnRows");
            
                List<GoodsReturnRows> resultListLines = Common.ResolveSAPViewODBC<GoodsReturnRows>(contextODBCLines, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContextRows = new CLContext<List<GoodsReturnRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<GoodsReturnRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseReturnByDocEntry").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = await oSlRequestObject.SendAsync<GoodsReturn>();

                SLRequestObject oSlRequestObjectRows = GetUserCtx("SL_GetPurchaseReturnRows").Get<FilterPurchaseOrder>();

                LogManager.Record($"RESOURCE LINES SL: {oSlRequestObjectRows.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextRows = await oSlRequestObjectRows.SendAsync<List<GoodsReturnRows>>();
                #endregion
            }
            
            oClContext.Response.Data.DocumentLines = oClContextRows.Response.Data;

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA
            if (oClContextRows.Response.Data is object && oClContextRows.Response.Data.Count > 0)
            {
                foreach (GoodsReturnRows item in oClContext.Response.Data.DocumentLines)
                {
                    if (!String.IsNullOrEmpty(item.WarehouseCode))
                    {
                        item.UoMMasterData = await GetUomMasterDataFilter(item.ItemCode, item.WarehouseCode,
                            oClContext.Response.Data.PriceList,
                            "Y");
                    }
                }
            }
            #endregion

            return oClContext;
        }

        #endregion

        #region ExchangeRate

        /// <summary>
        /// Asynchronously retrieves a list of banks from the database.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="Bank"/> objects, representing the banks retrieved.
        /// </returns>
        public static async Task<CLContext<ExchangeRate>> GetExchangeRate()
        {
            LogManager.Record($"REQUESTING EXCHANGE RATE RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<ExchangeRate> oClContext = null;
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetExchangeRate");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ExchangeRate> resultList = Common.ResolveSAPViewODBC<ExchangeRate>(contextODBC);
                LogManager.Record($"REQUEST COMPLETED");

                oClContext = new CLContext<ExchangeRate>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ExchangeRate>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion

            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetExchangeRate").Get();

                LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");
                oClContext = await oSlRequestObject.SendAsync<ExchangeRate>();
                #endregion
            }

            if (oClContext.Response.Data == null)
            {
                oClContext.Response.Data = new ExchangeRate()
                {
                    Rate = 0
                };
            }

            return oClContext;
        }


        /// <summary>
        /// Retrieves upcoming exchange rate records using either ODBC or Service Layer depending on the connection mode.
        /// </summary>
        /// <returns>
        /// A task that returns a <see cref="CLContext{List{UpcomingExchangeRate}}"/> containing the list of upcoming exchange rates.
        /// </returns>
        public static async Task<CLContext<List<UpcomingExchangeRate>>> GetUpcomingExchangeRate()
        {
            LogManager.Record("REQUESTING UPCOMING EXCHANGE RATE RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<UpcomingExchangeRate>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetUpcomingExchangeRate");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<UpcomingExchangeRate> resultList =
                    Common.ResolveSAPViewODBC<UpcomingExchangeRate>(contextODBC);

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<UpcomingExchangeRate>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UpcomingExchangeRate>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetUpcomingExchangeRate").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<UpcomingExchangeRate>>();

                #endregion
            }

            return oClContext;
        }

        #endregion

        #region Orders


        /// <summary>
        /// This method is used to create sales order
        /// </summary>
        /// <param name="pSalesOrder">model order</param>
        /// <param name="pUserId">curret user id</param>
        /// <param name="pCompanyId">current company id</param>
        /// <returns></returns>
        /// <exception cref="CLException">generate exception</exception>
        public static async Task<CLContext<SalesOrder>> PostOrders(
            SalesOrder pSalesOrder, 
            DocumentAttachment pAttachment,
            IEnumerable<HttpPostedFile> pAttachmentFiles,
            int pUserId = -1,
            int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;
        
            CLContext<SalesOrder> existingDocumentInformationResponse =
                await CheckIfDocumentExistByDocumentKey(pSalesOrder, SapDocumenType.SaleOrder, pUserId, pCompanyId);
        
            if (existingDocumentInformationResponse != null)
            {
                return existingDocumentInformationResponse;
            }
            
            DocumentAttachment documentAttachment = await CreateDocumentAttachments(pAttachment, pAttachmentFiles, pUserId, pCompanyId);

            pSalesOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<SalesOrder> slResponse =
                await CheckIfDocumentComesFromDraft(pSalesOrder, SapDocumenType.SaleOrder, userId, pCompanyId);
        
            if (slResponse != null)
            {
                return slResponse;
            }
            
            SetConfiguredSeriesToDocument(pSalesOrder, Constants.DocumentType.SalesOrders, userId, pCompanyId);

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(pSalesOrder, Constants.DocumentType.SalesOrders, userId, pCompanyId);
                
            if (queryConditionApply.IsApply)
            {
                pSalesOrder.DocObjectCode = ((int)Constants.DocumentType.SalesOrders).ToString();
        
                pSalesOrder.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });
        
                slResponse = await PostDraft(pSalesOrder, userId, pCompanyId);
                
            }
            else
            {
                SLRequestObject requestModel = BuildSalesDocumentSLRequestObject(Constants.DocumentType.SalesOrders, true, pSalesOrder, "PostOrders", userId, pCompanyId, true);
        
                slResponse = await requestModel.SendAsync<SalesOrder>();
            }
        
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                return await ValidateAndNotifyAuthorization(pSalesOrder, SapDocumenType.SaleOrder, queryConditionApply, userId, pCompanyId);
            }
        
            return slResponse;
        }

        public static async Task<CLContext<TotalsPreviewSLDocument>> PostOrdersServicePreview(
            SalesServicePreview _sales)
        {
            bool isSalesOrdesPreview =
                CL.COMMON.Core.GetConfigKeyValue<bool>(MethodBase.GetCurrentMethod(), "OrdersServicePreview");

            if (isSalesOrdesPreview)
            {
                LogManager.Record("REQUESTING POST OBJECT");

                SLRequestObject requestModel =
                    GetUserCtx("PostOrdersPreview").Post(_sales);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<TotalsPreviewSLDocument>();
            }
            else
            {
                throw new CLException("CL Metodo no implementado.", HttpStatusCode.Found);
            }
        }

        public static async Task<CLContext<SalesOrder>> PatchOrders(SalesOrder _salesOrder, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            string oRemoveLineProperties =
                "BaseType,BaseEntry,BaseLine,Udfs,TaxRate,LineTotal,ManBtchNum,ManSerNum,ManBtchNum,ManSerNum,UoMMasterData," +
                "DistNumber,SysNumber,SerialNumbers,FatherCode,LineStatus,WhsName,LinesCurrenciesList,OnHand,InventoryItem,LineNum,HideComp,Freight,IsAServerLine";

            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _salesOrder.DocumentLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);

            if (hasClosedLines)
            {
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineNum", "");
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineStatus", "");
            }

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "Series",
                "DocNum",
                "Udfs",
                "DocTotal",
                "DocEntry",
                "PriceList",
                "DocStatus",
                "TipoDocE",
                "IdType",
                "Identification",
                "Email",
                "DocObjectCode",
                "SalesPersonName",
                "HandWritten"
            };

            string headerProperties = string.Join(",", oRemoveHeaderProperties);

             DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);

            _salesOrder.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject requestModel = GetUserCtx("PatchOrders").Patch(_salesOrder,
                _fieldsToRemoveInLines: oRemoveLineProperties, _fieldsToRemoveInHeaders: headerProperties);

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            headers.Add(new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true"));

            requestModel.Headers = headers;

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");


            return await requestModel.SendAsync<SalesOrder>();
        }

        /// <summary>
        /// Sends a cancel request for the specified sales order via the Service Layer.
        /// </summary>
        /// <param name="docEntry">
        /// The unique document entry of the sales order to cancel.
        /// </param>
        /// <returns>
        /// A task that returns a <see cref="CLContext{SalesOrder}"/> containing the canceled order details.
        /// </returns>
        public static async Task<CLContext<SalesOrder>> CancelOrders(int docEntry)
        {
            ClUserContext oClUserContext = GetUserCtx("CancelSalesOrders");

            SLRequestObject oSlRequestObjectPostCancel = oClUserContext.Post(
                new FilterBaseDocEntry() { 
                    DocEntry = docEntry
                }
            );

            oSlRequestObjectPostCancel.Url_Request += $"({docEntry})/Cancel"; 

            return await oSlRequestObjectPostCancel.SendAsync<SalesOrder>();
        }

        /// <summary>
        /// Asynchronously retrieves a sales order by its document entry identifier.
        /// </summary>
        /// <param name="DocEntry">The document entry identifier of the sales order to retrieve.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{SalesOrder}"/> 
        /// object with the sales order data retrieved.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found for the specified document entry.</exception>
        public static async Task<CLContext<SalesOrder>> GetOrder(int DocEntry)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<SalesOrder> oClContext = null;

            CLContext<List<SalesOrderRows>> oClContextLines = null;

            List<WithholdingTaxCode> resultListWithholdingTax = new List<WithholdingTaxCode>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region ODBC Path

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetOrdersByDocEntry");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parameters = new Dictionary<string, object>
                {
                    { "@DocEntry", DocEntry }
                };

                List<SalesOrder> resultList = Common.ResolveSAPViewODBC<SalesOrder>(contextODBC, parameters);

                if (resultList == null || resultList.Count == 0)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext = new CLContext<SalesOrder>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesOrder>
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetOrdersRows");

                List<SalesOrderRows> resultListLines = Common.ResolveSAPViewODBC<SalesOrderRows>(contextODBCLines, parameters);

                oClContextLines = new CLContext<List<SalesOrderRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesOrderRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };

                ClUserContextODBC contextODBCWithholdingTax = GetUserCtxODBC("ODBC_WithholdingTaxBySalesOrder");

                resultListWithholdingTax = Common.ResolveSAPViewODBC<WithholdingTaxCode>(contextODBCWithholdingTax, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{DocEntry}"}
                });

                #endregion
            }
            else
            {
                #region SL Path

                SLRequestObject requestModel = GetUserCtx("SL_GetOrdersByDocEntry").Get(new FilterBaseDocument
                {
                    DocEntry = DocEntry
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<SalesOrder>();

                if (oClContext.Response.Data == null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                SLRequestObject requestModelLines = GetUserCtx("SL_GetOrdersRows").Get(new FilterBaseDocument
                {
                    DocEntry = DocEntry
                });

                LogManager.Record($"RESOURCE: {requestModelLines.Url_Request}");

                oClContextLines = await requestModelLines.SendAsync<List<SalesOrderRows>>();

                SLRequestObject requestWithholdingTax = GetUserCtx("SL_WithholdingTaxBySalesOrder").Get(new FilterBaseDocument
                {
                    DocEntry = DocEntry
                });

                CLContext<List<WithholdingTaxCode>> oClContextWithholdingTax = await requestWithholdingTax.SendAsync<List<WithholdingTaxCode>>();

                resultListWithholdingTax = oClContextWithholdingTax.Response.Data;

                #endregion
            }

            if (oClContextLines.Response.Data is object && oClContextLines.Response.Data.Count > 0)
            {
                foreach (SalesOrderRows row in oClContextLines.Response.Data)
                {
                    row.UoMMasterData = await GetUomMasterDataFilter(
                        row.ItemCode, 
                        row.WarehouseCode,
                        oClContext.Response.Data.PriceList,
                        "N");

                    row.LinesCurrenciesList =
                        await GetAdditionalCurrencies(
                            row.ItemCode, 
                            oClContext.Response.Data.PriceList);
                }
            }
            
            oClContext.Response.Data.WithholdingTaxDataCollection = resultListWithholdingTax;
            
            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();

            oClContext.Response.Data.DocumentLines.AddRange(oClContextLines.Response.Data);

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of sales orders filtered by various criteria such as salesperson code, date range, 
        /// document number, status, currency, customer code, and customer name.
        /// Supports both ODBC and Service Layer connections.
        /// </summary>
        /// <param name="slpCode">Salesperson code to filter orders.</param>
        /// <param name="dateInit">Start date for the order search range.</param>
        /// <param name="dateEnd">End date for the order search range.</param>
        /// <param name="docNum">Document number to filter (0 for no filter).</param>
        /// <param name="docStatus">Order status (e.g., 'O' for open, 'C' for closed).</param>
        /// <param name="docCurrency">Optional document currency filter.</param>
        /// <param name="cardCode">Optional customer code filter.</param>
        /// <param name="cardName">Optional customer name filter.</param>
        /// <returns>A task that returns a <see cref="CLContext{List{SalesOrder}}"/> with the filtered sales orders.</returns>
        public static async Task<CLContext<List<SalesOrder>>> GetOrders(
            int slpCode,
            string dateInit,
            string dateEnd,
            int docNum,
            string docStatus,
            string docCurrency = "",
            string cardCode = "",
            string cardName = "")
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<SalesOrder>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetOrdersByFilters");
                List<SalesOrder> resultList = Common.ResolveSAPViewODBC<SalesOrder>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@SlpCode", slpCode },
                        { "@DateInit", dateInit },
                        { "@DateEnd", dateEnd },
                        { "@DocNum", docNum },
                        { "@DocStatus", docStatus },
                        { "@DocCurrency", docCurrency },
                        { "@CardCode", cardCode },
                        { "@CardName", cardName }
                    });
                oClContext = new CLContext<List<SalesOrder>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesOrder>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetOrdersByFilters")
                    .Get(new FilterBaseDocuments() {
                        SlpCode = slpCode,
                        DateInit = dateInit,
                        DateEnd = dateEnd,
                        DocNum = docNum,
                        DocStatus = docStatus,
                        DocCurrency = docCurrency,
                        CardCode = Uri.EscapeUriString(cardCode ?? ""),
                        CardName = Uri.EscapeUriString(cardName ?? "")
                    });
                oClContext = await requestModel.SendAsync<List<SalesOrder>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Method to create drafts
        /// </summary>
        /// <param name="_order">Object to create</param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<SalesOrder>> PostSalesOrdeDrafts(SalesOrder _order,DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _order.DocObjectCode = ((int)Constants.DocumentType.SalesOrders).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _order.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_order.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<SalesOrder>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesOrder>()
                    {
                        Data = new SalesOrder()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            CLContext<SalesOrder> slResponse = null;
            
            slResponse = await PostDraft<SalesOrder>(_order);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<SalesOrder> oClContext = await ResolveCreatedDocument<SalesOrder>(slResponse,
                    SapDocumenType.Draft,
                    _order.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;

    
                return oClContext;
            }
            
            return slResponse;
        }
        
        /// <summary>
        /// Method to update drafts
        /// </summary>
        /// <param name="_order"></param>
        /// <param name="_attachment"></param>
        /// <param name="_attachmentFiles"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<SalesOrder>> PatchSalesOrdeDrafts(SalesOrder _order,DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");
            _order.DocObjectCode = ((int)Constants.DocumentType.SalesOrders).ToString();
            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);

            _order.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<SalesOrder> slResponse = null;
            slResponse = await PatchDraft(_order);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<SalesOrder> oClContext = await ResolveCreatedDocument<SalesOrder>(slResponse,
                    SapDocumenType.Draft,
                    _order.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
    
                return oClContext;
            }
            
            return slResponse;
        }

        #endregion

        #region Documents

        /// <summary>
        /// Create or update the document attachment
        /// </summary>
        /// <param name="_attachment">Document attachment object</param>
        /// <param name="_attachmentFiles">Attachment files</param>
        /// <returns>Returns the AbsoluteEntry of the attachment if saved, else return null</returns>
        /// <exception cref="CLException">
        /// If the ShareFolder setting is not found.
        /// If the "Ruta" property of ShareFolder setting is null or empty.
        /// </exception>
        public static async Task<int?> SaveDocumentAttachments(DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1)
        {
            if (_attachment is null || _attachment.Attachments2_Lines.Count == 0)
            {
                return null;
            }
            
            LogManager.Record("REQUESTING SHARED FOLDER TO STORE THE ATTACHMENTS...");

            CLContext<List<ShareFolder>> oShareFolderst = GetSettingByCode<List<ShareFolder>>(SettingCode.ShareFolder);

            if (oShareFolderst?.Response?.Data == null)
            {
                throw new CLException("No se ha encontrado la configuración 'ShareFolder'. Por favor agreguela.",
                    HttpStatusCode.NotFound);
            }

            int companyId = _companyId == -1 ? GetCompanyId() : _companyId;

            string filesPath = oShareFolderst.Response.Data.Find(x => x.CompanyId == companyId)?.Ruta;

            if (string.IsNullOrEmpty(filesPath))
            {
                throw new CLException("No se ha encontrado la ruta para el guardado de adjuntos en la configuración 'ShareFolder'",
                    HttpStatusCode.NotFound);
            }

            LogManager.Record("MAPPING ATTACHMENT FILES...");

            string timestamp = DateTime.Now.ToString("yyMddHHmmssfff");
            
            foreach (Attachments2Line attachmentLine in _attachment.Attachments2_Lines)
            {
                HttpPostedFile oFile = _attachmentFiles.FirstOrDefault(attF => attF.FileName == $"{attachmentLine.FileName}.{attachmentLine.FileExtension}");

                if (oFile != null)
                {
                    attachmentLine.FileName = $"{timestamp}.{attachmentLine.FileName}";

                    string name = $"\\{timestamp}.{oFile.FileName}";

                    if (Directory.Exists(filesPath))
                    {
                        if (System.IO.File.Exists(filesPath + name))
                        {
                            System.IO.File.Delete(filesPath + name);
                            
                            oFile?.SaveAs(filesPath + name);
                        }
                        else
                        {
                            oFile?.SaveAs(filesPath + name);
                        }
                    }

                    attachmentLine.SourcePath = filesPath;
                }
            }
            
            LogManager.Record("ATTACHMENT FILES MAPPED");

            LogManager.Record("SAVING ATTACHMENT...");

            CLContext<DocumentAttachment> oClContext = null;
            
            if (_attachment.AbsoluteEntry == 0)
            {
                SLRequestObject oSlRequestObject = GetUserCtx("PostAnexos", _userId, _companyId)
                    .Post(_attachment, _fieldsToRemoveInHeaders: "AbsoluteEntry",
                        _fieldsToRemoveInLines: "AbsoluteEntry,LineNum", _lineObjectName: "Attachments2_Lines");

                LogManager.Record($"URL: ${oSlRequestObject.Url_Request}");

                oClContext = await oSlRequestObject.SendAsync<DocumentAttachment>();

                LogManager.Record($"ATTACHMENT CREATION RESPONSE {JsonConvert.SerializeObject(oClContext)}");
            }
            else
            {
                SLRequestObject oSlRequestObject = GetUserCtx("PatchAnexos", _userId, _companyId)
                    .Patch(_attachment, _fieldsToRemoveInLines: "AbsoluteEntry", _lineObjectName: "Attachments2_Lines");
                
                List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

                headers.Add(new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true"));

                oSlRequestObject.Headers = headers;
                
                oClContext = await oSlRequestObject.SendAsync<DocumentAttachment>();

                LogManager.Record($"ATTACHMENT UPDATING RESPONSE {JsonConvert.SerializeObject(oClContext)}");
            }

            if (oClContext?.Code < (HttpStatusCode)200 && oClContext.Code > (HttpStatusCode)299)
            {
                throw new Exception($"No se pudo crear el adjunto. Detalles: {oClContext.Response.Message}");
            }
            
            return oClContext?.Response?.Data?.AbsoluteEntry ?? _attachment.AbsoluteEntry;
        }
        
        #endregion
        
        #region Quotations

        /// <summary>
        /// Check by the document key if the document already exist
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pSAPTable">SAP table of the document</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company IDF</param>
        /// <returns>Created document information if exist, otherwise null</returns>
        private static async Task<CLContext<T>> CheckIfDocumentExistByDocumentKey<T>(T pSalesDocument, string pSAPTable, int pUserId, int pCompanyId) where T : SalesDocument, new()
        {
            LogManager.Record("EXTRACTING DOCUMENT KEY FROM DOCUMENT UDFs...");
            
            string documentKey = pSalesDocument.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "";
            
            LogManager.Record(
                $"BUILDING SERVICE LAYER REQUEST OBJECT... | DOCUMENT KEY: {documentKey} - SAP Table: {pSAPTable} - USER ID: {pUserId} - COMPANY ID: {pCompanyId}");
            
            CLContext<CLMLTEMA.MODELS.UniqueId> response = await GetUniqueId(documentKey, pSAPTable, pUserId, pCompanyId);

            LogManager.Record($"DOCUMENT INFORMATION REQUESTED | RESPONSE: {JsonConvert.SerializeObject(response)}");

            if (response.Response.Data != null)
            {
                return new CLContext<T>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<T>()
                    {
                        Data = new T()
                        {
                            DocEntry = response.Response.Data.DocEntry,
                            DocNum = response.Response.Data.DocNum
                        }
                    }
                };
            }
            
            return null;
        }

        /// <summary>
        /// Check if the document comes from a Draft document
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pDocumentType">Document type</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        /// <returns>Draft document if exist, otherwise null</returns>
        /// <exception cref="CLException"></exception>
        private static async Task<CLContext<T>> CheckIfDocumentComesFromDraft<T>(T pSalesDocument, string pDocumentType, int pUserId, int pCompanyId) where T : SalesDocument, new()
        {
            int lineWithBaseType = pSalesDocument.DocumentLines.Find(_x => _x.BaseType == -1)?.BaseEntry ?? -1;
            
            int lineWithBaseEntry = pSalesDocument.DocumentLines.Find(_x => _x.BaseEntry > 0)?.BaseType ?? 0;

            Constants.DocumentType documentType = Common.GetDocumentTypeFromSapTable(pDocumentType);
            
            CLContext<T> slResponse = null;
            
            if (lineWithBaseEntry == -1 && lineWithBaseType > 0)
            {
                CLContext<DraftStatus> oClContextDraft = await ValidateStatusDraft(lineWithBaseType, pUserId, pCompanyId);
                
                if (oClContextDraft?.Response?.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                
                CLContext<ApprovalRequest> oClConfirmContext;
                
                pSalesDocument.DocEntry = lineWithBaseType;
                
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = lineWithBaseType
                    }
                };
                
                if (oClContextDraft.Response.Data.U_EMA_Approval_Status != null)
                {
                    switch (oClContextDraft.Response.Data.U_EMA_Approval_Status)
                    {

                        case Approval_Status.Approved:
                        
                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft, pUserId, pCompanyId);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<T>(null,
                                    pDocumentType,
                                    oClContextDraft.Response.Data.DocumentKey, pUserId, pCompanyId);
                            }

                            break;
                        case Approval_Status.Rejected:
                            
                            pSalesDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                            {
                                Name = "U_EMA_Approval_Status",
                                Value = Approval_Status.Pending,
                                FieldType = "String"
                            });

                            pSalesDocument.DocObjectCode = ((int)documentType).ToString();

                            CLContext<T> oClContextPatchDraft =
                                await PatchDraft(pSalesDocument, pUserId, pCompanyId);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<T>(null,
                                    SapDocumenType.Draft,
                                    pSalesDocument.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "", pUserId, pCompanyId);
                            }
                            
                            break;
                    }
                }
                else
                {
                    switch (oClContextDraft.Response.Data.Status)
                    {
                        case StatusDraft.Approved:
                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft, pUserId, pCompanyId);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<T>(null,
                                    pDocumentType, oClContextDraft.Response.Data.DocumentKey, pUserId, pCompanyId);
                            }

                            break;
                        case StatusDraft.Rejected:
                            pSalesDocument.DocObjectCode = ((int)documentType).ToString();

                            CLContext<T> oClContextPatchDraft =
                                await PatchDraft(pSalesDocument, pUserId, pCompanyId);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {

                                oClConfirmContext = await ConfirmDraftDocument(approvalDraft, pUserId, pCompanyId);

                                if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                {
                                    string documentKey =
                                        pSalesDocument.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "";

                                    slResponse = await ResolveCreatedDocument<T>(null,
                                        pDocumentType, documentKey, pUserId, pCompanyId);
                                    
                                    if (slResponse?.Response?.Data is null)
                                    {
                                        return await ResolveCreatedDocument<T>(null,
                                            SapDocumenType.Draft, documentKey, pUserId, pCompanyId);
                                    }
                                    
                                    if (documentType == Constants.DocumentType.InvoicesFE)
                                    {
                                        if (slResponse?.Response?.Data is null)
                                        {
                                            return await ResolveCreatedDocument<T>(null,
                                                SapDocumenType.Draft, documentKey, pUserId, pCompanyId);
                                        }
                                        
                                        CLContext<DocInfo> oClContextDocFe =
                                            await GetDocInfoByDocEntry(slResponse.Response.Data.DocEntry, pUserId, pCompanyId, "FE");

                                        if (oClContextDocFe.Response.Data is object && slResponse.Response.Data is ARInvoice oInvoice)
                                        {
                                            oInvoice.NumFE = oClContextDocFe.Response.Data.NumFE;
                                            oInvoice.ClaveFE = oClContextDocFe.Response.Data.ClaveFE;
                                        }

                                        return new CLContext<T>()
                                        {
                                            Response =  new Response<T>()
                                            {
                                                Data = slResponse.Response.Data,
                                                Message = slResponse.Response.Message
                                            },
                                            Code = slResponse.Code
                                        };
                                    }
                                }
                            }

                            break;
                    }
                }
            }

            return slResponse;
        }

        /// <summary>
        /// Set to document the configured series
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pDocumentType">Document type</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        private static void SetConfiguredSeriesToDocument(SalesDocument pSalesDocument,
            Constants.DocumentType pDocumentType, int pUserId, int pCompanyId)
        {
            SeriesByUser oSerie = GetSerie((int)pDocumentType, pUserId, pCompanyId);

            pSalesDocument.Series = oSerie.NoSerie;
        }

        /// <summary>
        /// Build the service layer request object for the sales documents
        /// </summary>
        /// <param name="pDocumentType">Document type</param>
        /// <param name="pIsPostObject">Indicates if the is a service layer request POST object</param>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pDbResource">Database resource code</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        /// <param name="pReturnNoContent">Indicates if should return a NoContent response</param>
        /// <returns>Built service layer request object for sales documents</returns>
        private static SLRequestObject BuildSalesDocumentSLRequestObject(Constants.DocumentType pDocumentType, bool pIsPostObject, SalesDocument pSalesDocument,
            string pDbResource, int pUserId, int pCompanyId, bool pReturnNoContent = false)
        {
            Dictionary<string, Func<JProperty, bool>> headerConditions = new Dictionary<string, Func<JProperty, bool>>();

            Func<JProperty, bool> oFunc = _property =>
            {
                JArray array = _property.Value as JArray;
                return array == null || array.Count == 0;
            };

            headerConditions.Add("DocumentReferences", oFunc);

            Dictionary<string, Func<JProperty, bool>> lineFlushCondition =
                new Dictionary<string, Func<JProperty, bool>>();

            if (pSalesDocument.DocumentLines.Exists(ln => ln.BaseEntry == null))
            {
                Func<JProperty, bool> result = (_property =>
                    _property.Value == null || Convert.ToInt32(_property.Value) == -1);

                lineFlushCondition.Add("BaseEntry", result);

                lineFlushCondition.Add("BaseType", result);

                lineFlushCondition.Add("BaseLine", result);
            }

            // Currently just credit notes are using this line flush conditions
            if (pDocumentType == Constants.DocumentType.CreditNotes)
            {
                Func<JProperty, bool> resultSerialNumbers = new Func<JProperty, bool>(_property =>
                {
                    if (_property.Value == null)
                    {
                        return true;
                    }

                    if (_property.Value.Type == JTokenType.Array)
                    {
                        JArray array = (JArray)_property.Value;
                        return array.Count == 0;
                    }

                    return false;
                });

                lineFlushCondition.Add("SerialNumbers", resultSerialNumbers);


                Func<JProperty, bool> resultBatchNumbers = new Func<JProperty, bool>(_property =>
                {
                    if (_property.Value == null)
                    {
                        return true;
                    }

                    if (_property.Value.Type == JTokenType.Array)
                    {
                        JArray array = (JArray)_property.Value;
                        return array.Count == 0;
                    }

                    return false;
                });

                lineFlushCondition.Add("BatchNumbers", resultBatchNumbers);
            }

            string fieldsToRemoveInLines = string.Empty;

            string fieldsToRemoveInHeaders = string.Empty;

            switch (pDocumentType)
            {
                case Constants.DocumentType.SalesQuotations:
                    fieldsToRemoveInLines = "WhsName,BaseType,BaseEntry,BaseLine,Udfs,TaxRate,LineTotal,LineNum,ManBtchNum,ManSerNum,UoMMasterData,LinesCurrenciesList,OnHand,InventoryItem,FatherCode,LineStatus,HideComp,VATLiable,Freight,IsAServerLine";
                    fieldsToRemoveInHeaders = "Udfs,DocNum,DocTotal,PriceList,DocEntry,DocStatus,TipoDocE,IdType,Identification,Email,DocObjectCode,SalesPersonName";
                    break;
                case Constants.DocumentType.SalesOrders:
                    fieldsToRemoveInLines = "Udfs,TaxRate,LineTotal,LineNum,LineStatus,ManBtchNum,ManSerNum,UoMMasterData,DistNumber,SysNumber,FatherCode,WhsName,LinesCurrenciesList,OnHand,InventoryItem,LineStatus,HideComp,VATLiable,Freight,IsAServerLine";
                    fieldsToRemoveInHeaders = "Udfs,DocTotal,PriceList,DocStatus,TipoDocE,IdType,Identification,Email,DocEntry,DocNum,DocObjectCode,SalesPersonName";
                    break;
                case Constants.DocumentType.InvoicesFE:
                case Constants.DocumentType.InvoicesTE:
                    fieldsToRemoveInLines = "LineTotal,Udfs,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,LinesCurrenciesList,OnHand,InventoryItem,LineTotal,HideComp,VATLiable,Freight,IsAServerLine";
                    fieldsToRemoveInHeaders = "DocTotal,Udfs,DocEntry,DocRate,IdTranRedimir,IdTranAcumular,PriceList,InvoiceNumber,DocStatus,TipoDocE,IdType,Identification,Email,NumFE,ClaveFE,DocTotalFC,DocumentKey,WithTransactionTapp,DocObjectCode,SalesPersonName,LineStatus";

                    //This is for when the doc is created through the service and they use a manual series
                    if (pSalesDocument.DocNum <= 0 )
                    {
                        fieldsToRemoveInHeaders += ",DocNum";
                    }
                    break;
                case Constants.DocumentType.ArDownPayment:
                case Constants.DocumentType.ApDownPayment:
                    fieldsToRemoveInLines = "LineTotal,Udfs,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,TaxOnly,LineStatus,HideComp,VATLiable,Freight,IsAServerLine";
                    fieldsToRemoveInHeaders = "DocTotal,Udfs,DocEntry,DocNum,DocRate,PriceList,DocStatus,TipoDocE,IdType,Identification,Email,InvoiceNumber,DocObjectCode";
                    break;
                case Constants.DocumentType.Delivery:
                    fieldsToRemoveInHeaders = "Udfs,DocStatus,DocEntry,DocNum,DocRate,Series,DocTotal,PriceList,SalesPersonName,DocObjectCode,ConfirmationEntry,TipoDocE,Identification,Email,IdType,DocumentReferences";
                    fieldsToRemoveInLines =
                        "Udfs,LinesCurrenciesList,ManBtchNum,ManSerNum,FatherCode,UoMMasterData,LineNum,LineStatus,HideComp,LineTotal,LineStatus,OnHand,InventoryItem,VATLiable,Freight,IsAServerLine";
                    break;
                case Constants.DocumentType.CreditNotes:
                    fieldsToRemoveInHeaders = "DocEntry,DocNum,IdTranRedimir,IdTranAcumular,Udfs,DocumentKey,DocTotal,DocTotalFC,WithTransactionTapp,PriceList,DocObjectCode,DocStatus,SalesPersonName,TipoDocE,Identification,Email,IdType";
                    fieldsToRemoveInLines = "Udfs,LineTotal,UoMMasterData,LinesCurrenciesList,WhsName,TaxRate,LineStatus,HideComp,LineNum,FatherCode,DocumentLinesBinAllocations,OnHand,InventoryItem,VATLiable,Freight,IsAServerLine";
                    break;
            }

            LogManager.Record("BUILDING SERVICE LAYER REQUEST OBJECT...");

            SLRequestObject slRequestObject; 
            
            if (pIsPostObject)
            {
                slRequestObject = GetUserCtx(pDbResource, pUserId, pCompanyId).Post(pSalesDocument, _fieldsToRemoveInLines: fieldsToRemoveInLines,
                    _fieldsToRemoveInHeaders: fieldsToRemoveInHeaders, _headerFlushConditions: headerConditions, _lineFlushConditions: lineFlushCondition);

                //This operation is applied because currently NuGet does not map UDFs to other objects besides lines.
                //In this functionality, the tax withholding UDFs are mapped as if they were lines in the document.
                if (pSalesDocument.WithholdingTaxDataCollection != null && pSalesDocument.WithholdingTaxDataCollection.Any())
                {
                    SLRequestObject slWithholdingObject;

                    slWithholdingObject = GetUserCtx(pDbResource, pUserId, pCompanyId).Post(pSalesDocument, _fieldsToRemoveInHeaders: fieldsToRemoveInHeaders,
                                        _fieldsToRemoveInLines: "Udfs", _lineObjectName: "WithholdingTaxDataCollection");
                   
                    if (!string.IsNullOrWhiteSpace(slRequestObject.Content) && !string.IsNullOrWhiteSpace(slWithholdingObject.Content))
                    {
                        var jsonWithholding = JObject.Parse(slWithholdingObject.Content);
                        var jsonReques = JObject.Parse(slRequestObject.Content);

                        if (jsonWithholding["WithholdingTaxDataCollection"] != null)
                        {
                            jsonReques["WithholdingTaxDataCollection"] = jsonWithholding["WithholdingTaxDataCollection"];
                            slRequestObject.Content = jsonReques.ToString(Newtonsoft.Json.Formatting.None);

                        }

                    }
                    
                }


            }
            else
            {
                slRequestObject = GetUserCtx(pDbResource, pUserId, pCompanyId).Patch(pSalesDocument, _fieldsToRemoveInLines: fieldsToRemoveInLines,
                    _fieldsToRemoveInHeaders: fieldsToRemoveInHeaders, _headerFlushConditions: headerConditions, _lineFlushConditions: lineFlushCondition);
                
                //This operation is applied because currently NuGet does not map UDFs to other objects besides lines.
                //In this functionality, the tax withholding UDFs are mapped as if they were lines in the document.
                if (pSalesDocument.WithholdingTaxDataCollection != null && pSalesDocument.WithholdingTaxDataCollection.Any())
                {
                    SLRequestObject slWithholdingObject;

                    slWithholdingObject = GetUserCtx(pDbResource, pUserId, pCompanyId).Patch(pSalesDocument, _fieldsToRemoveInHeaders: fieldsToRemoveInHeaders,
                                        _fieldsToRemoveInLines: "Udfs", _lineObjectName: "WithholdingTaxDataCollection");

                    if (!string.IsNullOrWhiteSpace(slRequestObject.Content) && !string.IsNullOrWhiteSpace(slWithholdingObject.Content))
                    {
                        var jsonWithholding = JObject.Parse(slWithholdingObject.Content);
                        var jsonReques = JObject.Parse(slRequestObject.Content);

                        if (jsonWithholding["WithholdingTaxDataCollection"] != null)
                        {
                            jsonReques["WithholdingTaxDataCollection"] = jsonWithholding["WithholdingTaxDataCollection"];
                            slRequestObject.Content = jsonReques.ToString(Newtonsoft.Json.Formatting.None);

                        }

                    }

                }


            }

            if (pReturnNoContent)
            {
                slRequestObject.Headers = new ParameterCollection()
                {
                    new KeyValuePair<string, string>("Prefer", "return-no-content") 
                };
            }

            LogManager.Record($"SERVICE LAYER REQUEST OBJECT BUILT | REQUEST OBJECT: {JsonConvert.SerializeObject(slRequestObject)}");

            return slRequestObject;
        }

        /// <summary>
        /// Checks if the type of the document applies for the authorization process
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pDocumentType">Document type</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        /// <returns>True if the document applies for the authorization process, otherwise false</returns>
        private static async Task<bool> TypeOfDocumentAppliesForAuthorizationProcess(
            string documentKey, Constants.DocumentType pDocumentType, int pUserId=-1, int pCompanyId=-1)
        {
            LogManager.Record($"START PROCESS CHECK IF TYPE OF THE DOCUMENT APPLIES FOR AUTHORIZATION PROCESS | DOCUMENT TYPE: {(int)pDocumentType}");
            
            LogManager.Record("BUILDING SERVICE LAYER REQUEST OBJECT...");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<CLSingleValue<String>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_ShouldBeAuthorizationDocument");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<CLSingleValue<String>> resultList = Common.ResolveSAPViewODBC<CLSingleValue<String>>(contextODBC, new Dictionary<string, object>(){
                    { "@DocumentType", ((int)pDocumentType).ToString() },
                    { "@DocumentKey", documentKey }
                });

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<CLSingleValue<String>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<CLSingleValue<String>> { Data = resultList.FirstOrDefault() },
                    value = resultList.FirstOrDefault()
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_ShouldBeAuthorizationDocument", pUserId, pCompanyId).Get(
                new FilterAuthorizationDocument()
                {
                    DocumentType = ((int)pDocumentType).ToString(),
                    DocumentKey = documentKey 
                });


                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<CLSingleValue<String>>();

                LogManager.Record("REQUEST COMPLETED");
            }

            
            LogManager.Record($"REQUEST RESPONSE | RESPONSE: {JsonConvert.SerializeObject(oClContext)}");

            return oClContext?.Response?.Data != null && oClContext.Response.Data.Value == "1";
        }

        /// <summary>
        /// Check if the document was created as a draft and send a notification if was created as draft
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pSAPTable">SAP table of the document</param>
        /// <param name="pWasCreatedAsDraft">Indicates if the document was created as draft manually</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        /// <returns>The created document</returns>
        /// <exception cref="CLException"></exception>
        private static async Task<CLContext<T>> ValidateAndNotifyAuthorization<T>(T pSalesDocument,
            string pSAPTable, QueryConditionApply pWasCreatedAsDraft, int pUserId, int pCompanyId) where T : SalesDocument, new()
        {
            Constants.DocumentType documentType = Common.GetDocumentTypeFromSapTable(pSAPTable);
            
            bool appliesForAuthorizationProcess = await TypeOfDocumentAppliesForAuthorizationProcess(pSalesDocument.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "",
                documentType, pUserId, pCompanyId);
            
            string table = appliesForAuthorizationProcess || pWasCreatedAsDraft.IsApply ? SapDocumenType.Draft : pSAPTable;

            string documentKey = pSalesDocument.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "";
            
            CLContext<T> oClContext = await ResolveCreatedDocument<T>(null, table,
                documentKey, pUserId, pCompanyId);
            
            if (oClContext?.Response?.Data is null)
            {
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
            }
            
            if (documentType == Constants.DocumentType.InvoicesFE)
            {
                CLContext<DocInfo> oClContextDocFe =
                    await GetDocInfoByDocEntry(oClContext.Response.Data.DocEntry, pUserId, pCompanyId, "FE");

                if (oClContextDocFe.Response.Data is object && oClContext.Response.Data is ARInvoice oInvoice)
                {
                    oInvoice.NumFE = oClContextDocFe.Response.Data.NumFE;
                    
                    oInvoice.ClaveFE = oClContextDocFe.Response.Data.ClaveFE;
                }
            }
            
            if (appliesForAuthorizationProcess)
            {
                int companyId = pCompanyId == -1 ? GetCompanyId(): pCompanyId;
                
                NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                
                try
                {
                    CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                    
                    if (oCLContextSetting.Response.Data != null)
                    {
                        List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                        
                        oDraftsSetting = settingList.Find(_setting => _setting.CompanyId == companyId);
                        
                        if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                        {
                            await SendNotifyAutoritation(oClContext.Response.Data.DocEntry, companyId, true, pWasCreatedAsDraft);
                        }
                    }
                }
                catch (Exception e)
                {
                    LogManager.Record($"Error: {e.Message}");
                }
            }

            return oClContext;
        }
        /// <summary>
        /// This method is used to create sale quotations documents
        /// </summary>
        /// <param name="pSalesQuotation"> model Quotation</param>
        /// <param name="pUserId"> current user id</param>
        /// <param name="pCompanyId">current company id</param>
        /// <returns></returns>
        /// <exception cref="CLException"> exepcion generada</exception>
        public static async Task<CLContext<SalesQuotation>> PostQuotations(SalesQuotation pSalesQuotation, DocumentAttachment pAttachment,
            IEnumerable<HttpPostedFile> pAttachmentFiles, int pUserId = -1, int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;

            CLContext<SalesQuotation> existingDocumentInformationResponse =
                await CheckIfDocumentExistByDocumentKey(pSalesQuotation, SapDocumenType.Quotation, pUserId, pCompanyId);

            if (existingDocumentInformationResponse != null)
            {
                return existingDocumentInformationResponse;
            }

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(pAttachment, pAttachmentFiles, pUserId, pCompanyId);
            pSalesQuotation.AttachmentEntry = documentAttachment?.AbsoluteEntry;
            
            CLContext<SalesQuotation> slResponse =
                await CheckIfDocumentComesFromDraft(pSalesQuotation, SapDocumenType.Quotation, userId, pCompanyId);

            if (slResponse != null)
            {
                return slResponse;
            }
            
            SetConfiguredSeriesToDocument(pSalesQuotation, Constants.DocumentType.SalesQuotations, userId, pCompanyId);

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(pSalesQuotation, Constants.DocumentType.SalesQuotations, userId, pCompanyId);

            if (queryConditionApply.IsApply)
            {
                pSalesQuotation.DocObjectCode = ((int)Constants.DocumentType.SalesQuotations).ToString();

                pSalesQuotation.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });

                slResponse = await PostDraft(pSalesQuotation, userId, pCompanyId);
               
            }
            else
            {
                SLRequestObject requestModel = BuildSalesDocumentSLRequestObject(Constants.DocumentType.SalesQuotations, true, pSalesQuotation, "PostQuotation", userId, pCompanyId, true);

                slResponse = await requestModel.SendAsync<SalesQuotation>();
            }
            

            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                return await ValidateAndNotifyAuthorization(pSalesQuotation, SapDocumenType.Quotation, queryConditionApply, userId, pCompanyId);
            }

            return slResponse;
        }

        /// <summary>
        /// Sends a cancel request for the specified sales quotation via the Service Layer.
        /// </summary>
        /// <param name="docEntry">
        /// The unique document entry of the sales quotation to cancel.
        /// </param>
        /// <returns>
        /// A task that returns a <see cref="CLContext{SalesQuotation}"/> containing the canceled quotation details.
        /// </returns>
        public static async Task<CLContext<SalesQuotation>> CancelQuotations(int docEntry)
        {
            ClUserContext oClUserContext = GetUserCtx("CancelSalesQuotations");

            SLRequestObject oSlRequestObjectPostCancel = oClUserContext.Post(
                new FilterBaseDocEntry()
                {
                    DocEntry = docEntry
                }
            );

            oSlRequestObjectPostCancel.Url_Request += $"({docEntry})/Cancel";

            return await oSlRequestObjectPostCancel.SendAsync<SalesQuotation>();
        }

        /// <summary>
        /// Method to get document by table and uniqueId
        /// </summary>
        /// <param name="_slResponse">Response</param>
        /// <param name="_table">Table to search docuement</param>
        /// <param name="_uniqueId">Id to search in document</param>
        /// <typeparam name="T">Type of object expected in the context</typeparam>
        /// <returns></returns>
        /// <exception cref="Exception"></exception>
        private static async Task<CLContext<T>> ResolveCreatedDocument<T>(CLContext<T> _slResponse, string _table,
            string _uniqueId, int _userId = -1, int _companyId = -1) where T : new()
        {
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string dbResource = String.Empty;

            switch (_table)
            {
                case "OQUT":
                    dbResource = "GetQuotationsByDocEntry";
                    break;
                case "ORDR":
                    dbResource = "GetOrdersByDocEntry";
                    break;
                case "OINV":
                    dbResource = "GetInvoice";
                    break;
                case "ODRF":
                    dbResource = "GetDraftByDocEntry";
                    break;
                case "OPOR":
                    dbResource = "GetPurchaseOrder";
                    break;
                case "OPCH":
                    dbResource = "GetPurchaseInvoiceByDocEntry";
                    break;
                case "OPDN":
                    dbResource = "GetGoodsReceiptByDocEntry";
                    break;
                case "ORPD":
                    dbResource = "GetPurchaseReturnsByDocEntry";
                    break;
                case "ODPO":
                    dbResource = "GetPurchaseDownPaymentByDocEntry";
                    break;
                case "ODPI":
                    dbResource = "GetARDownPayments";
                    break;
                case "ORIN":
                    dbResource = "GetCreditNotesByDocEntry";
                    break;
                case "ODLN":
                    dbResource = "GetDeliveryByDocEntry";
                    break;
                default:
                    throw new Exception($"{_table} is not a valid SAP Resolved table");
            }

            CLContext<CLMLTEMA.MODELS.UniqueId> resolved = await GetUniqueId(_uniqueId, _table, _userId, _companyId);

            LogManager.Record($"REQUESTING COMPLETE | DATA: {JsonConvert.SerializeObject(resolved.Response)}");

            if (resolved.Response.Data is Object)
            {
                #region Query Via ODBC
                if (connectionMode == SapConnectionType.ODBC)
                {
                    ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{dbResource}", _userId, _companyId);

                    LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                    List<T> resultList = Common.ResolveSAPViewODBC<T>(contextODBC,
                        new Dictionary<string, object>()
                        {
                        { "@DocEntry", resolved.Response.Data.DocEntry }
                        });

                    return new CLContext<T>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<T>()
                        {
                            Data = resultList.FirstOrDefault() // Assuming you want the first result
                        },
                        value = resultList.FirstOrDefault()
                    };
                }
                #endregion
                
                #region Query Via SL
                SLRequestObject oSlRequestDocumentObject = GetUserCtx($"SL_{dbResource}", -1, _companyId).Get(new FilterBaseDocument()
                {
                    DocEntry = resolved.Response.Data.DocEntry
                });

                LogManager.Record($"RESOURCE SL: {oSlRequestDocumentObject.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                return await oSlRequestDocumentObject.SendAsync<T>();
                #endregion
            }

            return new CLContext<T>();
        }

        public static async Task<CLContext<SalesQuotation>> PatchQuotations(SalesQuotation _salesQuotation, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            string oRemoveLineProperties =
                "BaseType,BaseEntry,BaseLine,Udfs,TaxRate,LineTotal,ManBtchNum,ManSerNum,UoMMasterData,FatherCode,LineStatus,WhsName,LinesCurrenciesList,OnHand,InventoryItem,LineNum,HideComp,VATLiable,Freight,IsAServerLine";

            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _salesQuotation.DocumentLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);

            if (hasClosedLines)
            {
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineNum", "");
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineStatus", "");
            }

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "Series",
                "Udfs",
                "DocNum",
                "DocTotal",
                "PriceList",
                "DocStatus",
                "TipoDocE",
                "IdType",
                "Identification",
                "Email",
                "DocObjectCode",
                "SalesPersonName",
                "HandWritten"
            };

            string oHeaderProperties = string.Join(",", oRemoveHeaderProperties);

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _salesQuotation.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject requestModel = GetUserCtx("PatchQuotation")
                .Patch(_salesQuotation, _fieldsToRemoveInLines: oRemoveLineProperties,
                    _fieldsToRemoveInHeaders: oHeaderProperties);

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            headers.Add(new KeyValuePair<string, string>("B1S-ReplaceCollectionsOnPatch", "true"));

            requestModel.Headers = headers;

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<SalesQuotation>();
        }
        
        /// <summary>
        /// Retrieves a sales quotation based on the provided document entry identifier.
        /// </summary>
        /// <param name="DocEntry">The document entry identifier used to fetch the sales quotation.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{SalesQuotation}"/>
        /// with the sales quotation data.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found for the given document entry.</exception>
        public static async Task<CLContext<SalesQuotation>> GetQuotation(int DocEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<SalesQuotation> oClContext = new CLContext<SalesQuotation>();
                
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetQuotationsByDocEntry");
                List<SalesQuotation> resultList = Common.ResolveSAPViewODBC<SalesQuotation>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", DocEntry }
                    });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<SalesQuotation>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesQuotation>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value =  resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetQuotationsByDocEntry").Get<FilterQuotation>();

                LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<SalesQuotation>();
                #endregion
            }

            if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
            {
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
            }

            CLContext<List<SalesQuotationRows>> oClContextLines = new CLContext<List<SalesQuotationRows>>();
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetQuotationsRows");
                List<SalesQuotationRows> resultListLines = Common.ResolveSAPViewODBC<SalesQuotationRows>(contextODBCLines,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", DocEntry }
                    });

                LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextLines = new CLContext<List<SalesQuotationRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesQuotationRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModelLines = GetUserCtx("SL_GetQuotationsRows").Get<FilterQuotation>();

                LogManager.Record($"RESOURCE LINES SL: {requestModelLines.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextLines = await requestModelLines.SendAsync<List<SalesQuotationRows>>();
                #endregion
            }

            //Se obtienen las unidades de medida
            if (oClContextLines.Response.Data is object && oClContextLines.Response.Data.Count > 0)
            {
                foreach (SalesQuotationRows row in oClContextLines.Response.Data)
                {
                    row.UoMMasterData = await GetUomMasterDataFilter(row.ItemCode, row.WarehouseCode,
                        oClContext.Response.Data.PriceList,
                        "N");

                    row.LinesCurrenciesList =
                        await GetAdditionalCurrencies(row.ItemCode, oClContext.Response.Data.PriceList);
                }
            }

            LogManager.Record($"REQUEST COMPLETED");

            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();

            oClContext.Response.Data.DocumentLines.AddRange(oClContextLines.Response.Data);
            
            return oClContext;
        }

        /// <summary>
        /// Method to obtain a list of sales quotations based on the provided filters.
        /// </summary>
        /// <param name="_slpCode">The salesperson code used to filter quotations.</param>
        /// <param name="_dateInit">The initial date for the quotation search range.</param>
        /// <param name="_dateEnd">The end date for the quotation search range.</param>
        /// <param name="_docNum">The document number to filter quotations.</param>
        /// <param name="_docStatus">The status of the document to filter quotations.</param>
        /// <param name="_docCurrency">The currency used to filter quotations (optional).</param>
        /// <param name="_cardCode">The business partner code used to filter quotations (optional).</param>
        /// <param name="_cardName">The business partner name used to filter quotations (optional).</param>
        /// <returns>
        /// A task representing the context containing the filtered list of sales quotations.
        /// </returns>
        public static async Task<CLContext<List<SalesQuotation>>> GetQuotations(
            int _slpCode, 
            string _dateInit, 
            string _dateEnd,
            int _docNum, 
            string _docStatus, 
            string _docCurrency = "", 
            string _cardCode = "", 
            string _cardName = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetQuotationsByFilters");
                
                List<SalesQuotation> resultList = Common.ResolveSAPViewODBC<SalesQuotation>(contextODBC, new Dictionary<string, object>()
                {
                    {"@SlpCode", $"{_slpCode}"},
                    {"@DateInit", $"{_dateInit}"},
                    {"@DateEnd", $"{_dateEnd}"},
                    {"@DocNum", $"{_docNum}"},
                    {"@DocStatus", $"{_docStatus}"},
                    {"@DocCurrency", $"{_docCurrency}"},
                    {"@CardCode", $"{_cardCode}"},
                    {"@CardName", $"{_cardName}"},
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<SalesQuotation>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesQuotation>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetQuotationsByFilters").Get<FilterQuotations>();

            LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");

            return await requestModel.SendAsync<List<SalesQuotation>>();
            #endregion
        }
        
        /// <summary>
        /// Method to create drafts
        /// </summary>
        /// <param name="_salesQuotation"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<SalesQuotation>> PostQuotationsDrafts(SalesQuotation _salesQuotation, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId
            
            _salesQuotation.DocObjectCode = ((int)Constants.DocumentType.SalesQuotations).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _salesQuotation.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_salesQuotation.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "", SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<SalesQuotation>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesQuotation>()
                    {
                        Data = new SalesQuotation()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            CLContext<SalesQuotation> slResponse = null;
            
            slResponse = await PostDraft<SalesQuotation>(_salesQuotation);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<SalesQuotation> oClContext = await ResolveCreatedDocument<SalesQuotation>(slResponse,
                    SapDocumenType.Draft,
                    _salesQuotation.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;

    
                return oClContext;
            }
            
            return slResponse;
        }

        /// <summary>
        /// Method to update drafts
        /// </summary>
        /// <param name="_salesQuotation"></param>
        /// <param name="_attachment"></param>
        /// <param name="_attachmentFiles"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<SalesQuotation>> PatchQuotationsDrafts(SalesQuotation _salesQuotation, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");
            _salesQuotation.DocObjectCode = ((int)Constants.DocumentType.SalesQuotations).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _salesQuotation.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<SalesQuotation> slResponse = null;
            slResponse = await PatchDraft(_salesQuotation);
            
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<SalesQuotation> oClContext = await ResolveCreatedDocument<SalesQuotation>(slResponse,
                    SapDocumenType.Draft,
                    _salesQuotation.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
    
                return oClContext;
            }
            
            return slResponse;
        }
        #endregion

        #region PriceLists

        /// <summary>
        /// Retrieves a list of price lists based on the specified view type.
        /// </summary>
        /// <param name="_viewType">The type of view to filter the price lists.</param>
        /// <returns>
        /// A task representing the context containing a list of price lists.
        /// </returns>
        public static async Task<CLContext<List<PriceList>>> GetPriceLists(string viewType)
        {
            LogManager.Record("REQUESTING RECORDS");

            string resource;

            switch (viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetInventoryPriceList";
                    break;
                case ItemsFilterType.PrchseItem:
                    resource = "GetPurchasesPriceLists";
                    break;
                case ItemsFilterType.SellItem:
                    resource = "GetSalesPriceList";
                    break;
                default:
                    resource = "GetPriceLists";
                    break;
            }
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PriceList>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC(resource);

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<PriceList> resultList =
                    Common.ResolveSAPViewODBC<PriceList>(contextODBC);

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<PriceList>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PriceList>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<List<PriceList>>();

                LogManager.Record("REQUESTING COMPLETED");

                #endregion
            }

            return oClContext;
        }

        #endregion

        #region Accounts

        /// <summary>
        /// Retrieves a list of accounts based on the specified store identifier.
        /// </summary>
        /// <param name="_store">The store identifier used to filter the accounts.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{Accounts}}"/> with the list of accounts.</returns>
        /// <exception cref="Exception"></exception>
        public static async Task<CLContext<List<Accounts>>> GetAccounts(string store)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Accounts>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetAccounts");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Accounts> resultList = Common.ResolveSAPViewODBC<Accounts>(contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@Store", store }
                    }
                );

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<Accounts>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Accounts>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetAccounts")
                    .Get(
                        new FilterStore (){ 
                            Store = store 
                        });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<Accounts>>();

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves account information based on the given account code.
        /// </summary>
        /// <param name="_account">The account code to retrieve information for.</param>
        /// <returns>A CLContext containing the account information.</returns>
        public static async Task<CLContext<Accounts>> GetAccount(string account)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<Accounts> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetAccount");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Accounts> resultList = Common.ResolveSAPViewODBC<Accounts>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@AcctCode", account }
                    }
                );

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<Accounts>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<Accounts>
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetAccount")
                    .Get(
                        new FilterAcctCode(){ 
                            AcctCode = account 
                        });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<Accounts>();

                #endregion
            }

            return oClContext;
        }

        #endregion

        #region IncomingPayments

        public static async Task<CLContext<IncomingPayment>> CancelIncomingPayments(int _docEntry)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            IncomingPayment _incomingPayment = new IncomingPayment() { DocEntry = _docEntry };

            //Pendiente de que exista algo para cancelar pagos
            SLRequestObject oSlRequestObject = GetUserCtx($"PatchIncomingPayments").Patch(_incomingPayment);

            //Esto es mientras hay un flujo para cancelar pagos
            oSlRequestObject.Method = "POST";

            oSlRequestObject.Url_Request = $"{oSlRequestObject.Url_Request}/Cancel";

            oSlRequestObject.Content = "{}";

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<IncomingPayment>();
        }

        /// <summary>
        /// Retrieves a list of payments that are eligible for cancellation based on the specified filters.
        /// </summary>
        /// <param name="DateFrom">The start date for filtering payments.</param>
        /// <param name="DateTo">The end date for filtering payments.</param>
        /// <param name="CardCode">The card code used to filter payments.</param>
        /// <param name="currency">The currency used to filter payments. If set to "##", it will be ignored.</param>
        /// <param name="type">The type of payment to filter. If set to "##", it will be ignored.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{List{PaymentForCancel}}"/>
        /// with the list of payments that match the specified filters.
        /// </returns>
        public static async Task<CLContext<List<PaymentForCancel>>> GetPayments(string DateFrom, string DateTo, string CardCode, string currency, string type)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PaymentForCancel>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPaymentsForCancel");
                List<PaymentForCancel> resultList = Common.ResolveSAPViewODBC<PaymentForCancel>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@DateFrom", DateFrom },
                        { "@DateTo", DateTo },
                        { "@CardCode", CardCode ?? "" },
                        { "@Currency", currency == "##" ? "" : currency },
                        { "@Type", type == "##" ? "" : type }
                    });
                oClContext = new CLContext<List<PaymentForCancel>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PaymentForCancel>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetPaymentsForCancel")
                    .Get(new FilterPayments()
                    {
                        DateFrom = DateFrom,
                        DateTo = DateTo,
                        CardCode = CardCode,
                        Currency = currency == "##" ? "" : currency,
                        Type = type == "##" ? "" : type
                    });
                oClContext = await requestModel.SendAsync<List<PaymentForCancel>>();
            }

            LogManager.Record("REQUEST COMPLETED");
            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of payments for mobile applications based on the specified date range and card code.
        /// </summary>
        /// <param name="DateFrom">The start date for filtering payments.</param>
        /// <param name="DateTo">The end date for filtering payments.</param>
        /// <param name="CardCode">The card code used to filter payments. If null, it will be ignored.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{List{PaymentForCancel}}"/>
        /// with the list of payments that match the specified filters.
        /// </returns>
        public static async Task<CLContext<List<PaymentForCancel>>> GetPaymentsMobile(string dateFrom, string dateTo, string cardCode)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PaymentForCancel>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPayments");
                List<PaymentForCancel> resultList =
                    Common.ResolveSAPViewODBC<PaymentForCancel>(
                        contextODBC,
                        new Dictionary<string, object>
                        {
                            { "@DateFrom", dateFrom },
                            { "@DateTo",   dateTo   },
                            { "@CardCode", cardCode ?? "" }
                        });
                oClContext = new CLContext<List<PaymentForCancel>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PaymentForCancel>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetPayments")
                    .Get(new FilterPaymentsForCancel()
                    {
                        DateFrom = dateFrom,
                        DateTo = dateTo,
                        CardCode = cardCode ?? ""
                    });
                oClContext = await requestModel.SendAsync<List<PaymentForCancel>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves the details of a specific incoming payment based on the provided document entry.
        /// </summary>
        /// <param name="_docEntry"></param>
        /// <returns></returns>
        public static async Task<CLContext<IncomingPaymentDetail>> GetPayment(int _docEntry)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<IncomingPaymentDetail> oClContext;
            CLContext<List<CreditVouchersDetail>> oClContextCredit;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                // Obtener detalle del pago
                ClUserContextODBC contextODBCDetail = GetUserCtxODBC($"ODBC_GetIncomingPaymentsDetail");
                LogManager.Record($"RESOURCE: {contextODBCDetail.Resource}");

                List<IncomingPaymentDetail> resultListDetail = Common.ResolveSAPViewODBC<IncomingPaymentDetail>(contextODBCDetail,
                    new Dictionary<string, object>()
                    {
                        {"@DocEntry", _docEntry}
                    });

                oClContext = new CLContext<IncomingPaymentDetail>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<IncomingPaymentDetail>()
                    {
                        Data = resultListDetail.FirstOrDefault()
                    },
                    value = resultListDetail.FirstOrDefault()
                };

                // Obtener credit vouchers
                ClUserContextODBC contextODBCVouchers = GetUserCtxODBC($"ODBC_GetCreditVouchers");
                LogManager.Record($"RESOURCE: {contextODBCVouchers.Resource}");

                List<CreditVouchersDetail> resultListVouchers = Common.ResolveSAPViewODBC<CreditVouchersDetail>(contextODBCVouchers,
                    new Dictionary<string, object>()
                    {
                        {"@DocNum", _docEntry}
                    });

                oClContextCredit = new CLContext<List<CreditVouchersDetail>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<CreditVouchersDetail>>()
                    {
                        Data = resultListVouchers
                    },
                    value = resultListVouchers
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObjectDetail = GetUserCtx($"GetIncomingPaymentsDetail").Get(
                    new FilterBaseDocEntry()
                    {
                        DocEntry = _docEntry
                    });

                LogManager.Record($"RESOURCE: {oSlRequestObjectDetail.Url_Request}");

                oClContext = await oSlRequestObjectDetail.SendAsync<IncomingPaymentDetail>();

                SLRequestObject oSlRequestObjectVouchers = GetUserCtx($"GetCreditVouchers").Get(new FilterBaseDocNum()
                {
                    DocNum = _docEntry
                });

                LogManager.Record($"RESOURCE: {oSlRequestObjectVouchers.Url_Request}");

                oClContextCredit = await oSlRequestObjectVouchers.SendAsync<List<CreditVouchersDetail>>();

                #endregion
            }

            // Combinar resultados (común para ambas ramas)
            if (oClContext.Response?.Data != null)
            {
                oClContext.Response.Data.CreditCards = oClContextCredit.Response.Data;
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        public static async Task<CLContext<IncomingPayment>> PostIncomingPayments(IncomingPayment _incomingPayment,
            int _userId = -1, int _companyId = -1, string _userEmail = "")
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            if (!string.IsNullOrEmpty(_incomingPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? ""))
            {
                CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_incomingPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.IncomingPayment, _userId, _companyId);

                if (uniques.Response.Data != null)
                {
                    return new CLContext<IncomingPayment>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<IncomingPayment>()
                        {
                            Data = new IncomingPayment()
                            {
                                DocEntry = uniques.Response.Data.DocEntry,
                                DocNum = uniques.Response.Data.DocNum
                            }
                        }
                    };
                }
            }

            #endregion

            SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.IncomingPayments, _userId, _companyId);

            _incomingPayment.Series = oSerie.NoSerie;

            string removeHeaderProperties = "PPTransactions";

            SLRequestObject oSlRequestObject =
                GetUserCtx($"PostIncomingPayments", _userId, _companyId).Post(_incomingPayment,
                    _fieldsToRemoveInHeaders: removeHeaderProperties);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record("REQUESTING COMPLETED");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            CLContext<IncomingPayment> incomingPaymentContext = await oSlRequestObject.SendAsync<IncomingPayment>();

            if (incomingPaymentContext.Response != null)
            {
                if (_incomingPayment.PPTransactions != null)
                {
                    CLContext<PPTransaction> ppTransaction = null;

                    foreach (PPTransaction transaction in _incomingPayment.PPTransactions)
                    {
                        transaction.CompanyId = _companyId == -1 ? GetCompanyId() : _companyId;
                        transaction.CreatedBy = _userEmail == string.Empty ? CL.COMMON.Core.GetClaimValue<string>("UserEmail") : _userEmail;
                        transaction.DocEntry = incomingPaymentContext.Response.Data?.DocEntry ?? 0;
                        ppTransaction = Sale(transaction);
                    }
                }
            }

            return incomingPaymentContext;
        }

        #endregion

        #region CONCILIACION DE DOCUMENTOS

        public static async Task<CLContext<List<PayInAccount>>> GetPayInAccount(string _cardCode, string _docCurrency, string _dateInit, string _dateEnd)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetAccountPayments");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<PayInAccount> resultList = Common.ResolveSAPViewODBC<PayInAccount>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@CardCode", $"{_cardCode ?? ""}"},
                        {"@DocCurrency", $"{_docCurrency ?? ""}"},
                        {"@DateInit", $"{_dateInit ?? ""}"},
                        {"@DateEnd", $"{_dateEnd ?? ""}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<PayInAccount>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PayInAccount>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx($"SL_GetAccountPayments").Get(new FilterInvoiceOpenForPayReceived()
                {
                    CardCode = _cardCode ?? "",
                    DocCurrency = _docCurrency ?? "",
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? ""
                });

                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await oSlRequestObject.SendAsync<List<PayInAccount>>();
                #endregion
            }
        }

        public static async Task<CLContext<InternalReconciliationsResponse>> CreateInternalReconciliation(
            InternalReconciliations _internalReconciliation, int _userId = -1,
            int _companyId = -1)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            SLRequestObject requestModel =
                GetUserCtx("PostInternalReconciliations", _userId, _companyId).Post(_internalReconciliation);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<InternalReconciliationsResponse>();
        }

        #endregion

        #region Invoices

        /// <summary>
        /// Retrieves A/R invoices filtered by salesperson, dates, document info, BP data, status, and delivery.
        /// Uses ODBC or SAP Service Layer depending on the current connection mode.
        /// </summary>
        /// <param name="SlpCode">Salesperson code.</param>
        /// <param name="DateInit">Start date filter.</param>
        /// <param name="DateEnd">End date filter.</param>
        /// <param name="DocNum">Document number filter.</param>
        /// <param name="DocStatus">Document status filter.</param>
        /// <param name="DocCurrency">Document currency filter.</param>
        /// <param name="CardCode">Business partner code filter.</param>
        /// <param name="CardName">Business partner name filter.</param>
        /// <param name="Status">Additional status filter.</param>
        /// <param name="Delivery">Delivery status filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{ARInvoice}"/> that matches the filters.
        /// </returns>
        public static async Task<CLContext<List<ARInvoice>>> GetInvoices(
            int SlpCode,
            string DateInit,
            string DateEnd,
            int DocNum,
            string DocStatus,
            string DocCurrency,
            string CardCode,
            string CardName,
            string Status,
            string Delivery)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInvoicesByFilters");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@SlpCode", SlpCode },
                    { "@DateInit", DateInit ?? "" },
                    { "@DateEnd", DateEnd ?? "" },
                    { "@DocNum", DocNum },
                    { "@DocStatus", DocStatus ?? "" },
                    { "@DocCurrency", DocCurrency ?? "" },
                    { "@CardCode", CardCode ?? "" },
                    { "@CardName", CardName ?? "" },
                    { "@Status", Status ?? "" },
                    { "@Delivery", Delivery ?? "" }
                };

                List<ARInvoice> resultList =
                     Common.ResolveSAPViewODBC<ARInvoice>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<ARInvoice>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ARInvoice>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterInvoices filter = new FilterInvoices
                {
                    SlpCode = SlpCode,
                    DateInit = DateInit ?? "",
                    DateEnd = DateEnd ?? "",
                    DocNum = DocNum,
                    DocStatus = DocStatus ?? "",
                    DocCurrency = DocCurrency ?? "",
                    CardCode = CardCode ?? "",
                    CardName = CardName ?? "",
                    DStatus = Status ?? "",
                    Delivery = Delivery ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetInvoicesByFilters").Get<FilterInvoices>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<ARInvoice>>();

                #endregion
            }
        }
        /// <summary>
        /// Retrieves reserve (proforma) A/R invoices filtered by salesperson, date range,
        /// document data, and BP info. Uses ODBC or SAP Service Layer based on connection mode.
        /// </summary>
        /// <param name="_slpCode">Salesperson code.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <param name="_docNum">Document number filter.</param>
        /// <param name="_docStatus">Document status filter.</param>
        /// <param name="_docCurrency">Document currency filter.</param>
        /// <param name="_cardCode">Business partner code filter.</param>
        /// <param name="_cardName">Business partner name filter.</param>
        /// <returns>A <see cref="CLContext{T}"/> containing a <see cref="List{ARInvoice}"/>.</returns>
        public static async Task<CLContext<List<ARInvoice>>> GetInvoicesReserve(
            int _slpCode,
            string _dateInit,
            string _dateEnd,
            int _docNum,
            string _docStatus,
            string _docCurrency,
            string _cardCode,
            string _cardName)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInvoicesReserveByFilters");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARInvoice> resultList = Common.ResolveSAPViewODBC<ARInvoice>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@SlpCode", _slpCode},
                        {"@DateInit", $"{_dateInit ?? ""}"},
                        {"@DateEnd", $"{_dateEnd ?? ""}"},
                        {"@DocNum", _docNum},
                        {"@DocStatus", $"{_docStatus ?? ""}"},
                        {"@DocCurrency", $"{_docCurrency ?? ""}"},
                        {"@CardCode", $"{_cardCode ?? ""}"},
                        {"@CardName", $"{_cardName ?? ""}"}
                    });

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<ARInvoice>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ARInvoice>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetInvoicesReserveByFilters").Get(new FilterInvoices()
                {
                    SlpCode = _slpCode,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    DocNum = _docNum,
                    DocStatus = _docStatus ?? "",
                    DocCurrency = _docCurrency ?? "",
                    CardCode = _cardCode ?? "",
                    CardName = _cardName ?? ""
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<ARInvoice>>();

                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves a reserve invoice for preview based on the provided document entry identifier.
        /// </summary>
        /// <param name="docEntry">The document entry identifier for the reserve invoice to be retrieved.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{ARInvoice}"/> with the reserve invoice data.</returns>
        public static async Task<CLContext<ARInvoice>> GetReserveInvoiceToPreview(int docEntry)
        {
             LogManager.Record("REQUESTING RECORDS");

            #region FLUJO DE OBTENCION DE LAS CABECERA

            LogManager.Record($"REQUESTING RESERVE INVOICE DATA HEADER");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<ARInvoice> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetReserveInvoiceToPreview");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARInvoice> resultList = Common.ResolveSAPViewODBC<ARInvoice>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", docEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<ARInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ARInvoice>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                FilterBaseDocEntry filter = new FilterBaseDocEntry
                {
                    DocEntry = docEntry
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetReserveInvoiceToPreview").Get<FilterBaseDocEntry>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<ARInvoice>();
                #endregion

            }
            #endregion

            #region FLUJO DE OBTENCIO DE LINEAS
            LogManager.Record($"REQUESTING RESERVE INVOICE LINES DATA");

            CLContext<List<ARInvoiceRows>> oClContextLines = null;
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetReserveInvoiceRows");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARInvoiceRows> resultList = Common.ResolveSAPViewODBC<ARInvoiceRows>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", docEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLines = new CLContext<List<ARInvoiceRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ARInvoiceRows>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                FilterBaseDocEntry filterLines = new FilterBaseDocEntry
                {
                    DocEntry = docEntry
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetReserveInvoiceRows").Get<FilterBaseDocEntry>(filterLines);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLines = await requestModel.SendAsync<List<ARInvoiceRows>>();
                #endregion

            }

            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();

            oClContext.Response.Data.DocumentLines.AddRange(oClContextLines.Response.Data);
            
            #endregion

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA

            if (oClContextLines.Response.Data is object && oClContextLines.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    row.UoMMasterData = await GetUomMasterDataFilter(row.ItemCode, row.WarehouseCode,
                        oClContext.Response.Data.PriceList,
                        "N");

                    row.LinesCurrenciesList =
                        await GetAdditionalCurrencies(row.ItemCode, oClContext.Response.Data.PriceList);
                }
            }

            #endregion

            #region FLUJO DE OBTENCION DE SERIES

            LogManager.Record($"REQUESTING SERIES DATA");

            CLContext<List<SeriesForNC>> oClContextSeries = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBCSeries = GetUserCtxODBC("ODBC_GetSeriesForNC");
                LogManager.Record($"RESOURCE: {contextODBCSeries.Resource}");

                List<SeriesForNC> resultListSeries = Common.ResolveSAPViewODBC<SeriesForNC>(contextODBCSeries,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", docEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextSeries = new CLContext<List<SeriesForNC>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SeriesForNC>>()
                    {
                        Data = resultListSeries
                    },
                    value = resultListSeries
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                FilterInvoice filterSeries = new FilterInvoice
                {
                    DocEntry = docEntry
                };

                SLRequestObject requestModelSeries = GetUserCtx("SL_GetSeriesForNC").Get<FilterInvoice>(filterSeries);

                LogManager.Record($"RESOURCE: {requestModelSeries.Url_Request}");

                oClContextSeries = await requestModelSeries.SendAsync<List<SeriesForNC>>();

                #endregion
            }

            //Se setean las series
            if (oClContextSeries.Response.Data != null && oClContextSeries.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    SeriesForNC seriesForNC =
                        oClContextSeries.Response.Data.Find(_x => _x.ItemCode == row.ItemCode);

                    if (seriesForNC is object)
                    {
                        row.SerialNumbers = new List<SerialNumbers>();
                        row.SerialNumbers.Add(new SerialNumbers()
                        {
                            SystemSerialNumber = seriesForNC.SysNumber,
                            Quantity = 1,
                            DistNumber = seriesForNC.DistNumber
                        });

                        oClContextSeries.Response.Data.Remove(seriesForNC);
                    }
                }
            }

            #endregion

            #region FLUJO DE OBTENCION DE LOTES

            LogManager.Record($"REQUESTING LOTES DATA");

            CLContext<List<BatchsForNC>> oClContextLotes = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBCLotes = GetUserCtxODBC("ODBC_GetLotesForNC");
                LogManager.Record($"RESOURCE: {contextODBCLotes.Resource}");

                List<BatchsForNC> resultListLotes = Common.ResolveSAPViewODBC<BatchsForNC>(contextODBCLotes,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", docEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLotes = new CLContext<List<BatchsForNC>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BatchsForNC>>()
                    {
                        Data = resultListLotes
                    },
                    value = resultListLotes
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                FilterInvoice filterLotes = new FilterInvoice
                {
                    DocEntry = docEntry
                };

                SLRequestObject requestModelLotes = GetUserCtx("SL_GetLotesForNC").Get<FilterInvoice>(filterLotes);

                LogManager.Record($"RESOURCE: {requestModelLotes.Url_Request}");

                oClContextLotes = await requestModelLotes.SendAsync<List<BatchsForNC>>();

                #endregion
            }

            //Se setean los lotes
            if (oClContextLotes.Response.Data != null && oClContextLotes.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    row.BatchNumbers = oClContextLotes.Response?.Data?
                        .Where(_x => _x.ItemCode == row.ItemCode)
                        .Select(_y => new BatchNumbers()
                        {
                            SystemSerialNumber = _y.SysNumber,
                            Quantity = Convert.ToDecimal(_y?.Quantity ?? 0),
                            BatchNumber = _y.DistNumber
                        }).ToList();
                }
            }

            #endregion

            return oClContext;
        }


        /// <summary>
        /// Retrieves an ARInvoice based on the provided document entry identifier.
        /// </summary>
        /// <param name="_DocEntry">The document entry identifier for the invoice to be retrieved.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a CLContext object with the ARInvoice data.</returns>
        public static async Task<CLContext<ARInvoice>> GetInvoice(int _DocEntry)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region FLUJO DE OBTENCION DE LAS CABECERA

            LogManager.Record($"REQUESTING INVOICE DATA HEADER");

            CLContext<ARInvoice> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetInvoice");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARInvoice> resultList = Common.ResolveSAPViewODBC<ARInvoice>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DocEntry", $"{_DocEntry}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<ARInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ARInvoice>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                FilterBaseDocEntry filter = new FilterBaseDocEntry
                {
                    DocEntry = _DocEntry
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetInvoice").Get<FilterBaseDocEntry>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<ARInvoice>();
                #endregion

            }
            #endregion



            #region FLUJO DE OBTENCIO DE LINEAS

            LogManager.Record($"REQUESTING INVOICE LINES DATA");

            CLContext<List<ARInvoiceRows>> oClContextLines = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetInvoiceRows");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARInvoiceRows> resultList = Common.ResolveSAPViewODBC<ARInvoiceRows>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@DocEntry", $"{_DocEntry}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLines = new CLContext<List<ARInvoiceRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ARInvoiceRows>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL

                FilterBaseDocEntry filterLines = new FilterBaseDocEntry
                {
                    DocEntry = _DocEntry
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetInvoiceRows").Get<FilterBaseDocEntry>(filterLines);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLines = await requestModel.SendAsync<List<ARInvoiceRows>>();
                #endregion

            }

            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();

            oClContext.Response.Data.DocumentLines.AddRange(oClContextLines.Response.Data);
            
            #endregion

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA

            if (oClContextLines.Response.Data is object && oClContextLines.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    row.UoMMasterData = await GetUomMasterDataFilter(row.ItemCode, row.WarehouseCode,
                        oClContext.Response.Data.PriceList,
                        "N");

                    row.LinesCurrenciesList =
                        await GetAdditionalCurrencies(row.ItemCode, oClContext.Response.Data.PriceList);
                }
            }

            #endregion

            #region FLUJO DE OBTENCION DE SERIES

            LogManager.Record($"REQUESTING SERIES DATA");

            CLContext<List<SeriesForNC>> oClContextSeries = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBCSeries = GetUserCtxODBC("ODBC_GetSeriesForNC");
                LogManager.Record($"RESOURCE: {contextODBCSeries.Resource}");

                List<SeriesForNC> resultListSeries = Common.ResolveSAPViewODBC<SeriesForNC>(contextODBCSeries,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", _DocEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextSeries = new CLContext<List<SeriesForNC>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SeriesForNC>>()
                    {
                        Data = resultListSeries
                    },
                    value = resultListSeries
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                FilterInvoice filterSeries = new FilterInvoice
                {
                    DocEntry = _DocEntry
                };

                SLRequestObject requestModelSeries = GetUserCtx("SL_GetSeriesForNC").Get<FilterInvoice>(filterSeries);

                LogManager.Record($"RESOURCE: {requestModelSeries.Url_Request}");

                oClContextSeries = await requestModelSeries.SendAsync<List<SeriesForNC>>();

                #endregion
            }

            //Se setean las series
            if (oClContextSeries.Response.Data != null && oClContextSeries.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    SeriesForNC seriesForNC =
                        oClContextSeries.Response.Data.Find(_x => _x.ItemCode == row.ItemCode);

                    if (seriesForNC is object)
                    {
                        row.SerialNumbers = new List<SerialNumbers>();
                        row.SerialNumbers.Add(new SerialNumbers()
                        {
                            SystemSerialNumber = seriesForNC.SysNumber,
                            Quantity = 1,
                            DistNumber = seriesForNC.DistNumber
                        });

                        oClContextSeries.Response.Data.Remove(seriesForNC);
                    }
                }
            }

            #endregion

            #region FLUJO DE OBTENCION DE LOTES

            LogManager.Record($"REQUESTING LOTES DATA");

            CLContext<List<BatchsForNC>> oClContextLotes = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBCLotes = GetUserCtxODBC("ODBC_GetLotesForNC");
                LogManager.Record($"RESOURCE: {contextODBCLotes.Resource}");

                List<BatchsForNC> resultListLotes = Common.ResolveSAPViewODBC<BatchsForNC>(contextODBCLotes,
                    new Dictionary<string, object>()
                    {
                        { "@DocEntry", _DocEntry }
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContextLotes = new CLContext<List<BatchsForNC>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BatchsForNC>>()
                    {
                        Data = resultListLotes
                    },
                    value = resultListLotes
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                FilterInvoice filterLotes = new FilterInvoice
                {
                    DocEntry = _DocEntry
                };

                SLRequestObject requestModelLotes = GetUserCtx("SL_GetLotesForNC").Get<FilterInvoice>(filterLotes);

                LogManager.Record($"RESOURCE: {requestModelLotes.Url_Request}");

                oClContextLotes = await requestModelLotes.SendAsync<List<BatchsForNC>>();

                #endregion
            }

            //Se setean los lotes
            if (oClContextLotes.Response.Data != null && oClContextLotes.Response.Data.Count > 0)
            {
                foreach (ARInvoiceRows row in oClContext.Response.Data.DocumentLines)
                {
                    row.BatchNumbers = oClContextLotes.Response?.Data?
                        .Where(_x => _x.ItemCode == row.ItemCode)
                        .Select(_y => new BatchNumbers()
                        {
                            SystemSerialNumber = _y.SysNumber,
                            Quantity = Convert.ToDecimal(_y?.Quantity ?? 0),
                            BatchNumber = _y.DistNumber
                        }).ToList();
                }
            }

            #endregion

            return oClContext;
        }

        #region Approval queries process

        
         /// <summary>
         /// Retrieve the configured approval query conditions 
         /// </summary>
         /// <param name="pDocumentType">Represent the document type for filter the approval query conditions by documents</param>
         /// <param name="pUserId">Represent the current user logged in the application</param>
         /// <param name="pCompanyId">Represent the company of the current user</param>
        private static async Task<List<QueryCondition>> GetApprovalQueryConditions(Constants.DocumentType pDocumentType, int pUserId = -1, int pCompanyId = -1)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            LogManager.Record($"DOCUMENT TYPE: {pDocumentType} | USER ID: {pUserId} | COMPANY ID: {pCompanyId}");

            string userSapLicense = GetUserSapLicense(pUserId);

            LogManager.Record("REQUESTING APPROVAL QUERY CONDITIONS...");

            CLContext<List<QueryCondition>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetApprovalQueryConditions", pUserId, pCompanyId);
                LogManager.Record($"RESOURCE: {ctx.Resource}");
                List<QueryCondition> resultList =
                    Common.ResolveSAPViewODBC<QueryCondition>(
                        ctx,
                        new Dictionary<string, object>{
                            { "@DocType",   (int) pDocumentType },
                            { "@SapLicense", userSapLicense }
                        });
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<QueryCondition>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<QueryCondition>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetApprovalQueryConditions", pUserId, pCompanyId)
                    .Get(new FilterApprovalQuery()
                    {
                        DocType = (int)pDocumentType,
                        SapLicense = userSapLicense
                    });
                LogManager.Record($"RESOURCE: {req.Url_Request}");
                oClContext = await req.SendAsync<List<QueryCondition>>();
                LogManager.Record("REQUEST COMPLETED");
            }

            if (oClContext.Response?.Data is null || !oClContext.Response.Data.Any())
            {
                LogManager.Record("NO QUERY CONDITIONS WAS RETRIEVED");
                
                return new List<QueryCondition>();
            }
            
            LogManager.Record($"APPROVAL QUERY CONDITIONS RETRIEVED...");

            return oClContext.Response.Data;
        }

        /// <summary>
        /// Retrieve the specified user SAP license
        /// </summary>
        /// <param name="pUserId">Identification of the user to retrieve the SAP license</param>
        private static string GetUserSapLicense(int pUserId)
        {
            LogManager.Record("REQUESTING USER LICENSE...");
            
            CLContext<CLLicense> oClLicenseContext =
                Services.Execute<CLLicense, MainDBContext, int, ICLSingle>(
                    "GetLicenseByUser",
                    pUserId).Get();

            string userSapLicense =
                oClLicenseContext.Response.Data.User.Substring(oClLicenseContext.Response.Data.User.LastIndexOf('\\') +
                                                               1);
            
            LogManager.Record($"USER LICENSE RETRIEVED | LICENSE: {userSapLicense}");

            return userSapLicense;
        }

        /// <summary>
        /// Filter the query conditions based on the approval query filters defined 
        /// </summary>
        /// <param name="pQueryConditions">All query conditions retrieved</param>
        /// <param name="_pSalesDocument">Current document where the conditions will be validated</param>
        private static List<QueryCondition> FilterQueryConditions(List<QueryCondition> pQueryConditions, object _pSalesDocument)
        {
            LogManager.Record("START PROCESS FOR FILTER QUERY CONDITIONS");

            LogManager.Record("RETRIEVING APPROVAL QUERY FILTER CONDITIONS SETTING...");
            
            CLContext<List<ApprovalQueriesFilterCondition>> clContextApprovalQueriesFilterConditions = GetSettingByCode<List<ApprovalQueriesFilterCondition>>(SettingsEnum.ApprovalQueriesFilterConditions);
            
            List<ApprovalQueriesFilterCondition> approvalQueriesFilterConditions =
                clContextApprovalQueriesFilterConditions.Response.Data;

            if (approvalQueriesFilterConditions is null)
            {
                LogManager.Record("NO APPROVAL QUERY FILTER CONDITIONS WAS FOUND");
                
                return pQueryConditions;
            }

            LogManager.Record(
                $"APPROVAL QUERY FILTER CONDITIONS SETTING RETRIEVED | CONDITIONS: {JsonConvert.SerializeObject(approvalQueriesFilterConditions)}");

            IEnumerable<IGrouping<string, QueryCondition>> groupedQueriesConditions = pQueryConditions.GroupBy(qc => qc.Condition);

            List<QueryCondition> queriesConditionsFiltered = new List<QueryCondition>();
            
            LogManager.Record("APPLYING FILTER CONDITIONS...");
            
            foreach (IGrouping<string, QueryCondition> queryConditionGroup in groupedQueriesConditions)
            {
                ApprovalQueriesFilterCondition filterCondition =
                    approvalQueriesFilterConditions.Find((qfc => qfc.QueryConditionName == queryConditionGroup.Key));

                if (filterCondition is null)
                {
                    queriesConditionsFiltered.AddRange(queryConditionGroup);

                    continue;
                }
                
                List<QueryCondition> filteredQueryConditions = queryConditionGroup.ToList();
                
                foreach (var condition in filterCondition.Conditions)
                {

                    object documentPropertyValue = GetFirstPropertyValueByName(_pSalesDocument, condition.DocumentPropertyName); 

                    if (documentPropertyValue is null)
                    {
                        LogManager.Record($"The property \"{condition.DocumentPropertyName}\" for query condition \"{queryConditionGroup.Key}\" was not found.");

                        continue;
                    }

                    string strDocumentPropertyValue = documentPropertyValue.ToString();

                    double.TryParse(strDocumentPropertyValue, out double dblDocumentPropertyValue);
                    
                    switch (condition.ConditionType)
                    {
                        case ApprovalQueriesFilterConditionType.Different:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => !qc.FilterBy.Equals(strDocumentPropertyValue)).ToList();
                            break;
                        case ApprovalQueriesFilterConditionType.Equality:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => qc.FilterBy.Equals(strDocumentPropertyValue)).ToList();
                            break;
                        case ApprovalQueriesFilterConditionType.GreaterThan:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => Convert.ToDouble(qc.FilterBy) < dblDocumentPropertyValue).ToList();
                            break;
                        case ApprovalQueriesFilterConditionType.LessThan:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => Convert.ToDouble(qc.FilterBy) > dblDocumentPropertyValue).ToList();
                            break;
                        case ApprovalQueriesFilterConditionType.GreaterOrEqual:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => Convert.ToDouble(qc.FilterBy) <= dblDocumentPropertyValue).ToList();
                            break;
                        case ApprovalQueriesFilterConditionType.LessOrEqual:
                            filteredQueryConditions = filteredQueryConditions.Where(qc => Convert.ToDouble(qc.FilterBy) >= dblDocumentPropertyValue).ToList();
                            break;
                    }
                }
                
                queriesConditionsFiltered.AddRange(filteredQueryConditions);
            }

            LogManager.Record("FILTER CONDITIONS APPLIED");
            
            return queriesConditionsFiltered;
        }


        /// <summary>
        /// Start the validations of the approval queries conditions
        /// </summary>
        /// <param name="pDocument">Current document where the approval queries conditions will be validated</param>
        /// <param name="pDocumentType">Indicates what type of document is the current document</param>
        /// <param name="pUserId">Represent the current user identification</param>
        /// <param name="pCompanyId">Represent the current user company identification</param>
        /// <returns>If do not need to apply the authorization process returns false, otherwise returns true</returns>
        private static async Task<QueryConditionApply> StartQueryConditionsValidations(object pDocument, Constants.DocumentType pDocumentType, int pUserId = -1, int pCompanyId = -1)
        {
            List<QueryCondition> queryConditions = await GetApprovalQueryConditions(pDocumentType, pUserId, pCompanyId);

            queryConditions = FilterQueryConditions(queryConditions, pDocument);
            
            foreach (QueryCondition condition in queryConditions)
            {
                ApprovalQueriesConditionsResults approvalQueryConditionResult = ValidateQueryCondition(condition, pDocument);

                switch (approvalQueryConditionResult)
                {
                    case ApprovalQueriesConditionsResults.ApplyAuthorizationProcess:
                        return new QueryConditionApply()
                        {
                           IsApply = true,
                           QueryCondition = condition
                        };
                    case ApprovalQueriesConditionsResults.CheckNextCondition:
                        continue;
                    case ApprovalQueriesConditionsResults.IgnoreNextConditions:
                        return new QueryConditionApply()
                        {
                            IsApply = false,
                            QueryCondition = condition
                        };
                }
            }

            return new QueryConditionApply()
            {
                IsApply = false,
            };
        }

        /// <summary>
        /// Send the approval query and document information to the database to be validated
        /// </summary>
        /// <param name="pQueryCondition">Represent the current approval query condition that will be validated</param>
        /// <param name="pDocument">Represent the current document where the approval query condition will be validated</param>
        private static ApprovalQueriesConditionsResults ValidateQueryCondition(QueryCondition pQueryCondition, object pDocument)
        {
            try
            {
                List<OdbcParameter> odbcParameters = GenerateParametersToValidateQueryCondition(pDocument, pQueryCondition);

                LogManager.Record($"VALIDATING QUERY CONDITION... | NAME: {pQueryCondition.Condition}");

                MainDBContext mainDbContextInstance = new MainDBContext();

                string query = BuildDatabaseQuerySentenceForValidateQueryCondition(odbcParameters, mainDbContextInstance);

                LogManager.Record($"QUERY TO EXECUTE: {query}");

                Common.SingleValue<ApprovalQueriesConditionsResults> result = CL.DB.Core.GetSet<Common.SingleValue<ApprovalQueriesConditionsResults>, MainDBContext, ICLSingle>(
                    mainDbContextInstance,
                    query, 
                    odbcParameters);

                LogManager.Record(
                    $"QUERY CONDITION VALIDATED | NAME: {pQueryCondition.Condition} | RESULT {result?.Value}");

                return result?.Value ?? new ApprovalQueriesConditionsResults();
            }
            catch (Exception e)
            {
                LogManager.Record($"AN ERROR OCCURS TRYING TO VALIDATE THE QUERY CONDITION \"{pQueryCondition.Condition}\". DETAILS: {e.Message}");

                throw;
            }
        }

        /// <summary>
        /// Build the query to execute in the application database to validate the query conditions
        /// </summary>
        /// <param name="pParameters">List of parameters that will be send to the stored procedure</param>
        /// <param name="pContext">A database context instance</param>
        private static string BuildDatabaseQuerySentenceForValidateQueryCondition(List<OdbcParameter> pParameters, MainDBContext pContext)
        {
            string databaseObjectName =
                CL.DB.Core.GetDBResource("ValidateApprovalQueryCondition", pContext);

            List<string> namedParameters = new List<string>();

            LogManager.Record($"BUILD DATABASE QUERY SENTENCE FOR VALIDATE QUERY CONDITION... PARAMETERS: {JsonConvert.SerializeObject(pParameters)}");

            foreach (OdbcParameter parameter in pParameters)
            {
                
                string formattedParam = parameter.DbType == DbType.String ? $"N'{parameter.Value}'" : $"{parameter.Value}";
                    
                namedParameters.Add($"{parameter.ParameterName} = {formattedParam}");
            }
            LogManager.Record($"RESULT OF PARAMETERS FOR THE EXECUTION OF STORED PROCEDURE... RESULT: {JsonConvert.SerializeObject(namedParameters)}");

            return $"EXEC dbo.{databaseObjectName} {string.Join(",", namedParameters)}";
        }

        /// <summary>
        /// Generate the parameters that will be send to the stored procedure that validate the approval queries conditions
        /// </summary>
        /// <param name="pDocument">Current document to subtract the properties that will be validated</param>
        /// <param name="pQueryCondition">Current approval query condition that will be validated</param>
        private static List<OdbcParameter> GenerateParametersToValidateQueryCondition(object pDocument, QueryCondition pQueryCondition)
        {
            LogManager.Record("ADDING PARAMETERS TO SEND TO APPLICATION DATABASE OBJECT FOR APPROVAL QUERIES...");
            LogManager.Record($"DOCUMENT: {JsonConvert.SerializeObject(pDocument)}");
            LogManager.Record($"QUERYCONDITION: {JsonConvert.SerializeObject(pQueryCondition)}");

            List<OdbcParameter> odbcParameters = new List<OdbcParameter>();

            CLContext<List<string>> clContextDocumentPropertiesToSend = GetSettingByCode<List<string>>(SettingsEnum.ApprovalQueriesDocumentProperties);

            if (clContextDocumentPropertiesToSend.Response?.Data is null || !clContextDocumentPropertiesToSend.Response.Data.Any())
            {
                LogManager.Record($"NO DOCUMENT PROPERTIES WAS RETRIEVED FROM \"{SettingsEnum.ApprovalQueriesDocumentProperties}\" SETTING.");
            }
            else
            {

                AddOdbcParametersFromDocument(pDocument, clContextDocumentPropertiesToSend.Response.Data, odbcParameters);
            }

            odbcParameters.Add(new OdbcParameter($"@{pQueryCondition.Condition}", (object)pQueryCondition.Value ?? DBNull.Value));

            LogManager.Record($"PARAMETERS ADDED");

            return odbcParameters;
        }

        /// <summary>
        /// Recursively traverses an object and its nested properties (including collections)
        /// to extract the values of specified property names and adds them as ODBC parameters.
        /// </summary>
        /// <param name="document">The root object to inspect for property values.</param>
        /// <param name="propertyNames">A list of property names to extract values for.</param>
        /// <param name="odbcParameters">The list where discovered OdbcParameters will be added.</param>
        /// <param name="isArray">
        /// Indicates whether the current context is within a collection, which affects how multiple values are merged.
        /// If true, the value is concatenated with commas for repeated parameters.
        /// </param>
        /// <param name="visited">
        /// A set used to track already visited objects to prevent infinite recursion in case of circular references.
        /// Should be null on the first call; the method will initialize it internally.
        /// </param>
        private static void AddOdbcParametersFromDocument(object document, List<string> propertyNames, List<OdbcParameter> odbcParameters, bool isArray = false,
            HashSet<object> visited = null)
        {
            if (document == null || propertyNames == null || !propertyNames.Any())
                return;

            visited = visited  ?? new HashSet<object>();

            // Avoid infinite recursion by skipping already visited objects
            if (visited.Contains(document)) return;
            visited.Add(document);

            List<PropertyInfo> documentProperties = document.GetType().GetProperties().ToList();

            foreach (string configuredPropertyName in propertyNames)
            {
                PropertyInfo documentProperty = null;

                if (configuredPropertyName.StartsWith("U_") && documentProperties.Any(p => p.Name == "Name") && documentProperties.Any(p => p.Name == "Value"))
                {
                    string udfName = documentProperties.FirstOrDefault(p => p.Name == "Name").GetValue(document)?.ToString();

                    if (udfName == configuredPropertyName)
                    {
                        documentProperty = documentProperties.FirstOrDefault(p => p.Name == "Value");
                        isArray = false;
                    }
                }
                else
                {
                    documentProperty = documentProperties
                        .FirstOrDefault(p => p.Name == configuredPropertyName);
                }

                if (documentProperty != null)
                {
                    // Property exists at this level
                    object value = documentProperty.GetValue(document);

                    if (isArray)
                    {
                        // Combine values for array entries under the same parameter name
                        var existingParam = odbcParameters
                            .Find(p => p.ParameterName.Equals($"@{configuredPropertyName}"));
                        if (existingParam != null)
                        {
                            existingParam.Value += "," + value;
                        }
                        else
                        {
                            odbcParameters.Add(new OdbcParameter($"@{configuredPropertyName}", value ?? DBNull.Value));
                        }
                    }
                    else
                    {
                        // Add parameter if not already present
                        if (!odbcParameters.Any(p => p.ParameterName.Equals($"@{configuredPropertyName}")))
                        {
                            odbcParameters.Add(new OdbcParameter($"@{configuredPropertyName}", value ?? DBNull.Value));
                        }
                    }
                }
                else
                {
                    // Property not found at current level — search in nested objects and collections
                    foreach (PropertyInfo property in documentProperties)
                    {
                        if (property.PropertyType == typeof(string) || property.PropertyType.IsPrimitive)
                            continue;

                        var value = property.GetValue(document);
                        if (value == null) continue;

                        if (typeof(IEnumerable).IsAssignableFrom(property.PropertyType) && property.PropertyType != typeof(string))
                        {
                            // Recurse through each item in the collection
                            if (value is IEnumerable list)
                            {
                                foreach (var item in list)
                                {
                                    AddOdbcParametersFromDocument(item, new List<string> { configuredPropertyName }, odbcParameters, true);
                                }
                            }
                        }
                        else if (!property.PropertyType.IsEnum && !property.PropertyType.IsValueType)
                        {
                            // Recurse into complex object
                            AddOdbcParametersFromDocument(value, propertyNames, odbcParameters, false, visited);
                        }
                    }
                }
            }
        }

        /// <summary>
        /// Recursively searches through an object and its nested properties to find the first occurrence 
        /// of a property by name and returns its value.
        /// </summary>
        /// <param name="document">The root object to search through.</param>
        /// <param name="targetPropertyName">The name of the property to find.</param>
        /// <param name="visited">
        /// A set of already visited objects to prevent infinite loops in case of circular references. 
        /// This should be null on the initial call.
        /// </param>
        /// <returns>
        /// The value of the first property that matches <paramref name="targetPropertyName"/>, 
        /// or null if not found.
        /// </returns>
        private static object GetFirstPropertyValueByName(object document, string targetPropertyName, HashSet<object> visited = null)
        {
            if (document == null || string.IsNullOrWhiteSpace(targetPropertyName))
                return null;

            visited = visited ?? new HashSet<object>();

            // Prevent infinite recursion due to circular references
            if (visited.Contains(document)) return null;
            visited.Add(document);


            List<PropertyInfo> properties = document.GetType().GetProperties().ToList();

            PropertyInfo documentProperty = null;

            if (targetPropertyName.StartsWith("U_") && properties.Any(p => p.Name == "Name") && properties.Any(p => p.Name == "Value"))
            {
                string udfName = properties.FirstOrDefault(p => p.Name == "Name").GetValue(document)?.ToString();

                if (udfName == targetPropertyName)
                {
                    documentProperty = properties.FirstOrDefault(p => p.Name == "Value");
                }
            }
            else
            {
                documentProperty = properties
                    .FirstOrDefault(p => p.Name == targetPropertyName);
            }

            if (documentProperty != null) return documentProperty.GetValue(document);


            // Then search recursively in nested properties
            foreach (PropertyInfo prop in properties)
            {
                var type = prop.PropertyType;

                // Skip primitive types, enums, strings, and value types
                if (type == typeof(string) || type.IsPrimitive || type.IsEnum || type.IsValueType)
                    continue;

                var value = prop.GetValue(document);
                if (value == null) continue;

                // Handle collections
                if (typeof(IEnumerable).IsAssignableFrom(type) && type != typeof(string))
                {
                    foreach (var item in (IEnumerable)value)
                    {
                        var result = GetFirstPropertyValueByName(item, targetPropertyName, visited);
                        if (result != null)
                            return result;
                    }
                }
                // Handle complex objects
                else
                {
                    var result = GetFirstPropertyValueByName(value, targetPropertyName, visited);
                    if (result != null)
                        return result;
                }
            }

            return null;
        }
        #endregion

        /// <summary>
        /// Map the invoice down payments
        /// </summary>
        /// <param name="pArInvoice">Invoice document</param>
        /// <returns>An invoice document with the mapped down payments</returns>
        private static JObject MapDownPayments(JObject pArInvoice)
        {
            JToken downPaymentsToken = pArInvoice.Property("DownPaymentsToDraw")?.Value<JToken>();

            if (downPaymentsToken != null && downPaymentsToken.Any())
            {
                JArray JDownPaymentsToDraw = pArInvoice.GetValue("DownPaymentsToDraw") as JArray;

                if (JDownPaymentsToDraw != null && JDownPaymentsToDraw.Any())
                {
                    foreach (JObject downPayment in JDownPaymentsToDraw)
                    {
                        decimal grossAmountToDraw = downPayment.GetValue("GrossAmountToDraw").ToObject<decimal>();

                        if (grossAmountToDraw == 0)
                        {
                            downPayment.Property("GrossAmountToDraw")?.Remove();
                        }
                        else
                        {
                            downPayment.Property("GrossAmountToDrawFC")?.Remove();
                        }
                    }
                }
                
                pArInvoice.Property("DownPaymentsToDraw")?.Replace(new JProperty("DownPaymentsToDraw", JDownPaymentsToDraw));
            }

            return pArInvoice;
        }

        /// <summary>
        /// Set the customer address information if the should set the customer address information
        /// </summary>
        /// <param name="pSalesDocument">Document information</param>
        /// <param name="pUserId">Current user ID</param>
        /// <param name="pCompanyId">Current company ID</param>
        /// <returns>A serialized sales document with the customer address information</returns>
        private static async Task<string> AddCustomerAddressInformation(JObject pSalesDocument, int pUserId, int pCompanyId)
        {
            LogManager.Record("RETRIEVING INVOICE FIELDS CONFIGURATION...");
            
            List<SettingFieldsInvoice> oCompaniesFieldsInvoices =
                GetSettingByCode<List<SettingFieldsInvoice>>(SettingCode.FieldsInvoice).Response.Data;

            int oCompanyId = pCompanyId == -1 ? GetCompanyId() : pCompanyId;

            LogManager.Record($"FILTERING SETTING VALUES BY COMPANY ID... | COMPANY ID: {pCompanyId}");
            
            SettingFieldsInvoice settingFieldsInvoice =
                oCompaniesFieldsInvoices.FirstOrDefault(_tf => _tf.CompanyId == oCompanyId);

            LogManager.Record($"SETTING VALUE: {JsonConvert.SerializeObject(settingFieldsInvoice)}");
            
            if (settingFieldsInvoice != null && settingFieldsInvoice.SetAddressBusinessPartner)
            {
                LogManager.Record("RETRIEVING CUSTOMER INFORMATION...");

                string cardCode = pSalesDocument.GetValue("CardCode").ToObject<string>();
                
                CLContext<BusinessPartners> oClContextCustomer =
                    await GetBusinessPartner(cardCode, pUserId, pCompanyId);

                LogManager.Record($"CUSTOMER INFORMATION: {JsonConvert.SerializeObject(oClContextCustomer.Response.Data)}");
                
                if (oClContextCustomer.Response.Data is object)
                {
                    pSalesDocument.Add("U_BR_IDB", oClContextCustomer.Response.Data.Barrio);
                    
                    pSalesDocument.Add("U_CAN_IDB", oClContextCustomer.Response.Data.Canton);
                    
                    pSalesDocument.Add("U_DT_IDB", oClContextCustomer.Response.Data.Distrito);
                    
                    pSalesDocument.Add("U_PROV_IDB", oClContextCustomer.Response.Data.Provincia);
                }
            }

            return JsonConvert.SerializeObject(pSalesDocument,
                new JsonSerializerSettings { DateTimeZoneHandling = DateTimeZoneHandling.Local });
        }
        
        /// <summary>
        /// This method is used to create invoice document
        /// </summary>
        /// <param name="pArInvoice">model invoice document</param>
        /// <param name="pUserId">current user id</param>
        /// <param name="pCompanyId">current company id</param>
        /// <returns></returns>
        /// <exception cref="CLException">generate exception</exception>
        public static async Task<CLContext<ARInvoice>> PostInvoices(ARInvoiceWithPayment _invoice, DocumentAttachment pAttachment,
            IEnumerable<HttpPostedFile> pAttachmentFiles, int pUserId = -1,int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;

            ARInvoice pArInvoice = _invoice.ARInvoice;


            CLContext<ARInvoice> existingDocumentInformationResponse =
                await CheckIfDocumentExistByDocumentKey(pArInvoice, SapDocumenType.ArInvoice, pUserId, pCompanyId);
        
            if (existingDocumentInformationResponse != null)
            {
                return existingDocumentInformationResponse;
            }

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(pAttachment, pAttachmentFiles);
            pArInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            Constants.DocumentType invoiceType = pArInvoice.Udfs.Find(_udf => _udf.Name == "U_TipoDocE")?.Value == "FE"
                ? Constants.DocumentType.InvoicesFE
                : Constants.DocumentType.InvoicesTE;

            //Si tiene asignada una serie corresponde a un doc offline el cual se le asignada desde movil, esta seria offline 
            if (pArInvoice.Series > 0)
            {
                 pArInvoice.HandWritten = BoYesNo.TYES;
            }
            else
            {
                SetConfiguredSeriesToDocument(pArInvoice, invoiceType, userId, pCompanyId);
            }

            CLContext<ARInvoice> slResponse =
                await CheckIfDocumentComesFromDraft(pArInvoice, SapDocumenType.ArInvoice, userId, pCompanyId);
        
            if (slResponse != null)
            {
                return slResponse;
            }

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_invoice, Constants.DocumentType.InvoicesFE, userId, pCompanyId);
              
            if (queryConditionApply.IsApply)
            {
                pArInvoice.DocObjectCode = ((int)Constants.DocumentType.InvoicesFE).ToString();
        
                pArInvoice.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });
        
                slResponse = await PostDraft(pArInvoice, userId, pCompanyId);

            }
            else
            {
                SLRequestObject requestModel = BuildSalesDocumentSLRequestObject(Constants.DocumentType.InvoicesFE, true, pArInvoice, "PostInvoice", userId, pCompanyId, true);
                
                requestModel.Content = await AddCustomerAddressInformation(MapDownPayments(JsonConvert.DeserializeObject<JObject>(requestModel.Content)), userId, pCompanyId);
                
                slResponse = await requestModel.SendAsync<ARInvoice>();
            }

            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                return await ValidateAndNotifyAuthorization(pArInvoice, SapDocumenType.ArInvoice, queryConditionApply,
                    pUserId, pCompanyId);
            }

            return slResponse;
        }

        public static async Task<CLContext<ARInvoiceWithPayment>> PostInvoicesWithPayment(
            ARInvoiceWithPayment _arInvoiceWithPayment,DocumentAttachment _attachment,IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1, string _userEmail = "")
        {
            CLContext<ARInvoice> arInvoiceContext =
                await PostInvoices(_arInvoiceWithPayment ,_attachment,_attachmentFiles, _userId, _companyId);

            ARInvoiceWithPayment arInvoiceWithPayment = null;

            // If the invoice has an authorization process, we don't need create the payment
            if (arInvoiceContext.Response.Data is object && arInvoiceContext.Response.Data.ConfirmationEntry != 0)
            {
                arInvoiceWithPayment = new ARInvoiceWithPayment()
                {
                    ARInvoice = arInvoiceContext.Response.Data,
                    IncomingPayment = null
                };

                return new CLContext<ARInvoiceWithPayment>()
                {
                    Code = arInvoiceContext.Code,
                    Response = new Response<ARInvoiceWithPayment>()
                    {
                        Data = arInvoiceWithPayment
                    },
                    value = arInvoiceWithPayment
                };
            }

            if (arInvoiceContext.Response != null)
            {
                _arInvoiceWithPayment.IncomingPayment.PaymentInvoices[0].DocEntry =
                    arInvoiceContext.Response.Data.DocEntry;

                CLContext<IncomingPayment> incomingPaymentContext =
                    await PostIncomingPayments(_arInvoiceWithPayment.IncomingPayment, _userId, _companyId, _userEmail);

                if (incomingPaymentContext.Response != null)
                {
                    arInvoiceWithPayment = new ARInvoiceWithPayment()
                    {
                        ARInvoice = arInvoiceContext.Response.Data,
                        IncomingPayment = incomingPaymentContext.Response.Data
                    };

                    return new CLContext<ARInvoiceWithPayment>()
                    {
                        Code = incomingPaymentContext.Code,
                        Response = new Response<ARInvoiceWithPayment>()
                        {
                            Data = arInvoiceWithPayment
                        },
                        value = arInvoiceWithPayment
                    };
                }

                arInvoiceWithPayment = new ARInvoiceWithPayment()
                {
                    ARInvoice = arInvoiceContext.Response.Data,
                    IncomingPayment = incomingPaymentContext.Response.Data
                };

                return new CLContext<ARInvoiceWithPayment>()
                {
                    Code = incomingPaymentContext.Code,
                    Response = new Response<ARInvoiceWithPayment>()
                    {
                        Data = arInvoiceWithPayment
                    },
                    value = arInvoiceWithPayment
                };
            }

            return new CLContext<ARInvoiceWithPayment>()
            {
                Code = arInvoiceContext.Code,
                Response = new Response<ARInvoiceWithPayment>()
                {
                    Data = arInvoiceWithPayment
                },
                value = arInvoiceWithPayment
            };
        }

        /// <summary>
        /// Reserves invoices along with payment information in the system.
        /// </summary>
        /// <param name="_arInvoiceWithPayment">Object containing invoice and payment information.</param>
        /// <param name="_attachment">Attachment file related to the invoice or payment.</param>
        /// <param name="_attachmentFiles">Collection of attached files for the invoice or payment.</param>
        /// <param name="_userId">ID of the user performing the operation (default is -1).</param>
        /// <param name="_companyId">ID of the company to which the invoice belongs (default is -1).</param>
        /// <param name="_userEmail">Email of the user performing the operation.</param>
        /// <returns>A Task object representing the asynchronous operation, returning a context with invoice and payment information.</returns>
        public static async Task<CLContext<ARInvoiceWithPayment>> PostReserveInvoicesWithPayment(
            ARInvoiceWithPayment _arInvoiceWithPayment,DocumentAttachment _attachment,IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1, string _userEmail = "")
        {
            CLContext<ARInvoice> arInvoiceContext =
                await PostInvoices(_arInvoiceWithPayment,_attachment,_attachmentFiles, _userId, _companyId);

            ARInvoiceWithPayment arInvoiceWithPayment = null;

            // If the invoice has an authorization process, we don't need create the payment
            if (arInvoiceContext.Response.Data is object && arInvoiceContext.Response.Data.ConfirmationEntry != 0)
            {
                arInvoiceWithPayment = new ARInvoiceWithPayment()
                {
                    ARInvoice = arInvoiceContext.Response.Data,
                    IncomingPayment = null
                };

                return new CLContext<ARInvoiceWithPayment>()
                {
                    Code = arInvoiceContext.Code,
                    Response = new Response<ARInvoiceWithPayment>()
                    {
                        Data = arInvoiceWithPayment
                    },
                    value = arInvoiceWithPayment
                };
            }

            if (arInvoiceContext.Response != null)
            {
                _arInvoiceWithPayment.IncomingPayment.PaymentInvoices[0].DocEntry =
                    arInvoiceContext.Response.Data.DocEntry;

                CLContext<IncomingPayment> incomingPaymentContext =
                    await PostIncomingPayments(_arInvoiceWithPayment.IncomingPayment, _userId, _companyId, _userEmail);

                if (incomingPaymentContext.Response != null)
                {
                    arInvoiceWithPayment = new ARInvoiceWithPayment()
                    {
                        ARInvoice = arInvoiceContext.Response.Data,
                        IncomingPayment = incomingPaymentContext.Response.Data
                    };

                    return new CLContext<ARInvoiceWithPayment>()
                    {
                        Code = incomingPaymentContext.Code,
                        Response = new Response<ARInvoiceWithPayment>()
                        {
                            Data = arInvoiceWithPayment
                        },
                        value = arInvoiceWithPayment
                    };
                }

                arInvoiceWithPayment = new ARInvoiceWithPayment()
                {
                    ARInvoice = arInvoiceContext.Response.Data,
                    IncomingPayment = incomingPaymentContext.Response.Data
                };

                return new CLContext<ARInvoiceWithPayment>()
                {
                    Code = incomingPaymentContext.Code,
                    Response = new Response<ARInvoiceWithPayment>()
                    {
                        Data = arInvoiceWithPayment
                    },
                    value = arInvoiceWithPayment
                };
            }

            return new CLContext<ARInvoiceWithPayment>()
            {
                Code = arInvoiceContext.Code,
                Response = new Response<ARInvoiceWithPayment>()
                {
                    Data = arInvoiceWithPayment
                },
                value = arInvoiceWithPayment
            };
        }
        
        /// <summary>
        /// Retrieves document information by document entry, optionally filtered by user, company, and document type.
        /// </summary>
        /// <param name="_docEntry">Document entry identifier.</param>
        /// <param name="_userId">User identifier (optional, default -1).</param>
        /// <param name="_companyId">Company identifier (optional, default -1).</param>
        /// <param name="_tipoDoc">Document type filter (optional).</param>
        /// <returns>A <see cref="CLContext{DocInfo}"/> with the document information.</returns>
        public static async Task<CLContext<DocInfo>> GetDocInfoByDocEntry(int _docEntry, int _userId = -1, int _companyId = -1, string _tipoDoc = null)
        {
            LogManager.Record($"REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetNumFEOnline", _userId, _companyId);

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocEntry", _docEntry },
                    { "@TipoDoc", _tipoDoc ?? "" }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<DocInfo> resultList = Common.ResolveSAPViewODBC<DocInfo>(contextODBC, parametersODBC);

                DocInfo result = resultList.FirstOrDefault();

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<DocInfo>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<DocInfo>() { Data = result },
                    value = result
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterBaseDocEntryAndTipoDoc filter = new FilterBaseDocEntryAndTipoDoc()
                {
                    DocEntry = _docEntry,
                    TipoDoc = _tipoDoc
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetNumFEOnline", _userId, _companyId).Get<FilterBaseDocEntryAndTipoDoc>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<DocInfo>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves the list of open invoices available for payment received filtering by card code, document currency, and date range.
        /// </summary>
        /// <param name="_cardCode">Customer or business partner code.</param>
        /// <param name="_docCurrency">Document currency code.</param>
        /// <param name="_dateInit">Start date of the filter range (string format).</param>
        /// <param name="_dateEnd">End date of the filter range (string format).</param>
        /// <returns>A CLContext containing a list of open invoices for payment received.</returns>
        public static async Task<CLContext<List<InvoiceOpen>>> GetInvoiceOpenForPayReceived(string _cardCode, string _docCurrency, string _dateInit, string _dateEnd)
        {
            LogManager.Record("REQUESTING OPEN INVOICES RECORDS");
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInvoiceOpenForPayReceived");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<InvoiceOpen> resultList = Common.ResolveSAPViewODBC<InvoiceOpen>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@CardCode", $"{_cardCode}"},
                        {"@DocCurrency", $"{_docCurrency}"},
                        {"@DateInit", $"{_dateInit}"},
                        {"@DateEnd", $"{_dateEnd}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<InvoiceOpen>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<InvoiceOpen>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetInvoiceOpenForPayReceived").Get(new FilterInvoiceOpenForPayReceived()
                {
                    CardCode = _cardCode,
                    DocCurrency = _docCurrency,
                    DateInit = _dateInit,
                    DateEnd = _dateEnd

                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<InvoiceOpen>>();
                #endregion
            }
        }

        /// <summary>
        /// Retrieves open invoices for internal reconciliation filtered by BP, currency, and date range.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_cardCode">Business partner code filter.</param>
        /// <param name="_docCurrency">Document currency filter.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{InvoiceOpen}"/>.
        /// </returns>
        public static async Task<CLContext<List<InvoiceOpen>>> GetInvoiceForInternalReconciliation(
            string _cardCode,
            string _docCurrency,
            string _dateInit,
            string _dateEnd){
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetInvoiceForInternalReconciliation");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@CardCode", _cardCode ?? "" },
                    { "@DocCurrency", _docCurrency ?? "" },
                    { "@DateInit", _dateInit ?? "" },
                    { "@DateEnd", _dateEnd ?? "" }
                };

                List<InvoiceOpen> resultList =
                     Common.ResolveSAPViewODBC<InvoiceOpen>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<InvoiceOpen>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<InvoiceOpen>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterInvoiceOpenForPayReceived filter = new FilterInvoiceOpenForPayReceived
                {
                    CardCode = _cardCode ?? "",
                    DocCurrency = _docCurrency ?? "",
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? ""
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetInvoiceForInternalReconciliation").Get<FilterInvoiceOpenForPayReceived>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<InvoiceOpen>>();

                #endregion
            }
        }

       /// Retrieves document information by document number.
        /// </summary>
        /// <param name="_docNum">The document number to search for.</param>
        /// <param name="_userId">The user ID for the request context. Default is -1 (uses current user).</param>
        /// <param name="_companyId">The company ID for the request context. Default is -1 (uses current company).</param>
        /// <param name="_tipoDoc">The document type to filter by (e.g., "FE" for electronic invoices). Optional.</param>
        /// <returns>
        /// A CLContext containing the document information (DocInfo) matching the specified document number.
        /// </returns>
        public static async Task<CLContext<DocInfo>> GetDocInfoByDocNum(int _docNum, int _userId = -1, int _companyId = -1, string _tipoDoc = null)
        {
            LogManager.Record($"REQUESTING RECORD");

            SLRequestObject requestModel = GetUserCtx("GetNumFEOnlineDocNum", _userId, _companyId).Get(new FilterInvoiceByDocNum()
            {
                DocNum = _docNum,
                TipoDoc = _tipoDoc
            });

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<DocInfo>();
        }

        /// <summary>
        /// Retrieves a list of open credit notes for a specified business partner, currency, and date range.
        /// </summary>
        /// <param name="cardCode">The business partner code.</param>
        /// <param name="docCurrency">The currency of the documents to filter by.</param>
        /// <param name="dateInit">The initial date of the range (inclusive).</param>
        /// <param name="dateEnd">The end date of the range (inclusive).</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a 
        /// <see cref="CLContext{List{ReconciliationCreditMemo}}"/> with the list of matching credit notes.
        /// </returns>
        public static async Task<CLContext<List<ReconciliationCreditMemo>>> GetCreditNotesOpen(string cardCode, string docCurrency, string dateInit, string dateEnd)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ReconciliationCreditMemo>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetCreditNotes");
                List<ReconciliationCreditMemo> resultList =
                    Common.ResolveSAPViewODBC<ReconciliationCreditMemo>(
                        contextODBC,
                        new Dictionary<string, object>
                        {
                            { "@CardCode",    cardCode    },
                            { "@DocCurrency", docCurrency },
                            { "@DateInit",    dateInit    },
                            { "@DateEnd",     dateEnd     }
                        });
                oClContext = new CLContext<List<ReconciliationCreditMemo>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ReconciliationCreditMemo>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetCreditNotes")
                    .Get(new FilterCreditNotesOpen()
                    {
                        CardCode = cardCode,
                        DocCurrency = docCurrency,
                        DateInit = dateInit,
                        DateEnd = dateEnd
                    });
                oClContext = await requestModel.SendAsync<List<ReconciliationCreditMemo>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of credit notes from SAP, filtered by various criteria such as sales employee, date range, document number, status, currency, business partner code, and business partner name.
        /// </summary>
        /// <param name="_slpCode">
        /// The sales employee code to filter the credit notes.
        /// </param>
        /// <param name="_dateInit">
        /// The start date (inclusive) of the date range to filter credit notes, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_dateEnd">
        /// The end date (inclusive) of the date range to filter credit notes, in string format (e.g., "yyyy-MM-dd").
        /// </param>
        /// <param name="_docNum">
        /// The document number to filter the credit notes. Use 0 to ignore this filter.
        /// </param>
        /// <param name="_docStatus">
        /// The document status to filter the credit notes (e.g., "O" for open, "C" for closed).
        /// </param>
        /// <param name="_docCurrency">
        /// The document currency to filter the credit notes (e.g., "USD", "CRC").
        /// </param>
        /// <param name="_cardCode">
        /// The business partner code to filter the credit notes.
        /// </param>
        /// <param name="_cardName">
        /// The business partner name to filter the credit notes.
        /// </param>
        /// <returns>
        /// A <see cref="Task{TResult}"/> representing the asynchronous operation, with a <see cref="CLContext{T}"/> result
        /// containing a list of <see cref="ARCreditMemo"/> objects that match the specified criteria.
        /// </returns>
        /// <remarks>
        /// This method queries the SAP data source for credit notes using the provided filters.
        /// </remarks>
        public static async Task<CLContext<List<ARCreditMemo>>> GetCreditNotes(
            int _slpCode,
            string _dateInit,
            string _dateEnd,
            int _docNum,
            string _docStatus,
            string _docCurrency,
            string _cardCode,
            string _cardName)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetCreditNotesByFilters");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ARCreditMemo> resultList = Common.ResolveSAPViewODBC<ARCreditMemo>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@SlpCode", _slpCode},
                        {"@DateInit", $"{_dateInit ?? ""}"},
                        {"@DateEnd", $"{_dateEnd ?? ""}"},
                        {"@DocNum", _docNum},
                        {"@DocStatus", $"{_docStatus ?? ""}"},
                        {"@DocCurrency", $"{_docCurrency ?? ""}"},
                        {"@CardCode", $"{_cardCode ?? ""}"},
                        {"@CardName", $"{_cardName ?? ""}"}
                    });

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<ARCreditMemo>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ARCreditMemo>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetCreditNotesByFilters").Get(new FilterCreditNotes()
                {
                    SlpCode = _slpCode,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    DocNum = _docNum,
                    DocStatus = _docStatus ?? "",
                    DocCurrency = _docCurrency ?? "",
                    CardCode = _cardCode ?? "",
                    CardName = _cardName ?? ""
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<ARCreditMemo>>();

                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves a credit note based on the provided document entry.
        /// </summary>
        /// <param name="docEntry">The document entry identifier for the credit note to be retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{ARCreditMemo}"/>
        /// object which includes the credit note details and its associated document lines.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found for the specified document entry.</exception>
        public static async Task<CLContext<ARCreditMemo>> GetCreditNote(int docEntry)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<ARCreditMemo> oClContext;
            ARCreditMemo creditNote;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetCreditNotesByDocEntry");
                var list = Common.ResolveSAPViewODBC<ARCreditMemo>(
                    ctx,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
                creditNote = list.FirstOrDefault();
                oClContext = new CLContext<ARCreditMemo>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ARCreditMemo> { Data = creditNote },
                    value = creditNote
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetCreditNotesByDocEntry")
                    .Get(new FilterBaseDocEntry(){ 
                        DocEntry = docEntry 
                    });
                LogManager.Record($"RESOURCE: {req.Url_Request}");
                oClContext = await req.SendAsync<ARCreditMemo>();
                creditNote = oClContext.Response.Data;
            }

            if (oClContext.Response?.Data == null)
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);

            List<ARCreditMemoRows> lines;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctxL = GetUserCtxODBC("ODBC_GetCreditNotesRows");
                lines = Common.ResolveSAPViewODBC<ARCreditMemoRows>(
                    ctxL,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
            }
            else
            {
                SLRequestObject reqL = GetUserCtx("SL_GetCreditNotesRows")
                    .Get(new FilterBaseDocEntry(){ 
                        DocEntry = docEntry 
                    });
                LogManager.Record($"RESOURCE: {reqL.Url_Request}");
                var slL = await reqL.SendAsync<List<ARCreditMemoRows>>();
                lines = slL.Response.Data;
            }

            if (lines != null && lines.Count > 0)
            {
                foreach (var row in lines)
                {
                    if (!string.IsNullOrEmpty(row.WarehouseCode))
                        row.UoMMasterData = await GetUomMasterDataFilter(
                            row.ItemCode, row.WarehouseCode, creditNote.PriceList, "N");
                    row.LinesCurrenciesList = await GetAdditionalCurrencies(
                        row.ItemCode, creditNote.PriceList);
                }
            }

            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();
            oClContext.Response.Data.DocumentLines.AddRange(lines);

            LogManager.Record("REQUEST COMPLETED");
            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of available invoice types from the system.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing an <see cref="IEnumerable{T}"/> of <see cref="TypeInvoice"/> 
        /// representing the available invoice types.
        /// </returns>
        public static CLContext<IEnumerable<TypeInvoice>> GetTypeInvoices()
        {
            LogManager.Record("REQUESTING RECORD");

            CLContext<IEnumerable<TypeInvoice>> oClContext =
                Services.Execute<TypeInvoice, MainDBContext>("GetTypeInvoice").Get();

            LogManager.Record("REQUESTING COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves the list of available currencies from the system, either via ODBC or Service Layer, depending on the connection mode.
        /// </summary>
        /// <param name="_includeAllCurrencies">
        /// If <c>true</c>, includes all currencies in the response. If <c>false</c>, excludes the currency marked as the "All Currencies Symbol" (usually a placeholder like "ALL").
        /// </param>
        /// <returns>
        /// A <see cref="Task{CLContext{List{TypeCurrency}}}"/> containing the response context with the list of currencies.
        /// </returns>
        public static async Task<CLContext<List<TypeCurrency>>> GetCurrencies(bool _includeAllCurrencies)
        {
            LogManager.Record("REQUESTING RECORDS");

            string allCurrenciesSymbol = CL.COMMON.Core.GetConfigKeyValue<string>(System.Reflection.MethodBase.GetCurrentMethod(),
                "AllCurrenciesSymbol");
            
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<TypeCurrency>> oClContext = new CLContext<List<TypeCurrency>>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetCurrencies");

                List<TypeCurrency> resultList = Common.ResolveSAPViewODBC<TypeCurrency>(contextODBC);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                

                oClContext = new CLContext<List<TypeCurrency>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<TypeCurrency>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oRequestObject = GetUserCtx("SL_GetCurrencies").Get();

                LogManager.Record($"RESOURCE: {oRequestObject.Url_Request}");

                oClContext = await oRequestObject.SendAsync<List<TypeCurrency>>();
                
                #endregion
                
            }

            LogManager.Record("REQUEST COMPLETED");

            if (!_includeAllCurrencies)
            {
                oClContext.Response.Data =
                    oClContext.Response.Data.Where(x => x.Symbol != allCurrenciesSymbol).ToList();
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }
        
        private static async System.Threading.Tasks.Task UpdateInvoice<T>(T _data) where T : class, new()
        {
            LogManager.Record("RESQUESTING POS OBJECT");

            SLRequestObject oSlRequestObject = GetUserCtx("PatchInvoice").Patch(_data);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"MODEL: {oSlRequestObject.Content}");

            await oSlRequestObject.SendAsync<T>();

            LogManager.Record("REQUEST COMPLETED");
        }
        
        /// <summary>
        /// Method to create drafts
        /// </summary>
        /// <param name="_arInvoice">Object to create</param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<ARInvoice>> PostInvoicesDrafts(ARInvoice _arInvoice,DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _arInvoice.DocObjectCode = ((int)Constants.DocumentType.InvoicesFE).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _arInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_arInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<ARInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ARInvoice>()
                    {
                        Data = new ARInvoice()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            CLContext<ARInvoice> slResponse = null;
            
            slResponse = await PostDraft<ARInvoice>(_arInvoice);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<ARInvoice> oClContext = await ResolveCreatedDocument<ARInvoice>(slResponse,
                    SapDocumenType.Draft,
                    _arInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;

    
                return oClContext;
            }
            
            return slResponse;
        }
        
        /// <summary>
        /// Method to update drafts
        /// </summary>
        /// <param name="_arInvoice"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<ARInvoice>> PatchInvoicesDrafts(ARInvoice _arInvoice, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");
            _arInvoice.DocObjectCode = ((int)Constants.DocumentType.InvoicesFE).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _arInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<ARInvoice> slResponse = null;
            slResponse = await PatchDraft(_arInvoice);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<ARInvoice> oClContext = await ResolveCreatedDocument<ARInvoice>(slResponse,
                    SapDocumenType.Draft,
                    _arInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
    
                return oClContext;
            }
            
            return slResponse;
        }

        /// <summary>
        /// Updates an existing AR Invoice document by sending a PATCH request,
        /// including optional file attachments and cleaning unnecessary properties from the payload.
        /// </summary>
        /// <param name="_arInvoice">The AR invoice document to be updated.</param>
        /// <param name="_attachment">Metadata related to the attachments to be included.</param>
        /// <param name="_attachmentFiles">List of actual files to be attached to the document.</param>
        /// <returns>
        /// A <see cref="Task"/> that represents the asynchronous operation. The task result contains a 
        /// <see cref="CLContext{ARInvoice}"/> object with the updated invoice data returned by the server.
        /// </returns>
        public static async Task<CLContext<ARInvoice>> PatchInvoice(SalesDocument _arInvoice, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH ARINVOICE OBJECT");

            string oRemoveLineProperties =
                "LineTotal,Udfs,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,LinesCurrenciesList,OnHand,InventoryItem,LineTotal," +
                "HideComp,VATLiable,Freight,IsAServerLine,LineNum,LineStatus,Currency,BaseType,BaseEntry,BaseLine"; 
            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _arInvoice.DocumentLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);

            if (hasClosedLines)
            {
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineNum", "");
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineStatus", "");
            }

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "DocTotal",
                "Udfs",
                "DocEntry",
                "DocNum",
                "DocRate",
                "IdTranRedimir",
                "IdTranAcumular",
                "PriceList",
                "InvoiceNumber",
                "DocStatus",
                "TipoDocE",
                "IdType",
                "Identification",
                "Email",
                "NumFE",
                "ClaveFE",
                "DocTotalFC",
                "DocumentKey",
                "WithTransactionTapp",
                "DocObjectCode",
                "SalesPersonName",
                "Series",
                "HandWritten"
            };

            string headerProperties = string.Join(",", oRemoveHeaderProperties);

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _arInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject requestModel = GetUserCtx("PatchInvoice").Patch(_arInvoice,
                _fieldsToRemoveInLines: oRemoveLineProperties, _fieldsToRemoveInHeaders: headerProperties);

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            requestModel.Headers = headers;

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");


            return await requestModel.SendAsync<ARInvoice>();
        }

        #endregion

        #region Draft
        private static async Task<CLContext<T>> PostDraft<T>(T _draft, int _userId = -1, int _companyId = -1) where T : new()
        {
            LogManager.Record("START CREATING DRAFT PROCESS");
            
            string oHeaderProperties =
                "SalesPersonName,DocTotal,DocEntry,DocNum,DocRate,IdTranRedimir,IdTranAcumular,PriceList,InvoiceNumber,DocStatus,TipoDocE,IdType,Identification,Email,NumFE,ClaveFE,DocTotalFC,DocumentKey,WithTransactionTapp,HandWritten";
            string oLinesProperties =
                "BaseEntry,BaseLine,WhsName,BaseType,LineTotal,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,LinesCurrenciesList,OnHand,InventoryItem,LineTotal,HideComp,VATLiable,Freight,IsAServerLine";
            
            
            SLRequestObject oSlRequestObject = GetUserCtx("PostDraft", _userId, _companyId).Post(_draft, oHeaderProperties, oLinesProperties);
            
            oSlRequestObject.Headers = new ParameterCollection()
            {
                { new KeyValuePair<string, string>("Prefer", "return-no-content") }
            };

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<T>();
        }

        /// <summary>
        /// Sends a cancel request for the specified sales draft via the Service Layer.
        /// </summary>
        /// <param name="docEntry">
        /// The unique document entry of the sales draft to cancel.
        /// </param>
        /// <returns>
        /// A task that returns a <see cref="CLContext{Drafts}"/> containing the canceled draft details.
        /// </returns>
        public static async Task<CLContext<Drafts>> CancelDrafts(int docEntry)
        {
            ClUserContext oClUserContext = GetUserCtx("CancelSalesDrafts");

            SLRequestObject oSlRequestObjectPostCancel = oClUserContext.Post(
                new FilterBaseDocEntry()
                {
                    DocEntry = docEntry
                }
            );

            oSlRequestObjectPostCancel.Url_Request += $"({docEntry})/Cancel";

            return await oSlRequestObjectPostCancel.SendAsync<Drafts>();
        }

        /// <summary>
        /// Retrieves a list of draft documents based on the specified filters.
        /// </summary>
        /// <param name="SlpCode">The salesperson code used to filter the drafts.</param>
        /// <param name="DateInit">The start date for the draft search range.</param>
        /// <param name="DateEnd">The end date for the draft search range.</param>
        /// <param name="DocNum">The document number to filter the drafts.</param>
        /// <param name="DocStatus">The status of the document to filter the drafts.</param>
        /// <param name="DocCurrency">The currency of the document to filter the drafts. Default is an empty string.</param>
        /// <param name="CardCode">The card code to filter the drafts. Default is an empty string.</param>
        /// <param name="CardName">The card name to filter the drafts. Default is an empty string.</param>
        /// <param name="_viewType">The view type to determine the resource for fetching drafts. Default is an empty string.</param>
        /// <param name="ObjType">The object type to filter the drafts. Default is an empty string.</param>
        /// <returns>A task representing the asynchronous operation, containing a context with a list of draft documents.</returns>
        public static async Task<CLContext<List<Drafts>>> GetDrafts(
            int SlpCode,
            string DateInit,
            string DateEnd,
            int DocNum,
            string DocStatus,
            string DocCurrency = "",
            string CardCode = "",
            string CardName = "",
            string viewType = "",
            string ObjType = ""){

            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string resource = viewType == COMMON.ViewType.Purchase
                ? "GetPurchaseDraftsByFilters"
                : "GetDraftsByFilters";

            CLContext<List<Drafts>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_" + resource);
                List<Drafts> resultList = Common.ResolveSAPViewODBC<Drafts>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@SlpCode", SlpCode },
                        { "@DateInit", DateInit ?? "" },
                        { "@DateEnd", DateEnd ?? "" },
                        { "@DocNum", DocNum },
                        { "@DocStatus", DocStatus },
                        { "@DocCurrency", DocCurrency },
                        { "@CardCode", CardCode ?? "" },
                        { "@CardName", CardName ?? "" },
                        { "@ObjType", ObjType ?? "" }
                    });
                oClContext = new CLContext<List<Drafts>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Drafts>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_" + resource)
                    .Get<FilterDrafts>(new FilterDrafts()
                    {
                        SlpCode = SlpCode,
                        DateInit = DateInit ?? "",
                        DateEnd = DateEnd ?? "",
                        DocNum = DocNum,
                        DocStatus = DocStatus,
                        DocCurrency = DocCurrency,
                        CardCode = CardCode ?? "",
                        CardName = CardName ?? "",
                        ObjType = ObjType ?? ""
                    });
                oClContext = await requestModel.SendAsync<List<Drafts>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a draft document by its DocEntry, including its line items and additional UoM and currency details.
        /// Supports both ODBC and Service Layer connections.
        /// </summary>
        /// <param name="docEntry">The unique identifier of the draft document.</param>
        /// <returns>
        /// A task that returns a <see cref="CLContext{Drafts}"/> containing the draft document and its line details.
        /// </returns>
        /// <exception cref="CLException">
        /// Thrown when the draft document is not found.
        /// </exception>
        public static async Task<CLContext<Drafts>> GetDraft(int docEntry)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<Drafts> oClContext;
            Drafts draft;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetDraftsByDocEntry");
                List<Drafts> result = Common.ResolveSAPViewODBC<Drafts>(
                    ctx,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
                draft = result.FirstOrDefault();
                oClContext = new CLContext<Drafts>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<Drafts> { Data = draft },
                    value = draft
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetDraftsByDocEntry")
                    .Get(new FilterBaseDocument(){ 
                        DocEntry = docEntry 
                    });
                LogManager.Record($"RESOURCE: {req.Url_Request}");
                oClContext = await req.SendAsync<Drafts>();
                draft = oClContext.Response.Data;
            }

            if (oClContext == null || oClContext.Response?.Data == null)
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);

            List<DraftsRows> lines;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctxLines = GetUserCtxODBC("ODBC_GetDraftRows");
                lines = Common.ResolveSAPViewODBC<DraftsRows>(
                    ctxLines,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
            }
            else
            {
                SLRequestObject reqLines = GetUserCtx("SL_GetDraftRows")
                    .Get(new FilterBaseDocument(){ 
                        DocEntry = docEntry 
                    });
                LogManager.Record($"RESOURCE: {reqLines.Url_Request}");
                CLContext<List<DraftsRows>> slLinesCtx = await reqLines.SendAsync<List<DraftsRows>>();
                lines = slLinesCtx.Response.Data;
            }

            if (lines != null && lines.Count > 0)
            {
                foreach (var row in lines)
                {
                    if (!string.IsNullOrEmpty(row.WarehouseCode)) {
                        row.UoMMasterData = await GetUomMasterDataFilter(row.ItemCode, row.WarehouseCode, draft.PriceList, "N");
                    }
                        
                    row.LinesCurrenciesList = await GetAdditionalCurrencies(row.ItemCode, draft.PriceList);
                }
            }

            LogManager.Record("REQUEST COMPLETED");
            oClContext.Response.Data.DocumentLines = lines;
            return oClContext;
        }

        /// <summary>
        /// Validates the status of a draft document by document entry.
        /// </summary>
        /// <param name="_docEntry">Document entry identifier.</param>
        /// <param name="_userId">User identifier (optional, default -1).</param>
        /// <param name="_companyId">Company identifier (optional, default -1).</param>
        /// <returns>A <see cref="CLContext{DraftStatus}"/> with the draft status information.</returns>
        public static async Task<CLContext<DraftStatus>> ValidateStatusDraft(int _docEntry, int _userId = -1, int _companyId = -1)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetStatusDraftsByDocEntry", _userId, _companyId);

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocEntry", _docEntry }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<DraftStatus> resultList = Common.ResolveSAPViewODBC<DraftStatus>(contextODBC, parametersODBC);

                DraftStatus result = resultList.FirstOrDefault();

                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<DraftStatus>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<DraftStatus>() { Data = result },
                    value = result
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterDraft filter = new FilterDraft()
                {
                    DocEntry = _docEntry
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetStatusDraftsByDocEntry", _userId, _companyId).Get<FilterDraft>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                return await requestModel.SendAsync<DraftStatus>();

                #endregion
            }
        }
        
        /// <summary>
        /// Method to update draft
        /// </summary>
        /// <param name="_draft"></param>
        /// <typeparam name="T"></typeparam>
        /// <returns></returns>
        private static async Task<CLContext<T>> PatchDraft<T>(T _draft, int _userId = -1, int _companyId = -1) where T : new()
        {
            string oHeaderProperties =
                "DocTotal,Udfs,DocNum,DocRate,IdTranRedimir,IdTranAcumular,PriceList,InvoiceNumber,DocStatus,TipoDocE,IdType,Identification,Email,NumFE,ClaveFE,DocTotalFC,DocumentKey,WithTransactionTapp,Series,ConfirmationEntry,HandWritten";
            string oLinesProperties =
                "LineTotal,Udfs,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,LinesCurrenciesList,OnHand,InventoryItem,LineTotal,BaseType,BaseEntry,WhsName,LineStatus,ItemDescription,BaseLine,HideComp,VATLiable,Freight,IsAServerLine";
            
            SLRequestObject oSlRequestObject = GetUserCtx("PatchDraft", _userId, _companyId).Patch(_draft, oHeaderProperties, oLinesProperties);
            
            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<T>();
        }
        
        /// <summary>
        /// Metod to notify authorization
        /// </summary>
        /// <param name="_emailData"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static CLContext<string> SendNotifyDrafts(SendEmailAutoritathionModel _emailData)
        {
            try
            {
                LogManager.Record("REQUESTING POST OBJECT");

                CLContext<List<EmailCredential>> credentials = GetSettingByCode<List<EmailCredential>>(SettingCode.Account);

                int companyId = GetCompanyId();

                EmailCredential oEmailCredential =
                    credentials.Response.Data.Find(element => element.CompanyId == companyId);

                if (oEmailCredential == null)
                {
                    throw new CLException("CL - No se ha configurado la información de correo para la compañia en curso.",
                        HttpStatusCode.NotFound);
                }
                CL.COMMON.Core.SendEmail(
                        new CL.STRUCTURES.CLASSES.Email.EmailCredential()
                        {
                            Account = oEmailCredential.Account,
                            Host = oEmailCredential.Host,
                            Port = oEmailCredential.Port,
                            Password = oEmailCredential.Password,
                            Subject = oEmailCredential.Subject,
                            Ssl = oEmailCredential.Ssl,
                            User = oEmailCredential.User,
                            IdCompany = oEmailCredential.CompanyId
                        },
                        new CL.STRUCTURES.CLASSES.Email.EmailDetails()
                        {
                            Body = _emailData.Body,
                            EmailsTo = new List<string>()
                            {
                            _emailData.To
                            },
                            Subject = _emailData.Subject
                        }
                    );

                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<string>() { Code = HttpStatusCode.OK };
            }
            catch(CLException e)
            {
                LogManager.Record($"Ha ocurrido un error : {e.Message} , con status code: {e.Code}");
                return new CLContext<string>() { Code = HttpStatusCode.NotFound };
            }
           
        }

        #endregion

        #region Anticipos

        /// <summary>
        /// Retrieves closed A/R down payments filtered by BP, currency, date range, and document number.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_cardCode">Business partner code filter.</param>
        /// <param name="_docCurrency">Document currency filter.</param>
        /// <param name="_dateInit">Start date filter.</param>
        /// <param name="_dateEnd">End date filter.</param>
        /// <param name="_docNum">Document number filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{AppliedDownPayment}"/>.
        /// </returns>
        public static async Task<CLContext<List<AppliedDownPayment>>> GetARDownPaymentsClosed(
            string _cardCode,
            string _docCurrency,
            string _dateInit,
            string _dateEnd,
            int _docNum)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetDownPaymentsClosed");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@CardCode", _cardCode ?? "" },
                    { "@DocCurrency", _docCurrency ?? "" },
                    { "@DateInit", _dateInit ?? "" },
                    { "@DateEnd", _dateEnd ?? "" },
                    { "@DocNum", _docNum }
                };

                List<AppliedDownPayment> resultList =
                     Common.ResolveSAPViewODBC<AppliedDownPayment>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<AppliedDownPayment>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<AppliedDownPayment>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterARDownPayments filter = new FilterARDownPayments
                {
                    CardCode = _cardCode ?? "",
                    DocCurrency = _docCurrency ?? "",
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    DocNum = _docNum
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetDownPaymentsClosed").Get<FilterARDownPayments>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<AppliedDownPayment>>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves A/R down payments filtered by salesperson, dates, document info, and BP data.
        /// Uses ODBC or SAP Service Layer depending on the current connection mode.
        /// </summary>
        /// <param name="_slpCode">Salesperson code.</param>
        /// <param name="_dateInit">Start date filter (string).</param>
        /// <param name="_dateEnd">End date filter (string).</param>
        /// <param name="_docNum">Document number filter.</param>
        /// <param name="_docStatus">Document status filter.</param>
        /// <param name="_docCurrency">Document currency filter.</param>
        /// <param name="_cardCode">Business partner code filter.</param>
        /// <param name="_cardName">Business partner name filter.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{DownPayments}"/> that matches the filters.
        /// </returns>
        public static async Task<CLContext<List<DownPayments>>> GetARDownPayments(
            int _slpCode,
            string _dateInit,
            string _dateEnd,
            int _docNum,
            string _docStatus,
            string _docCurrency,
            string _cardCode,
            string _cardName)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetDownPaymentsByFilters");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<DownPayments> resultList = Common.ResolveSAPViewODBC<DownPayments>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@SlpCode", _slpCode},
                        {"@DateInit", $"{_dateInit ?? ""}"},
                        {"@DateEnd", $"{_dateEnd ?? ""}"},
                        {"@DocNum", _docNum},
                        {"@DocStatus", $"{_docStatus ?? ""}"},
                        {"@DocCurrency", $"{_docCurrency ?? ""}"},
                        {"@CardCode", $"{_cardCode ?? ""}"},
                        {"@CardName", $"{_cardName ?? ""}"}
                    });

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<DownPayments>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<DownPayments>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetDownPaymentsByFilters").Get(new FilterARDownPayments()
                {
                    SlpCode = _slpCode,
                    DateInit = _dateInit ?? "",
                    DateEnd = _dateEnd ?? "",
                    DocNum = _docNum,
                    DocStatus = _docStatus ?? "",
                    DocCurrency = _docCurrency ?? "",
                    CardCode = _cardCode ?? "",
                    CardName = _cardName ?? ""
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<DownPayments>>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves an accounts receivable down payment document based on the provided document entry.
        /// </summary>
        /// <param name="DocEntry">The document entry identifier for the down payment to be retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{DownPayments}"/>
        /// object which includes the down payment details and its associated document lines.
        /// </returns>
        /// <exception cref="CLException">Thrown when no records are found for the specified document entry.</exception>
        public static async Task<CLContext<DownPayments>> GetARDownPayment(int docEntry)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<DownPayments> oClContext;
            DownPayments downPayment;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetARDownPayments");
                var list = Common.ResolveSAPViewODBC<DownPayments>(
                    ctx,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
                downPayment = list.FirstOrDefault();
                oClContext = new CLContext<DownPayments>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<DownPayments> { Data = downPayment },
                    value = downPayment
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetARDownPayments")
                    .Get(new FilterBaseDocEntry(){ 
                        DocEntry = docEntry 
                    });
                oClContext = await req.SendAsync<DownPayments>();
                downPayment = oClContext.Response.Data;
            }

            if (oClContext.Response?.Data == null)
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);

            List<DownPaymentRows> lines;
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctxL = GetUserCtxODBC("ODBC_GetARDownPaymentsRows");
                lines = Common.ResolveSAPViewODBC<DownPaymentRows>(
                    ctxL,
                    new Dictionary<string, object> { 
                        { "@DocEntry", docEntry } 
                    });
            }
            else
            {
                SLRequestObject reqL = GetUserCtx("SL_GetARDownPaymentsRows")
                    .Get(new FilterBaseDocEntry(){ 
                        DocEntry = docEntry 
                    });
                var slL = await reqL.SendAsync<List<DownPaymentRows>>();
                lines = slL.Response.Data;
            }

            oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();
            oClContext.Response.Data.DocumentLines.AddRange(lines);

            if (lines != null && lines.Count > 0)
            {
                foreach (var row in lines)
                {
                    if (!string.IsNullOrEmpty(row.WarehouseCode))
                        row.UoMMasterData = await GetUomMasterDataFilter(
                            row.ItemCode, row.WarehouseCode, downPayment.PriceList, "N");
                }
            }

            LogManager.Record("REQUEST COMPLETED");
            return oClContext;
        }

        /// <summary>
        /// Creates an advance invoice (AR down payment) with an optional incoming payment and document attachment.
        /// </summary>
        /// <param name="_advanceInvoicePayment">An object containing the AR down payment and the incoming payment data.</param>
        /// <param name="_attachment">Metadata for the document attachment related to the invoice.</param>
        /// <param name="_attachmentFiles">The uploaded files to be attached to the document.</param>
        /// <param name="_userId">The ID of the user performing the operation. Default is -1.</param>
        /// <param name="_companyId">The ID of the company to which the transaction belongs. Default is -1.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a 
        /// <see cref="CLContext{AdvanceInvoiceWithPayment}"/> object with the created AR down payment 
        /// and optional incoming payment.
        /// </returns>
        public static async Task<CLContext<AdvanceInvoiceWithPayment>> PostAdvanceInvoiceWithPayment(AdvanceInvoiceWithPayment _advanceInvoicePayment,  DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1)
        {

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _advanceInvoicePayment.ARInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<DownPayments> downPaymentContext =
                await PostDownPayments(_advanceInvoicePayment.ARInvoice,SapDocumenType.ArDownPayment, _userId, _companyId);

            AdvanceInvoiceWithPayment advanceInvoiceWithPayment = new AdvanceInvoiceWithPayment();

            if (downPaymentContext.Response != null)
            {
                advanceInvoiceWithPayment.ARInvoice = downPaymentContext.Response.Data;

                if (_advanceInvoicePayment.IncomingPayment != null)
                {
                    _advanceInvoicePayment.IncomingPayment.PaymentInvoices[0].DocEntry =
                        downPaymentContext.Response.Data.DocEntry;

                    CLContext<IncomingPayment> incomingPaymentContext =
                        await PostIncomingPayments(_advanceInvoicePayment.IncomingPayment, _userId, _companyId);

                    if (incomingPaymentContext.Response != null)
                    {
                        advanceInvoiceWithPayment.IncomingPayment = incomingPaymentContext.Response.Data;

                        return new CLContext<AdvanceInvoiceWithPayment>()
                        {
                            Code = incomingPaymentContext.Code,
                            Response = new Response<AdvanceInvoiceWithPayment>()
                            {
                                Data = advanceInvoiceWithPayment
                            },
                            value = advanceInvoiceWithPayment
                        };
                    }
                }


                return new CLContext<AdvanceInvoiceWithPayment>()
                {
                    Code = downPaymentContext.Code,
                    Response = new Response<AdvanceInvoiceWithPayment>()
                    {
                        Data = advanceInvoiceWithPayment
                    },
                    value = advanceInvoiceWithPayment
                };
            }

            return new CLContext<AdvanceInvoiceWithPayment>()
            {
                Code = downPaymentContext.Code,
                Response = new Response<AdvanceInvoiceWithPayment>()
                {
                    Data = advanceInvoiceWithPayment
                },
                value = advanceInvoiceWithPayment
            };
        }

        /// <summary>
        /// Method to create downpayment
        /// </summary>
        /// <param name="pDownPaymentInvoice">Model downpayment</param>
        /// <param name="pUserId">User logged</param>
        /// <param name="pCompanyId">company logged</param>
        /// <returns></returns>
        public static async Task<CLContext<DownPayments>> PostDownPayments(DownPayments pDownPaymentInvoice, string pDocumentType, int pUserId = -1,
            int pCompanyId = -1)
        {
            int userId = pUserId == -1 ? CL.COMMON.Core.GetClaimUserId() : pUserId;
        
            CLContext<DownPayments> existingDocumentInformationResponse =
                await CheckIfDocumentExistByDocumentKey(pDownPaymentInvoice, pDocumentType, userId, pCompanyId);
        
            if (existingDocumentInformationResponse != null)
            {
                return existingDocumentInformationResponse;
            }
            
            Constants.DocumentType documentType = Common.GetDocumentTypeFromSapTable(pDocumentType);

            CLContext<DownPayments> slResponse =
                await CheckIfDocumentComesFromDraft(pDownPaymentInvoice, pDocumentType, userId, pCompanyId);
        
            if (slResponse != null)
            {
                return slResponse;
            }

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(pDownPaymentInvoice, documentType, userId, pCompanyId);
            
            string resource = pDocumentType == SapDocumenType.ArDownPayment ? "PostDownPayment" : "PostPurchaseDownPayment";

            SetConfiguredSeriesToDocument(pDownPaymentInvoice, documentType, userId, pCompanyId);
            
            if (queryConditionApply.IsApply)
            {
                pDownPaymentInvoice.DocObjectCode = ((int)documentType).ToString();

                pDownPaymentInvoice.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });

                slResponse = await PostDraft(pDownPaymentInvoice);
            }
            else
            {
                SLRequestObject requestModel = BuildSalesDocumentSLRequestObject(documentType, true,
                    pDownPaymentInvoice, resource, userId, pCompanyId, true);

                slResponse = await requestModel.SendAsync<DownPayments>();
            }

            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                return await ValidateAndNotifyAuthorization(pDownPaymentInvoice, pDocumentType, queryConditionApply,
                    userId, pCompanyId);
            }

            return slResponse;
        }

        /// <summary>
        /// Updates an existing Advance Invoice document by sending a PATCH request,
        /// including optional file attachments and cleaning unnecessary properties from the payload.
        /// </summary>
        /// <param name="_downPaymentInvoice">The dvance Invoice document to be updated.</param>
        /// <param name="_attachment">Metadata related to the attachments to be included.</param>
        /// <param name="_attachmentFiles">List of actual files to be attached to the document.</param>
        /// <returns>
        /// A <see cref="Task"/> that represents the asynchronous operation. The task result contains a 
        /// <see cref="CLContext{ARInvoice}"/> object with the updated invoice data returned by the server.
        /// </returns>
        public static async Task<CLContext<AdvanceInvoiceWithPayment>> PatchAdvanceInvoice(AdvanceInvoiceWithPayment _downPaymentInvoice, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING PATCH ARINVOICE OBJECT");

            string oRemoveLineProperties =
                "LineTotal,Udfs,LineNum,TaxRate,UoMMasterData,ManSerNum,ManBtchNum,FatherCode,LinesCurrenciesList,OnHand,InventoryItem,LineTotal," +
                "HideComp,VATLiable,Freight,IsAServerLine,LineNum,LineStatus,Currency,BaseType,BaseEntry,BaseLine";
            //Se verifica si hay lineas cerradas
            bool hasClosedLines = _downPaymentInvoice.ARInvoice.DocumentLines.Any(_x => _x.LineStatus == LineStatus.bost_Close);


            if (hasClosedLines)
            {
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineNum", "");
                oRemoveLineProperties = oRemoveLineProperties.Replace(",LineStatus", "");
            }

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "DocTotal",
                "Udfs",
                "DocEntry",
                "DocNum",
                "DocRate",
                "IdTranRedimir",
                "IdTranAcumular",
                "PriceList",
                "InvoiceNumber",
                "DocStatus",
                "TipoDocE",
                "IdType",
                "Identification",
                "Email",
                "NumFE",
                "ClaveFE",
                "DocTotalFC",
                "DocumentKey",
                "WithTransactionTapp",
                "DocObjectCode",
                "SalesPersonName",
                "Series",
                "HandWritten"
            };

            string headerProperties = string.Join(",", oRemoveHeaderProperties);

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _downPaymentInvoice.ARInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            SLRequestObject requestModel = GetUserCtx("PatchDownPayment").Patch(_downPaymentInvoice.ARInvoice,
                _fieldsToRemoveInLines: oRemoveLineProperties, _fieldsToRemoveInHeaders: headerProperties);

            List<KeyValuePair<string, string>> headers = new List<KeyValuePair<string, string>>();

            requestModel.Headers = headers;

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");


            return await requestModel.SendAsync<AdvanceInvoiceWithPayment>();
        }

        #endregion

        #region Anticipos proveedores
        /// <summary>
        /// Method to create purchase advances
        /// </summary>
        /// <param name="_advanceInvoicePayment">Model to create</param>
        /// <param name="_userId">User logged</param>
        /// <param name="_companyId">Compny logged</param>
        /// <returns></returns>
        public static async Task<CLContext<AdvancePurchaseInvoiceWithPayment>> PostPurchaseDownPayments(
           AdvancePurchaseInvoiceWithPayment _advanceInvoicePayment, DocumentAttachment _attachment,
           IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1)
       {
            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _advanceInvoicePayment.APInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            
            CLContext<DownPayments> downPaymentContext =
                await PostDownPayments(_advanceInvoicePayment.APInvoice,SapDocumenType.ApDownPayment, _userId, _companyId);
            
            AdvancePurchaseInvoiceWithPayment advanceInvoiceWithPayment = new AdvancePurchaseInvoiceWithPayment();
            
            // If the invoice has an authorization process, we don't need create the payment
            if (downPaymentContext.Response.Data is object && downPaymentContext.Response.Data.ConfirmationEntry != 0)
            {
                advanceInvoiceWithPayment = new AdvancePurchaseInvoiceWithPayment()
                {
                    APInvoice = downPaymentContext.Response.Data,
                    OutgoingPayment = null
                };

                return new CLContext<AdvancePurchaseInvoiceWithPayment>()
                {
                    Code = downPaymentContext.Code,
                    Response = new Response<AdvancePurchaseInvoiceWithPayment>()
                    {
                        Data = advanceInvoiceWithPayment
                    },
                    value = advanceInvoiceWithPayment
                };
            }

            if (downPaymentContext.Response != null)
            {
                advanceInvoiceWithPayment.APInvoice  = downPaymentContext.Response.Data;

                if (_advanceInvoicePayment.OutgoingPayment != null)
                {
                    _advanceInvoicePayment.OutgoingPayment.PaymentInvoices[0].DocEntry =
                        downPaymentContext.Response.Data.DocEntry;

                    CLContext<IncomingPayment> incomingPaymentContext =
                        await PostOutgoingPayments(_advanceInvoicePayment.OutgoingPayment);

                    if (incomingPaymentContext.Response != null)
                    {
                        advanceInvoiceWithPayment.OutgoingPayment = incomingPaymentContext.Response.Data;

                        return new CLContext<AdvancePurchaseInvoiceWithPayment>()
                        {
                            Code = incomingPaymentContext.Code,
                            Response = new Response<AdvancePurchaseInvoiceWithPayment>()
                            {
                                Data = advanceInvoiceWithPayment
                            },
                            value = advanceInvoiceWithPayment
                        };
                    }
                }


                return new CLContext<AdvancePurchaseInvoiceWithPayment>()
                {
                    Code = downPaymentContext.Code,
                    Response = new Response<AdvancePurchaseInvoiceWithPayment>()
                    {
                        Data = advanceInvoiceWithPayment
                    },
                    value = advanceInvoiceWithPayment
                };
            }

            return new CLContext<AdvancePurchaseInvoiceWithPayment>()
            {
                Code = downPaymentContext.Code,
                Response = new Response<AdvancePurchaseInvoiceWithPayment>()
                {
                    Data = advanceInvoiceWithPayment
                },
                value = advanceInvoiceWithPayment
            };
        }
        
       /// <summary>
       /// Retrieves a list of accounts payable down payments based on the specified filters.
       /// </summary>
       /// <param name="_slpCode">The sales representative code to filter the down payments.</param>
       /// <param name="_dateFrom">The start date for filtering records.</param>
       /// <param name="_dateTo">The end date for filtering records.</param>
       /// <param name="_docNum">The document number to filter the down payments.</param>
       /// <param name="_docStatus">The status of the document to filter.</param>
       /// <param name="_cardCode">The business partner code (optional).</param>
       /// <param name="_cardName">The business partner name (optional).</param>
       /// <returns>
       /// A CLContext containing a list of accounts payable down payments.
       /// </returns>
       public static async Task<CLContext<List<DownPayments>>> GetAPDownPayments(int _slpCode, string _dateFrom,
           string _dateTo, int _docNum, string _docStatus, string _cardCode = "", string _cardName = "")
       {
           LogManager.Record($"REQUESTING RECORDS");

           string connectionMode = GetConnectionMode();

           LogManager.Record($"CONNECTION MODE: {connectionMode}");

           #region Query Via ODBC
           if (connectionMode == SapConnectionType.ODBC)
           {
               ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseDownPaymentsByFilters");
            
               List<DownPayments> resultList = Common.ResolveSAPViewODBC<DownPayments>(contextODBC, new Dictionary<string, object>()
               {
                   {"@SlpCode", $"{_slpCode}"},
                   {"@DateFrom", $"{_dateFrom}"},
                   {"@DateTo", $"{_dateTo}"},
                   {"@DocNum", $"{_docNum}"},
                   {"@DocStatus", $"{_docStatus}"},
                   {"@CardCode", $"{_cardCode}"},
                   {"@CardName", $"{_cardName}"}
               });
           
               LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
               LogManager.Record("REQUEST COMPLETED");

               return new CLContext<List<DownPayments>>()
               {
                   Code = HttpStatusCode.OK,
                   Response = new Response<List<DownPayments>>()
                   {
                       Data = resultList
                   },
                   value = resultList
               };
           } 
           #endregion
            
           #region Query Via SL
           SLRequestObject requestModel = GetUserCtx("SL_GetPurchaseDownPaymentsByFilters").Get<FilterPurchaseDocuments>();

           LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
           LogManager.Record($"REQUEST COMPLETED");

           return await requestModel.SendAsync<List<DownPayments>>();
           #endregion
       }
       
       /// <summary>
       /// Method to retrieve an Accounts Payable (AP) Down Payment based on the provided document entry.
       /// </summary>
       /// <param name="_docEntry">The unique document entry identifier for the AP Down Payment.</param>
       /// <returns>
       /// A task representing the context containing the requested AP Down Payment details.
       /// </returns>
       public static async Task<CLContext<DownPayments>> GetAPDownPayment(int _docEntry)
       {
           LogManager.Record($"REQUESTING RECORDS");

           string connectionMode = GetConnectionMode();

           LogManager.Record($"CONNECTION MODE: {connectionMode}");

           CLContext<DownPayments> oClContext = new CLContext<DownPayments>();
           CLContext<List<DownPaymentRows>> oClContextRows = new CLContext<List<DownPaymentRows>>();
           CLContext<List<WithholdingTaxCode>> oClContextWithholding = new CLContext<List<WithholdingTaxCode>>();

           if (connectionMode == SapConnectionType.ODBC)
           {
               #region Query Via ODBC
               ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseDownPaymentByDocEntry");
           
               List<DownPayments> resultList = Common.ResolveSAPViewODBC<DownPayments>(contextODBC, new Dictionary<string, object>()
               {
                   {"@DocEntry", $"{_docEntry}"}
               });
               
               LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
               LogManager.Record("REQUEST COMPLETED");

               oClContext = new CLContext<DownPayments>()
               {
                   Code = HttpStatusCode.OK,
                   Response = new Response<DownPayments>()
                   {
                       Data = resultList.FirstOrDefault()
                   },
                   value = resultList.FirstOrDefault()
               };
               
               ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetPurchaseDownPaymentRows");
           
               List<DownPaymentRows> resultListLines = Common.ResolveSAPViewODBC<DownPaymentRows>(contextODBCLines, new Dictionary<string, object>()
               {
                   {"@DocEntry", $"{_docEntry}"}
               });
               
               LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
               LogManager.Record("REQUEST COMPLETED");

               oClContextRows = new CLContext<List<DownPaymentRows>>()
               {
                   Code = HttpStatusCode.OK,
                   Response = new Response<List<DownPaymentRows>>()
                   {
                       Data = resultListLines
                   },
                   value = resultListLines
               };
               
               ClUserContextODBC contextODBCWithholdingTax = GetUserCtxODBC("ODBC_WithholdingTaxByPurchaseDownPayment");
            
               List<WithholdingTaxCode> resultListWithholdingTax = Common.ResolveSAPViewODBC<WithholdingTaxCode>(contextODBCWithholdingTax, new Dictionary<string, object>()
               {
                   {"@DocEntry", $"{_docEntry}"}
               });
                
               LogManager.Record($"RESOURCE WITHHOLDING TAX ODBC: {contextODBCWithholdingTax.Resource}");
               LogManager.Record("REQUEST COMPLETED");

               oClContextWithholding = new CLContext<List<WithholdingTaxCode>>()
               {
                   Code = HttpStatusCode.OK,
                   Response = new Response<List<WithholdingTaxCode>>()
                   {
                       Data = resultListWithholdingTax
                   },
                   value = resultListWithholdingTax
               };
               #endregion
           }
           else
           {
               #region Query Via SL
               SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseDownPaymentByDocEntry").Get<FilterPurchaseOrder>();
               
               LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
               LogManager.Record("REQUEST COMPLETED");

               oClContext = await oSlRequestObject.SendAsync<DownPayments>();
               
               SLRequestObject oSlRequestObjectRows = GetUserCtx("SL_GetPurchaseDownPaymentRows").Get<FilterPurchaseOrder>();
               
               LogManager.Record($"RESOURCE LINES SL: {oSlRequestObjectRows.Url_Request}");
               LogManager.Record("REQUEST COMPLETED");

               oClContextRows = await oSlRequestObjectRows.SendAsync<List<DownPaymentRows>>();
               
               SLRequestObject oSlRequestObjectWithholdingTax = GetUserCtx("SL_WithholdingTaxByPurchaseDownPayment").Get<FilterPurchaseOrder>();
                
               LogManager.Record($"RESOURCE WITHHOLDING TAX SL: {oSlRequestObjectWithholdingTax.Url_Request}");
               LogManager.Record("REQUEST COMPLETED");
                
               oClContextWithholding = await oSlRequestObjectWithholdingTax.SendAsync<List<WithholdingTaxCode>>();
               #endregion
           }
           
           oClContext.Response.Data.DocumentLines = new List<SalesDocumentLine>();
           oClContext.Response.Data.WithholdingTaxDataCollection = oClContextWithholding.Response.Data;
           oClContext.Response.Data.DocumentLines.AddRange(oClContextRows.Response.Data);

           #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA
           if (oClContextRows.Response.Data is object && oClContextRows.Response.Data.Count > 0)
           {
               foreach (DownPaymentRows item in oClContext.Response.Data.DocumentLines)
               {
                   item.UoMMasterData = await GetUomMasterDataFilter(item.ItemCode, item.WarehouseCode,
                       oClContext.Response.Data.PriceList,
                       "Y");
               }
           }
           #endregion
           
           LogManager.Record($"REQUEST COMPLETED");

           return oClContext;
       }
       /// <summary>
       /// Method to create drafts
       /// </summary>
       /// <param name="_apInvoiceWithPayment">Model to create</param>
       /// <returns></returns>
       /// <exception cref="CLException"></exception>
        public static async Task<CLContext<DownPayments>> PostAPDownPaymentDrafts(DownPayments _apInvoiceWithPayment,DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _apInvoiceWithPayment.DocObjectCode = ((int)Constants.DocumentType.ApDownPayment).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _apInvoiceWithPayment.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<DownPayments>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<DownPayments>()
                    {
                        Data = new DownPayments()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            CLContext<DownPayments> slResponse = null;
            
            slResponse = await PostDraft<DownPayments>(_apInvoiceWithPayment);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<DownPayments> oClContext = await ResolveCreatedDocument<DownPayments>(slResponse,
                    SapDocumenType.Draft,
                    _apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;


                return oClContext;
            }
            
            return slResponse;
        }
        
       /// <summary>
       /// Method to create drafts
       /// </summary>
       /// <param name="_apInvoiceWithPayment"></param>
       /// <param name="_attachment"></param>
       /// <param name="_attachmentFiles"></param>
       /// <returns></returns>
       /// <exception cref="CLException"></exception>
       public static async Task<CLContext<DownPayments>> PatchAPDownPaymentDrafts(DownPayments _apInvoiceWithPayment,DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
       {
           LogManager.Record("REQUESTING POST OBJECT");
           _apInvoiceWithPayment.DocObjectCode = ((int)Constants.DocumentType.ApDownPayment).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _apInvoiceWithPayment.AttachmentEntry = documentAttachment?.AbsoluteEntry;

           CLContext<DownPayments> slResponse = await PostDraft<DownPayments>(_apInvoiceWithPayment);
           if (slResponse.Code == HttpStatusCode.NoContent)
           {
               CLContext<DownPayments> oClContext = await ResolveCreatedDocument<DownPayments>(slResponse,
                   SapDocumenType.Draft,
                   _apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
               if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
               {
                   throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
               }
               oClContext.Response.Data.ConfirmationEntry = 0;
               return oClContext;
           }
            
           return slResponse;
       }
        #endregion

        #region Movimientos de dinero

        public static async Task<CLContext<CashFlow>> PostCashFlow(CashFlow _cashFlow)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            ClUserContext oClUserContext = GetUserCtx("GetUserSAP");

            string userCode = String.Empty;

            if (oClUserContext.License.Contains(@"\"))
            {
                userCode = oClUserContext.License.Split('\\')[1];
            }
            else
            {
                userCode = oClUserContext.License;
            }

            SLRequestObject oSlRequestObjectInternal = oClUserContext.Get(new FilterUserSAP()
            {
                UserCode = userCode
            });

            LogManager.Record($"URL: ${oSlRequestObjectInternal.Url_Request}");

            CLContext<UsersSAP> oContext = await oSlRequestObjectInternal.SendAsync<UsersSAP>();

            _cashFlow.U_INTERNAL_K = oContext.Response.Data.UserSignature;
            _cashFlow.Code = $"USR{_cashFlow.U_INTERNAL_K}_R{_cashFlow.U_Type}_{DateTime.Now:yyyyMMddHHmmss}";
            _cashFlow.Name = _cashFlow.Code;

            SLRequestObject oSlRequestObject = GetUserCtx("PostCashFlow").Post(_cashFlow);

            LogManager.Record($"URL: ${oSlRequestObject.Url_Request}");

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<CashFlow>();
        }

        #endregion

        #region Purchase Invoices

        /// <summary>
        /// Method to create purchase invoice with payment
        /// </summary>
        /// <param name="_apInvoiceWithPayment">Model to create purchase invoice with payment</param>
        /// <returns></returns>
        public static async Task<CLContext<APInvoiceWithPayment>> CreatePurchaseInvoiceWithPayment(
            APInvoiceWithPayment _apInvoiceWithPayment, DocumentAttachment _attachment,
            IEnumerable<HttpPostedFile> _attachmentFiles)
        {

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _apInvoiceWithPayment.APInvoice.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<APInvoice> apInvoiceContext = await Process.CreatePurchaseInvoice(_apInvoiceWithPayment.APInvoice);
            
            APInvoiceWithPayment apInvoiceWithPayment = null;
            
            // If the invoice has an authorization process, we don't need create the payment
            if (apInvoiceContext.Response.Data is object && apInvoiceContext.Response.Data.ConfirmationEntry != 0)
            {
                apInvoiceWithPayment = new APInvoiceWithPayment()
                {
                    APInvoice = apInvoiceContext.Response.Data,
                    OutgoingPayment = null
                };

                return new CLContext<APInvoiceWithPayment>()
                {
                    Code = apInvoiceContext.Code,
                    Response = new Response<APInvoiceWithPayment>()
                    {
                        Data = apInvoiceWithPayment
                    },
                    value = apInvoiceWithPayment
                };
            }

             apInvoiceWithPayment = new APInvoiceWithPayment()
            {
                APInvoice = apInvoiceContext.Response?.Data
            };

            if (apInvoiceWithPayment.APInvoice != null && _apInvoiceWithPayment.OutgoingPayment != null)
            {
                _apInvoiceWithPayment.OutgoingPayment.PaymentInvoices[0].DocEntry =
                    apInvoiceContext.Response.Data.DocEntry;
                
                CLContext<IncomingPayment> outgoingPaymentContext = await Process.PostOutgoingPayments(_apInvoiceWithPayment.OutgoingPayment);
                apInvoiceWithPayment.OutgoingPayment = outgoingPaymentContext.Response?.Data;
            }

            return new CLContext<APInvoiceWithPayment>()
            {
                Code = apInvoiceContext.Code,
                Response = new Response<APInvoiceWithPayment>()
                {
                    Data = apInvoiceWithPayment
                },
                value = apInvoiceWithPayment
            };
        }


        /// <summary>
        /// Method to create purchase invoice
        /// </summary>
        /// <param name="_apInvoice">Model to create</param>
        /// <returns></returns>
        public static async Task<CLContext<APInvoice>> CreatePurchaseInvoice(APInvoice _apInvoice)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();
            
            int companyId = GetCompanyId();
                        
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.ApInvoice);

            if (uniques.Response.Data != null)
            {
                return new CLContext<APInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<APInvoice>()
                    {
                        Data = new APInvoice()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };

            }

            #endregion

            #region Validar si aplica query autorizacion

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(_apInvoice, Constants.DocumentType.PurchaseInvoice, userId, companyId);

            #endregion

            //Validar documento base preliminar
            int lineWithBaseType = _apInvoice.DocumentLines.Find(_x => _x.BaseType == -1)?.BaseEntry ?? -1;
            int lineWithBaseEntry = _apInvoice.DocumentLines.Find(_x => _x.BaseEntry > 0)?.BaseType ?? 0;

            CLContext<APInvoice> slResponse = null;
            CLContext<DraftStatus> oClContextDraft=null;
            if (lineWithBaseType > 0)
            {
                //Obtener status del documento preliminar
                oClContextDraft = await ValidateStatusDraft(lineWithBaseType);
            }
            
            if (lineWithBaseEntry == -1 && lineWithBaseType > 0 && oClContextDraft!=null &&oClContextDraft.Response!=null &&oClContextDraft.Response.Data!=null)
            {
                #region Documento base preliminar

                //Obtener status del documento preliminar
               oClContextDraft = await ValidateStatusDraft(lineWithBaseType);

                if (oClContextDraft is null || oClContextDraft.Response is null ||
                    oClContextDraft.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                _apInvoice.DocEntry = lineWithBaseType;

                // Pasar el documento en firme
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = lineWithBaseType
                    }
                };

                CLContext<ApprovalRequest> oClConfirmContext = null;

                //Validar si es autorzazion simulada
                if (oClContextDraft.Response.Data?.Status == null &&
                    oClContextDraft.Response.Data?.U_EMA_Approval_Status != null)
                {
                    //Status draft
                    switch (oClContextDraft.Response.Data.U_EMA_Approval_Status)
                    {
                        case Approval_Status.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<APInvoice>(slResponse,
                                    SapDocumenType.ApInvoice,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case Approval_Status.Rejected:
                            //Validar si tiene autorizaciones 
                            if (queryConditionApply.IsApply)
                            {
                                //patch draft
                                _apInvoice.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Pending,
                                    FieldType = "String"
                                });

                                _apInvoice.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

                                CLContext<APInvoice> oClContextPatchDraft =
                                    await PatchDraft<APInvoice>(_apInvoice);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    slResponse = await ResolveCreatedDocument<APInvoice>(slResponse,
                                        SapDocumenType.Draft,
                                        _apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                }
                            }
                            else
                            {
                                //patch draft
                                _apInvoice.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                                {
                                    Name = "U_EMA_Approval_Status",
                                    Value = Approval_Status.Approved,
                                    FieldType = "String"
                                });

                                _apInvoice.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

                                CLContext<APInvoice> oClContextPatchDraft =
                                    await PatchDraft<APInvoice>(_apInvoice);

                                if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                                {
                                    oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                    if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                    {
                                        slResponse = await ResolveCreatedDocument<APInvoice>(slResponse,
                                            SapDocumenType.ApInvoice,
                                            _apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }
                                }
                            }

                            break;
                    }
                }
                else // draft auto
                {
                    //status draft auto
                    switch (oClContextDraft.Response.Data.Status)
                    {
                        case StatusDraft.Approved:

                            oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                            {
                                slResponse = await ResolveCreatedDocument<APInvoice>(slResponse,
                                    SapDocumenType.ApInvoice,
                                    oClContextDraft.Response.Data.DocumentKey);
                            }

                            break;
                        case StatusDraft.Rejected:
                            _apInvoice.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

                            CLContext<APInvoice> oClContextPatchDraft =
                                await PatchDraft<APInvoice>(_apInvoice);

                            if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                            {
                                oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                                if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                                {
                                    //Validar si con patch draft crea documento en firme o sigue pendiente de autorizacion 

                                    #region Validar creacion documento en firme

                                    CLContext<APInvoice> oClContext = await ResolveCreatedDocument<APInvoice>(
                                        slResponse,
                                        SapDocumenType.ApInvoice,
                                        _apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                                    if (oClContext is null || oClContext.Response is null ||
                                        oClContext.Response.Data is null)
                                    {
                                        return await ResolveCreatedDocument<APInvoice>(slResponse,
                                            SapDocumenType.Draft,
                                            _apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                                    }


                                    return oClContext;

                                    #endregion
                                }
                            }

                            break;
                    }
                }

                return slResponse;

                #endregion
            }
            else
            {
                SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.PurchaseInvoice);

                _apInvoice.Series = oSerie.NoSerie;
                
                Dictionary<string, Func<JProperty, bool>> lineFlushCondition =
                    new Dictionary<string, Func<JProperty, bool>>();
                

                if (_apInvoice.DocumentLines.Exists(x => x.BaseEntry == null))
                {
                    Func<JProperty, bool> result = new Func<JProperty, bool>(_property =>
                        _property.Value == null || Convert.ToInt32(_property.Value) == -1);

                    lineFlushCondition.Add("BaseEntry", result);
                    lineFlushCondition.Add("BaseType", result);
                }
                

                string oLinesProperties = "Udfs,LineNum,LineStatus,TaxRate,VATLiable";
                string oHeaderProperties = "Udfs,DocEntry,DocNum,DocDueDate,DocTotal,PriceList,DocObjectCode";

                SLRequestObject oSlRequestObject = GetUserCtx("PostPurchaseInvoice").Post(_apInvoice,
                    _fieldsToRemoveInLines: oLinesProperties, _fieldsToRemoveInHeaders: oHeaderProperties, _lineFlushConditions:lineFlushCondition);


                if (queryConditionApply.IsApply)
                {
                    _apInvoice.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

                    _apInvoice.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                    {
                        Name = "U_EMA_Approval_Status",
                        Value = Approval_Status.Pending,
                        FieldType = "String"
                    });

                    slResponse = await PostDraft<APInvoice>(_apInvoice);
                }
                else
                {
                    LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");

                    LogManager.Record($"REQUEST COMPLETED");

                    LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

                    // Add headear to prevent error on autorization process

                    oSlRequestObject.Headers = new ParameterCollection()
                    {
                        { new KeyValuePair<string, string>("Prefer", "return-no-content") }
                    };

                    slResponse = await oSlRequestObject.SendAsync<APInvoice>();
                }

                if (slResponse.Code == HttpStatusCode.NoContent)
                {
                    #region Validar si el tipo de documento aplica para autorizacion


                    bool apply = await TypeOfDocumentAppliesForAuthorizationProcess(_apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "",
                                                                                     Constants.DocumentType.PurchaseInvoice);

                    #endregion

                    string table =
                        (apply || queryConditionApply.IsApply)
                            ? SapDocumenType.Draft
                            : SapDocumenType.ApInvoice;

                    CLContext<APInvoice> oClContext = await ResolveCreatedDocument<APInvoice>(slResponse, table,
                        _apInvoice.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                    if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                    {
                        throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                    }
                    if (apply)
                    {
                        NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                        try
                        {
                            CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                            if (oCLContextSetting.Response.Data != null)
                            {
                                List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                oDraftsSetting = settingList.Find(_setting => _setting.CompanyId==companyId);
                                if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                {
                                    await SendNotifyAutoritation(oClContext.Response.Data.DocEntry, companyId, true, queryConditionApply);
                                }
                            }
                        }
                        catch (Exception e)
                        {
                            LogManager.Record($"Error: {e.Message}");
                        }
                    }


                    return oClContext;
                }
            }

            return slResponse;

        }

        /// <summary>
        /// Method to retrieve a list of open purchase invoices based on specific filters.
        /// </summary>
        /// <param name="_cardCode">The business partner code to filter invoices.</param>
        /// <param name="_docCurrency">The currency of the invoices to filter.</param>
        /// <param name="_dateInit">The start date for filtering invoices.</param>
        /// <param name="_dateEnd">The end date for filtering invoices.</param>
        /// <returns>
        /// A task representing the context containing a list of open purchase invoices that match the given criteria.
        /// </returns>
        public static async Task<CLContext<List<InvoiceOpen>>> GetOpenPurchaseInvoices(string _cardCode, string _docCurrency, 
            string _dateInit, string _dateEnd)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetOpenInvoicePurchase");
            
                List<InvoiceOpen> resultList = Common.ResolveSAPViewODBC<InvoiceOpen>(contextODBC, new Dictionary<string, object>()
                {
                    {"@CardCode", $"{_cardCode}"},
                    {"@DocCurrency", $"{_docCurrency}"},
                    {"@DateInit", $"{_dateInit}"},
                    {"@DateEnd", $"{_dateEnd}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<InvoiceOpen>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<InvoiceOpen>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetOpenInvoicePurchase").Get<FilterInvoiceOpenForPayReceived>();
            
            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");
            
            return await oSlRequestObject.SendAsync<List<InvoiceOpen>>();
            #endregion
        }
        
        /// <summary>
        /// Retrieves a list of Accounts Payable (AP) Invoices based on the provided filters.
        /// </summary>
        /// <param name="_slpCode">The salesperson code used to filter the invoices.</param>
        /// <param name="_dateFrom">The start date for filtering invoices.</param>
        /// <param name="_dateTo">The end date for filtering invoices.</param>
        /// <param name="_docNum">The document number to filter a specific invoice.</param>
        /// <param name="_docStatus">The status of the invoice (e.g., open, closed).</param>
        /// <param name="_cardCode">Optional. The business partner code to filter invoices.</param>
        /// <param name="_cardName">Optional. The business partner name to filter invoices.</param>
        /// <returns>
        /// A task representing an asynchronous operation that returns a <see cref="CLContext{List{APInvoice}}"/> 
        /// containing the requested AP Invoices.
        /// </returns>
        public static async Task<CLContext<List<APInvoice>>> GetPurchaseInvoices(int _slpCode, string _dateFrom,
            string _dateTo, int _docNum, string _docStatus, string _cardCode = "", string _cardName = "")
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");
            
            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseInvoices");

                List<APInvoice> resultList = Common.ResolveSAPViewODBC<APInvoice>(contextODBC, new Dictionary<string, object>()
                {
                    {"@SlpCode", $"{_slpCode}"},
                    {"@DateFrom", $"{_dateFrom}"},
                    {"@DateTo", $"{_dateTo}"},
                    {"@DocNum", $"{_docNum}"},
                    {"@DocStatus", $"{_docStatus}"},
                    {"@CardCode", $"{_cardCode}"},
                    {"@CardName", $"{_cardName}"}
                });
            
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<APInvoice>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<APInvoice>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion
            
            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseInvoices").Get<FilterPurchaseDocuments>();

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<APInvoice>>();
            #endregion
        }
        
        /// <summary>
        /// Method to retrieve an accounts payable (AP) invoice based on the provided document entry.
        /// </summary>
        /// <param name="_docEntry">The unique document entry identifier for the AP invoice.</param>
        /// <returns>
        /// A task representing the context containing the requested AP invoice.
        /// </returns>
        public static async Task<CLContext<APInvoice>> GetPurchaseInvoice(int _docEntry)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<APInvoice> oClContext = new CLContext<APInvoice>();
            CLContext<List<APInvoiceRows>> oClContextRows = new CLContext<List<APInvoiceRows>>();
            CLContext<List<WithholdingTaxCode>> oClContextWithholding = new CLContext<List<WithholdingTaxCode>>();
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPurchaseInvoiceByDocEntry");

                List<APInvoice> resultList = Common.ResolveSAPViewODBC<APInvoice>(contextODBC, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<APInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<APInvoice>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                
                ClUserContextODBC contextODBCLines = GetUserCtxODBC("ODBC_GetPurchaseInvoiceRows");

                List<APInvoiceRows> resultListLines = Common.ResolveSAPViewODBC<APInvoiceRows>(contextODBCLines, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE LINES ODBC: {contextODBCLines.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextRows = new CLContext<List<APInvoiceRows>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<APInvoiceRows>>()
                    {
                        Data = resultListLines
                    },
                    value = resultListLines
                };
                
                ClUserContextODBC contextODBCWithholdingTax = GetUserCtxODBC("ODBC_WithholdingTaxByPurchaseInvoice");
            
                List<WithholdingTaxCode> resultListWithholdingTax = Common.ResolveSAPViewODBC<WithholdingTaxCode>(contextODBCWithholdingTax, new Dictionary<string, object>()
                {
                    {"@DocEntry", $"{_docEntry}"}
                });
                
                LogManager.Record($"RESOURCE WITHHOLDING TAX ODBC: {contextODBCWithholdingTax.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContextWithholding = new CLContext<List<WithholdingTaxCode>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<WithholdingTaxCode>>()
                    {
                        Data = resultListWithholdingTax
                    },
                    value = resultListWithholdingTax
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject oSlRequestObject = GetUserCtx("SL_GetPurchaseInvoiceByDocEntry").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContext = await oSlRequestObject.SendAsync<APInvoice>();

                SLRequestObject oSlRequestObjectRows = GetUserCtx("SL_GetPurchaseInvoiceRows").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE LINES SL: {oSlRequestObjectRows.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContextRows = await oSlRequestObjectRows.SendAsync<List<APInvoiceRows>>();

                SLRequestObject oSlRequestObjectWithholdingTax = GetUserCtx("SL_WithholdingTaxByPurchaseInvoice").Get<FilterPurchaseOrder>();
                
                LogManager.Record($"RESOURCE WITHHOLDING TAX SL: {oSlRequestObjectWithholdingTax.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                
                oClContextWithholding = await oSlRequestObjectWithholdingTax.SendAsync<List<WithholdingTaxCode>>();
                #endregion
            }

            oClContext.Response.Data.DocumentLines = oClContextRows.Response.Data;
            oClContext.Response.Data.WithholdingTaxDataCollection = oClContextWithholding.Response.Data;

            #region FLUJO PARA OBTENER LAS UNIDADES DE MEDIDA

            if (oClContextRows.Response.Data is object && oClContextRows.Response.Data.Count > 0)
            {
                foreach (APInvoiceRows item in oClContext.Response.Data.DocumentLines)
                {
                    if (!String.IsNullOrEmpty(item.WarehouseCode))
                    {
                        item.UoMMasterData = await GetUomMasterDataFilter(item.ItemCode, item.WarehouseCode,
                            oClContext.Response.Data.PriceList,
                            "Y");
                    }
                }
            }

            #endregion
            
            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }
        /// <summary>
        /// Method to create drafts
        /// </summary>
        /// <param name="_apInvoiceWithPayment">Model to create</param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<APInvoice>> PostPurchaseInvoicesDrafts(APInvoice _apInvoiceWithPayment, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            _apInvoiceWithPayment.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _apInvoiceWithPayment.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.Draft);

            if (uniques.Response.Data != null)
            {
                return new CLContext<APInvoice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<APInvoice>()
                    {
                        Data = new APInvoice()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            CLContext<APInvoice> slResponse = null;
            
            slResponse = await PostDraft<APInvoice>(_apInvoiceWithPayment);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<APInvoice> oClContext = await ResolveCreatedDocument<APInvoice>(slResponse,
                    SapDocumenType.Draft,
                    _apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");

                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }

                oClContext.Response.Data.ConfirmationEntry = 0;


                return oClContext;
            }
            
            return slResponse;
        }
        
        /// <summary>
        /// Method to update drafts
        /// </summary>
        /// <param name="_apInvoiceWithPayment"></param>
        /// <param name="_attachment"></param>
        /// <param name="_attachmentFiles"></param>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<APInvoice>> PatchPurchaseInvoicesDrafts(APInvoice _apInvoiceWithPayment, DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles)
        {
            LogManager.Record("REQUESTING POST OBJECT");
            _apInvoiceWithPayment.DocObjectCode = ((int)Constants.DocumentType.PurchaseInvoice).ToString();

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(_attachment, _attachmentFiles);
            _apInvoiceWithPayment.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            CLContext<APInvoice> slResponse = await PatchDraft(_apInvoiceWithPayment);
            if (slResponse.Code == HttpStatusCode.NoContent)
            {
                CLContext<APInvoice> oClContext = await ResolveCreatedDocument<APInvoice>(slResponse,
                    SapDocumenType.Draft,
                    _apInvoiceWithPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value ?? "");
                if (oClContext is null || oClContext.Response is null || oClContext.Response.Data is null)
                {
                    throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
                }
                oClContext.Response.Data.ConfirmationEntry = 0;
                return oClContext;
            }
            return slResponse;
        }

        #endregion

        #region VendorPayments

        /// <summary>
        /// Method to create purchase payment
        /// </summary>
        /// <param name="_outgoingPayment">Model to create payment</param>
        /// <returns></returns>
        public static async Task<CLContext<IncomingPayment>> PostOutgoingPayments(IncomingPayment _outgoingPayment)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            #region Validar si existe documento por el uniqueId

            CLContext<CLMLTEMA.MODELS.UniqueId> uniques = await GetUniqueId(_outgoingPayment.Udfs.Find(_x => _x.Name == "U_DocumentKey")?.Value, SapDocumenType.OutgoingPayment);

            if (uniques.Response.Data != null)
            {
                return new CLContext<IncomingPayment>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<IncomingPayment>()
                    {
                        Data = new IncomingPayment()
                        {
                            DocEntry = uniques.Response.Data.DocEntry,
                            DocNum = uniques.Response.Data.DocNum
                        }
                    }
                };
            }

            #endregion

            SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.OutgoingPayment);

            _outgoingPayment.Series = oSerie.NoSerie;

            string removeHeaderProperties = "PPTransactions";

            SLRequestObject oSlRequestObject =
                GetUserCtx($"PostOutgoingPayments")
                    .Post(_outgoingPayment, _fieldsToRemoveInHeaders: removeHeaderProperties);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {oSlRequestObject.Content}");

            LogManager.Record("REQUESTING COMPLETED");

            CLContext<IncomingPayment> outgoingPaymentContext = await oSlRequestObject.SendAsync<IncomingPayment>();

            if (outgoingPaymentContext.Response != null)
            {
                if (_outgoingPayment.PPTransactions != null)
                {
                    CLContext<PPTransaction> ppTransaction = null;

                    foreach (PPTransaction transaction in _outgoingPayment.PPTransactions)
                    {
                        transaction.CompanyId = GetCompanyId();
                        transaction.CreatedBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");
                        transaction.DocEntry = _outgoingPayment.PaymentInvoices[0].DocEntry;
                        ppTransaction = Sale(transaction);
                    }
                }
            }

            return outgoingPaymentContext;
        }

        #endregion

        #region CreditNotes

        /// <summary>
        /// Cancels the payments associated with a credit note invoice by retrieving related payments and canceling them.
        /// </summary>
        /// <param name="pSalesDocument">The sales document (credit note) whose payments need to be canceled.</param>
        private static async System.Threading.Tasks.Task CancelCreditNoteInvoicePayments(SalesDocument pSalesDocument)
        {
            LogManager.Record("REQUESTING PAYMENTS TO CANCEL");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<OneIncomingPayment>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetPaymentForCancel");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@DocEntry", pSalesDocument.DocEntry }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<OneIncomingPayment> resultList = Common.ResolveSAPViewODBC<OneIncomingPayment>(contextODBC, parametersODBC);

                oClContext = new CLContext<List<OneIncomingPayment>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<OneIncomingPayment>>() { Data = resultList },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterPaymentForCancel filter = new FilterPaymentForCancel()
                {
                    DocEntry = pSalesDocument.DocEntry
                };

                SLRequestObject oSlRequestObjectGetCancel = GetUserCtx("SL_GetPaymentForCancel").Get<FilterPaymentForCancel>(filter);

                LogManager.Record($"RESOURCE: {oSlRequestObjectGetCancel.Url_Request}");

                oClContext = await oSlRequestObjectGetCancel.SendAsync<List<OneIncomingPayment>>();

                #endregion
            }

            if (oClContext.Response.Data is object && oClContext.Response.Data.Count > 0)
            {
                ClUserContext oClUserContext = GetUserCtx("PatchIncomingPayments");

                foreach (OneIncomingPayment oIncomingPayment in oClContext.Response.Data)
                {
                    SLRequestObject oSlRequestObjectPostCancel = oClUserContext.Patch(
                        new IncomingPayment() { DocEntry = oIncomingPayment.DocEntryPay }
                    );

                    oSlRequestObjectPostCancel.Method = "POST";

                    oSlRequestObjectPostCancel.Url_Request = $"{oSlRequestObjectPostCancel.Url_Request}/Cancel";

                    oSlRequestObjectPostCancel.Content = "{}";

                    await oSlRequestObjectPostCancel.SendAsync<IncomingPayment>();
                }
            }
        }

        /// <summary>
        /// Map the doc entry of the referenced document
        /// </summary>
        /// <param name="pSalesDocument">Credit note document information</param>
        /// <exception cref="Exception">If no document found</exception>
        private static async System.Threading.Tasks.Task MapReferencedDocumentsEntries(SalesDocument pSalesDocument)
        {
            if (pSalesDocument.DocumentReferences != null)
            {
                CLContext<DocInfo> oClContextDocInfo =
                    await GetDocInfoByDocNum(pSalesDocument.DocumentReferences[0].RefDocNum, _tipoDoc: "FE");

                if (oClContextDocInfo.Response.Data is object)
                {
                    pSalesDocument.DocumentReferences[0].RefDocEntr = oClContextDocInfo.Response.Data.DocEntry;
                }
                else
                {
                    throw new Exception(
                        $"No se encontro ninguna factura con el numero de documento: {pSalesDocument.DocumentReferences[0].RefDocNum}");
                }
            }
        }

        public static async Task<CLContext<ARCreditMemo>> PostCreditNotes(ARCreditMemo pCreditMemo,DocumentAttachment pAttachment,
            IEnumerable<HttpPostedFile> pAttachmentFiles)
        {
            int userId = CL.COMMON.Core.GetClaimUserId();

            int companyId = (int)System.Web.HttpContext.Current.Items[HttpContextItems.CompanyKey];

            CLContext<ARCreditMemo> existingDocumentResponse =
                await CheckIfDocumentExistByDocumentKey(pCreditMemo, SapDocumenType.CreditNotes, userId, companyId);

            if (existingDocumentResponse != null)
            {
                return existingDocumentResponse;
            }

            DocumentAttachment documentAttachment = await CreateDocumentAttachments(pAttachment, pAttachmentFiles);
            pCreditMemo.AttachmentEntry = documentAttachment?.AbsoluteEntry;

            QueryConditionApply queryConditionApply = await StartQueryConditionsValidations(pCreditMemo, Constants.DocumentType.CreditNotes, userId, companyId);

            if(pCreditMemo.DocumentReferences != null &&
               pCreditMemo.DocumentReferences.Count > 0 &&
               pCreditMemo.DocumentReferences[0]?.RefDocEntr <= 0)
            {
                await MapReferencedDocumentsEntries(pCreditMemo);
            }
            
            SetConfiguredSeriesToDocument(pCreditMemo, Constants.DocumentType.CreditNotes, -1, -1);

            CLContext<ARCreditMemo> oClContextPostNC;
            
            if (queryConditionApply.IsApply)
            {
                pCreditMemo.DocObjectCode = ((int)Constants.DocumentType.CreditNotes).ToString();

                pCreditMemo.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                {
                    Name = "U_EMA_Approval_Status",
                    Value = "arsPending",
                    FieldType = "String"
                });

                oClContextPostNC = await PostDraft(pCreditMemo);
            }
            else
            {
                SLRequestObject oSlRequestObject = BuildSalesDocumentSLRequestObject(Constants.DocumentType.CreditNotes, true, pCreditMemo,
                    "PostCreditNotes", userId, companyId, true);

                oClContextPostNC = await oSlRequestObject.SendAsync<ARCreditMemo>();
            }

            if (oClContextPostNC.Code == HttpStatusCode.NoContent)
            {
                oClContextPostNC = await ValidateAndNotifyAuthorization(pCreditMemo, SapDocumenType.CreditNotes, queryConditionApply,
                    userId, companyId);

                if (oClContextPostNC?.Response?.Data?.ConfirmationEntry == 0)
                {
                    //Si viene DocEntry, es porque esta haciendo una copia de factura a Nota de credito, entonces hay que cancelarle los pagos
                    if (pCreditMemo.DocEntry > 0)
                    {
                        await CancelCreditNoteInvoicePayments(pCreditMemo);
                    }
                    
                    await CancelCreditNoteTransactions(pCreditMemo, oClContextPostNC.Response.Data.DocEntry);
                }
            }
            
            return oClContextPostNC;
        }

        /// <summary>
        /// Cancel the transactions linked to the credit memo invoice
        /// </summary>
        /// <param name="pCreditMemo">Credit memo document information</param>
        /// <param name="pCreatedCreditNoteEntry">Doc entry of the created credit memo</param>
        private static async System.Threading.Tasks.Task CancelCreditNoteTransactions(ARCreditMemo pCreditMemo, int pCreatedCreditNoteEntry)
        {
            #region CANCELAR TRANSACCION LEALTO

            if (!string.IsNullOrEmpty(pCreditMemo.IdTranRedimir))
            {
                await CancelLoyaltyTransactions(pCreditMemo.IdTranRedimir);
            }

            if (!string.IsNullOrEmpty(pCreditMemo.IdTranAcumular))
            {
                await CancelLoyaltyTransactions(pCreditMemo.IdTranAcumular);
            }

            #endregion

            #region CANCELAR TRANSACCION TAPP

            if (pCreditMemo.WithTransactionTapp)
            {
                await CreateNoteCreditTapp(pCreditMemo, pCreatedCreditNoteEntry);
            }

            #endregion
        }
        
        #endregion

        #region Warehouses

        /// <summary>
        /// Retrieves a list of warehouses based on the specified parameters.
        /// </summary>
        /// <param name="_companyId">The ID of the company for which to retrieve warehouses. Default is -1, which indicates no specific company.</param>
        /// <param name="_licence">The license ID used for authentication. Default is -1, which indicates no specific license.</param>
        /// <param name="_userAssign">A boolean indicating whether to assign a user for the request. Default is false.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{Warehouses}}"/> object with the list of warehouses.</returns>
        public static async Task<CLContext<List<Warehouses>>> GetWarehouses(int _companyId = -1, int _licence = -1,
            bool _userAssign = false)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Warehouses>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetWarehouses", -1, _companyId, _licence);

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Warehouses> resultList = Common.ResolveSAPViewODBC<Warehouses>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<Warehouses>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Warehouses>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetWarehouses").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<Warehouses>>();
                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of warehouses whose names match the given filter.
        /// Chooses between ODBC and Service Layer queries based on the current connection mode.
        /// </summary>
        /// <param name="filterWarehouse">
        /// The substring to match against warehouse names (case-insensitive).
        /// </param>
        /// <param name="companyId">
        /// Optional company identifier; if -1, the current company context is used.
        /// </param>
        /// <param name="licence">
        /// Optional licence identifier; if -1, the current licence context is used.
        /// </param>
        /// <param name="userAssign">
        /// If true, filters warehouses by the current user's assignments.
        /// </param>
        /// <returns>
        /// A task that returns a <see cref="CLContext{List{Warehouses}}"/> containing the filtered warehouses.
        /// </returns>
        public static async Task<CLContext<List<Warehouses>>> GetWarehousesByFilter(
            string filterWarehouse,
            int companyId = -1,
            int licence = -1,
            bool userAssign = false)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Warehouses>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC =
                    GetUserCtxODBC("ODBC_GetWarehousesByFilter");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Warehouses> resultList = Common.ResolveSAPViewODBC<Warehouses>(contextODBC, new Dictionary<string, object>()
                {
                    { "@FilterWarehouse", filterWarehouse }
                });

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<Warehouses>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Warehouses>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetWarehousesByFilter")
                    .Get<FilterWarehouses>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<Warehouses>>();

                #endregion
            }

            return oClContext;
        }


        /// <summary>
        /// Retrieves warehouse information based on the specified warehouse code.
        /// </summary>
        /// <param name="_whsCode">The warehouse code used to retrieve warehouse information.</param>
        /// <returns>An asynchronous task that returns a context containing information about the warehouse identified by the warehouse code.</returns>
        public static async Task<CLContext<Warehouses>> GetWarehouse(string _whsCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<Warehouses> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetWarehousesByWhsCode");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Warehouses> resultList = Common.ResolveSAPViewODBC<Warehouses>(contextODBC, new Dictionary<string, object>()
                {
                    {"@WhsCode", $"{_whsCode}"}
                });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<Warehouses>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<Warehouses>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetWarehousesByWhsCode").Get<FilterBaseWhsCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<Warehouses>();
                #endregion
            }

            return oClContext;
        }

        #endregion

        #region WithholdingTax

        /// <summary>
        /// Asynchronously retrieves a list of withholding tax records.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation, containing a <see cref="CLContext{T}"/>  
        /// with a list of <see cref="WithholdingTax"/> records.
        /// </returns>
        public static async Task<CLContext<List<WithholdingTax>>> GetWithholdingTax()
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<WithholdingTax>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_WithholdingTax");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<WithholdingTax> resultList = Common.ResolveSAPViewODBC<WithholdingTax>(contextODBC);
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<WithholdingTax>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<WithholdingTax>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_WithholdingTax").Get();
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                oClContext = await requestModel.SendAsync<List<WithholdingTax>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of withholding taxes applicable to a specific business partner.
        /// </summary>
        /// <param name="_cardCode">The unique identifier of the business partner (optional).</param>
        /// <returns>
        /// A task representing the asynchronous operation, containing a CLContext with a list of 
        /// withholding taxes associated with the specified business partner.
        /// </returns>
        public static async Task<CLContext<List<WithholdingTaxByBP>>> GetWithholdingTaxByBP(string cardCode = null)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<WithholdingTaxByBP>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_WithholdingTaxByBP");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<WithholdingTaxByBP> resultList = Common.ResolveSAPViewODBC<WithholdingTaxByBP>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", cardCode }
                    });
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<WithholdingTaxByBP>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<WithholdingTaxByBP>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_WithholdingTaxByBP") 

                    .Get(new FilterWithholdingTax(){ 
                        CardCode = cardCode 
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                oClContext = await requestModel.SendAsync<List<WithholdingTaxByBP>>();
            }

            return oClContext;
        }

        #endregion

        #region ItemPrices

        /// <summary>
        /// Retrieves the price of a specific item from a given price list.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_itemCode">The item code to retrieve the price for.</param>
        /// <param name="_priceList">The price list identifier.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing an <see cref="ItemPrice"/> with the price information.
        /// </returns>
        public static async Task<CLContext<ItemPrice>> GetItemPrice(string _itemCode, int _priceList)
        {
            LogManager.Record($"REQUESTING RECORD");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetItemPrices");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@ItemCode", _itemCode ?? "" },
                    { "@PriceList", _priceList }
                };

                List<ItemPrice> resultList =
                     Common.ResolveSAPViewODBC<ItemPrice>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<ItemPrice>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<ItemPrice>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterItemPrices filter = new FilterItemPrices
                {
                    ItemCode = _itemCode ?? "",
                    PriceList = _priceList
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetItemPrices").Get<FilterItemPrices>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<ItemPrice>();

                #endregion
            }
        }

        #endregion

        #region Items

        /// <summary>
        /// Retrieves a list of items available for stock transfer from the specified warehouse.
        /// </summary>
        /// <param name="_whsCode">The warehouse code to filter items.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a CLContext object with a list of items available for transfer.</returns>
        public static async Task<CLContext<List<ItemsForTransferStock>>> GetItemsForTansfersRequest(string _whsCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemsForTransferStock>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemsForTansfersRequest");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsForTransferStock> resultList = Common.ResolveSAPViewODBC<ItemsForTransferStock>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@WhsCode", $"{_whsCode}"},
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<ItemsForTransferStock>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemsForTransferStock>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetItemsForTansfersRequest").Get<FilterBaseWhsCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemsForTransferStock>>();
                #endregion
            }


            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();

            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(_tf => _tf.CompanyId == oCompanyId);

            foreach (ItemsForTransferStock oItemsModel in oClContext.Response.Data)
            {
                oItemsModel.Stock = Convert.ToDecimal(oItemsModel.Stock).ToString("0.##");
                oItemsModel.Typehead = ItemTypeheadFormat(pattern?.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.Stock, oItemsModel.Barcode,
                    oItemsModel.DistNumber, null);
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }
        
       /// <summary>
        /// Retrieves items available for stock transfer from a specified warehouse and item code.
        /// </summary>
        /// <param name="_whsCode">The warehouse code to filter items.</param>
        /// <param name="_itemCode">The item code to filter items.</param>
        /// <returns>A CLContext object containing a list of items available for transfer.</returns>
        public static async Task<CLContext<List<ItemsForTransferStock>>> GetItemsForTansfersRequestPagination(string _whsCode, string _itemCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemsForTransferStock>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemsForTansfersRequestModal");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsForTransferStock> resultList = Common.ResolveSAPViewODBC<ItemsForTransferStock>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@WhsCode", $"{_whsCode}"},
                        {"@ItemCode", $"{_itemCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<ItemsForTransferStock>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemsForTransferStock>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetItemsForTansfersRequestModal").Get<FilterBaseWhsCodeItemCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemsForTransferStock>>();
                #endregion

            }

            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();

            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(_tf => _tf.CompanyId == oCompanyId);

            foreach (ItemsForTransferStock oItemsModel in oClContext.Response.Data)
            {
                oItemsModel.Stock = Convert.ToDecimal(oItemsModel.Stock).ToString("0.##");
                oItemsModel.Typehead = ItemTypeheadFormat(pattern?.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.Stock, oItemsModel.Barcode,
                    oItemsModel.DistNumber, null);
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves the list of items available for stock transfer asynchronously.
        /// </summary>
        /// <param name="_whsCode">The warehouse code to filter items.</param>
        /// <param name="_binAbs">The bin location identifier.</param>
        /// <param name="_warehouseDefault">The default warehouse name.</param>
        /// <returns>A task that returns a CLContext containing a list of ItemsForTransferStock objects.</returns>
        public static async Task<CLContext<List<ItemsForTransferStock>>> GetItemsForTansfers(string _whsCode, int _binAbs, string _warehouseDefault)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemsForTransferStock>> oCLContext = null;
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemsForTransfers");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsForTransferStock> resultList = Common.ResolveSAPViewODBC<ItemsForTransferStock>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@WhsCode", $"{_whsCode}"},
                        {"@WarehouseDefault", $"{_warehouseDefault}"},
                        {"@BinAbs", $"{_binAbs}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = new CLContext<List<ItemsForTransferStock>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemsForTransferStock>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetItemsForTransfers").Get<FilterItemsForTransfer>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = await requestModel.SendAsync<List<ItemsForTransferStock>>();
                #endregion
            }


            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();
            
            SettingTypeaheadFormat pattern = companiesTypeaheadFormat.FirstOrDefault(_tf => _tf.CompanyId == oCompanyId);

            foreach (ItemsForTransferStock oItemsModel in oCLContext.Response.Data)
            {
                oItemsModel.Stock = Convert.ToDecimal(oItemsModel.Stock).ToString("0.##");
                oItemsModel.Typehead = ItemTypeheadFormat(pattern?.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.Stock, oItemsModel.Barcode,
                    oItemsModel.DistNumber, null);
            }

            LogManager.Record("REQUEST COMPLETED");

            return oCLContext;
        }
        
       /// <summary>
        /// Retrieves a paginated list of items available for transfer stock asynchronously.
        /// </summary>
        /// <param name="_whsCode">The warehouse code to filter items.</param>
        /// <param name="_binAbs">The absolute bin location identifier.</param>
        /// <param name="_warehouseDefault">The default warehouse name.</param>
        /// <param name="_itemCode">The item code to filter specific items.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a CLContext
        /// with a list of ItemsForTransferStock objects, including pagination and typeahead formatting.
        /// </returns>
        public static async Task<CLContext<List<ItemsForTransferStock>>> GetItemsForTansfersPagination(string _whsCode, int _binAbs, string _warehouseDefault, string _itemCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemsForTransferStock>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetItemsForTransfersModal");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsForTransferStock> resultList = Common.ResolveSAPViewODBC<ItemsForTransferStock>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@WhsCode", $"{_whsCode}"},
                        {"@WarehouseDefault", $"{_warehouseDefault}"},
                        {"@BinAbs", $"{_binAbs}"},
                        {"@ItemCode", $"{_itemCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<ItemsForTransferStock>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemsForTransferStock>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetItemsForTransfersModal").Get<FilterItemsForTransferPagination>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemsForTransferStock>>();
                #endregion

            }


            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();
            
            SettingTypeaheadFormat pattern = companiesTypeaheadFormat.FirstOrDefault(_tf => _tf.CompanyId ==oCompanyId);

            foreach (ItemsForTransferStock oItemsModel in oClContext.Response.Data)
            {
                oItemsModel.Stock = Convert.ToDecimal(oItemsModel.Stock).ToString("0.##");
                oItemsModel.Typehead = ItemTypeheadFormat(pattern?.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.Stock, oItemsModel.Barcode,
                    oItemsModel.DistNumber, null);
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves an item based on the specified parameters.
        /// </summary>
        /// <param name="_itemCode">The item code used for retrieval.</param>
        /// <param name="_whsCode">The warehouse code used for retrieval.</param>
        /// <param name="_priceList">The price list used for retrieval.</param>
        /// <param name="_cardCode">The card code used for retrieval.</param>
        /// <param name="_prchseItem">The purchase item used for retrieval.</param>
        /// <param name="_sysNumber">The system number used for retrieval.</param>
        /// <param name="_viewType">The view type used for retrieval.</param>
        /// <returns>An asynchronous task that returns a CLContext containing an ItemsModelSap object based on the provided parameters.</returns>
        public static async Task<CLContext<ItemsModelSap>> GetItem(string _itemCode, string _whsCode, int _priceList, string _cardCode,
            string _prchseItem,int _sysNumber, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORD");

            bool HasDiscountApplied = false;
            string resource = "";
            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemInventory";
                    break;
                case ItemsFilterType.PrchseItem:
                    resource = "GetItemPurchase"; 
                    break;
                case ItemsFilterType.SellItem:
                    resource = "GetItemSale";
                    break;
            }

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            ItemsModelSap item = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemsModelSap> resultList = Common.ResolveSAPViewODBC<ItemsModelSap>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@PriceList", $"{_priceList}"},
                        {"@WhsCode", $"{_whsCode}"},
                        {"@CardCode", $"{_cardCode}"},
                        {"@SysNumber", $"{_sysNumber}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                item = resultList.FirstOrDefault();
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get<FilterItem>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                CLContext<ItemsModelSap> oClContex = await requestModel.SendAsync<ItemsModelSap>();

                item = oClContex.Response.Data;
                #endregion
            }

            if (item is object)
            {
                CLContext<List<UoMMasterData>> oUoMContext = await GetUomMasterData(_itemCode,_whsCode,_priceList,_prchseItem);

                item.UoMMasterData = oUoMContext.Response.Data;
            }

            #region OBTIENE LAS MONEDAS ADICIONALES

            if (item is object)
            {
                item.LinesCurrenciesList =
                    await GetAdditionalCurrencies(item.ItemCode,
                        item.PriceList);
            }

            #endregion

            #region OBTENER LISTA DE MATERIALES

            if (item is object && item.TreeType == "S")
            {
                List<BillOfMaterial> resultMaterialList;

                if (connectionMode == SapConnectionType.ODBC)
                {
                    var ctxMaterial = GetUserCtxODBC("ODBC_GetItemMaterial");
                    resultMaterialList = Common.ResolveSAPViewODBC<BillOfMaterial>(
                        ctxMaterial,
                        new Dictionary<string, object>
                        {
                            { "@ItemCode", item.ItemCode },
                            { "@WhsCode",  item.WhsCode  },
                            { "@PriceList", item.PriceList }
                        });
                }
                else
                {
                    var reqMaterial = GetUserCtx("SL_GetItemMaterial")
                        .Get(new FilterListMaterial()
                        {
                            ItemCode = item.ItemCode,
                            WhsCode = item.WhsCode,
                            PriceList = item.PriceList
                        });
                    var slMatCtx = await reqMaterial.SendAsync<List<BillOfMaterial>>();
                    resultMaterialList = slMatCtx.Response.Data;
                }

                item.BillOfMaterial = resultMaterialList;

                foreach (var mat in item.BillOfMaterial)
                {
                    mat.LinesCurrenciesList = await GetAdditionalCurrencies(mat.ItemCode, mat.PriceList);
                    mat.UoMMasterData = await GetUomMasterDataFilter(mat.ItemCode, mat.WhsCode, mat.PriceList, "N");

                    if (mat.ManSerNum == "Y")
                    {
                        List<OnHandSeries> seriesList;

                        if (connectionMode == SapConnectionType.ODBC)
                        {
                            var ctxSeriesOdbc = GetUserCtxODBC("ODBC_GetOnHanSeries");
                            seriesList = Common.ResolveSAPViewODBC<OnHandSeries>(
                                ctxSeriesOdbc,
                                new Dictionary<string, object>
                                {
                                    { "@ItemCode", mat.ItemCode },
                                    { "@WhsCode",  mat.WhsCode  }
                                });
                        }
                        else
                        {
                            var reqSeries = GetUserCtx("SL_GetOnHanSeries")
                                .Get(new FilterSeriesSap(){ 
                                    ItemCode = mat.ItemCode, 
                                    WhsCode = mat.WhsCode 
                                });
                            var slSeriesCtx = await reqSeries.SendAsync<List<OnHandSeries>>();
                            seriesList = slSeriesCtx.Response.Data;
                        }

                        mat.OnHand = seriesList.FirstOrDefault()?.OnHand ?? 0;
                    }
                }
            }

            #endregion

            #region OBTIENE DESCUENTO DEL ITEM

            if (item is object && !CollectionUtilities.IsNullOrEmpty(_cardCode))
            {
                //se optienen los descuentos del item
                CLContext<List<ItemDiscount>> oClContextDiscounts = await GetDiscountByItem(_cardCode,
                    item?.ItemCode);

                //se evalua si tiene algun descuento configurado, en caso de que no se agrega el descuento en cero
                if (oClContextDiscounts.Response.Data is object && oClContextDiscounts.Response.Data.ToList().Count > 0)
                {
                    // se optienen las jerarquias de descuento que tiene configurada la compania
                    int companyId = GetCompanyId();
                    CLContext<IEnumerable<DiscountHierarchy>> oClContextDiscountsHierarchies = GetDiscountHierarchiesToAplicate(companyId);

                    //se evalua si tienen alguna jerarquia configurada en caso de que no, se agrega en descuento cero
                    if (oClContextDiscountsHierarchies.Response.Data is object && oClContextDiscountsHierarchies.Response.Data.ToList().Count > 0)
                    {
                        var result  = GetDiscountForAplicate(oClContextDiscounts.Response.Data.ToList(), oClContextDiscountsHierarchies.Response.Data.ToList());
                        item.DiscountPercent = (decimal)result.discount;
                        HasDiscountApplied=result.HasDiscountApplied;
                        if (item.DiscountPercent == 0)
                        {
                            if (oClContextDiscounts.Response.Data is object && oClContextDiscounts.Response.Data.ToList().Count > 0)
                            {
                                //Se evalua los descuentos por busqueda fortmateadas
                                ItemDiscount total = oClContextDiscounts.Response.Data.Find(_discounts => _discounts.GroupType=="S" && _discounts.ObjType=="7");
                                item.DiscountPercent = (decimal)(total!=null ? total.Discount : 0);
                            }
                        }
                    }
                    else
                    {
                        switch (_viewType)
                        {
                            case ItemsFilterType.InvntItem:
                                 //se optienen los descuentos del item cuando no esta activa las jerarquias
                                 item.DiscountPercent = (decimal)await GetTotalDiscount(_cardCode, item?.ItemCode,"C");
                                break;
                            case ItemsFilterType.PrchseItem:
                                //se optienen los descuentos del item cuando no esta activa las jerarquias
                                item.DiscountPercent = (decimal)await GetTotalDiscount(_cardCode, item?.ItemCode,"C");
                                break;
                            case ItemsFilterType.SellItem:
                                //se optienen los descuentos del item cuando no esta activa las jerarquias
                                item.DiscountPercent = (decimal)await GetTotalDiscount(_cardCode, item?.ItemCode,"V");
                                break;
                        }
                    }
                }

                item.HasDiscountApplied = HasDiscountApplied;

            }
            
            #endregion

            LogManager.Record("REQUEST COMPLETED");

            return  new CLContext<ItemsModelSap>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<ItemsModelSap>()
                {
                    Data = item
                },
                value = item
            };
        }

        /// <summary>
        /// Retrieves a list of additional currencies for a given item and price list.
        /// </summary>
        /// <param name="_itemcode">The code of the item for which additional currencies are to be retrieved.</param>
        /// <param name="_priceList">The price list identifier used to filter the currencies.</param>
        /// <returns>A task representing the asynchronous operation, with a list of <see cref="LinesCurrencies"/> as the result, 
        /// containing the additional currencies available for the specified item and price list.</returns>
        private static async Task<List<LinesCurrencies>> GetAdditionalCurrencies(string _itemcode, int _priceList)
        {
            LogManager.Record("REQUESTING CURRENCIES DATA");

            List<LinesCurrencies> oList = new List<LinesCurrencies>();

            CLContext<List<SettingFieldsInvoice>>
                oSettingFieldsInvoice = GetSettingByCode<List<SettingFieldsInvoice>>(SettingCode.FieldsInvoice);

            if (oSettingFieldsInvoice is object && oSettingFieldsInvoice.Response.Data is object)
            {
                int companyId = GetCompanyId();

                SettingFieldsInvoice data = oSettingFieldsInvoice.Response.Data.Find(x => x.CompanyId == companyId);

                if (data is object && data.ChangeCurrencyLine)
                {
                    string connectionMode = GetConnectionMode();

                    LogManager.Record($"CONNECTION MODE: {connectionMode}");

                    CLContext<CurrenciesAdditional> oClContextCurrAdditional = null;

                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        #region Query Via ODBC
                        ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetLinesCurrencies");
                        LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                        List<CurrenciesAdditional> resultList = Common.ResolveSAPViewODBC<CurrenciesAdditional>(contextODBC,
                            new Dictionary<string, object>()
                            {
                                {"@ItemCode", _itemcode},
                                {"@PriceList", _priceList}
                            });

                        LogManager.Record($"REQUESTING COMPLETED");

                        oClContextCurrAdditional =  new CLContext<CurrenciesAdditional>()
                        {
                            Code = HttpStatusCode.OK,
                            Response = new Response<CurrenciesAdditional>()
                            {
                                Data = resultList.FirstOrDefault()
                            },
                            value = resultList.FirstOrDefault()
                        };
                        #endregion
                    }
                    else
                    {
                        #region Query Via SL
                        SLRequestObject requestModel = GetUserCtx("SL_GetLinesCurrencies").Get<FilterItemPrices>(new FilterItemPrices()
                        {
                            ItemCode = _itemcode,
                            PriceList = _priceList
                        });

                        LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                        LogManager.Record($"REQUESTING COMPLETED");

                        oClContextCurrAdditional = await requestModel.SendAsync<CurrenciesAdditional>();
                        #endregion

                    }


                    if (oClContextCurrAdditional.Response is object &&
                        oClContextCurrAdditional.Response?.Data is object)
                    {
                        oList = GetLinesCurrencies(oClContextCurrAdditional.Response?.Data);
                    }
                }

                LogManager.Record("REQUEST COMPLETED");
            }

            return oList;
        }

        private static List<LinesCurrencies> GetLinesCurrencies(CurrenciesAdditional _currenciesAdditional)
        {
            List<LinesCurrencies> oLinesCurrenciesList = new List<LinesCurrencies>();


            if (!string.IsNullOrEmpty(_currenciesAdditional.Currency))
            {
                oLinesCurrenciesList.Add(new LinesCurrencies()
                {
                    Id = "0",
                    DocCurrency = _currenciesAdditional.Currency,
                    Description = $"{_currenciesAdditional.Currency} - Moneda primaria",
                    Price = _currenciesAdditional.Price
                });
            }

            if (!string.IsNullOrEmpty(_currenciesAdditional.Currency1))
            {
                oLinesCurrenciesList.Add(new LinesCurrencies()
                {
                    Id = "1",
                    DocCurrency = _currenciesAdditional.Currency1,
                    Description = $"{_currenciesAdditional.Currency1} - Moneda adicional 1",
                    Price = _currenciesAdditional.AddPrice1
                });
            }

            if (!string.IsNullOrEmpty(_currenciesAdditional.Currency2))
            {
                oLinesCurrenciesList.Add(new LinesCurrencies()
                {
                    Id = "2",
                    DocCurrency = _currenciesAdditional.Currency2,
                    Description = $"{_currenciesAdditional.Currency2} - Moneda adicional 2",
                    Price = _currenciesAdditional.AddPrice2
                });
            }

            return oLinesCurrenciesList;
        }

        /// <summary>
        /// Metodo para obtener todos los items
        /// </summary>
        /// <param name="_WhsCode"></param>
        /// <returns></returns>
        public static async Task<CLContext<List<ItemSearch>>> GetItems(string _whsCode, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string resource = "";
            
            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemsForInventory"; 
                    break;
                case ItemsFilterType.PrchseItem:
                    resource = "GetItemsForPurchases";
                    break;
                case ItemsFilterType.SellItem:
                    resource = "GetItemsForSales";
                    break;
                
            }

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemSearch>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemSearch> resultList = Common.ResolveSAPViewODBC<ItemSearch>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@WhsCode", $"{_whsCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = new CLContext<List<ItemSearch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemSearch>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get<FilterBaseWhsCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemSearch>>();
                #endregion
            }

            LogManager.Record($"TYPEAHEAD FORMAT");

            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();

            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);


            decimal number = 0;

            foreach (ItemSearch oItemsModel in oClContext.Response.Data)
            {
                number = 0;
                oItemsModel.OnHand = decimal.TryParse(oItemsModel.OnHand, out number)
                    ? number.ToString("0.##")
                    : oItemsModel.OnHand.ToString();

                oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.OnHand, oItemsModel.BarCode,
                    oItemsModel.DistNumberSerie, oItemsModel.BinCode);
            }

            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of items with filters applied based on item code, warehouse code, and view type.
        /// </summary>
        /// <param name="_itemCode">The code of the item to filter by. If null, it defaults to an empty string.</param>
        /// <param name="_whsCode">The warehouse code to filter the items by.</param>
        /// <param name="_viewType">The type of view to determine the resource for fetching items. 
        /// It can be one of the following: InvntItem, PrchseItem, SellItem.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{ItemSearch}}"/> 
        /// with the list of items that match the specified filters.</returns>
        public static async Task<CLContext<List<ItemSearch>>> GetItemsWithFilters(string _itemCode, string _whsCode, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string resource = "";

            _itemCode = (_itemCode ?? "").ToUpper();

            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemsForInventoryModal";
                    break;
                case ItemsFilterType.PrchseItem:
                    resource = "GetItemsForPurchasesModal";
                    break;
                case ItemsFilterType.SellItem:
                    resource = "GetItemsForSalesModal"; 
                    break;
                
            }

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemSearch>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemSearch> resultList = Common.ResolveSAPViewODBC<ItemSearch>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@WhsCode", $"{_whsCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext =  new CLContext<List<ItemSearch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemSearch>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get(
                    new FilterBaseWhsCodeItemCode()
                    {
                        ItemCode = Uri.EscapeUriString(_itemCode ?? ""),
                        WhsCode = _whsCode
                    }
                );

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemSearch>>();
                #endregion
            }


            LogManager.Record($"TYPEAHEAD FORMAT");
            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();
            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);
            decimal number = 0;
            foreach (ItemSearch oItemsModel in oClContext.Response.Data)
            {
                number = 0;
                oItemsModel.OnHand = decimal.TryParse(oItemsModel.OnHand, out number)
                    ? number.ToString("0.##")
                    : oItemsModel.OnHand.ToString();
                oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.OnHand, oItemsModel.BarCode,
                    oItemsModel.DistNumberSerie, oItemsModel.BinCode);
            }
            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");
            return oClContext;
        }
        
        /// <summary>
        /// Retrieves an item with the current item code, warehouse code, and view type.
        /// </summary>
        /// <param name="_itemCode">The code of the item to filter by.</param>
        /// <param name="_whsCode">The warehouse code to filter the items by.</param>
        /// <param name="_viewType">The type of view to determine the resource for fetching items. 
        /// It can be one of the following: InvntItem, PrchseItem, SellItem.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{ItemSearch}}"/> 
        /// with the list of items that match the specified item code, warehouse code, and view type.</returns>
        public static async Task<CLContext<List<ItemSearch>>> GetItemByScan(string _filterCode, string _whsCode, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORDS");
            string resource = "";
            
            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemForInventoryScan";
                    break;
                case ItemsFilterType.PrchseItem:
                    resource = "GetItemForPurchasesScan";
                    break;
                case ItemsFilterType.SellItem:
                    resource = "GetItemForSalesScan";
                    break;
            }
            
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemSearch>> oClContext = null;
            
            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                
                List<ItemSearch> resultList = Common.ResolveSAPViewODBC<ItemSearch>(contextODBC, new Dictionary<string, object>()
                {
                    {"@FilterCode", $"{_filterCode}"},
                    {"@WhsCode", $"{_whsCode}"}
                });
                
                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<ItemSearch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemSearch>>()
                    {
                        Data = resultList
                    }
                    ,value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                
                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<List<ItemSearch>>();

                #endregion
            }
            
            LogManager.Record($"TYPEAHEAD FORMAT");
            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;
            
            int oCompanyId = GetCompanyId();
            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);
            decimal number = 0;
            foreach (ItemSearch oItemsModel in oClContext.Response.Data)
            {
                number = 0;
                oItemsModel.OnHand = decimal.TryParse(oItemsModel.OnHand, out number)
                    ? number.ToString("0.##")
                    : oItemsModel.OnHand.ToString();
                oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.OnHand, oItemsModel.BarCode,
                    oItemsModel.DistNumberSerie, oItemsModel.BinCode);
            }
            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");
            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");
            return oClContext;
        }

        // <summary>
        /// Retrieves the availability of an item in warehouses asynchronously.
        /// </summary>
        /// <param name="_itemCode">The code of the item to check availability for.</param>
        /// <returns>A task that returns a CLContext containing a list of StockInWarehouses objects.</returns>
        public static async Task<CLContext<List<StockInWarehouses>>> GetItemWarehouseAvailability(string _itemCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStockInWarehouses");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<StockInWarehouses> resultList = Common.ResolveSAPViewODBC<StockInWarehouses>(contextODBC,
                    new Dictionary<string, object>()
                    {
                         {"@ItemCode", _itemCode}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<StockInWarehouses>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<StockInWarehouses>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetStockInWarehouses").Get<FilterBaseItemCode>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<StockInWarehouses>>();
            #endregion

        }
        
        /// <summary>
        /// Method to get items by warehouses
        /// </summary>
        /// <param name="_itemCode">Item to search</param>
        /// <param name="_filterWarehouse">Warehouse to search</param>
        /// <returns></returns>
        public static async Task<CLContext<List<StockInWarehouses>>> WarehouseAvailabilityByFilter(string _itemCode, string _filterWarehouse)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStockInWarehousesByFilter");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<StockInWarehouses> resultList = Common.ResolveSAPViewODBC<StockInWarehouses>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@Warehouse", $"{_filterWarehouse ?? ""}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<StockInWarehouses>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<StockInWarehouses>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetStockInWarehousesByFilter").Get<FilterStockInWarehouses>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<StockInWarehouses>>();
            #endregion

        }

        /// <summary>
        /// Retrieves the available stock of a specific item in a given warehouse.
        /// </summary>
        /// <param name="_itemCode">The code of the item to retrieve the available stock for.</param>
        /// <param name="_whsCode">The code of the warehouse to check for stock availability.</param>
        /// <returns>A CLContext object containing the available stock information.</returns>
        public static async Task<CLContext<StockInWarehouses>> GetStockAvailable(string _itemCode, string _whsCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetStockAvailable");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<StockInWarehouses> resultList = Common.ResolveSAPViewODBC<StockInWarehouses>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@WhsCode", $"{_whsCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<StockInWarehouses>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<StockInWarehouses>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetStockAvailable").Get<FilterBaseWhsCodeItemCode>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<StockInWarehouses>();
            #endregion
        }
        
        /// <summary>
        /// Retrieves item details based on the given item code and document type.
        /// </summary>
        /// <param name="_itemCode">The item code to retrieve details for.</param>
        /// <param name="_docType">The document type to filter the details.</param>
        /// <returns>A CLContext object containing a list of item details or an empty list if not found.</returns>
        public static async Task<CLContext<List<ItemDetail>>> GetItemDetails(string _itemCode, string _docType)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetDetailItem");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<ItemDetail> resultList = Common.ResolveSAPViewODBC<ItemDetail>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@DocType", $"{_docType}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<ItemDetail>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemDetail>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetDetailItem").Get<FilterItemDetail>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<ItemDetail>>();
            #endregion
            
        }

        /// <summary>
        /// Retrieves data for a Good Receipt Invoice, including the last purchase price, average price,
        /// and deviation status for a list of item codes.
        /// </summary>
        /// <param name="itemCodes">A list of item codes to retrieve data for.</param>
        /// <returns>A CLContext containing a list of item data for the Good Receipt Invoice.</returns>
        public static async Task<CLContext<List<ItemDataForInvoiceGoodReceipt>>> GetDataForGoodReceiptInvoice(
            List<string> itemCodes)
        {
            List<ItemDataForInvoiceGoodReceipt> values = new List<ItemDataForInvoiceGoodReceipt>();

            foreach (string ItemCode in itemCodes)
            {
                ItemDataForInvoiceGoodReceipt ItemData = new ItemDataForInvoiceGoodReceipt();

                ItemData.ItemCode = ItemCode;

                CLContext<ItemDataForInvoiceGoodReceipt> oLastPriceContext = await GetItemLastPurchagePrice(ItemCode);

                if (oLastPriceContext.Response != null && oLastPriceContext.Response.Data != null)
                {
                    ItemData.LastPrice = oLastPriceContext.Response.Data.LastPrice;
                }

                CLContext<ItemDataForInvoiceGoodReceipt> oAvgPriceContext = await GetItemAVGPrice(ItemCode);

                if (oAvgPriceContext.Response != null && oAvgPriceContext.Response.Data != null)
                {
                    ItemData.AVGPrice = oAvgPriceContext.Response.Data.AVGPrice;
                }

                CLContext<ValidateDeviation> oClContext = Services
                    .Execute<ValidateDeviation, ItemDeviationFilter, MainDBContext, ICLSingle>("GetValidateDeviation",
                        new ItemDeviationFilter()
                        {
                            ItemCode = HttpUtility.UrlEncode(ItemCode),
                            AVGPrice = ItemData.AVGPrice,
                            LastPrice = ItemData.LastPrice
                        }).Get();

                ItemData.DeviationStatus = oClContext.Response.Data.DeviationStatus;
                ItemData.Message = oClContext.Response.Data.Message;

                values.Add(ItemData);
            }

            return new CLContext<List<ItemDataForInvoiceGoodReceipt>>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<ItemDataForInvoiceGoodReceipt>>()
                {
                    Data = values,
                    Message = ""
                }
            };
        }
        
        /// <summary>
        /// Retrieves all items for inventory entry modal with typeahead formatting.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_itemCode">The item code filter.</param>
        /// <param name="_whsCode">The warehouse code filter.</param>
        /// <param name="_viewType">The view type filter (e.g., InvntItem).</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{ItemSearch}"/> with formatted typeahead data.
        /// </returns>
        public static async Task<CLContext<List<ItemSearch>>> GetItemsEntryForInventoryModal(string _itemCode, string _whsCode, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (_itemCode == null)
            {
                _itemCode = " ";
            }

            string resource = "";
            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemsEntryForInventoryModal";
                    break;
            }

            CLContext<List<ItemSearch>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@ItemCode", _itemCode.ToUpper() },
                    { "@WhsCode", _whsCode ?? "" }
                };

                List<ItemSearch> resultList =
                     Common.ResolveSAPViewODBC<ItemSearch>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                oClContext = new CLContext<List<ItemSearch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemSearch>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterItemsPagination filter = new FilterItemsPagination
                {
                    ItemCode = _itemCode.ToUpper(),
                    WhsCode = _whsCode ?? ""
                };

                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get<FilterItemsPagination>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemSearch>>();

                #endregion
            }

            // Apply TypeAhead formatting to results
            LogManager.Record($"TYPEAHEAD FORMAT");
            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;

            int oCompanyId = GetCompanyId();
            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);
            decimal number = 0;
            foreach (ItemSearch oItemsModel in oClContext.Response.Data)
            {
                number = 0;
                oItemsModel.OnHand = decimal.TryParse(oItemsModel.OnHand, out number)
                    ? number.ToString("0.##")
                    : oItemsModel.OnHand.ToString();
                oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.OnHand, oItemsModel.BarCode,
                    oItemsModel.DistNumberSerie, oItemsModel.BinCode);
            }
            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");
            return oClContext;
        }
       
        
        /// <summary>
        /// Retrieves all items for inventory entry filtered by warehouse with typeahead formatting.
        /// Uses ODBC or SAP Service Layer based on the current connection mode.
        /// </summary>
        /// <param name="_whsCode">The warehouse code filter.</param>
        /// <param name="_viewType">The view type filter (e.g., InvntItem).</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a <see cref="List{ItemSearch}"/> with formatted typeahead data.
        /// </returns>
        public static async Task<CLContext<List<ItemSearch>>> GetItemsInventoryEntry(string _whsCode, string _viewType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string resource = "";
            switch (_viewType)
            {
                case ItemsFilterType.InvntItem:
                    resource = "GetItemsInventoryEntry";
                    break;
            }

            CLContext<List<ItemSearch>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_{resource}");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@WhsCode", _whsCode ?? "" }
                };

                List<ItemSearch> resultList =
                     Common.ResolveSAPViewODBC<ItemSearch>(contextODBC, parametersODBC);

                LogManager.Record($"REQUEST COMPLETED");

                oClContext = new CLContext<List<ItemSearch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemSearch>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterItems filter = new FilterItems
                {
                    WhsCode = _whsCode ?? ""
                };

                SLRequestObject requestModel = GetUserCtx($"SL_{resource}").Get<FilterItems>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<ItemSearch>>();

                #endregion
            }

            // Apply TypeAhead formatting to results
            LogManager.Record($"TYPEAHEAD FORMAT");

            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>(SettingCode.PatternTypeahead).Response.Data;

            int oCompanyId = GetCompanyId();

            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);

            decimal number = 0;

            foreach (ItemSearch oItemsModel in oClContext.Response.Data)
            {
                number = 0;
                oItemsModel.OnHand = decimal.TryParse(oItemsModel.OnHand, out number)
                    ? number.ToString("0.##")
                    : oItemsModel.OnHand.ToString();

                oItemsModel.TypeAheadFormat = ItemTypeheadFormat(pattern.ItemPattern, oItemsModel.ItemCode,
                    oItemsModel.ItemName, oItemsModel.OnHand, oItemsModel.BarCode,
                    oItemsModel.DistNumberSerie, oItemsModel.BinCode);
            }

            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");

            return oClContext;
        }

        public static async Task<CLContext<ItemModel>> CreateItem(ItemsModel _item)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            #region VALIDAR SI EXISTE CODIGO DE BARRAS

            if (_item.ItemBarCodeCollection is object && _item.ItemBarCodeCollection.Count > 0)
            {
                string connectionMode = GetConnectionMode();

                LogManager.Record($"CONNECTION MODE: {connectionMode}");

                ClUserContextODBC contextODBC = null;
                ClUserContext oUserContext = null;

                if (connectionMode == SapConnectionType.ODBC)
                {
                    contextODBC = GetUserCtxODBC("ODBC_ExistsBarcode");
                    LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                }
                else
                {
                    oUserContext = GetUserCtx("SL_ExistsBarcode");
                }

                foreach (BarCodeMasterData barCode in _item.ItemBarCodeCollection)
                {
                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        #region Query Via ODBC
                        List<BarCodeMasterData> resultList = Common.ResolveSAPViewODBC<BarCodeMasterData>(contextODBC,
                            new Dictionary<string, object>()
                            {
                                {"@BarCode", $"{barCode.Barcode}"}
                            });

                        LogManager.Record($"REQUESTING COMPLETED");

                        if (resultList != null && resultList.Count > 0)
                        {
                            throw new CLException($"EL Codigo de barras {barCode.Barcode} ya se encuentra registrado.",
                                HttpStatusCode.MultipleChoices);
                        }
                        #endregion
                    }
                    else
                    {
                        #region Query Via SL
                        SLRequestObject oSlRequestObjectBarCode = oUserContext.Get(new FilterExistsBarcode()
                        {
                            BarCode = barCode.Barcode
                        });

                        CLContext<BarCodeMasterData> oContextExists =
                            await oSlRequestObjectBarCode.SendAsync<BarCodeMasterData>();

                        if (oContextExists.Response.Data is object)
                        {
                            throw new CLException($"EL Codigo de barras {barCode.Barcode} ya se encuentra registrado.",
                                HttpStatusCode.MultipleChoices);
                        }
                        #endregion
                    }
                }
            }

            #endregion

            string headerProperties =
                "OnHand,IsCommited,OnOrder,WhsCode,BillOfMaterial,PriceList,ItemClass,Frozen,ItemBarCodeCollection,InventoryItem,SalesItem,PurchaseItem,UoMEntry,TaxOnly,TaxCode,TaxRate,UnitPrice,UnitPriceFC,Discount,UoMMasterData,LastPurchasePrice,HasInconsistency,InconsistencyMessage,LastPurchasePriceFC,LinesCurrenciesList,DiscountPercent,Quantity";

            if (string.IsNullOrEmpty(_item.ItemCode))
            {
                headerProperties = $"{headerProperties},ItemCode";
            }
            
            string lineProperties = "ItemCode";

            SeriesByUser oSerie = GetSerie((int)Constants.DocumentType.Items);

            _item.Series = oSerie.NoSerie;


            SLRequestObject requestModel = GetUserCtx("PostItem").Post(_item
                , _fieldsToRemoveInHeaders: headerProperties, _fieldsToRemoveInLines: lineProperties,
                _lineObjectName: "ItemPrices");

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            CLContext<ItemModel> oClContext = await requestModel.SendAsync<ItemModel>();

            //Si vienen codigos de barras, los registramos
            if (_item.ItemBarCodeCollection != null && _item.ItemBarCodeCollection.Count > 0)
            {
                foreach (BarCodeMasterData barCode in _item.ItemBarCodeCollection)
                {
                    barCode.ItemNo = oClContext.Response.Data.ItemCode;
                }

                await InsertBarcodes(_item.ItemBarCodeCollection);
            }

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Method to update item
        /// </summary>
        /// <param name="_item">Item to update</param>
        /// <returns></returns>
        public static async Task<CLContext<ItemModel>> UpdateItem(ItemsModel _item)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "OnHand",
                "IsCommited",
                "OnOrder",
                "WhsCode",
                "ItemClass",
                "Frozen",
                "ItemBarCodeCollection",
                "InventoryItem",
                "SalesItem",
                "PurchaseItem",
                "UoMEntry",
                "TaxOnly",
                "TaxCode",
                "TaxRate",
                "UnitPrice",
                "UnitPriceFC",
                "Discount",
                "UoMMasterData",
                "LastPurchasePrice",
                "HasInconsistency",
                "InconsistencyMessage",
                "ItemCode",
                "ItemCode",
                "Series",
                "LastPurchasePriceFC",
                "BillOfMaterial",
                "PriceList",
                "LinesCurrenciesList",
                "DiscountPercent",
                "Quantity"
            };

            string headerProperties = string.Join(",", oRemoveHeaderProperties);

            List<string> oRemoveLineProperties = new List<string>()
            {
                "ItemCode"
            };

            string lineProperties = string.Join(",", oRemoveLineProperties);

            SLRequestObject requestModel = GetUserCtx("PostItem").Patch(_item
                , _fieldsToRemoveInHeaders: headerProperties, _fieldsToRemoveInLines: lineProperties,
                _lineObjectName: "ItemPrices");

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            CLContext<ItemModel> oClContext = await requestModel.SendAsync<ItemModel>();

            //Si vienen codigos de barras, los actualizamos
            if (_item.ItemBarCodeCollection != null && _item.ItemBarCodeCollection.Count > 0)
            {
                foreach (BarCodeMasterData barCode in _item.ItemBarCodeCollection)
                {
                    barCode.ItemNo = HttpUtility.UrlDecode(_item.ItemCode);
                }

                await UpdateBarcodes(_item.ItemBarCodeCollection);
            }

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves the list of serial numbers for a specific item and warehouse.
        /// </summary>
        /// <param name="_itemCode">The code of the item to retrieve serial numbers for.</param>
        /// <param name="_whsCode">The code of the warehouse where the item is stored.</param>
        /// <returns>A context containing the list of serial numbers.</returns>
        public static async Task<CLContext<List<SerialNumbers>>> GetItemSeriesByWarehouse(string _itemCode, string _whsCode)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSeriesForList");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<SerialNumbers> resultList = Common.ResolveSAPViewODBC<SerialNumbers>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@ItemCode", $"{_itemCode}"},
                        {"@WhsCode", $"{_whsCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<SerialNumbers>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SerialNumbers>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetSeriesForList").Get<FilterBaseWhsCodeItemCode>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<SerialNumbers>>();
            #endregion
            
        }

        /// <summary>
        /// Retrieves the required information of bill of materials to sync in the mobile application
        /// </summary>
        /// <returns>A CLContext with the collection of bill of materials information</returns>
        public static async Task<CLContext<List<BillOfMaterialToSync>>> GetBillOfMaterialsToSync(DateTime pLastUpdate)
        {
            LogManager.Record("REQUESTING BILL OF MATERIALS INFORMATION...");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetBillOfMaterialsToSync");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BillOfMaterialToSync> resultList = Common.ResolveSAPViewODBC<BillOfMaterialToSync>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@LastUpdate", $"{pLastUpdate.ToCustomTimeSpan()}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<BillOfMaterialToSync>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BillOfMaterialToSync>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetBillOfMaterialsToSync").Get(new BillOfMaterialsSyncFilter()
                {
                    LastUpdate = pLastUpdate.ToCustomTimeSpan()
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<BillOfMaterialToSync>>();
                #endregion
            }
        }
        
        /// <summary>
        /// Retrieves the count of bill of materials that were modified in an specific date range
        /// </summary>
        public static async Task<CLContext<MobileChangeInformation>> GetMobileBillOfMaterialsCount(DateTime pLastUpdate)
        {
            CLContext<List<BillOfMaterialToSync>> oMobileBillOfMaterials = await GetBillOfMaterialsToSync(pLastUpdate);

            int count = oMobileBillOfMaterials.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.BillOfMaterials
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }
        #endregion
        
        #region DiscountItem
            
        /// <summary>
        /// Asynchronously retrieves a list of item discounts based on the specified card code and item code.
        /// </summary>
        /// <param name="_cardCode">The card code representing the business partner for which the discount is requested.</param>
        /// <param name="_itemCode">The item code representing the specific item for which the discount is requested.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{ItemDiscount}}"/>
        /// object which includes the HTTP status code and a response containing a list of <see cref="ItemDiscount"/> objects.
        /// </returns>
        public static async Task<CLContext<List<ItemDiscount>>> GetDiscountByItem(string cardCode, string itemCode)
        {
            LogManager.Record($"REQUESTING DISCOUNT BY ITEM... | ITEMCODE: {itemCode} CARDCODE: {cardCode}");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemDiscount>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetDiscountByItem");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<ItemDiscount> resultList = Common.ResolveSAPViewODBC<ItemDiscount>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", cardCode },
                        { "@ItemCode", itemCode }
                    });
                LogManager.Record("DISCOUNT BY ITEM REQUESTED");
                oClContext = new CLContext<List<ItemDiscount>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemDiscount>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetDiscountByItem").Get(
                    new FilterDiscountByItem(){ 
                        CardCode = cardCode, 
                        ItemCode = itemCode 
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<List<ItemDiscount>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Method to get dicount by hierarchies
        /// </summary>
        /// <param name="_itemDiscounts">Item to get discount</param>
        /// <param name="_discountHierarchies">Hierarchies configured</param>
        /// <returns></returns>
        private static (double discount, bool HasDiscountApplied) GetDiscountForAplicate(List<ItemDiscount> _itemDiscounts, List<DiscountHierarchy> _discountHierarchies)
        {
            double discount;
            bool hasDiscountApplied = false;
            foreach (DiscountHierarchy hierarchy in _discountHierarchies)
            {
                discount = -1;
                switch (hierarchy.Type)
                {
                    case (int)TypesOfDiscountHierarchy.BUSINESSPARTNER:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.SPECIFIC_BP && 
                                                                  _discount.ObjType == ObjectsType.ITEM_PROPERTIES)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.ITEM_GROUP:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.ALL_BPs && 
                                                                    _discount.ObjType == ObjectsType.ITEM_GROUPS)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.CUSTOMER_GROUP_BY_ITEM_GROUP:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP && 
                                                                    _discount.ObjType == ObjectsType.ITEM_GROUPS)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.CUSTOMER_GROUP_BY_ITEM:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP && 
                                                                    _discount.ObjType == ObjectsType.ITEM)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.CUSTOMER_BY_ITEM_GROUP:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.SPECIFIC_BP && 
                                                                    _discount.ObjType == ObjectsType.ITEM_GROUPS)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.CUSTOMER_BY_ITEM:
                        discount = _itemDiscounts.Find(_discount => _discount.GroupType == TypesOfDiscountGrups.SPECIFIC_BP && 
                                                                    _discount.ObjType == ObjectsType.ITEM)?.Discount ?? 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.CUSTOMER_BY_ITEM_FAMILY:
                        discount = 0;
                        break;
                    
                    case (int)TypesOfDiscountHierarchy.GLOBAL_SALES_AGREEMENTS:
                        discount = 0;
                        break;
                    
                }

                if (discount > 0)
                {
                    hasDiscountApplied = true;
                    return (discount ,  hasDiscountApplied);
                }
                
            }
            hasDiscountApplied = false;
            return (0, hasDiscountApplied );
        }
        
        /// <summary>
        /// Method to get discount by business partners
        /// </summary>
        /// <param name="_cardCode"></param>
        /// <param name="_itemCode"></param>
        /// <returns></returns>
        public static async Task<double> GetTotalDiscount(string _cardCode, string _itemCode,string _groupType)
        {
            //se optienen los descuentos del item
            CLContext<List<ItemDiscounts>> oClContextItemsDiscounts = await GetDiscountsByItem(_cardCode, _itemCode, _groupType);
            if (oClContextItemsDiscounts.Response.Data is object && oClContextItemsDiscounts.Response.Data.ToList().Count > 0)
            {
                double total = 0;
                total = CalculateDiscountLine(oClContextItemsDiscounts.Response.Data);
                return total;
            }
            return 0;
        }
        
        /// <summary>
        /// Asynchronously retrieves a list of item discounts based on the specified card code, item code, and group type.
        /// </summary>
        /// <param name="_cardCode">The card code representing the business partner for which the discount is requested.</param>
        /// <param name="_itemCode">The item code representing the specific item for which the discount is requested.</param>
        /// <param name="_groupType">The group type used to filter the discounts.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{ItemDiscounts}}"/>
        /// object which includes the HTTP status code and a response containing a list of <see cref="ItemDiscounts"/> objects.
        /// </returns>
        public static async Task<CLContext<List<ItemDiscounts>>> GetDiscountsByItem(string cardCode, string itemCode, string groupType)
        {
            LogManager.Record($"REQUESTING DISCOUNT BY ITEM... | ITEMCODE: {itemCode} CARDCODE: {cardCode}");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ItemDiscounts>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetDiscountsByItem");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<ItemDiscounts> resultList = Common.ResolveSAPViewODBC<ItemDiscounts>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", cardCode },
                        { "@ItemCode", itemCode },
                        { "@GroupType", groupType }
                    });
                oClContext = new CLContext<List<ItemDiscounts>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ItemDiscounts>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetDiscountsByItem")
                    .Get(new FilterDiscountsByItem(){ 
                        CardCode = cardCode, 
                        ItemCode = itemCode, 
                        GroupType = groupType 
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<List<ItemDiscounts>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Method for managing discount obtaining methods
        /// </summary>
        /// <param name="_itemDiscounts"></param>
        /// <returns></returns>
        public static double CalculateDiscountLine(List<ItemDiscounts> _itemDiscounts)
        {
            double discount = 0;
            ItemDiscounts _discountsData = new ItemDiscounts();
            List<ItemDiscounts> _discountsAux = _itemDiscounts.FindAll(item=>item.ObjType!=ObjectsType.ITEM_PROPERTIES );
            if (_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.ALL_BPs).Count()>0)
            {
                _discountsData=CalculateDiscountForProperties(_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.ALL_BPs).ToList());
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.VENDOR_GROUP).Count()>0)
            {
                _discountsData=CalculateDiscountForProperties(_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.VENDOR_GROUP).ToList());
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP).Count()>0)
            {
                _discountsData=CalculateDiscountForProperties(_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP).ToList());
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.SPECIFIC_BP).Count()>0)
            {
                _discountsData=CalculateDiscountForProperties(_itemDiscounts.Where(p => p.ObjType == ObjectsType.ITEM_PROPERTIES && p.GroupType == TypesOfDiscountGrups.SPECIFIC_BP).ToList());
                _discountsAux.Add(_discountsData);
            }
           
            discount=CalculateDiscountForBp(_discountsAux);
            return discount;
        }

        /// <summary>
        /// Method to get discount by properties of item
        /// </summary>
        /// <param name="_itemDiscounts"></param>
        /// <returns></returns>
        public static ItemDiscounts CalculateDiscountForProperties(List<ItemDiscounts> _itemDiscounts)
        {
            if (_itemDiscounts.Count > 0)
            {
                ItemDiscounts item = new ItemDiscounts();
                double discount = 0;
                switch (_itemDiscounts[0].DiscRelItem)
                {
                    case TypesRelPayForBp.HIGHEST_DISCOUNT:
                        discount= _itemDiscounts.Max<ItemDiscounts>(_discounts => _discounts.Discount);
                        break;

                    case TypesRelPayForBp.LOWEST_DISCOUNT:
                        discount=_itemDiscounts.Min<ItemDiscounts>(_discounts => _discounts.Discount);
                        break;

                    case TypesRelPayForBp.AVERAGE:
                        discount= _itemDiscounts.Average<ItemDiscounts>(_discounts => _discounts.Discount);
                        break;

                    case TypesRelPayForBp.TOTAL:
                        discount = _itemDiscounts.Sum<ItemDiscounts>(_discounts => _discounts.Discount);
                        break;

                    case TypesRelPayForBp.DISCOUNT_MULTIPLES:
                        discount=CalculateMultipleDiscount(_itemDiscounts);
                        break;
                }

                item = _itemDiscounts[0];
                item.Discount = discount;
                return item;
            }
            return null;
        }
        
        /// <summary>
        /// Method to get discount by Business partners
        /// </summary>
        /// <param name="_itemDiscounts"></param>
        /// <returns></returns>
        public static double CalculateDiscountForBp(List<ItemDiscounts> _itemDiscounts)
        {
            double discount=0;
            if (_itemDiscounts.Count > 0)
            {
                switch (_itemDiscounts[0].DiscRelBp)
                {
                    case TypesRelPayForBp.HIGHEST_DISCOUNT:
                        discount=_itemDiscounts.Max<ItemDiscounts>(item => item.Discount);
                        break;

                    case TypesRelPayForBp.LOWEST_DISCOUNT:
                        discount=_itemDiscounts.Min<ItemDiscounts>(item => item.Discount);
                        break;

                    case TypesRelPayForBp.AVERAGE:
                        discount = CalculateDiscountBPAverage(_itemDiscounts);
                        break;

                    case TypesRelPayForBp.TOTAL:
                        discount=_itemDiscounts.Sum<ItemDiscounts>(item => item.Discount);
                        break;

                    case TypesRelPayForBp.DISCOUNT_MULTIPLES:
                        discount = CalculateMultipleDiscount(_itemDiscounts);
                        break;
                }

                if (discount > 0)
                {
                    return discount;
                }
            }
            return discount;
        }
        
        /// <summary>
        /// Method to calculate multiple discount
        /// </summary>
        /// <param name="_discount"></param>
        /// <returns></returns>
        static double CalculateMultipleDiscount(List<ItemDiscounts> _discount)
        {
            double descuentoTotal = 1;
            foreach (ItemDiscounts discount in _discount)
            {
                double descuentoDecimal = discount.Discount / 100; // Convertir el descuento de porcentaje a decimal
                descuentoTotal *= (1 - descuentoDecimal); // Aplicar el descuento
            }

            double descuentoFinal = 1 - descuentoTotal;
            double descuentoFinalPorcentaje = descuentoFinal * 100; // Convertir el descuento final a porcentaje

            return descuentoFinalPorcentaje;
        }
        
        /// <summary>
        /// Method to calculate average for bp
        /// </summary>
        /// <param name="_itemDiscounts"></param>
        /// <returns></returns>
        public static double CalculateDiscountBPAverage(List<ItemDiscounts> _itemDiscounts)
        {
            double discount = 0;
            ItemDiscounts _discountsData = new ItemDiscounts();
            List<ItemDiscounts> _discountsAux = new List<ItemDiscounts>();
            if (_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.ALL_BPs).Count()>0)
            {
                discount = _itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.ALL_BPs).Average(_discounts => _discounts.Discount);
                _discountsData=_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.ALL_BPs).FirstOrDefault();
                _discountsData.Discount = discount;
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p =>  p.GroupType == TypesOfDiscountGrups.VENDOR_GROUP).Count()>0)
            {
                discount = _itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.VENDOR_GROUP).Average(_discounts => _discounts.Discount);
                _discountsData=_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.VENDOR_GROUP).FirstOrDefault();
                _discountsData.Discount = discount;
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP).Count()>0)
            {
                discount = _itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP).Average(_discounts => _discounts.Discount);
                _discountsData=_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.CUSTOMER_GROUP).FirstOrDefault();
                _discountsData.Discount = discount;
                _discountsAux.Add(_discountsData);
            } 
            if (_itemDiscounts.Where(p =>  p.GroupType == TypesOfDiscountGrups.SPECIFIC_BP).Count()>0)
            {
                discount = _itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.SPECIFIC_BP).Average(_discounts => _discounts.Discount);
                _discountsData=_itemDiscounts.Where(p => p.GroupType == TypesOfDiscountGrups.SPECIFIC_BP).FirstOrDefault();
                _discountsData.Discount = discount;
                _discountsAux.Add(_discountsData);
            }

            discount = _discountsAux.Average(_discounts => _discounts.Discount);
            return discount;
        }
        #endregion

        #region BinLocations

        /// <summary>
        /// Retrieves a list of bin (location) allocations for a specific item in a specific warehouse,
        /// based on the current SAP connection mode (ODBC or Service Layer).
        /// </summary>
        /// <param name="itemCode">The code of the item to retrieve bin allocations for.</param>
        /// <param name="whsCode">The code of the warehouse where the item is stored.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result is a <see cref="CLContext{List{Location}}"/>
        /// containing the list of bin allocations for the specified item and warehouse.
        /// </returns>
        public static async Task<CLContext<List<Location>>> GetBinAllocations(string itemCode, string whsCode)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Location>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_Getlocations");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<Location> resultList = Common.ResolveSAPViewODBC<Location>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@ItemCode", itemCode },
                        { "@WhsCode",  whsCode  }
                    });
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<Location>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Location>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_Getlocations")
                    .Get(new FilterBaseWhsCodeItemCode()
                    {
                        ItemCode = itemCode,
                        WhsCode = whsCode
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                oClContext = await requestModel.SendAsync<List<Location>>();
            }

            return oClContext;
        }

        #endregion

        #region SalesMan

        /// <summary>
        /// Asynchronously retrieves a list of salesmen from the database.
        /// </summary>
        /// <param name="_companyId">The ID of the company to filter the salesmen. Default is -1, which means no specific company filter is applied.</param>
        /// <param name="_licence">The license ID used for authentication. Default is -1, which means no specific license is used.</param>
        /// <param name="_userAssign">A boolean indicating whether to assign a user context for the operation. Default is false.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{SalesMan}}"/>
        /// object which includes the HTTP status code and a response containing a list of <see cref="SalesMan"/> objects.
        /// </returns>
        public static async Task<CLContext<List<SalesMan>>> GetSalesMen(int _companyId = -1, int _licence = -1, bool _userAssign = false)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSalesMen", -1, _companyId, _licence);

                if (_userAssign)
                {
                    await SignIn(new CLMLTEMA.MODELS.License()
                    {
                        CompanyId = _companyId,
                        Id = _licence,
                        User = contextODBC.License
                    });
                }

                List<SalesMan> resultList = Common.ResolveSAPViewODBC<SalesMan>(contextODBC);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<List<SalesMan>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<SalesMan>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion

            #region Query Via SL
            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetSalesMen", -1, _companyId, _licence).Get();

            if (_userAssign)
            {
                await SignIn(new CLMLTEMA.MODELS.License()
                {
                    CompanyId = _companyId,
                    Id = _licence,
                    User = oSlRequestObject.Login.Content.UserName
                });
            }

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<List<SalesMan>>();
            #endregion
        }

        /// <summary>
        /// Retrieves a salesperson's details based on the specified salesperson code.
        /// </summary>
        /// <param name="_slpCode">The code of the salesperson to retrieve.</param>
        /// <returns>
        /// A task representing the asynchronous operation, containing a CLContext with the SalesMan details.
        /// </returns>
        public static async Task<CLContext<SalesMan>> GetSalesMan(int _slpCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSalesMan", -1, -1, -1);

                List<SalesMan> resultList = Common.ResolveSAPViewODBC<SalesMan>(contextODBC, new Dictionary<string, object>()
                {
                    {"@SlpCode", $"{_slpCode}"}
                });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<SalesMan>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<SalesMan>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
            }
            #endregion

            #region Query Via SL
            SalesMan oSalesMan = new SalesMan()
            {
                SlpCode = _slpCode
            };

            SLRequestObject oSlRequestObject = GetUserCtx("SL_GetSalesMan", -1, -1, -1).Get(oSalesMan);

            LogManager.Record($"RESOURCE SL: {oSlRequestObject.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<SalesMan>();
            #endregion
        }

        #endregion

        #region BusinessPartners

        /// <summary>
        /// Retrieves a list of business partners from the SAP view, applying a typeahead format if available.
        /// </summary>
        /// <param name="slpCode">The salesperson code to filter the business partners. Optional.</param>
        /// <returns>A CLContext containing the list of business partners with the applied typeahead format.</returns>
        public static async Task<CLContext<List<BusinessPartners>>> GetBusinessPartners(string slpCode = "")
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BusinessPartners>> oClContext = null;

            List<BusinessPartners> resultList = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBusinessPartners");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                resultList = Common.ResolveSAPViewODBC<BusinessPartners>(
                    contextODBC,
                    new Dictionary<string, object> {
                        { "@SlpCode", slpCode }
                    });

                oClContext = new CLContext<List<BusinessPartners>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>> { Data = resultList },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetBusinessPartners")
                    .Get<FilterBusinessPartnerSlpCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<BusinessPartners>>();

                resultList = oClContext.Response.Data;

                #endregion
            }

            LogManager.Record("TYPEAHEAD FORMAT");

            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>("PatternTypeahead")
                    .Response.Data;

            int companyId = GetCompanyId();

            var pattern = companiesTypeaheadFormat
                .FirstOrDefault(tf => tf.CompanyId == companyId);

            if (pattern != null)
            {
                foreach (var bp in resultList)
                {
                    bp.TypeAheadFormat = pattern.BusinessPattern
                        .Replace("@CODE", bp.CardCode)
                        .Replace("@NAME", bp.CardName);
                }
            }

            LogManager.Record("TYPEAHEAD FORMAT COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of business partners from a SAP view using ODBC based on a filter string and an optional sales employee code.
        /// </summary>
        /// <param name="_filterBusinessPartner">Filter to apply to business partner codes or names.</param>
        /// <param name="_slpCode">Optional sales employee code used to further filter the business partners.</param>
        /// <returns>
        /// A <see cref="CLContext{List{BusinessPartners}}"/> containing the list of matching business partners and a success status code.
        /// </returns>
        public static async Task<CLContext<List<BusinessPartners>>> GetBusinessPartnersbyFilter(string filterBusinessPartner, string slpCode)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BusinessPartners>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBusinessPartnersbyFilter");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@FilterBusinessPartner", filterBusinessPartner },
                        { "@SlpCode", slpCode }
                    }
                );

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = new CLContext<List<BusinessPartners>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetBusinessPartnersbyFilter")
                    .Get(new FilterBusinessPartners()
                    {
                        FilterBusinessPartner = filterBusinessPartner ?? "",
                        SlpCode = slpCode
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUESTING COMPLETED");

                oClContext = await requestModel.SendAsync<List<BusinessPartners>>();

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a business partner based on the specified card code, user ID, and company ID.
        /// </summary>
        /// <param name="_cardCode">The card code of the business partner (optional).</param>
        /// <param name="_userId">The ID of the user requesting the data (default: -1).</param>
        /// <param name="_companyId">The ID of the company associated with the business partner (default: -1).</param>
        /// <returns>A CLContext object containing the business partner data.</returns>
        public static async Task<CLContext<BusinessPartners>> GetBusinessPartner(string cardCode = null, int userId = -1, int companyId = -1)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<BusinessPartners> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC =
                    GetUserCtxODBC("ODBC_GetBusinessPartner", userId, companyId);

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", cardCode }
                    }
                );

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<BusinessPartners>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<BusinessPartners>
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetBusinessPartner", userId, companyId)
                    .Get(new FilterBaseByCardCode()
                    {
                        CardCode = cardCode
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<BusinessPartners>();

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of address types from the database using the default context and logs the operation.
        /// </summary>
        /// <returns>A CLContext containing a collection of AddressTypes.</returns>
        public static CLContext<IEnumerable<AddressTypes>> GetAddressType()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<AddressTypes>> oAddressTypesList =
                Services.Execute<AddressTypes, MainDBContext>("GetAddressType").Get();

            LogManager.Record("REQUEST COMPLETED");

            return oAddressTypesList;
        }

        /// <summary>
        /// Retrieves a list of business partners (SociosComercial) from the database using the default context and logs the operation.
        /// </summary>
        /// <returns>A CLContext containing a collection of SociosComercial.</returns>
        public static CLContext<IEnumerable<SociosComercial>> GetSocioComercial()
        {
            LogManager.Record("REQUESTING RECORDS");

            CLContext<IEnumerable<SociosComercial>> oAddressTypesList =
                Services.Execute<SociosComercial, MainDBContext>("GetSocioComercial").Get();

            LogManager.Record("REQUEST COMPLETED");

            return oAddressTypesList;
        }

        /// <summary>
        /// Asynchronously retrieves a list of suppliers from the database.
        /// </summary>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{BusinessPartners}}"/>
        /// object which includes the HTTP status code and a response containing a list of <see cref="BusinessPartners"/> objects.
        /// </returns>
        public static async Task<CLContext<List<BusinessPartners>>> GetSuppliers()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BusinessPartners>> oClContext = new CLContext<List<BusinessPartners>>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSuppliers");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC, new Dictionary<string, object>());

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");

                oClContext = new CLContext<List<BusinessPartners>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetSuppliers").Get();

                LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
                LogManager.Record($"REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<BusinessPartners>>();
                #endregion
            }

            LogManager.Record($"TYPEAHEAD FORMAT");

            List<SettingTypeaheadFormat> companiesTypeaheadFormat =
                GetSettingByCode<List<SettingTypeaheadFormat>>("PatternTypeahead").Response.Data;

            int oCompanyId = GetCompanyId();

            SettingTypeaheadFormat pattern =
                companiesTypeaheadFormat.FirstOrDefault(tf => tf.CompanyId == oCompanyId);

            foreach (BusinessPartners oBusinessPartners in oClContext.Response.Data)
            {
                oBusinessPartners.TypeAheadFormat = pattern.BusinessPattern.Replace("@CODE", oBusinessPartners.CardCode)
                    .Replace("@NAME", oBusinessPartners.CardName);
            }

            LogManager.Record($"TYPEAHEAD FORMAT COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Asynchronously retrieves a supplier based on the provided CardCode.
        /// </summary>
        /// <param name="CardCode">The unique identifier for the supplier to be retrieved.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{BusinessPartners}"/>
        /// object which includes the HTTP status code and a response containing the <see cref="BusinessPartners"/> object.
        /// </returns>
        public static async Task<CLContext<BusinessPartners>> GetSupplier(string CardCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSupplier");

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC, new Dictionary<string, object>()
                {
                    {"@CardCode", $"{CardCode}"}
                });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");

                return new CLContext<BusinessPartners>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<BusinessPartners>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
            }
            #endregion
            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetSupplier").Get<FilterBusinessPartner>();

            LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<BusinessPartners>();
            #endregion
        }

        /// <summary>
        /// Asynchronously retrieves a list of suppliers based on the provided filter.
        /// </summary>
        /// <param name="FilterBusinessPartner">The filter criteria used to search for suppliers.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{BusinessPartners}}"/>
        /// object which includes the HTTP status code and a response containing a list of <see cref="BusinessPartners"/> objects
        /// that match the filter criteria.
        /// </returns>
        public static async Task<CLContext<List<BusinessPartners>>> GetSuppliersbyFilter(string FilterBusinessPartner)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            #region Query Via ODBC
            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetSuppliersbyFilter");
                Dictionary<string, object> parameters = new Dictionary<string, object>
                {
                    {"@FilterBusinessPartner", FilterBusinessPartner}
                };

                List<BusinessPartners> resultList = Common.ResolveSAPViewODBC<BusinessPartners>(contextODBC, parameters);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<BusinessPartners>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartners>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            #endregion

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetSuppliersbyFilter").Get<FilterSearchMasterDataBusinessPartner>();

            LogManager.Record($"RESOURCE SL: {requestModel.Url_Request}");
            LogManager.Record("REQUEST COMPLETED");

            return await requestModel.SendAsync<List<BusinessPartners>>();
            #endregion
        }

        /// <summary>
        /// Method to create business partner
        /// </summary>
        /// <param name="_businessPartner">Model bisuness partner to create</param>
        /// <returns></returns>
        public static async Task<CLContext<BusinessPartners>> CreateBusinessPartner(BusinessPartners _businessPartner)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "SalesPersonCode",
                "AttachmentEntry",
                "CashCustomer",
                "TypeAheadFormat",
                "TypeIdentification",
                "IsCompanyDirection",
                "ConfigurableFields",
                "Provincia",
                "Canton",
                "Distrito",
                "Barrio",
                "Direccion",
                "BPAddresses",
                "AttachmentEntry",
                "ShipToDefault",
                "BilltoDefault",
                "Device",
                "CreateDate"
            };

            _businessPartner.Valid = _businessPartner.Frozen == StatusBP.TNO ? StatusBP.TYES : StatusBP.TNO;

            //esta propiedad no se envia desde ema movil
            if (_businessPartner.PayTermsGrpCode == 0)
            {
                oRemoveHeaderProperties.Add("PayTermsGrpCode");
            }

            //esta propiedad no se envia desde ema movil
            if (_businessPartner.PriceListNum == 0)
            {
                oRemoveHeaderProperties.Add("PriceListNum");
            }

            if (string.IsNullOrEmpty(_businessPartner.CardCode))
            {
                oRemoveHeaderProperties.Add("CardCode");
            }

            //Esto se realizara para que pueda funcionar desde el movil
            if (_businessPartner.ConfigurableFields is object)
            {
                oRemoveHeaderProperties.Add("FederalTaxID");
                oRemoveHeaderProperties.Add("EmailAddress");
            }

            string oHeaderProperties = string.Join(",", oRemoveHeaderProperties);

            int serieType = _businessPartner.CardType == "cCustomer"
                ? (int)Constants.DocumentType.BusinessPartners
                : (int)Constants.DocumentType.Supplier;

            SeriesByUser oSerie = GetSerie(serieType);

            _businessPartner.Series = oSerie.NoSerie;

            SLRequestObject requestModel = GetUserCtx("PostBusinessPartner")
                .Post(_businessPartner, _fieldsToRemoveInHeaders: oHeaderProperties);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            JObject oJObject = JsonConvert.DeserializeObject<JObject>(requestModel.Content);

            if (_businessPartner.ConfigurableFields is object)
            {
                _businessPartner.ConfigurableFields.Where(_x => !_x.IsObjDirection)
                    .ToList()
                    .ForEach(_element => { oJObject.Add(_element.NameSL, _element.Value); });
            }

            requestModel.Content = JsonConvert.SerializeObject(oJObject, new JsonSerializerSettings
            {
                DateTimeZoneHandling = DateTimeZoneHandling.Local
            });

            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<BusinessPartners>();
        }




        /// <summary>
        /// Method to activate business partner
        /// </summary>
        /// <param name="_businessPartner"></param>
        /// <returns></returns>
        public static async Task<CLContext<BusinessPartnersActivate>> ActivateBusinessPartner(BusinessPartnersActivate _businessPartner)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            SLRequestObject requestModel = GetUserCtx("PostActivateBusinessPartner")
                .Patch(_businessPartner);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<BusinessPartnersActivate>();
        }

        /// <summary>
        /// Method to update business partner
        /// </summary>
        /// <param name="_businessPartner">Model business partner to update</param>
        /// <returns></returns>
        public static async Task<CLContext<BusinessPartners>> UpdateBusinessPartner(BusinessPartners _businessPartner)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            List<string> oRemoveHeaderProperties = new List<string>()
            {
                "SalesPersonCode",
                "AttachmentEntry",
                "Series",
                "CashCustomer",
                "TypeAheadFormat",
                "TypeIdentification",
                "ConfigurableFields",
                "IsCompanyDirection",
                "Provincia",
                "Canton",
                "Distrito",
                "Barrio",
                "Direccion",
                "BPAddresses",
                "AttachmentEntry",
                "ShipToDefault",
                "BilltoDefault",
                "Device",
                "CreateDate"
            };

            _businessPartner.Valid = _businessPartner.Frozen == StatusBP.TNO ? StatusBP.TYES : StatusBP.TNO;

            //esta propiedad no se envia desde ema movil
            if (_businessPartner.PayTermsGrpCode == 0)
            {
                oRemoveHeaderProperties.Add("PayTermsGrpCode");
            }

            //esta propiedad no se envia desde ema movil
            if (_businessPartner.PriceListNum == 0)
            {
                oRemoveHeaderProperties.Add("PriceListNum");
            }

            //Esto se realizara para que pueda funcionar desde el movil
            if (_businessPartner.ConfigurableFields is object)
            {
                oRemoveHeaderProperties.Add("FederalTaxID");
                oRemoveHeaderProperties.Add("EmailAddress");
            }

            string headerProperties = string.Join(",", oRemoveHeaderProperties);

            SLRequestObject requestModel = GetUserCtx("PatchBusinessPartner")
                .Patch(_businessPartner, _fieldsToRemoveInHeaders: headerProperties);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            JObject oJObject = JsonConvert.DeserializeObject<JObject>(requestModel.Content);

            if (_businessPartner.ConfigurableFields is object)
            {
                _businessPartner.ConfigurableFields.Where(_x => !_x.IsObjDirection)
                    .ToList()
                    .ForEach(_element => { oJObject.Add(_element.NameSL, _element.Value); });
            }

            requestModel.Content = JsonConvert.SerializeObject(oJObject,
                new JsonSerializerSettings { DateTimeZoneHandling = DateTimeZoneHandling.Local });

            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            LogManager.Record($"REQUEST COMPLETED");

            return await requestModel.SendAsync<BusinessPartners>();
        }

        /// <summary>
        /// Retrieves the locations of a customer based on the specified card code and address type.
        /// </summary>
        /// <param name="_cardCode">The card code of the customer.</param>
        /// <param name="_addressType">The type of address to filter the locations.</param>
        /// <returns>A CLContext object containing a list of customer locations.</returns>
        public static async Task<CLContext<List<BusinessPartnerLocation>>> GetCustomerLocations(string cardCode, int addressType)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BusinessPartnerLocation>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBusinessPartnerLocations");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                var parameters = new Dictionary<string, object>
                {
                    { "@CardCode", cardCode },
                    { "@AddressType", addressType }
                };
                var resultList = Common.ResolveSAPViewODBC<BusinessPartnerLocation>(contextODBC, parameters);
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<BusinessPartnerLocation>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartnerLocation>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBusinessPartnerLocations").Get(
                    new BusinessPartnerLocationdsFilter()
                    {
                        CardCode = cardCode,
                        AddressType = addressType
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                oClContext = await requestModel.SendAsync<List<BusinessPartnerLocation>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves the list of business partner properties from the appropriate data source, 
        /// depending on the connection mode (ODBC or Service Layer).
        /// </summary>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{BPProperties}}"/>
        /// object with the list of retrieved business partner properties.
        /// </returns>
        public static async Task<CLContext<List<BPProperties>>> GetProperties()
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BPProperties>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetProperties");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<BPProperties> resultList = Common.ResolveSAPViewODBC<BPProperties>(contextODBC);
                oClContext = new CLContext<List<BPProperties>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BPProperties>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetProperties").Get();
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<List<BPProperties>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a business partner property by card code.
        /// </summary>
        /// <param name="_cardCode">The card code of the business partner.</param>
        /// <returns>A CLContext object containing the business partner property.</returns>
        public static async Task<CLContext<BPProperty>> GetBPProperty(string cardCode)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<BPProperty> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBPProperties");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<BPProperty> resultList = Common.ResolveSAPViewODBC<BPProperty>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", cardCode }
                    });
                LogManager.Record("REQUEST COMPLETED");
                BPProperty single = resultList.FirstOrDefault();
                oClContext = new CLContext<BPProperty>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<BPProperty> { Data = single },
                    value = single
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBPProperties").Get(
                    new FilterBaseByCardCode()
                    {
                        CardCode = cardCode
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<BPProperty>();
                LogManager.Record("REQUEST COMPLETED");
            }

            return oClContext;
        }

        /// <summary>
        /// Updates the properties of a business partner by sending a PATCH request with the specified property data.
        /// </summary>
        /// <param name="_properties">The <see cref="PatchProperties"/> object containing the business partner code and the list of properties to update.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{BusinessPartners}"/> 
        /// object with the updated business partner data.
        /// </returns>
        public static async Task<CLContext<BusinessPartners>> PostProperties(PatchProperties _properties)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            string removeHeaderProperties = "CardCode,PropertiesList";

            SLRequestObject oSlRequestObject = GetUserCtx("PatchBusinessPartner")
                .Patch(_properties, _fieldsToRemoveInHeaders: removeHeaderProperties);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            JObject oJObject = new JObject();

            foreach (BPProperties oProperties in _properties.PropertiesList)
            {
                oJObject.Add(oProperties.GroupCode, oProperties.Value);
            }

            oSlRequestObject.Content = JsonConvert.SerializeObject(oJObject);

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<BusinessPartners>();
        }

        #endregion

        #region Anexos

        /// <summary>
        /// This method is used to assingment method
        /// </summary>
        /// <param name="_businessPartner">This model to assingment attachment an business partner</param>
        private static async System.Threading.Tasks.Task AsignarAnexo(BusinessPartners _businessPartner)
        {
            LogManager.Record($"UPDATING ATTACHMENT FOR BP... CARDCODE: {_businessPartner.CardCode}, AttachmentEntry: {_businessPartner.AttachmentEntry}" );

            string headerProperties =
                "Valid,FatherCard,ShipToDefault,BilltoDefault,CreateDate,CardCode,GroupCode,CardName,CardType,Phone1,PayTermsGrpCode,DiscountPercent,MaxCommitment,FederalTaxID,PriceListNum,SalesPersonCode,Currency,EmailAddress,Series,CashCustomer,TypeAheadFormat,TypeIdentification,Provincia,Canton,Distrito,Barrio,Direccion,Frozen,FatherType,ConfigurableFields,BPAddresses,Udfs,IsCompanyDirection,Device";

            SLRequestObject requestModel = GetUserCtx("PatchBusinessPartner")
                .Patch(_businessPartner, _fieldsToRemoveInHeaders: headerProperties);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUEST COMPLETED");

            await requestModel.SendAsync<BusinessPartners>();
        }



        /// <summary>
        /// This method is used to create attachment
        /// </summary>
        /// <returns></returns>
        /// <exception cref="CLException"></exception>
        public static async Task<CLContext<Attachments2>> CreateAnexos()
        {
            LogManager.Record("RESQUESTING POST ATTCHMENTS");

            string attachmentJson = HttpContext.Current.Request.Form["FILES"];

            Attachments2 attachment = (attachmentJson is null) ? null : JsonConvert.DeserializeObject<Attachments2>(attachmentJson);

            IEnumerable<HttpPostedFile> attachmentFiles = new List<HttpPostedFile>();

            if (HttpContext.Current.Request.Files.Count > 0)
            {
                HttpFileCollection files = HttpContext.Current.Request.Files;

                attachmentFiles = files.AllKeys.Select(key => files[key]);
            }

            CLContext<List<ShareFolder>> oShareFolderst = GetSettingByCode<List<ShareFolder>>(SettingCode.ShareFolder);

            DocumentAttachment reponse = await CreateDocumentAttachments(attachment, attachmentFiles);

            if (reponse.AbsoluteEntry >= 0)
            {
                await AsignarAnexo(new BusinessPartners()
                { AttachmentEntry = reponse.AbsoluteEntry, CardCode = attachment.CardCode });
            }

            return new CLContext<Attachments2>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<Attachments2>()
                {
                    Data = new Attachments2
                    {
                        AbsoluteEntry = reponse.AbsoluteEntry,
                        CardCode = attachment.CardCode,
                        Attachments2_Lines = reponse.Attachments2_Lines
                    }
                }
            };
            
        }
       
        public static async Task<DocumentAttachment> CreateDocumentAttachments(DocumentAttachment _attachment, IEnumerable<HttpPostedFile> _attachmentFiles, int _userId = -1, int _companyId = -1)
        {

            if (_attachment is null || _attachment.Attachments2_Lines.Count == 0)
            {
                return null;
            }

            LogManager.Record("RESQUESTING POST ATTCHMENTS");

            //Le indica al sever que acepte bodies grandes
            ServicePointManager.Expect100Continue = false;

            var cookieContainer = new CookieContainer();

            ClUserContext clUser = GetUserCtx("PostAnexos", _userId, _companyId);

            string sessionId = await LoginSL(clUser);

            string url = clUser.SLUrl + "Attachments2";

            // Agregamos la cookie
            cookieContainer.Add(new Uri(url),
                                new Cookie("B1SESSION", sessionId));
            
            var boundary = Guid.NewGuid().ToString();

            var handler = new HttpClientHandler
            {
                CookieContainer = cookieContainer,
                UseCookies = true
            };


            using (var client = new HttpClient(handler))
            {
                try
                {
                    using (var form = new MultipartFormDataContent(boundary))
                    {
                        LogManager.Record("CREATION FROMDATA WITH ATTACHMENTS");

                        foreach (Attachments2Line attachmentLine in _attachment.Attachments2_Lines)
                        {
                            string timestamp = DateTime.Now.ToString("yyMddHHmmssfff");
                            string name = $"{attachmentLine.FileName}_{timestamp}.{attachmentLine.FileExtension}";
                            

                            HttpPostedFile oFile = _attachmentFiles.FirstOrDefault(attF => attF.FileName == $"{attachmentLine.FileName}.{attachmentLine.FileExtension}");
                            
                            
                            if (oFile == null)
                            {
                                LogManager.Record($"ATTACHMENTS NAME: {name}, NO ADDED TO FROMDATA");
                                continue;
                            }
                            LogManager.Record($"ATTACHMENTS NAME: {name}");
                            oFile.InputStream.Position = 0;
                            var streamContent = new StreamContent(oFile.InputStream);

                            form.Headers.ContentType.Parameters.Clear();
                            form.Headers.ContentType.Parameters.Add(new NameValueHeaderValue("boundary", boundary));

                            var cd = new ContentDispositionHeaderValue("form-data");
                            cd.Name = string.Concat("\"", "files", "\"");
                            cd.FileName = string.Concat("\"", name, "\"");
                            streamContent.Headers.ContentDisposition = cd;

                            var mimeTypeDictionary = new MimeTypeDictionary();
                            string contentType = mimeTypeDictionary.GetMimeType("." + attachmentLine.FileExtension);

                            streamContent.Headers.ContentType = new MediaTypeHeaderValue(contentType);
                            form.Add(streamContent);

                        }

                        LogManager.Record("CREATION FROMDATA COMPLETE");

                        if (!form.Any())
                        {
                            LogManager.Record("NO FILES ADDED TO FORMDATA");

                            return _attachment;

                        }


                        client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("*/*"));

                        HttpResponseMessage response;

                        if (_attachment.AbsoluteEntry == 0)
                        {
                            LogManager.Record("POST ATTACHMENTS");
                            response = await client.PostAsync(url, form);
                        }
                        else
                        {
                            LogManager.Record($"PATCH ATTACHMENTS.... ABSOLUTEENTRY: {_attachment.AbsoluteEntry}");
                            var patchUrl = $"{url}({_attachment.AbsoluteEntry})";

                            var request = new HttpRequestMessage(new HttpMethod("PATCH"), patchUrl)
                            {
                                Content = form
                            };

                            response = await client.SendAsync(request);
                        }


                        string result = await response.Content.ReadAsStringAsync();
                        


                        DocumentAttachment slResponse = JsonConvert.DeserializeObject<DocumentAttachment>(result);


                        if (response.IsSuccessStatusCode)
                        {
                            LogManager.Record("REQUESTING COMPLETE");
                            return slResponse;
                        }
                        else
                        {
                            dynamic errorObj = JsonConvert.DeserializeObject(result);
                            string errorMessage = errorObj?.error?.message?.value;
                            throw new CLException(errorMessage, HttpStatusCode.InternalServerError);
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw;
                }
            }
        }


       
        /// <summary>
        /// Asynchronously retrieves a list of item batches by warehouse.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="Batch"/> objects, representing the item batches retrieved.
        /// </returns>
        public static async Task<CLContext<List<Attachments2Line>>> GetAttachment(int attachmentEntry)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Attachments2Line>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetAnexos");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Attachments2Line> resultList = Common.ResolveSAPViewODBC<Attachments2Line>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@AttachmentEntry", attachmentEntry }
                    });
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<Attachments2Line>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Attachments2Line>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetAnexos").Get(
                    new AttachmentFilter()
                    {
                        AttachmentEntry = attachmentEntry
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                LogManager.Record("REQUEST COMPLETED");
                oClContext = await requestModel.SendAsync<List<Attachments2Line>>();
            }

            return oClContext;
        }

        /// <summary>
        /// This method is used to download attachment
        /// </summary>
        /// <param name="path">path attachment</param>
        /// <returns></returns>
        /// <exception cref="CLException">Exception when not found path</exception>
        public static CLContext<string> DownloadAttachment(string path)
        {
            LogManager.Record("REQUESTING RECORDS");

            string base64 = string.Empty;

            if (System.IO.File.Exists(path))
            {
                base64 = CL.COMMON.Core.FileToBase64(path);
            }
            else
            {
                throw new CLException($"CL - La ruta: {path} no existe.", HttpStatusCode.InternalServerError);
            }

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<string>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<string>()
                {
                    Data = base64,
                    Message = string.Empty
                }
            };
        }

        #endregion

        #region BPAddress

        /// <summary>
        /// Method to create partner address.
        /// </summary>
        /// <param name="_businessPartner">Model to bisuness partner to created</param>
        /// <returns></returns>
        public static async Task<CLContext<BusinessPartners>> CreateAddress(BusinessPartners _businessPartner)
        {
            LogManager.Record("REQUEST POST OBJECT");

            string removeHeaderPropersties =
                "GroupCode,CardName,CardType,Phone1,PayTermsGrpCode,DiscountPercent,MaxCommitment,FederalTaxID,PriceListNum,SalesPersonCode,Currency,EmailAddress,Series,CashCustomer,TypeAheadFormat,TypeIdentification,Provincia,Canton,Distrito,Barrio,Direccion,Frozen,FatherType,FatherCard,ConfigurableFields,BPAddresses,Udfs,IsCompanyDirection,AttachmentEntry,Device,CreateDate,Valid";

            SLRequestObject oSlRequestObject = GetUserCtx("PatchBusinessPartner")
                .Patch(_businessPartner, _fieldsToRemoveInHeaders: removeHeaderPropersties);

            LogManager.Record($"URL: {oSlRequestObject.Url_Request}");

            JObject oJObject = JsonConvert.DeserializeObject<JObject>(oSlRequestObject.Content);

            JArray BPAddresses = new JArray();

            if (_businessPartner.BPAddresses is object)
            {
                _businessPartner.BPAddresses.ForEach(element =>
                {
                    JObject BPAdress = new JObject();

                    BPAdress.Add("AddressName", element.AddressName);
                    BPAdress.Add("Street", element.Street);
                    BPAdress.Add("Block", element.Block);
                    BPAdress.Add("ZipCode", element.ZipCode);
                    BPAdress.Add("City", element.City);
                    BPAdress.Add("County", element.County);
                    BPAdress.Add("Country", element.Country);
                    BPAdress.Add("State", element.State);
                    BPAdress.Add("AddressType", element.AddressType);
                    BPAdress.Add("AddressName2", element.AddressName2);
                    BPAdress.Add("AddressName3", element.AddressName3);
                    BPAdress.Add("BPCode", element.BPCode);
                    BPAdress.Add("GlobalLocationNumber", element.GlobalLocationNumber);
                    BPAdress.Add("StreetNo", element.StreetNo);
                    BPAdress.Add("BuildingFloorRoom", element.BuildingFloorRoom);
                    BPAdress.Add("RowNum", element.RowNum);
                    if (element.ConfigurableFields is object)
                    {
                        element.ConfigurableFields.ForEach(x => { BPAdress.Add(x.NameSL, x.Value); });
                    }

                    BPAddresses.Add(BPAdress);
                });
            }

            oJObject.Add("BPAddresses", BPAddresses);

            string jsonBusinessPartner = JsonConvert.SerializeObject(oJObject,
                new JsonSerializerSettings { DateTimeZoneHandling = DateTimeZoneHandling.Local });

            oSlRequestObject.Content = jsonBusinessPartner;

            LogManager.Record("REQUEST COMPLETED");

            return await oSlRequestObject.SendAsync<BusinessPartners>();
        }

        /// <summary>
        /// Asynchronously retrieves a list of business partner addresses based on the provided card code and optional pattern.
        /// </summary>
        /// <param name="_cardCode">The card code of the business partner.</param>
        /// <param name="_Pattern">An optional pattern to filter the addresses.</param>
        /// <returns>
        /// A task representing the asynchronous operation, with a <see cref="CLContext{List{BPAddresses}}"/>
        /// containing the list of business partner addresses and the operation status.
        /// </returns>
        public static async Task<CLContext<List<BPAddresses>>> GetBPAddresses(string cardCode, string pattern = "")
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BPAddresses>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBPAddress");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BPAddresses> resultList = Common.ResolveSAPViewODBC<BPAddresses>(contextODBC, new Dictionary<string, object>(){
                    { "@CardCode", cardCode },
                    { "@Pattern", pattern ?? "" }
                });

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<BPAddresses>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BPAddresses>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBPAddress").Get(
                    new FilterAddress()
                    {
                        CardCode = cardCode,
                        Pattern = pattern ?? ""
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<List<BPAddresses>>();

                LogManager.Record("REQUEST COMPLETED");
            }

            return oClContext;
        }


        /// <summary>
        /// Retrieves the delivery addresses for a specific business partner (BP) using either the ODBC or Service Layer (SL) connection mode.
        /// </summary>
        /// <param name="_cardCode">The unique identifier (CardCode) of the business partner.</param>
        /// <param name="_addressType">The type of address to filter by, typically:
        /// </param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// with a list of <see cref="BPAddresses"/> related to the specified business partner and address type.
        /// </returns>
        public static async Task<CLContext<List<BPAddresses>>> GetBPADeliveryddresses(string _cardCode, string _addressType)
        {
            LogManager.Record("REQUESTING BD DELIVERY ADDRESS RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BPAddresses>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBPDeliveryAddress");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BPAddresses> resultList = Common.ResolveSAPViewODBC<BPAddresses>(contextODBC, new Dictionary<string, object>(){
                    { "@CardCode", _cardCode },
                    { "@AddressType", _addressType }
                });

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<BPAddresses>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BPAddresses>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBPDeliveryAddress").Get(
                    new FilterDeliveryAddress()
                    {
                        CardCode = _cardCode,
                        AddressType = _addressType
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<List<BPAddresses>>();

                LogManager.Record("REQUEST COMPLETED");
            }

            return oClContext;
        }

        #endregion

        #region BusinessPartnerLocations

        /// <summary>
        /// Retrieves a business partner's location information based on optional filters such as card code and address ID.
        /// </summary>
        /// <param name="_cardCode">The business partner's card code (optional).</param>
        /// <param name="_addressId">The address ID associated with the business partner (optional).</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{BusinessPartnerLocation}"/> 
        /// object with the location information of the business partner.
        /// </returns>
        public static async Task<CLContext<BusinessPartnerLocation>> GetBusinessPartnerLocation(string _cardCode = null, string _addressId = null)
        {
            LogManager.Record("REQUESTING RECORDS...");

            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            bool hasFilters = !(String.IsNullOrEmpty(_cardCode) && String.IsNullOrEmpty(_addressId));

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetBusinessPartnerLocation");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                Dictionary<string, object> parameters = new Dictionary<string, object>();

                if (hasFilters)
                {
                    parameters.Add("@CardCode", $"{_cardCode ?? ""}");
                    parameters.Add("@AddressId", $"{_addressId ?? ""}");
                }

                List<BusinessPartnerLocation> resultList = Common.ResolveSAPViewODBC<BusinessPartnerLocation>(contextODBC, parameters);

                LogManager.Record($"EXECUTING REQUEST...");

                return new CLContext<BusinessPartnerLocation>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<BusinessPartnerLocation>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject oSlRequestObject = null;

                if (hasFilters)
                {
                    BusinessPartnerLocationFilter oFilter = new BusinessPartnerLocationFilter()
                    {
                        CardCode = _cardCode,
                        AddressId = _addressId
                    };

                    oSlRequestObject = GetUserCtx("SL_GetBusinessPartnerLocation").Get(oFilter);
                }
                else
                {
                    oSlRequestObject = GetUserCtx("SL_GetBusinessPartnerLocation").Get<BusinessPartnerLocationFilter>();
                }

                LogManager.Record($"RESOURCE: {oSlRequestObject.Url_Request}");
                LogManager.Record($"EXECUTING REQUEST...");

                return await oSlRequestObject.SendAsync<BusinessPartnerLocation>();

                #endregion
            }
        }

        #endregion

        #region Banks

        /// <summary>
        /// Asynchronously retrieves a list of banks from the database.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="Bank"/> objects, representing the banks retrieved.
        /// </returns>
        public static async Task<CLContext<List<Bank>>> GetBanks()
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Bank>> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBanks");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                List<Bank> resultList = Common.ResolveSAPViewODBC<Bank>(contextODBC, new Dictionary<string, object>());
                oClContext = new CLContext<List<Bank>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Bank>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBanks").Get();
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<List<Bank>>();
            }

            LogManager.Record("REQUEST COMPLETED");
            return oClContext;
        }

        /// <summary>
        /// Asynchronously retrieves a filtered bank record based on the provided bank code and bank name.
        /// </summary>
        /// <param name="BankCode">The code of the bank to filter the records.</param>
        /// <param name="BankName">The name of the bank to filter the records.</param>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a <see cref="Bank"/> object, representing the filtered bank record retrieved.
        /// </returns>
        public static async Task<CLContext<Bank>> GetBankFiltered(string bankCode, string bankName)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<Bank> oClContext;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBank");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Bank> resultList = Common.ResolveSAPViewODBC<Bank>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@BankCode", bankCode },
                        { "@BankName", bankName }
                    });
                LogManager.Record("REQUEST COMPLETED");
                Bank single = resultList.FirstOrDefault();
                oClContext = new CLContext<Bank>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<Bank> { Data = single },
                    value = single
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBank")
                    .Get(new FilterBank()
                    {
                        BankCode = bankCode,
                        BankName = bankName
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
                oClContext = await requestModel.SendAsync<Bank>();
            }

            return oClContext;
        }

        #endregion

        #region Barcodes

        /// <summary>
        /// Sends a list of new barcodes to the backend service for insertion.
        /// </summary>
        /// <param name="_barcodes">A list of <see cref="BarCodeMasterData"/> to insert.</param>
        private static async System.Threading.Tasks.Task InsertBarcodes(List<BarCodeMasterData> _barcodes)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            foreach (BarCodeMasterData barCode in _barcodes)
            {
                SLRequestObject requestModel = GetUserCtx("PostBarcodes")
                    .Post(barCode);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                await requestModel.SendAsync<BarCodeMasterData>();
            }

            LogManager.Record("REQUEST COMPLETED");
        }

        /// <summary>
        /// Updates existing barcodes or inserts new ones after checking for duplicates.
        /// </summary>
        /// <param name="_barcodes">A list of <see cref="BarCodeMasterData"/> to update or insert.</param>
        /// <exception cref="CLException">
        /// Thrown when a barcode without an AbsEntry already exists in the system.
        /// </exception>
        private static async System.Threading.Tasks.Task UpdateBarcodes(List<BarCodeMasterData> _barcodes)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");

            ClUserContext oClUserContext = GetUserCtx("PostBarcodes");
            ClUserContext oClUserContextPatch = GetUserCtx("PatchBarcodes");
            ClUserContext oUserContext = GetUserCtx("ExistsBarcode");

            foreach (BarCodeMasterData barCode in _barcodes)
            {
                if (barCode.AbsEntry > 0)
                {
                    SLRequestObject requestModel = oClUserContextPatch.Patch(barCode);

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                    await requestModel.SendAsync<BarCodeMasterData>();
                }
                else
                {
                    #region VALIDAR SI EXISTE CODIGO DE BARRAS

                    SLRequestObject oSlRequestObjectBarCode = oUserContext.Get(new FilterExistsBarcode()
                    {
                        BarCode = barCode.Barcode
                    });

                    CLContext<BarCodeMasterData> oContextExists =
                        await oSlRequestObjectBarCode.SendAsync<BarCodeMasterData>();

                    if (oContextExists.Response.Data is object)
                    {
                        throw new CLException($"EL Codigo de barras {barCode.Barcode} ya se encuentra registrado.",
                            HttpStatusCode.MultipleChoices);
                    }

                    #endregion

                    SLRequestObject requestModel = oClUserContext.Post(barCode);

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                    await requestModel.SendAsync<BarCodeMasterData>();
                }
            }

            LogManager.Record("REQUESTING POST OBJECT");
        }

        /// <summary>
        /// Obtiene los códigos de barra asociados a un artículo según su código.
        /// </summary>
        /// <param name="itemCode">Código del artículo.</param>
        /// <returns>
        /// Lista de códigos de barra como <see cref="BarCodeMasterData"/> dentro de un <see cref="CLContext{T}"/>.
        /// </returns>
        public static async Task<CLContext<List<BarCodeMasterData>>> GetBarcodesByItem(string itemCode)
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<BarCodeMasterData>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBarcodeByItem");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<BarCodeMasterData> resultList = Common.ResolveSAPViewODBC<BarCodeMasterData>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@ItemCode", itemCode }
                    });

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<BarCodeMasterData>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BarCodeMasterData>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetBarcodeByItem")
                    .Get(new FilterBaseItemCode()
                    {
                        ItemCode = itemCode
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<BarCodeMasterData>>();
            }

            return oClContext;
        }

        #endregion

        #region Batches

        /// <summary>
        /// Retrieves a list of batches by warehouse from the service, grouping by batch number and including bin locations.
        /// </summary>
        /// <returns>A <see cref="CLContext{List{Batch}}"/> containing the list of batches and their associated locations.</returns>
        public static async Task<CLContext<List<Batch>>> GetItemBatchesByWarehouse()
        {
            LogManager.Record($"REQUESTING RECORDS");

            SLRequestObject requestModel = GetUserCtx("GetBatch").Get<FilterItem>();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUEST COMPLETED");

            CLContext<List<BatchsBinCode>> oClContext = await requestModel.SendAsync<List<BatchsBinCode>>();

            List<Batch> batch = null;

            if (oClContext.Response.Data != null && oClContext.Response.Data.Count > 0)
            {
                batch = new List<Batch>();

                decimal number = 0;

                foreach (BatchsBinCode item in oClContext.Response.Data)
                {
                    Batch lotesModel = null;

                    if (batch.Exists(x => x.SysNumber == item.SysNumber))
                    {
                        lotesModel = batch.Find(x => x.SysNumber == item.SysNumber);

                        number = item.OnHandQty;

                        lotesModel.Locations.Add(new Location
                        {
                            AbsEntry = item.AbsEntry,
                            BinCode = item.BinCode,
                            Stock = Convert.ToDecimal(number.ToString("0.##"))
                        });
                    }
                    else
                    {
                        lotesModel = new Batch();

                        number = item.Disponible;
                        lotesModel.Disponible = Convert.ToDecimal(number.ToString("0.##"));

                        number = item.Stock;
                        lotesModel.Stock = Convert.ToDecimal(number.ToString("0.##"));

                        number = item.CommitQty;
                        lotesModel.CommitQty = Convert.ToDecimal(number.ToString("0.##"));

                        lotesModel.SysNumber = item.SysNumber;
                        lotesModel.DistNumber = item.DistNumber;


                        if (item.AbsEntry > 0)
                        {
                            lotesModel.Locations = new List<Location>();

                            number = item.OnHandQty;

                            lotesModel.Locations.Add(new Location
                            {
                                AbsEntry = item.AbsEntry,
                                BinCode = item.BinCode,
                                Stock = Convert.ToDecimal(number.ToString("0.##")),
                            });
                        }

                        batch.Add(lotesModel);
                    }
                }
            }

            return new CLContext<List<Batch>>()
            {
                Response = new Response<List<Batch>>()
                {
                    Data = batch,
                    Message = oClContext.Response.Message
                }
            };
        }

        /// <summary>
        /// Retrieves available batch information for transfer operations filtered by item, warehouse, and bin location.
        /// </summary>
        /// <param name="_itemCode">Item code filter.</param>
        /// <param name="_whsCode">Warehouse code filter.</param>
        /// <param name="_binAbs">Bin location absolute entry.</param>
        /// <returns>A <see cref="CLContext{List{Batch}}"/> with the list of batches available for transfers.</returns>
        public static async Task<CLContext<List<Batch>>> GetLotesForTansfers(string _itemCode, string _whsCode, int _binAbs)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetLotesForTansfers");

                Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                {
                    { "@ItemCode", _itemCode ?? "" },
                    { "@WhsCode", _whsCode ?? "" },
                    { "@BinAbs", _binAbs }
                };

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<Batch> resultList = Common.ResolveSAPViewODBC<Batch>(contextODBC, parametersODBC);

                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<Batch>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Batch>>() { Data = resultList },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via Service Layer

                FilterBatchesForTransfer filter = new FilterBatchesForTransfer
                {
                    ItemCode = _itemCode ?? "",
                    WhsCode = _whsCode ?? "",
                    BinAbs = _binAbs
                };

                SLRequestObject requestModel = GetUserCtx("SL_GetLotesForTansfers").Get<FilterBatchesForTransfer>(filter);

                LogManager.Record($"URL: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                return await requestModel.SendAsync<List<Batch>>();

                #endregion
            }
        }

        #endregion

        #region Payment Terms

        /// <summary>
        /// Asynchronously retrieves a list of payment terms from the database.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{T}"/> 
        /// object with a list of <see cref="PayTerm"/> objects, representing the payment terms retrieved.
        /// </returns>
        public static async Task<CLContext<List<PayTerm>>> GetPayTerms()
        {
            LogManager.Record("REQUESTING RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PayTerm>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetPayTerms");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<PayTerm> resultList =
                    Common.ResolveSAPViewODBC<PayTerm>(contextODBC, new Dictionary<string, object>());

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<PayTerm>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<PayTerm>>
                    {
                        Data = resultList,
                        Message = "Request completed successfully"
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetPayTerms").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<PayTerm>>();

                #endregion
            }

            return oClContext;
        }

        #endregion

        #region Udfs

        /// <summary>
        /// Retrieves user-defined fields (UDFs) for a specified SAP table.
        /// </summary>
        /// <param name="_tableID">The identifier of the SAP table to retrieve UDFs from.</param>
        /// <returns>
        /// A context containing the list of user-defined fields.
        /// </returns>
        public static async Task<CLContext<List<UdfContext>>> GetUdfs(string tableID)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<UdfContext>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetUdfByCategory");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<UdfContext> resultList = Common.ResolveSAPViewODBC<UdfContext>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@TableID", tableID }
                    }
                );

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<UdfContext>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UdfContext>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetUdfByCategory")
                    .Get(
                        new FilterUdfsByTableId()
                        {
                            TableID = tableID
                        });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<UdfContext>>();

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of UDF (User-Defined Field) invocations from a specified data source,
        /// either via ODBC or SL connection, depending on the current configuration.
        /// </summary>
        /// <param name="_datasource">The name of the data source to query.</param>
        /// <param name="_value">The value to filter the UDF records by.</param>
        /// <returns>
        /// The task result contains a <see cref="CLContext{List{UdfInvoke}}"/>
        /// with the filtered UDF invocation records.
        /// </returns>
        public static async Task<CLContext<List<CL.STRUCTURES.CLASSES.Udf.UdfInvoke>>> GetUdfInvokeDBO(
            string _datasource, string _value)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            string valueFilter = CL.COMMON.Core.GetConfigKeyValue<String>(MethodBase.GetCurrentMethod(), "ValueFilter");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC();

                contextODBC.ResourceType = "SV";
                contextODBC.Resource = $"{_datasource} WHERE \"{valueFilter}\" = '{_value}'";

                List<UdfInvoke> resultList = Common.ResolveSAPViewODBC<UdfInvoke>(contextODBC);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<UdfInvoke>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<UdfInvoke>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                ClUserContext oUserContext = GetUserCtx();


                oUserContext.Resource =
                    $"view.svc/{_datasource}?$filter={valueFilter} eq '{_value}'";

                SLRequestObject requestModel = oUserContext.Get();

                requestModel.Headers =
                    new System.Collections.Generic.List<
                        System.Collections.Generic.KeyValuePair<System.String, System.String>>
                    {
                        new System.Collections.Generic.KeyValuePair<System.String, System.String>("Prefer", "odata.maxpagesize=0")
                    };

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                return await CL.UDFS.Udf.GetUdfInvokeDBO(requestModel);
                #endregion
            }


        }

        /// <summary>
        /// Retrieves and maps UDF (User Defined Fields) values for a list of document lines,
        /// based on the configured data source (ODBC or Service Layer).
        /// </summary>
        /// <param name="udfSource">List of UDF source line definitions containing table and key references.</param>
        /// <returns>
        /// A task that resolves to a <see cref="CLContext{List{UdfSourceLine}}"/> containing the UDF data for each line.
        /// </returns>
        /// <exception cref="Exception">Thrown when no category configuration is found for a given table.</exception>
        public static async Task<CLContext<List<UdfSourceLine>>> GetUdfsLinesData(List<UdfSourceLine> udfSource)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            foreach (var line in udfSource)
            {
                var catCtx = Services
                    .Execute<CL.STRUCTURES.CLASSES.Udf.UdfCategory, MainDBContext, string, ICLSingle>("GetUdfCategory", line.TableId)
                    .Get();

                if (catCtx.Response.Data == null)
                    throw new Exception(
                        $"No se encuentra configurada una categoría de línea para '{line.TableId}'");

                line.TableId = catCtx.Response.Data.Name;
                line.Key = catCtx.Response.Data.KeyLine;

                List<JObject> resultList;

                LogManager.Record("REQUESTING RECORDS");

                if (connectionMode == SapConnectionType.ODBC)
                {
                    var ctxOdbc = GetUserCtxODBC($"ODBC_{line.TableId}");

                    LogManager.Record($"RESOURCE: {ctxOdbc.Resource}");

                    resultList = Common.ResolveSAPViewODBC<JObject>(
                        ctxOdbc,
                        new Dictionary<string, object>
                        {
                            { "@DocEntry", int.Parse(line.Value)     },
                            { "@LineNum",  int.Parse(line.ValueLine) }
                        });
                }
                else
                {
                    var requestModel = GetUserCtx($"SL_{line.TableId}")
                        .Get(new FilterUdfsLines()
                        {
                            DocEntry = int.Parse(line.Value),
                            LineNum = int.Parse(line.ValueLine)
                        });

                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                    var slCtx = await requestModel.SendAsync<List<JObject>>();

                    resultList = slCtx.Response.Data;
                }

                LogManager.Record("REQUEST COMPLETED");

                if (resultList != null && resultList.Any())
                {
                    var data = resultList.First();
                    foreach (var udf in line.Udf)
                    {
                        udf.Values = data.ContainsKey(udf.Name)
                            ? data[udf.Name].ToString()
                            : null;
                    }
                }
            }

            return new CLContext<List<UdfSourceLine>>
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<UdfSourceLine>>
                {
                    Data = udfSource,
                    Message = ""
                },
                value = udfSource
            };
        }

        /// <summary>
        /// Retrieves the list of User Defined Fields (UDFs) with their values based on a specified filter.
        /// Supports retrieval through either ODBC or Service Layer (SL) connections.
        /// </summary>
        /// <param name="_filterUdf">The filter criteria to identify the UDF source (e.g., document key, line number, card code, item code).</param>
        /// <returns>A CLContext object containing a list of configured UDFs and their corresponding values.</returns>
        public static async Task<CLContext<List<CL.STRUCTURES.CLASSES.Udf.Udf>>> GetUdfsData(FilterKeyUdf _filterUdf)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            var filter = new FilterKeyUdf();
            if (!string.IsNullOrEmpty(_filterUdf.CardCode))
            {
                filter.CardCode = _filterUdf.CardCode;
            }
            else if (!string.IsNullOrEmpty(_filterUdf.ItemCode))
            {
                filter.ItemCode = _filterUdf.ItemCode;
            }
            else
            {
                filter.DocEntry = _filterUdf.DocEntry;
            }

            List<JObject> resultList = new List<JObject>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                var ctxOdbc = GetUserCtxODBC($"ODBC_{_filterUdf.TypeDocument}");

                LogManager.Record($"RESOURCE: {ctxOdbc.Resource}");

                resultList = Common.ResolveSAPViewODBC<JObject>(
                    ctxOdbc,
                    new Dictionary<string, object>
                    {
                        { "@CardCode", _filterUdf.CardCode },
                        { "@ItemCode", _filterUdf.ItemCode },
                        { "@DocEntry", _filterUdf.DocEntry },
                        { "@LineNum",  _filterUdf.LineNum }
                    });
            }
            else
            {
                var requestModel = GetUserCtx($"SL_{_filterUdf.TypeDocument}").Get<FilterKeyUdf>(filter);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                var slCtx = await requestModel.SendAsync<List<JObject>>();

                resultList = slCtx.Response.Data;
            }

            LogManager.Record("REQUEST COMPLETED");

            JObject comparisonObject = resultList.FirstOrDefault();

            int companyId = GetCompanyId();

            var oCLContextUdfs = CL.UDFS.Udf
                .GetUdfConfigured<MainDBContext, FilterUdfs, ICLSingle>(
                    "GetUdfsDBOByCategory",
                    new FilterUdfs
                    {
                        Category = !string.IsNullOrEmpty(_filterUdf.DraftType)
                            ? _filterUdf.DraftType
                            : _filterUdf.TypeDocument,
                        CompanyId = companyId
                    })
                .Get();

            var udfsValue = new List<CL.STRUCTURES.CLASSES.Udf.Udf>();

            if (comparisonObject != null)
            {
                JObject responseData = (JObject)comparisonObject;

                foreach (JProperty property in responseData.Properties())
                {
                    string propertyName = property.Name;

                    if (propertyName.StartsWith("U_"))
                    {
                        string value = string.IsNullOrEmpty(property.Value?.ToString()) ? null : property.Value.ToString();

                        CL.STRUCTURES.CLASSES.Udf.Udf oUdfTarget = new CL.STRUCTURES.CLASSES.Udf.Udf
                        {
                            Value = value,
                            Name = propertyName,
                        };

                        #region AGREGAR SOLO LOS UDFS CONFIGURADOS
                        if (oCLContextUdfs.Response?.Data?.UDFList != null && oCLContextUdfs.Response?.Data?.UDFList.Count > 0)
                        {
                            if (oCLContextUdfs.Response.Data.UDFList.Exists(element => element.Name == propertyName))
                            {
                                oCLContextUdfs.Response.Data.UDFList.Find(element => element.Name == propertyName);
                                if (oCLContextUdfs.Response.Data.UDFList.Find(element => element.Name == propertyName).FieldType == "DateTime")
                                {
                                    try
                                    {
                                        DateTime date = DateTime.ParseExact(oUdfTarget.Value, "d/M/yyyy HH:mm:ss", CultureInfo.InvariantCulture);
                                        string dateFormat = date.ToString("yyyy-MM-dd");
                                        oUdfTarget.Value = dateFormat;
                                    }
                                    catch { }
 
                                }
                                udfsValue.Add(oUdfTarget);
                            }
                        }
                        #endregion
                    }
                }
            }

            return new CLContext<List<CL.STRUCTURES.CLASSES.Udf.Udf>>
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<CL.STRUCTURES.CLASSES.Udf.Udf>>
                {
                    Data = udfsValue,
                    Message = ""
                },
                value = udfsValue
            };
        }

        #endregion

        #region BusinessPartnerGroups

        /// <summary>
        /// Retrieves a list of Business Partner Groups from the configured data source.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{List{BusinessPartnerGroup}}"/> object containing the response data and HTTP status code.
        /// </returns>
        public static async Task<CLContext<List<BusinessPartnerGroup>>> GetBusinessPartnersGroups()
        {
            LogManager.Record($"CONFIGURING REQUEST MODEL...");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBusinessPartnersGroups");

                List<BusinessPartnerGroup> resultList = Common.ResolveSAPViewODBC<BusinessPartnerGroup>(contextODBC);

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<BusinessPartnerGroup>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartnerGroup>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetBusinessPartnersGroups").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                return await requestModel.SendAsync<List<BusinessPartnerGroup>>();

                #endregion
            }
        }

        /// <summary>
        /// Retrieves a list of Business Partner Groups filtered by a specific group type.
        /// </summary>
        /// <param name="_groupType">The group type used as a filter (e.g., Customer, Supplier).</param>
        /// <returns>
        /// The task result contains a <see cref="CLContext{List{BusinessPartnerGroup}}"/>
        /// with the filtered Business Partner Groups and HTTP status information.
        /// </returns>
        public static async Task<CLContext<List<BusinessPartnerGroup>>> GetBpGroupsByGroupType(string _groupType)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBPGroups");

                List<BusinessPartnerGroup> resultList = Common.ResolveSAPViewODBC<BusinessPartnerGroup>(contextODBC, new Dictionary<string, object>()
                {
                    {"@GroupType", $"{_groupType}"}
                });

                LogManager.Record($"RESOURCE ODBC: {contextODBC.Resource}");
                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<BusinessPartnerGroup>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<BusinessPartnerGroup>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetBPGroups").Get<FilterBpGroups>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                return await requestModel.SendAsync<List<BusinessPartnerGroup>>();
                #endregion
            }

        }

        #endregion

        #region TypeaheadFormat

        /// <summary>
        /// Formats a string for typeahead display by replacing placeholders in the given pattern
        /// with actual item-related values such as item code, name, stock, barcode, serial number, and bin code.
        /// </summary>
        /// <param name="_pattern">The string pattern containing placeholders (e.g., "@CODE", "@NAME").</param>
        /// <param name="_itemCode">The item code to replace "@CODE".</param>
        /// <param name="_itemName">The item name to replace "@NAME".</param>
        /// <param name="_stock">The stock value to replace "@STOCK".</param>
        /// <param name="_barCode">The barcode to replace "@BARCODE".</param>
        /// <param name="_distNumber">The serial number to replace "@SERIE".</param>
        /// <param name="_binCode">The bin code to replace "@BINCODE".</param>
        /// <returns>A formatted string with all applicable placeholders replaced by their corresponding values.</returns>
        public static string ItemTypeheadFormat(string _pattern, string _itemCode, string _itemName, string _stock,
            string _barCode, string _distNumber, string _binCode)
        {
            try
            {
                string[] valores = _pattern.Split('/');
                string typeheadFormat = string.Empty;

                foreach (string item in valores)
                {
                    if (item.Contains("@CODE") && !string.IsNullOrEmpty(_itemCode))
                    {
                        if (!string.IsNullOrEmpty(typeheadFormat))
                        {
                            typeheadFormat = $"{typeheadFormat}{(item.Replace("@CODE", _itemCode))}";
                        }
                        else
                        {
                            typeheadFormat = $"{(item.Replace("@CODE", _itemCode))}";
                        }
                    }

                    if (item.Contains("@NAME") && !string.IsNullOrEmpty(_itemName))
                    {
                        typeheadFormat = $"{typeheadFormat}{(item.Replace("@NAME", _itemName))}";
                    }

                    if (item.Contains("@STOCK") && !string.IsNullOrEmpty(_stock))
                    {
                        typeheadFormat = $"{typeheadFormat}{(item.Replace("@STOCK", _stock))}";
                    }

                    if (item.Contains("@BARCODE") && !string.IsNullOrEmpty(_barCode))
                    {
                        typeheadFormat = $"{typeheadFormat}{(item.Replace("@BARCODE", _barCode))}";
                    }

                    if (item.Contains("@SERIE") && !string.IsNullOrEmpty(_distNumber))
                    {
                        typeheadFormat = $"{typeheadFormat} {(item.Replace("@SERIE", _distNumber))}";
                    }

                    if (item.Contains("@BINCODE") && !string.IsNullOrEmpty(_binCode))
                    {
                        typeheadFormat = $"{typeheadFormat} {(item.Replace("@BINCODE", _binCode))}";
                    }
                }

                return typeheadFormat;
            }
            catch (Exception)
            {
                throw;
            }
        }

        #endregion

        #region Dimension

        /// <summary>
        /// Retrieves a list of SAP dimensions along with their associated distribution rules.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation. The task result contains a <see cref="CLContext{List{Dimension}}"/>
        /// with the dimension data and their distribution rules.
        /// </returns>
        /// <exception cref="CLException">Thrown if no dimension records are found.</exception>
        public static async Task<CLContext<List<Dimension>>> GetDimensions()
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<Dimension>> oClContext = null;
            List<Dimension> dimensions = new List<Dimension>();

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetDimensions");
                LogManager.Record($"RESOURCE: {ctx.Resource}");
                dimensions = Common.ResolveSAPViewODBC<Dimension>(ctx, new Dictionary<string, object>());

                oClContext = new CLContext<List<Dimension>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<Dimension>> { Data = dimensions },
                    value = dimensions
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetDimensions").Get();
                LogManager.Record($"RESOURCE: {req.Url_Request}");
                oClContext = await req.SendAsync<List<Dimension>>();
                dimensions = oClContext.Response.Data;
            }

            if (oClContext == null || oClContext.Response?.Data == null)
            {
                throw new CLException("CL No se encontraron registros.", HttpStatusCode.NotFound);
            }

            foreach (var dimension in dimensions)
            {
                List<DistributionRules> rules;

                if (connectionMode == SapConnectionType.ODBC)
                {
                    ClUserContextODBC ctxLines = GetUserCtxODBC("ODBC_GetDistributionRulesByDimension");
                    LogManager.Record($"RESOURCE: {ctxLines.Resource}");
                    rules = Common.ResolveSAPViewODBC<DistributionRules>(
                        ctxLines,
                        new Dictionary<string, object> { { "@DimCode", dimension.DimCode } });
                }
                else
                {
                    SLRequestObject reqLines = GetUserCtx("SL_GetDistributionRulesByDimension")
                        .Get(new FilterDimension()
                        {
                            DimCode = dimension.DimCode
                        });
                    LogManager.Record($"RESOURCE: {reqLines.Url_Request}");
                    CLContext<List<DistributionRules>> linesCtx = await reqLines.SendAsync<List<DistributionRules>>();
                    rules = linesCtx.Response.Data;
                }

                dimension.DistributionRulesList = rules;
            }

            LogManager.Record("REQUEST COMPLETED");

            return oClContext;
        }

        #endregion

        #region Approvals

        /// <summary>
        /// Retrieves the list of approval query conditions for a specific business partner and document type,
        /// based on the current SAP license assigned to the user.
        /// </summary>
        /// <param name="cardCode">The business partner card code.</param>
        /// <param name="documentType">The internal document type identifier.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a list of <see cref="QueryCondition"/> records 
        /// that define conditional approval logic for the given context.
        /// </returns>
        /// <exception cref="CLException">Thrown when license retrieval or query fails.</exception>
        public static async Task<CLContext<List<QueryCondition>>> GetApprovalQueryConditions(string cardCode, int documentType)
        {
            LogManager.Record("REQUESTING RECORDS");
            string connectionMode = GetConnectionMode();
            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<QueryCondition>> oClContext;
            CLContext<CLLicense> licenseCtx = Services
                .Execute<CLLicense, MainDBContext, int, ICLSingle>(
                    "GetLicenseByUser",
                    CL.COMMON.Core.GetClaimUserId())
                .Get();
            string sapLicense = licenseCtx.Response.Data.User
                .Substring(licenseCtx.Response.Data.User.LastIndexOf('\\') + 1);

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC ctx = GetUserCtxODBC("ODBC_GetApprovalQueryConditions");
                LogManager.Record($"RESOURCE: {ctx.Resource}");
                List<QueryCondition> resultList =
                    Common.ResolveSAPViewODBC<QueryCondition>(
                        ctx,
                        new Dictionary<string, object>{
                            { "@CardCode",  cardCode      },
                            { "@DocType",   documentType  },
                            { "@SapLicense", sapLicense   }
                        });
                LogManager.Record("REQUEST COMPLETED");
                oClContext = new CLContext<List<QueryCondition>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<QueryCondition>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject req = GetUserCtx("SL_GetApprovalQueryConditions")
                    .Get(new FilterApprovalQuery()
                    {
                        CardCode = cardCode,
                        DocType = documentType,
                        SapLicense = sapLicense
                    });
                LogManager.Record($"RESOURCE: {req.Url_Request}");
                oClContext = await req.SendAsync<List<QueryCondition>>();
                LogManager.Record("REQUEST COMPLETED");
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of approval requests based on the specified filters.
        /// </summary>
        /// <param name="DateInit">The start date for filtering approval requests.</param>
        /// <param name="DateEnd">The end date for filtering approval requests.</param>
        /// <param name="DraftEntry">The draft entry number to filter approval requests.</param>
        /// <param name="ApprovalStatus">The status of the approval requests to filter by.</param>
        /// <param name="DocType">The document type to filter approval requests.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{ApprovalRequest}}"/> with the filtered approval requests.</returns>
        public static async Task<CLContext<List<ApprovalRequest>>> GetApprovalRequests(
            string DateInit,
            string DateEnd,
            int DraftEntry,
            string ApprovalStatus,
            string DocType
        )
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<ApprovalRequest>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetApprovalRequestsByFilters");

                List<ApprovalRequest> resultList = Common.ResolveSAPViewODBC<ApprovalRequest>(
                    contextODBC, new Dictionary<string, object>
                {
                    { "@ApprovalStatus", ApprovalStatus },
                    { "@DocType", DocType },
                    { "@DraftEntry", DraftEntry },
                    { "@DateInit", DateInit },
                    { "@DateEnd", DateEnd }
                });

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<ApprovalRequest>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<ApprovalRequest>> { Data = resultList },
                    value = resultList
                };
            }
            else
            {
                SLRequestObject requestModel = GetUserCtx("SL_GetApprovalRequestsByFilters")
                    .Get(new FilterApprovalRequests()
                    {
                        ApprovalStatus = ApprovalStatus,
                        DocType = DocType,
                        DraftEntry = DraftEntry,
                        DateInit = DateInit,
                        DateEnd = DateEnd
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<ApprovalRequest>>();
            }

            return oClContext;
        }

        /// <summary>
        /// Method to create a firm document from the base
        /// </summary>
        /// <param name="_approvalRequest"></param>
        /// <returns></returns>
        public static async Task<CLContext<ApprovalRequest>> PatchApprovalRequests(ApprovalRequest _approvalRequest, int _documentType)
        {
            LogManager.Record("REQUESTING PATCH OBJECT");
            if (_approvalRequest.ApprovedType == "SAP")
            {
                List<string> oRemoveHeaderProperties = new List<string>()
                {
                    "Code",
                    "ApprovalTemplatesID",
                    "ObjectType",
                    "IsDraft",
                    "ObjectEntry",
                    "Status",
                    "Remarks",
                    "CurrentStage",
                    "OriginatorID",
                    "CreationDate",
                    "CreationTime",
                    "DraftEntry",
                    "DraftType",
                    "ApprovalRequestLines",
                    "ApprovedType"
                };

                string headerProperties = string.Join(",", oRemoveHeaderProperties);

                SLRequestObject requestModel = GetUserCtx("PatchApprovalRequests")
                    .Patch(_approvalRequest, _fieldsToRemoveInHeaders: headerProperties);

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

                CLContext<ApprovalRequest> oClPatchContext = await requestModel.SendAsync<ApprovalRequest>();

                LogManager.Record($"REQUEST COMPLETED");

                if (oClPatchContext.Code == HttpStatusCode.NoContent)
                {
                    #region Validar si el documento esta completamente aprobado

                    LogManager.Record("REQUESTING RECORDS");

                    SLRequestObject requestCodeModel = GetUserCtx("GetApprovalRequestsByCode").Get(
                        new FilterApprovalRequestByCode()
                        {
                            Code = _approvalRequest.Code
                        });

                    LogManager.Record($"RESOURCE: {requestCodeModel.Url_Request}");

                    CLContext<ApprovalRequest> oClStatusContext = await requestCodeModel.SendAsync<ApprovalRequest>();

                    LogManager.Record($"REQUEST COMPLETED");
                    if (oClStatusContext.Response.Data != null)
                    {
                        int companyId = GetCompanyId();
                        NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                        try
                        {
                            CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                            if (oCLContextSetting.Response.Data != null)
                            {
                                List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                oDraftsSetting = settingList.Find(_setting => _setting.CompanyId == companyId);
                                if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                {
                                    await SendNotifyAutoritation(oClStatusContext.Response.Data.DraftEntry, companyId, false);
                                }
                            }
                        }
                        catch (Exception e)
                        {
                            LogManager.Record($"Error: {e.Message}");
                        }
                    }
                    if (oClStatusContext.Response.Data is object && oClStatusContext.Response.Data.Status == Approval_Status.Approved)
                    {
                        //Obtiene la lista de terminos de pago

                        CLContext<List<PayTerm>> oClPayTerms = await GetPayTerms();

                        //Consulta del preliminar para validad el termino de pago
                        ClUserContextODBC contextODBC = GetUserCtxODBC("GetDraftsByDocEntry");
                        Dictionary<string, object> parameters = new Dictionary<string, object>
                        {
                            { "@DocEntry",  _approvalRequest.DraftEntry } // Assuming docEntry is a parameter for the query
                        };

                        List<Drafts> resultList = Common.ResolveSAPViewODBC<Drafts>(contextODBC, parameters);

                        CLContext<Drafts> oClContext = new CLContext<Drafts>()
                        {
                            Code = HttpStatusCode.OK,
                            Response = new Response<Drafts>()
                            {
                                Data = resultList.FirstOrDefault() // Assuming you want the first result
                            }
                            ,
                            value = resultList.FirstOrDefault()
                        };


                        int payTermType = oClPayTerms.Response.Data.Find(_term => _term.GroupNum == oClContext.Response.Data.PaymentGroupCode).Type;

                        //se valida si el termino de pago es a contado
                        if (payTermType == 2 && (_documentType != (int)Constants.DocumentType.PurchaseOrder && _documentType != (int)Constants.DocumentType.SalesOrders && _documentType != (int)Constants.DocumentType.SalesQuotations))
                        {
                            return new CLContext<ApprovalRequest>()
                            {
                                Response = new Response<ApprovalRequest>()
                                {
                                    Data = oClStatusContext.Response.Data,
                                },
                                Code = HttpStatusCode.OK
                            };

                        }

                        // Pasar el documento en firme

                        ApprovedDraft approvalDraft = new ApprovedDraft()
                        {
                            Document = new Draft()
                            {
                                DocEntry = _approvalRequest.DraftEntry
                            }
                        };

                        CLContext<ApprovalRequest> oClConfirmContext = await ConfirmDraftDocument(approvalDraft);

                        if (oClConfirmContext.Code == HttpStatusCode.NoContent)
                        {
                            return oClStatusContext;
                        }
                    }

                    #endregion

                    return oClStatusContext;
                }
                else
                {
                    return oClPatchContext;
                }
            }
            else
            {
                ApprovedDraft approvalDraft = new ApprovedDraft()
                {
                    Document = new Draft()
                    {
                        DocEntry = _approvalRequest.DraftEntry
                    }
                };
                ApprovalRequest oApprovalRequests = new ApprovalRequest();
                CLContext<ApprovalRequest> oClConfirmContext = null;
                CLContext<DraftUpdateStaus> oClContextPatchDraft = null;

                DraftUpdateStaus pStatusDocument = new DraftUpdateStaus() { DocEntry = _approvalRequest.DraftEntry, Udfs = new List<CL.STRUCTURES.CLASSES.Udf.Udf>() };
                switch (_approvalRequest.ApprovalRequestDecisions[0].Status)
                {
                    case "ardApproved":
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Status",
                            Value = Approval_Status.Approved,
                            FieldType = "String"
                        });
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Remarks",
                            Value = _approvalRequest.ApprovalRequestDecisions[0].Remarks ?? "",
                            FieldType = "String"
                        });

                        oClContextPatchDraft = await PatchDraft(pStatusDocument);

                        if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                        {
                            CLContext<ApprovalRequest> oClConfirmContextDrafts = await ConfirmDraftDocument(approvalDraft);

                            if (oClConfirmContextDrafts.Code == HttpStatusCode.NoContent)
                            {
                                int companyId = GetCompanyId();
                                NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                                try
                                {
                                    CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting =
                                        Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                                    if (oCLContextSetting.Response.Data != null)
                                    {
                                        List<NotificationsDraftsSetting> settingList =
                                            JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(
                                                oCLContextSetting.Response.Data.Json);
                                        oDraftsSetting = settingList.Find(_setting => _setting.CompanyId == companyId);
                                        if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                        {
                                            await SendNotifyAutoritation(_approvalRequest.DraftEntry, companyId, false);
                                        }
                                    }

                                    oClConfirmContext = oClConfirmContextDrafts;
                                }
                                catch (Exception e)
                                {
                                    LogManager.Record($"Error: {e.Message}");
                                }
                            }
                        }

                        break;

                    case "ardNotApproved":
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Status",
                            Value = Approval_Status.Rejected,
                            FieldType = "String"
                        });
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Remarks",
                            Value = _approvalRequest.ApprovalRequestDecisions[0].Remarks ?? "",
                            FieldType = "String"
                        });

                        oClContextPatchDraft = await PatchDraft(pStatusDocument);

                        if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                        {
                            int companyId = GetCompanyId();
                            NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                            try
                            {
                                CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                                if (oCLContextSetting.Response.Data != null)
                                {
                                    List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                    oDraftsSetting = settingList.Find(_setting => _setting.CompanyId == companyId);
                                    if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                    {
                                        await SendNotifyAutoritation(_approvalRequest.DraftEntry, companyId, false);
                                    }
                                }
                                oClConfirmContext = new CLContext<ApprovalRequest>()
                                {
                                    Code = HttpStatusCode.OK,
                                    Response = new Response<ApprovalRequest>()
                                    {
                                        Data = new ApprovalRequest() { DraftEntry = _approvalRequest.DraftEntry }
                                    },
                                    value = new ApprovalRequest() { DraftEntry = _approvalRequest.DraftEntry }
                                };
                            }
                            catch (Exception e)
                            {
                                LogManager.Record($"Error: {e.Message}");
                            }
                        }

                        break;

                    case "ardPending":
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Status",
                            Value = Approval_Status.Pending,
                            FieldType = "String"
                        });
                        pStatusDocument.Udfs.Add(new CL.STRUCTURES.CLASSES.Udf.Udf()
                        {
                            Name = "U_EMA_Approval_Remarks",
                            Value = _approvalRequest.ApprovalRequestDecisions[0].Remarks ?? "",
                            FieldType = "String"
                        });

                        oClContextPatchDraft = await PatchDraft(pStatusDocument);

                        if (oClContextPatchDraft.Code == HttpStatusCode.NoContent)
                        {
                            int companyId = GetCompanyId();
                            NotificationsDraftsSetting oDraftsSetting = new NotificationsDraftsSetting();
                            try
                            {
                                CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.AuthorizationNotifications, true);
                                if (oCLContextSetting.Response.Data != null)
                                {
                                    List<NotificationsDraftsSetting> settingList = JsonConvert.DeserializeObject<List<NotificationsDraftsSetting>>(oCLContextSetting.Response.Data.Json);
                                    oDraftsSetting = settingList.Find(_setting => _setting.CompanyId == companyId);
                                    if (oDraftsSetting != null && oDraftsSetting.ActiveNotifications)
                                    {
                                        await SendNotifyAutoritation(_approvalRequest.DraftEntry, companyId, false);
                                    }
                                }
                                oClConfirmContext = new CLContext<ApprovalRequest>()
                                {
                                    Code = HttpStatusCode.OK,
                                    Response = new Response<ApprovalRequest>()
                                    {
                                        Data = new ApprovalRequest() { DraftEntry = _approvalRequest.DraftEntry }
                                    },
                                    value = new ApprovalRequest() { DraftEntry = _approvalRequest.DraftEntry }
                                };
                            }
                            catch (Exception e)
                            {
                                LogManager.Record($"Error: {e.Message}");
                            }
                        }

                        break;
                }

                return oClConfirmContext;
            }
        }

        /// <summary>
        /// Sends a draft document for confirmation and creates a final document.
        /// </summary>
        /// <param name="_approvedDraft">The draft document data to be confirmed.</param>
        /// <param name="_userId">The user ID associated with the operation. Optional.</param>
        /// <param name="_companyId">The company ID associated with the operation. Optional.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{ApprovalRequest}"/> with the result of the confirmation.</returns>
        private static async Task<CLContext<ApprovalRequest>> ConfirmDraftDocument(ApprovedDraft _approvedDraft, int _userId = -1, int _companyId = -1)
        {
            LogManager.Record("REQUESTING POST OBJECT");

            SLRequestObject requestModel = GetUserCtx("SaveDraftToDocument", _userId, _companyId).Post(_approvedDraft);

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");
            LogManager.Record($"DOCUMENT SERIALIZED: {requestModel.Content}");

            return await requestModel.SendAsync<ApprovalRequest>();
        }

        /// <summary>
        /// Retrieves approval requests based on the specified list of approval request codes.
        /// </summary>
        /// <param name="_codes">The list of approval request codes used to retrieve approval requests.</param>
        /// <returns>An asynchronous task that returns a context containing a list of ApprovalRequest objects based on the provided list of approval request codes.</returns>
        public static async Task<CLContext<List<ApprovalRequest>>> GetApprovalRequest(List<int> _codes)
        {
            List<ApprovalRequest> approvalList = new List<ApprovalRequest>();

            LogManager.Record("REQUESTING RECORDS");
            SLRequestObject requestModel = null;
            CLContext<List<ApprovalRequest>> approveList = null;

            if (_codes.Count > 0)
            {
                foreach (int oApprovalRequest in _codes)
                {
                    LogManager.Record("REQUESTING RECORDS");
                    SLRequestObject requestModelApprov = GetUserCtx("GetApprovalRequestsByDraftEntry").Get(new FilterApprovalRequests()
                    {
                        DraftEntry = oApprovalRequest
                    });
                    LogManager.Record($"RESOURCE: {requestModelApprov.Url_Request}");
                    LogManager.Record($"REQUEST COMPLETED");
                    CLContext<List<ApprovalRequest>> allApprovList = await requestModelApprov.SendAsync<List<ApprovalRequest>>();

                    if (allApprovList.Response.Data.Count > 0)
                    {
                        approvalList.Add(allApprovList.Response.Data[0]);
                    }
                }
            }
            return new CLContext<List<ApprovalRequest>>()
            {
                value = approvalList,
                Response = new Response<List<ApprovalRequest>>()
                {
                    Data = approvalList,
                    Message = approvalList.Count > 0 ? "Se encontraron las aprobaciones" : "No se encontraron las aprobaciones"
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Sends notification emails regarding the authorization status of a draft document.
        /// This function supports sending notifications both for approvals and for state updates.
        /// </summary>
        /// <param name="_docEntry">The identifier of the draft document.</param>
        /// <param name="_companyId">The identifier of the company the document belongs to.</param>
        /// <param name="_isApprove">
        /// Indicates whether the operation is an approval (`true`) or just a status update (`false`).
        /// </param>
        /// <param name="_queryConditionApply">
        /// Optional parameter that defines conditional logic to apply when retrieving approvers.
        /// If provided and `IsApply` is true, it alters how approver filters are constructed.
        /// </param>
        /// <returns>A <see cref="CLContext{string}"/> with the operation result status.</returns>
        public static async Task<CLContext<string>> SendNotifyAutoritation(int _docEntry, int _companyId, bool _isApprove, QueryConditionApply _queryConditionApply = null)
        {
            NotificationsBodySetting bodySetting = new NotificationsBodySetting();
            LogManager.Record($"Inicia el flujo de notificaciones para el documento con draftEntry {_docEntry}");
            try
            {
                CLContext<CLMLTEMA.MODELS.Setting> oCLContextSetting = Process.GetSettingByCode(SettingsEnum.EmailAuthoritation, true);
                if (oCLContextSetting.Response.Data == null)
                {
                    throw new CLException($"CL - No se ha encontrado una configuracion valida para el code '{SettingsEnum.EmailAuthoritation}'.",
                        HttpStatusCode.NotFound);
                }
                if (oCLContextSetting.Response.Data != null)
                {
                    List<NotificationsBodySetting> settingList = JsonConvert.DeserializeObject<List<NotificationsBodySetting>>(oCLContextSetting.Response.Data.Json);
                    bodySetting = settingList.Find(_setting => _setting.CompanyId == _companyId);
                    if (bodySetting.Body.Length > 0 && _isApprove)
                    {
                        bodySetting.Body = bodySetting.Body.Replace("#StatusTitle#", "creacion");
                        bodySetting.Body = bodySetting.Body.Replace("#StatusBody#", "creado");
                        bodySetting.Body = bodySetting.Body.Replace("#DraftId#", $"{_docEntry}");
                    }
                    if (bodySetting.Body.Length > 0 && !_isApprove)
                    {
                        bodySetting.Body = bodySetting.Body.Replace("#StatusTitle#", "actualizacion del estado");
                        bodySetting.Body = bodySetting.Body.Replace("#StatusBody#", "modificado el estado de");
                        bodySetting.Body = bodySetting.Body.Replace("#DraftId#", $"{_docEntry}");
                    }
                }
                if (_isApprove)
                {
                    string connectionMode = GetConnectionMode();
                    LogManager.Record($"CONNECTION MODE: {connectionMode}");

                    CLContext<List<SapLicencesDrafts>> oClStatusContext = null;

                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        #region Query Approvers Via ODBC

                        ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetUserAppover", -1, _companyId);

                        Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                        {
                            { "@DocEntry", _queryConditionApply?.IsApply == true ? -1 : _docEntry },
                            { "@WtmCode", _queryConditionApply?.IsApply == true ? _queryConditionApply?.QueryCondition?.WtmCode ?? 0 : 0 }
                        };

                        LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                        List<SapLicencesDrafts> resultList = Common.ResolveSAPViewODBC<SapLicencesDrafts>(contextODBC, parametersODBC);

                        oClStatusContext = new CLContext<List<SapLicencesDrafts>>()
                        {
                            Code = HttpStatusCode.OK,
                            Response = new Response<List<SapLicencesDrafts>>() { Data = resultList },
                            value = resultList
                        };

                        #endregion
                    }
                    else
                    {
                        #region Query Approvers Via Service Layer

                        FilterApproveDRafts filter = new FilterApproveDRafts()
                        {
                            DocEntry = _queryConditionApply?.IsApply == true ? -1 : _docEntry,
                            WtmCode = _queryConditionApply?.IsApply == true ? _queryConditionApply?.QueryCondition?.WtmCode ?? 0 : 0
                        };

                        SLRequestObject approveSlRequestObject = GetUserCtx("SL_GetUserAppover", -1, _companyId).Get<FilterApproveDRafts>(filter);

                        LogManager.Record($"RESOURCE: {approveSlRequestObject.Url_Request}");

                        oClStatusContext = await approveSlRequestObject.SendAsync<List<SapLicencesDrafts>>();

                        #endregion
                    }

                    LogManager.Record($"REQUEST COMPLETED");
                    if (oClStatusContext.Response.Data == null)
                    {
                        throw new CLException($"CL - No se ha encontrado usuarios aprobadores para el documento con draftEntry {_docEntry}.",
                            HttpStatusCode.NotFound);
                    }

                    if (oClStatusContext.Response.Data != null)
                    {
                        List<SapLicencesDrafts> sapLicencesDrafts = oClStatusContext.Response.Data.GroupBy(d => d.Email).Select(g => g.First()).ToList();

                        foreach (var _user in sapLicencesDrafts)
                        {
                            if (_user.Email == null)
                            {
                                LogManager.Record($"No se ha especificado el correo para el usuario : {_user.SapLicense}, verifique en SAP la asignacion del correo mencionado.");
                            }
                            else
                            {
                                SendEmailAutoritathionModel model = new SendEmailAutoritathionModel()
                                {
                                    Body = bodySetting.Body,
                                    Subject = bodySetting.Subject,
                                    To = _user.Email
                                };
                                SendNotifyDrafts(model);
                            }
                        }
                    }
                }
                else
                {
                    string connectionMode = GetConnectionMode();
                    LogManager.Record($"CONNECTION MODE: {connectionMode}");

                    CLContext<List<SapLicencesDrafts>> oClStatusContext = null;

                    if (connectionMode == SapConnectionType.ODBC)
                    {
                        #region Query Authors Via ODBC

                        ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetUserAuthor", -1, _companyId);

                        Dictionary<string, object> parametersODBC = new Dictionary<string, object>
                        {
                            { "@DocEntry", _docEntry }
                        };

                        LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                        List<SapLicencesDrafts> resultList = Common.ResolveSAPViewODBC<SapLicencesDrafts>(contextODBC, parametersODBC);

                        oClStatusContext = new CLContext<List<SapLicencesDrafts>>()
                        {
                            Code = HttpStatusCode.OK,
                            Response = new Response<List<SapLicencesDrafts>>() { Data = resultList },
                            value = resultList
                        };

                        #endregion
                    }
                    else
                    {
                        #region Query Authors Via Service Layer

                        FilterApproveDRafts filter = new FilterApproveDRafts()
                        {
                            DocEntry = _docEntry
                        };

                        SLRequestObject authorSlRequestObject = GetUserCtx("SL_GetUserAuthor", -1, _companyId).Get<FilterApproveDRafts>(filter);

                        LogManager.Record($"RESOURCE: {authorSlRequestObject.Url_Request}");

                        oClStatusContext = await authorSlRequestObject.SendAsync<List<SapLicencesDrafts>>();

                        #endregion
                    }

                    LogManager.Record($"REQUEST COMPLETED");
                    if (oClStatusContext.Response.Data == null)
                    {
                        throw new CLException($"CL - No se ha encontrado usuarios autores para el documento con draftEntry {_docEntry}.",
                            HttpStatusCode.NotFound);
                    }

                    if (oClStatusContext.Response.Data != null)
                    {
                        foreach (var _user in oClStatusContext.Response.Data)
                        {
                            if (_user.Email == null)
                            {
                                LogManager.Record($"No se ha especificado el correo para el usuario : {_user.SapLicense}, verifique en SAP la asignacion del correo mencionado.");
                            }
                            else
                            {
                                SendEmailAutoritathionModel model = new SendEmailAutoritathionModel()
                                {
                                    Body = bodySetting.Body,
                                    Subject = bodySetting.Subject,
                                    To = _user.Email
                                };
                                SendNotifyDrafts(model);
                            }
                        }
                    }
                }
                return new CLContext<string>() { Code = HttpStatusCode.Found };
            }
            catch (CLException e)
            {
                LogManager.Record($"Ha ocurrido un error : {e.Message} , con status code: {e.Code}");
                return new CLContext<string>() { Code = HttpStatusCode.NotFound };
            }
        }

        #endregion

        #region BlanketAgreement

        /// <summary>
        ///  Method to blanket header
        /// </summary>
        /// <param name="pLastUpdate"></param>
        /// <returns></returns>
        public static async Task<CLContext<List<MobileBlanketAgreement>>> GetBlanketAgreements(String _cardCode)
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            CLContext<List<MobileBlanketAgreement>> oCLContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBlanketAgreements");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileBlanketAgreement> resultList = Common.ResolveSAPViewODBC<MobileBlanketAgreement>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@CardCode", $"{_cardCode}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = new CLContext<List<MobileBlanketAgreement>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileBlanketAgreement>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx("SL_GetBlanketAgreements").Get<FilterBaseByCardCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                oCLContext = await requestModel.SendAsync<List<MobileBlanketAgreement>>();
                #endregion
            }

            CLContext<List<MobileBlanketAgreementDetail>> lines = await GetBlanketAgreementDetails();

            foreach (MobileBlanketAgreement agreement in oCLContext.Response.Data)
            {
                agreement.Lines = lines.Response.Data.Where(_x => _x.AbsID == agreement.AbsID).ToList();
            }

            LogManager.Record($"REQUEST COMPLETED");

            return oCLContext;

        }

        /// <summary>
        ///  Method to obtained blanket details
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<List<MobileBlanketAgreementDetail>>> GetBlanketAgreementDetails()
        {
            LogManager.Record($"REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetBlanketAgreementDetails");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileBlanketAgreementDetail> resultList = Common.ResolveSAPViewODBC<MobileBlanketAgreementDetail>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileBlanketAgreementDetail>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileBlanketAgreementDetail>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }

            #region Query Via SL
            SLRequestObject requestModel = GetUserCtx("SL_GetBlanketAgreementDetails").Get();

            LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

            LogManager.Record($"REQUESTING COMPLETED");

            return await requestModel.SendAsync<List<MobileBlanketAgreementDetail>>();
            #endregion

        }

        #endregion

        #region Freight

        /// <summary>
        /// Calcule the freight cost items
        /// </summary>
        /// <param name="_itemCode">Item to search</param>
        /// <param name="_filterWarehouse">Warehouse to search</param>
        /// <returns></returns>
        public static async Task<CLContext<List<ItemToFreight>>> CalculateFreight(string DocCurrency, List<ItemToFreight> itemsToFreight)
        {
            List<ItemToFreight> itemsToFreightList = new List<ItemToFreight>();

            foreach (ItemToFreight itemtoFreight in itemsToFreight)
            {
                LogManager.Record("REQUESTING RECORDS");

                ClUserContextODBC contextODBC = GetUserCtxODBC("CalculateFreight");

                List<ItemToFreight> resultList = Common.ResolveSAPProcedureODBC<ItemToFreight>(contextODBC, new Dictionary<string, object>()
                {
                    {"@ItemCode",  $"{itemtoFreight.ItemCode}"},
                    {"@TaxCode",  $"{itemtoFreight.TaxCode}"},
                    {"@TaxRate",  $"{itemtoFreight.TaxRate}"},
                    {"@Quantity",  $"{itemtoFreight.Quantity}"},
                    {"@CardCode",  $"{itemtoFreight.CardCode}"},
                    {"@DocCurrency",  $"{DocCurrency}"}
                });

                itemsToFreightList.Add(resultList.First());

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");
                LogManager.Record($"REQUEST COMPLETED");
            }

            itemsToFreightList = (
                from freightedItem in itemsToFreightList
                group freightedItem by freightedItem.TaxCode into tmpItemFreighted
                select new ItemToFreight()
                {
                    TaxCode = tmpItemFreighted.First().TaxCode,
                    TaxRate = tmpItemFreighted.First().TaxRate,
                    ItemCode = tmpItemFreighted.First().ItemCode,
                    Price = Math.Round(tmpItemFreighted.Max(x => x.Price), 2),
                    Quantity = Math.Round(tmpItemFreighted.Sum(x => x.Quantity), 2),
                    ItemName = tmpItemFreighted.First().ItemName,
                    SUoMEntry = tmpItemFreighted.First().SUoMEntry,
                    WhsCode = tmpItemFreighted.First().WhsCode,
                }).ToList();

            return new CLContext<List<ItemToFreight>>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<ItemToFreight>>()
                {
                    Data = itemsToFreightList,
                    Message = ""
                },
                value = itemsToFreightList
            };
        }

        #endregion

        #region Sync Documents

        /// <summary>
        /// Retrieves a paginated list of synchronized documents based on filters like status, type, and date range.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{SyncDocumentsPaged}"/> containing the filtered documents and total count.
        /// </returns>
        public static async Task<CLContext<SyncDocumentsPaged>> GetSyncDocument(string _filter, string _status,
            string _type, DateTime _from, DateTime _to, int _skip, int _take)
        {
            LogManager.Record($"REQUESTING RECORD");

            SyncDocumentFilter filter = new SyncDocumentFilter()
            {
                Filter = _filter,
                Status = _status,
                Type = _type,
                From = _from,
                To = _to,
                Skip = _skip,
                Take = _take
            };

            CLContext<Common.SingleValue<int>> oClCountContext = Services
                .Execute<Common.SingleValue<int>, SyncDocumentFilter, MainDBContext, ICLSingle>("GetSyncDocumentsCount",
                    filter).Get();

            CLContext<IEnumerable<SyncDocument>> oClSyncDocumentsContext = Services
                .Execute<SyncDocumentFilter, SyncDocument, MainDBContext>("GetSyncDocuments", filter).Get();

            SyncDocumentsPaged oSyncDocumentsPaged = new SyncDocumentsPaged()
            {
                SyncDocuments = oClSyncDocumentsContext.Response.Data,
                Count = oClCountContext.Response.Data.Value
            };

            LogManager.Record($"REQUEST COMPLETED");

            return new CLContext<SyncDocumentsPaged>()
            {
                Code = oClSyncDocumentsContext.Code,
                value = oSyncDocumentsPaged,
                Response = new Response<SyncDocumentsPaged>()
                {
                    Data = oSyncDocumentsPaged,
                    Message = oClSyncDocumentsContext.Response.Message
                }
            };
        }

        /// <summary>
        /// Retrieves a single synchronized document by its ID.
        /// </summary>
        /// <param name="_id">The document ID.</param>
        /// <returns>
        /// A <see cref="CLContext{SyncDocument}"/> containing the requested document.
        /// </returns>
        public static async Task<CLContext<SyncDocument>> GetSyncDocument(int _id)
        {
            LogManager.Record($"REQUESTING RECORD");

            CLContext<SyncDocument> oClContext = Services
                .Execute<SyncDocument, MainDBContext, int, ICLSingle>("GetSyncDocumentById", _id).Get();

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Submits a list of documents for synchronization. Adds metadata and updates the status accordingly.
        /// </summary>
        /// <param name="_syncDocuments">The list of documents to sync.</param>
        /// <returns>
        /// A <see cref="CLContext{List{SyncDocument}}"/> with synchronization results and status.
        /// </returns>
        public static async Task<CLContext<List<SyncDocument>>> PostSyncDocument(List<SyncDocument> _syncDocuments)
        {
            LogManager.Record($"REQUESTING POST OBJECT");

            string createdBy = CL.COMMON.Core.GetClaimValue<string>("UserEmail");

            string[] propsToExclude = new SyncDocument().GetType().GetProperties().Where(prop =>
                !(new[]
                {
                    "CreatedBy", "RawDocument", "DocumentType", "DocumentKey", "OfflineDate", "TransactionType",
                    "UserAssignId"
                }.Contains(prop.Name))).Select(prop => prop.Name).ToArray();

            foreach (SyncDocument _document in _syncDocuments)
            {
                try
                {
                    _document.CreatedBy = createdBy;

                    _document.TransactionStatus = DocumentSyncStatus.InQueue;

                    LogManager.Record($"SAVING OFFLINE DOCUMENT... | DOCUMENT INFO: {JsonConvert.SerializeObject(_document)}");

                    CLContext<SyncDocument> oClContext = _document.Post<SyncDocument, MainDBContext, ICLExclude, ICLSingle>("PostSyncDocument", propsToExclude);

                    if (oClContext.Response.Data == null || !((int)oClContext.Code > 199 && (int)oClContext.Code < 300))
                    {
                        _document.TransactionStatus = DocumentSyncStatus.NotSynchronized;

                        _document.TransactionDetail = oClContext.Response.Message;
                    }

                    LogManager.Record($"OFFLINE DOCUMENT SAVE RESPONSE | RESPONSE: {JsonConvert.SerializeObject(oClContext)}");
                }
                catch (Exception e)
                {
                    _document.TransactionStatus = DocumentSyncStatus.NotSynchronized;

                    _document.TransactionDetail = e.Message;

                    LogManager.Record($"[ERROR] - ${e.Message}");
                }
            }

            LogManager.Record($"REQUEST COMPLETED");

            return new CLContext<List<SyncDocument>>()
            {
                Code = HttpStatusCode.Created,
                Response = new Response<List<SyncDocument>>()
                {
                    Data = _syncDocuments,
                    Message = ""
                }
            };
        }

        /// <summary>
        /// Updates the synchronization status of a given document.
        /// </summary>
        /// <param name="_syncDocument">The document to update.</param>
        /// <returns>
        /// A <see cref="CLContext{SyncDocument}"/> with the updated status.
        /// </returns>
        public static CLContext<SyncDocument> PatchSyncDocumentStatus(SyncDocument _syncDocument)
        {
            LogManager.Record($"REQUESTING PATCH OBJECT");

            _syncDocument.UpdatedBy = "Service";

            CLContext<SyncDocument> oClContext =
                Services.Execute<SyncDocument, MainDBContext, ICLInclude, ICLSingle>("UpdateSyncDocumentStatus",
                    _syncDocument, "TransactionStatus", "UpdatedBy", "Id");

            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Update the information of the sync document in the database
        /// </summary>
        /// <param name="_syncDocument">Sync document information</param>
        /// <returns>Updated sync document</returns>
        public static CLContext<SyncDocument> PatchSyncDocument(SyncDocument _syncDocument)
        {
            LogManager.Record($"UPDATING SYNC DOCUMENT INFORMATION...");

            _syncDocument.UpdatedBy = "SyncService";

            CLContext<SyncDocument> oClContext =
                _syncDocument.Patch<SyncDocument, MainDBContext, ICLExclude, ICLSingle>("UpdateSyncDocument",
                    "UserAssignId", "OfflineDate", "TransactionType", "DocumentKey", "DocumentType", "RawDocument", "UserAssign", "IsActive");

            LogManager.Record($"SYNC DOCUMENT INFORMATION UPDATED");

            return oClContext;
        }

        /// <summary>
        /// Method to sync docuemnt to sap
        /// </summary>
        /// <returns></returns>
        public static async Task<CLContext<SyncDocumentStatus>> SyncDocumentsToSap()
        {
            SyncDocumentStatus syncDocumentStatus = new SyncDocumentStatus()
            {
                Status = "Starting",
                Count = 0,
                Errors = 0
            };

            // Service take documents by lots of defined
            // quantity to avoid memory errors

            LogManager.Record($"REQUESTING DOCUMENTS TO BE SYNC");

            CLContext<IEnumerable<SyncDocument>> syncDocumentsContext = Services.Execute<SyncDocument, MainDBContext, int>("GetSyncDocumentForService", 1);

            List<SyncDocument> syncDocuments = syncDocumentsContext.Response.Data.ToList();

            if (syncDocuments.Any())
            {
                LogManager.Record($"[{syncDocuments.Count}] DOCUMENT TO BE SYNC");

                syncDocumentStatus.Count = syncDocuments.Count;

                List<SyncDocument> oSyncDocuments = new List<SyncDocument>();

                LogManager.Record($"UPDATING STATUS TO PROCESSING ON DOCUMENTS SELECTED");
                // That is an important stage to avoid the concurrency problems when more than one instance
                // of the service was running at the same time
                foreach (SyncDocument syncDocument in syncDocuments)
                {
                    syncDocument.TransactionStatus = DocumentSyncStatus.Processing;

                    CLContext<SyncDocument> sdUpdateStatusContext = PatchSyncDocumentStatus(syncDocument);

                    if (sdUpdateStatusContext.Response.Data is null)
                    {
                        LogManager.Record(
                            $"DOCUMENT WITH KEY [{syncDocument.DocumentKey}] COULD NOT BE STATUS UPDATED");
                        LogManager.Record($"THE DOCUMENT WILL NOT BE PROCESSED");
                    }
                    else
                    {
                        oSyncDocuments.Add(syncDocument);
                    }
                }

                IEnumerable<IGrouping<int, SyncDocument>> groupedDocuments = oSyncDocuments.GroupBy(doc => doc.UserAssignId);

                foreach (var group in groupedDocuments)
                {
                    CLContext<UserAssign> currentUserAssignContext =
                        GetUserAssign(group.Key);

                    CLContext<User> currentUserContext = GetUser(currentUserAssignContext.Response.Data.UserId);

                    foreach (var syncDocument in group)
                    {
                        try
                        {
                            LogManager.Record($"CREATING DOCUMENT WITH KEY [{syncDocument.DocumentKey}]");

                            if (String.IsNullOrEmpty(syncDocument.DocumentType))
                            {
                                LogManager.Record($"TRANSACTION TYPE WAS NOT SET OR IS IN INCORRECT FORMAT");
                            }
                            else
                            {
                                if (currentUserAssignContext.Response.Data is null)
                                {
                                    LogManager.Record(
                                        $"USER ASSIGN WITH THE ID [{syncDocument.UserAssignId}] WAS NOT EXIST OR ISN'T CONFIGURED YET");
                                }
                                else
                                {
                                    switch (syncDocument.DocumentType)
                                    {
                                        case DocumentSyncTypes.SaleOrder:
                                            LogManager.Record($"REQUESTING SALES ORDER CREATION");

                                            DocumentToSync<SalesOrder> orderInfo = JsonConvert.DeserializeObject<DocumentToSync<SalesOrder>>(syncDocument.RawDocument);

                                            LogManager.Record($"INFO: {JsonConvert.SerializeObject(orderInfo)}");

                                            CLContext<SalesOrder> salesOrderContext = await PostOrders(orderInfo.Document,
                                                null,
                                                null,
                                                currentUserAssignContext.Response.Data.UserId,
                                                currentUserAssignContext.Response.Data.CompanyId);

                                            if (salesOrderContext.Response.Data is null)
                                            {
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                                                syncDocumentStatus.Errors++;
                                            }
                                            else
                                            {
                                                syncDocument.DocEntry = salesOrderContext.Response.Data.DocEntry;
                                                syncDocument.DocNum = salesOrderContext.Response.Data.DocNum;
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Success;
                                            }

                                            LogManager.Record(
                                                $"SALES ORDER SYNC FINALIZE WITH MESSAGE [{salesOrderContext.Response.Message}]");
                                            break;
                                        case DocumentSyncTypes.SaleQuotation:
                                            LogManager.Record($"REQUESTING SALES QUOTATION CREATION");

                                            DocumentToSync<SalesQuotation> quotationInfo = JsonConvert.DeserializeObject<DocumentToSync<SalesQuotation>>(syncDocument.RawDocument);

                                            CLContext<SalesQuotation> saleQuotationContext = await PostQuotations(
                                                quotationInfo.Document,
                                                null,
                                                null,
                                                currentUserAssignContext.Response.Data.UserId,
                                                currentUserAssignContext.Response.Data.CompanyId);

                                            if (saleQuotationContext.Response.Data is null)
                                            {
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                                                syncDocumentStatus.Errors++;
                                            }
                                            else
                                            {
                                                syncDocument.DocEntry = saleQuotationContext.Response.Data.DocEntry;
                                                syncDocument.DocNum = saleQuotationContext.Response.Data.DocNum;
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Success;
                                            }

                                            LogManager.Record(
                                                $"SALES QUOTATION SYNC FINALIZE WITH MESSAGE [{saleQuotationContext.Response.Message}]");
                                            break;
                                        case DocumentSyncTypes.Invoice:
                                            LogManager.Record($"REQUESTING INVOICE CREATION");

                                            DocumentToSync<ARInvoice> invoiceInfo = JsonConvert.DeserializeObject<DocumentToSync<ARInvoice>>(syncDocument.RawDocument);

                                            ARInvoiceWithPayment invoiceWithPayment = new ARInvoiceWithPayment()
                                            {
                                                ARInvoice = invoiceInfo.Document
                                            };


                                            CLContext<ARInvoice> arInvoiceContext = await PostInvoices(invoiceWithPayment, null, null,
                                                currentUserAssignContext.Response.Data.UserId,
                                                currentUserAssignContext.Response.Data.CompanyId);

                                            LogManager.Record($"RESPONSE INVOICE CREATION... DATA {JsonConvert.SerializeObject(arInvoiceContext.Response?.Data)}");

                                            if (arInvoiceContext.Response.Data is null)
                                            {
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                                                syncDocumentStatus.Errors++;
                                            }
                                            else
                                            {
                                                syncDocument.DocEntry = arInvoiceContext.Response.Data.DocEntry;
                                                syncDocument.DocNum = arInvoiceContext.Response.Data.DocNum;
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Success;

                                                Constants.DocumentType invoiceType = invoiceWithPayment.ARInvoice.Udfs.Find(_udf => _udf.Name == "U_TipoDocE")?.Value == "FE"
                                                    ? Constants.DocumentType.InvoicesFE
                                                    : Constants.DocumentType.InvoicesTE;

                                                //Cuando la numeracion es manual, el valor que retorna es -1 en del doc creado, por numercion manual
                                                int serie = arInvoiceContext.Response.Data?.Series > 0 ?
                                                              arInvoiceContext.Response.Data.Series : invoiceInfo?.Document?.Series ?? 0;

                                                PatchSerieNextNumber(new UpdateFESerie()
                                                {
                                                    CompanyId = currentUserAssignContext.Response.Data.CompanyId,
                                                    DocumentType = (int)invoiceType,
                                                    NextNumber = ++arInvoiceContext.Response.Data.DocNum,
                                                    NoSerie = serie,
                                                    UserAssingId = syncDocument.UserAssignId
                                                });
                                            }

                                            LogManager.Record(
                                                $"INVOICE SYNC FINALIZE WITH MESSAGE [{arInvoiceContext.Response.Message}]");
                                            LogManager.Enter();
                                            break;
                                        case DocumentSyncTypes.InvoiceWithPayment:
                                            LogManager.Record($"REQUESTING INVOICE WITH PAYMENT CREATION");

                                            DocumentToSync<ARInvoice> invoiceWithPaymentInfo = JsonConvert.DeserializeObject<DocumentToSync<ARInvoice>>(syncDocument.RawDocument);

                                            ARInvoiceWithPayment arInvoicesWithPayment = new ARInvoiceWithPayment()
                                            {
                                                ARInvoice = invoiceWithPaymentInfo.Document,
                                                IncomingPayment = invoiceWithPaymentInfo.Payment
                                            };

                                            CLContext<ARInvoiceWithPayment> arInvoicesWithPaymentContext =
                                                await PostInvoicesWithPayment(arInvoicesWithPayment, null, null,
                                                    currentUserAssignContext.Response.Data.UserId,
                                                    currentUserAssignContext.Response.Data.CompanyId,
                                                    currentUserContext.Response.Data.Email);

                                            LogManager.Record($"RESPONSE INVOICE CREATION... DATA {JsonConvert.SerializeObject(arInvoicesWithPaymentContext.Response?.Data)}");


                                            if (arInvoicesWithPaymentContext.Response.Data is null)
                                            {
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                                                syncDocumentStatus.Errors++;
                                            }
                                            else
                                            {
                                                syncDocument.DocEntry = arInvoicesWithPaymentContext.Response.Data.ARInvoice.DocEntry;
                                                syncDocument.DocNum = arInvoicesWithPaymentContext.Response.Data.ARInvoice.DocNum;
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Success;

                                                Constants.DocumentType invoiceType = arInvoicesWithPayment.ARInvoice.Udfs.Find(_udf => _udf.Name == "U_TipoDocE")?.Value == "FE"
                                                    ? Constants.DocumentType.InvoicesFE
                                                    : Constants.DocumentType.InvoicesTE;

                                                //Cuando la numeracion es manual, el valor que retorna es -1 en del doc creado, por numercion manual
                                                int serie = arInvoicesWithPaymentContext.Response.Data?.ARInvoice?.Series > 0 ?
                                                              arInvoicesWithPaymentContext.Response.Data.ARInvoice.Series : invoiceWithPaymentInfo?.Document?.Series ?? 0;
                                                    

                                                PatchSerieNextNumber(new UpdateFESerie()
                                                {
                                                    CompanyId = currentUserAssignContext.Response.Data.CompanyId,
                                                    DocumentType = (int)invoiceType,
                                                    NextNumber = ++arInvoicesWithPaymentContext.Response.Data.ARInvoice.DocNum,
                                                    NoSerie = serie,
                                                    UserAssingId = syncDocument.UserAssignId
                                                });
                                            }

                                            LogManager.Record(
                                                $"INVOICE WITH PAYMENT SYNC FINALIZE WITH MESSAGE [{arInvoicesWithPaymentContext.Response.Message}]");
                                            LogManager.Enter();
                                            break;
                                        case DocumentSyncTypes.IncomingPayment:
                                            LogManager.Record($"REQUESTING INCOMING PAYMENT CREATION");

                                            IncomingPayment incomingPayment =
                                                JsonConvert.DeserializeObject<IncomingPayment>(syncDocument
                                                    .RawDocument);
                                            CLContext<IncomingPayment> incomingPaymentContext =
                                                await PostIncomingPayments(incomingPayment,
                                                    currentUserAssignContext.Response.Data.UserId,
                                                    currentUserAssignContext.Response.Data.CompanyId,
                                                    currentUserContext.Response.Data.Email);

                                            if (incomingPaymentContext.Response.Data is null)
                                            {
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                                                syncDocumentStatus.Errors++;
                                            }
                                            else
                                            {
                                                syncDocument.DocEntry = incomingPaymentContext.Response.Data.DocEntry;
                                                syncDocument.DocNum = incomingPaymentContext.Response.Data.DocNum;
                                                syncDocument.TransactionStatus = DocumentSyncStatus.Success;
                                            }

                                            LogManager.Record(
                                                $"INCOMING PAYMENT SYNC FINALIZE WITH MESSAGE [{incomingPaymentContext.Response.Message}]");
                                            break;
                                        default:
                                            LogManager.Record(
                                                $"DOCUMENT TYPE [{syncDocument.TransactionType}] WAS NOT MAPPED TO BE CREATE AS ON SAP");
                                            break;
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            int code = ex.InnerException != null
                                ? ex.InnerException.InnerException != null
                                    ? ex.InnerException.InnerException.HResult
                                    : ex.InnerException.HResult
                                : ex.HResult;
                            string message = ex.InnerException != null
                                ? ex.InnerException.InnerException != null
                                    ? ex.InnerException.InnerException.Message
                                    : ex.InnerException.Message
                                : ex.Message;

                            LogManager.Record($"UNHANDLED ERROR: CODE: {code} | MESSAGE: {message}");

                            syncDocument.TransactionDetail = $"{code} - {message}";
                            syncDocument.TransactionStatus = DocumentSyncStatus.Errors;
                            syncDocumentStatus.Errors++;
                        }
                        finally
                        {
                            CLContext<SyncDocument> syncDocumentContext = PatchSyncDocument(syncDocument);

                            if (syncDocumentContext.Response.Data is null)
                            {
                                LogManager.Record(
                                    $"DOCUMENT WITH KEY [{syncDocument.DocumentKey}] COULD NOT BE UPDATED");
                                LogManager.Record($"THE DOCUMENT WILL STAY ON PROCESSING STATUS");
                            }
                        }
                    }
                }
            }
            else
            {
                LogManager.Record($"NO DOCUMENT TO BE SYNC");
            }

            return new CLContext<SyncDocumentStatus>()
            {
                Code = HttpStatusCode.OK,
                value = syncDocumentStatus,
                Response = new Response<SyncDocumentStatus>()
                {
                    Data = syncDocumentStatus,
                    Message = (syncDocumentStatus.Errors > 0)
                        ? "Sincronización completada con errores"
                        : "Sincronización completada"
                }
            };
        }

        #endregion

        #endregion

        #region Mobile

        /// <summary>
        /// Retrieves a list of mobile users from the database.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{MobileUser}}"/> containing the list of mobile users.
        /// </returns>
        public static CLContext<IEnumerable<MobileUser>> GetMobileUsers()
        {
            LogManager.Record($"REQUESTING RECORDS");

            CLContext<IEnumerable<MobileUser>> oClContext =
                Services.Execute<MobileUser, MainDBContext>("GetMobileUsers").Get();

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of mobile items updated after the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The date and time of the last update to filter items.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains 
        /// a <see cref="CLContext{List{MobileItem}}"/> with the updated mobile items.
        /// </returns>
        public static async Task<CLContext<List<MobileItem>>> GetMobileItems(DateTime pLastUpdate)
        {
            LogManager.Record($"REQUESTING MOBILE ITEMS RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileItems");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileItem> resultList = Common.ResolveSAPViewODBC<MobileItem>(contextODBC,
                    new Dictionary<string, object>()
                    {
                         {"@LastUpdate", $"{pLastUpdate.ToCustomTimeSpan()}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileItem>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileItem>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileItems").Get(new ItemsSyncFilter()
                {
                    LastUpdate = pLastUpdate.ToCustomTimeSpan()
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobileItem>>();
                #endregion
            }
        }

        /// <summary>
        /// Retrieves the count of mobile items that have been updated since the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The last update date used to filter mobile items.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a 
        /// <see cref="CLContext{MobileChangeInformation}"/> with the count and type of the updated items.
        /// </returns>
        public static async Task<CLContext<MobileChangeInformation>> GetMobileItemsCount(DateTime pLastUpdate)
        {
            CLContext<List<MobileItem>> oMobileItems = await GetMobileItems(pLastUpdate);

            int count = oMobileItems.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.Items
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Retrieves a list of mobile business partners based on the salesperson code and last update timestamp.
        /// </summary>
        /// <param name="pSlpCode">The salesperson code used to filter business partners.</param>
        /// <param name="pLastUpdate">The timestamp of the last update to fetch only updated records.</param>
        /// <returns>A task that resolves to a <see cref="CLContext{List{MobileBusinessPartner}}"/> containing the list of business partners.</returns>
        public static async Task<CLContext<List<MobileBusinessPartner>>> GetMobileBusinessPartners(int pSlpCode, DateTime pLastUpdate)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<MobileBusinessPartner>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetMobileBusinessPartners");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileBusinessPartner> resultList =
                    Common.ResolveSAPViewODBC<MobileBusinessPartner>(
                        contextODBC,
                        new Dictionary<string, object>
                        {
                            { "@SlpCode",    pSlpCode },
                            { "@LastUpdate", pLastUpdate.ToCustomTimeSpan() }
                        });

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<MobileBusinessPartner>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileBusinessPartner>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetMobileBusinessPartners")
                    .Get(new FilterBusinessPartnersMobile()
                    {
                        SlpCode = pSlpCode,
                        LastUpdate = pLastUpdate.ToCustomTimeSpan()
                    });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<MobileBusinessPartner>>();

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Gets the count of mobile business partners updated since a given date for a specific sales employee.
        /// </summary>
        /// <param name="pSlpCode">The sales employee code to filter business partners.</param>
        /// <param name="pLastUpdate">The date to filter updated business partners.</param>
        /// <returns>
        /// A task representing the asynchronous operation. 
        /// The result contains a <see cref="CLContext{MobileChangeInformation}"/> with the count and change type.
        /// </returns>
        public static async Task<CLContext<MobileChangeInformation>> GetMobileBusinessPartnersCount(int pSlpCode, DateTime pLastUpdate)
        {
            CLContext<List<MobileBusinessPartner>> oClBusinessPartners = await GetMobileBusinessPartners(pSlpCode, pLastUpdate);

            int count = oClBusinessPartners.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.BusinessPartners
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Retrieves the list of mobile accounts from the service layer.
        /// </summary>
        /// <returns>
        /// A task that represents the asynchronous operation. 
        /// The result contains a <see cref="CLContext{List{MobileAccount}}"/> with the retrieved accounts.
        /// </returns>
        public static async Task<CLContext<List<MobileAccount>>> GetMobileAccounts()
        {
            LogManager.Record($"REQUESTING MOBILE ACCOUNTS RECORDS");
            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileAccounts");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileAccount> resultList = Common.ResolveSAPViewODBC<MobileAccount>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileAccount>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileAccount>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileAccounts").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobileAccount>>();
                #endregion
            }

        }

        /// <summary>
        /// Asynchronously retrieves the list of mobile cards from the service layer.
        /// </summary>
        /// <returns>
        /// A task that represents the asynchronous operation.
        /// The result is a <see cref="CLContext{List{MobileCard}}"/> containing the retrieved mobile cards.
        /// </returns>
        public static async Task<CLContext<List<MobileCard>>> GetMobileCards()
        {
            LogManager.Record($"REQUESTING MOBILE CARDS RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileCards");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileCard> resultList = Common.ResolveSAPViewODBC<MobileCard>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileCard>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileCard>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileCards").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobileCard>>();
                #endregion
            }

        }

        /// <summary>
        /// Asynchronously retrieves updated mobile price list information based on the provided last update timestamp.
        /// </summary>
        /// <param name="pLastUpdate">The last update timestamp used to filter the price lists.</param>
        /// <returns>
        /// A task that represents the asynchronous operation.
        /// The result is a <see cref="CLContext{List{MobilePriceListInfo}}"/> containing the updated price list information.
        /// </returns>
        public static async Task<CLContext<List<MobilePriceListInfo>>> GetMobilePriceListsInfo(DateTime pLastUpdate)
        {
            LogManager.Record($"REQUESTING PRICE LIST RECORDS");


            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobilePriceListsInfo");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobilePriceListInfo> resultList = Common.ResolveSAPViewODBC<MobilePriceListInfo>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@LastUpdate", $"{pLastUpdate.ToCustomTimeSpan()}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobilePriceListInfo>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobilePriceListInfo>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobilePriceListsInfo").Get(new PriceListsSyncFilter()
                {
                    LastUpdate = pLastUpdate.ToCustomTimeSpan()
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                 return await requestModel.SendAsync<List<MobilePriceListInfo>>();
                #endregion
            }

        }

        /// <summary>
        /// Asynchronously retrieves the count of updated mobile price list records since the specified timestamp.
        /// </summary>
        /// <param name="pLastUpdate">The last update timestamp used to filter price list changes.</param>
        /// <returns>
        /// A task that represents the asynchronous operation.  
        /// The result is a <see cref="CLContext{MobileChangeInformation}"/> containing the count and type of the change.
        /// </returns>
        public static async Task<CLContext<MobileChangeInformation>> GetMobilePriceListsInfoCount(DateTime pLastUpdate)
        {
            CLContext<List<MobilePriceListInfo>> oMobilePriceListsInfo = await GetMobilePriceListsInfo(pLastUpdate);

            int count = oMobilePriceListsInfo.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.PriceLists
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Asynchronously retrieves detailed information about a mobile price list.
        /// </summary>
        /// <returns>
        /// A task representing the asynchronous operation.  
        /// The result is a <see cref="CLContext{MobilePriceListInfo}"/> containing the price list data.
        /// </returns>
        public static async Task<CLContext<MobilePriceListInfo>> GetMobilePriceListInfo(int _priceListNum)
        {
            LogManager.Record($"REQUESTING MOBILE PRICELIST INFO RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobilePriceListInfo");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobilePriceListInfo> resultList = Common.ResolveSAPViewODBC<MobilePriceListInfo>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@PriceListNum", $"{_priceListNum}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<MobilePriceListInfo>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<MobilePriceListInfo>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobilePriceListInfo").Get(new PriceListInfoFilter()
                {
                    PriceListNum = _priceListNum
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<MobilePriceListInfo>();
                #endregion
            }

        }

        /// <summary>
        /// Asynchronously retrieves the list of mobile price lists updated since the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The timestamp indicating the last update to filter records.</param>
        /// <returns>
        /// A task that represents the asynchronous operation.  
        /// The result is a <see cref="CLContext{List{MobilePriceList}}"/> containing the updated price list data.
        /// </returns>
        public static async Task<CLContext<List<MobilePriceList>>> GetMobilePriceLists(DateTime pLastUpdate)
        {
            LogManager.Record($"REQUESTING MOBILE PRICELIST RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobilePriceList");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobilePriceList> resultList = Common.ResolveSAPViewODBC<MobilePriceList>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@LastUpdate", $"{pLastUpdate.ToCustomTimeSpan()}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobilePriceList>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobilePriceList>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobilePriceList").Get(new PricesFilter()
                {
                    LastUpdate = pLastUpdate.ToCustomTimeSpan()
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobilePriceList>>();
                #endregion
            }

        }

        /// <summary>
        /// Asynchronously retrieves the count of mobile price list records updated since the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The timestamp used to filter price lists by last update.</param>
        /// <returns>
        /// A task representing the asynchronous operation.  
        /// The result contains a <see cref="CLContext{MobileChangeInformation}"/> object with the count and type of change.
        /// </returns>
        public static async Task<CLContext<MobileChangeInformation>> GetMobilePriceListsCount(DateTime pLastUpdate)
        {
            CLContext<List<MobilePriceList>> oMobilePriceLists = await GetMobilePriceLists(pLastUpdate);

            int count = oMobilePriceLists.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.Prices
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Asynchronously retrieves the list of mobile tax code determinations.
        /// </summary>
        /// <returns>
        /// A task that represents the asynchronous operation.  
        /// The result contains a <see cref="CLContext{List{MobileTaxCodeDetermination}}"/> with the tax code data.
        /// </returns>
        public static async Task<CLContext<List<MobileTaxCodeDetermination>>> GetMobileTaxCodeDeterminations()
        {
            LogManager.Record("REQUESTING mMOBILE TAXCODE DETERMINATIONS RECORD");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileTaxCodeDeterminations");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileTaxCodeDetermination> resultList = Common.ResolveSAPViewODBC<MobileTaxCodeDetermination>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileTaxCodeDetermination>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileTaxCodeDetermination>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileTaxCodeDeterminations").Get<FilterBaseWhsCode>();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

               return await requestModel.SendAsync<List<MobileTaxCodeDetermination>>();
                #endregion
            }

        }

        /// <summary>
        /// Retrieves an empty list of mobile charts.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{List{Chart}}"/> containing an empty chart list and a successful status code.
        /// </returns>
        public static CLContext<List<Chart>> GetMobileCharts()
        {
            return new CLContext<List<Chart>>()
            {
                Response = new Response<List<Chart>>()
                {
                    Data = new List<Chart>(),
                    Message = string.Empty
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Asynchronously retrieves a list of mobile measurement units from the service layer.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{List{MobileMeasurementUnit}}"/> containing the retrieved measurement units.
        /// </returns>
        public static async Task<CLContext<List<MobileMeasurementUnit>>> GetMobileMeasurementUnits()
        {
            LogManager.Record($"REQUESTING MOBILE MEASUREMENT UNITS RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");


            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileMeasurmentUnits");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileMeasurementUnit> resultList = Common.ResolveSAPViewODBC<MobileMeasurementUnit>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileMeasurementUnit>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileMeasurementUnit>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileMeasurmentUnits").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobileMeasurementUnit>>();
                #endregion
            }
        }

        /// <summary>
        /// Retrieves a list of mobile discount groups that have been updated since the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The timestamp to filter updated discount groups.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{List{MobileDiscountGroup}}"/>
        /// with the list of updated discount groups.
        /// </returns>
        public static async Task<CLContext<List<MobileDiscountGroup>>> GetMobileDiscountGroups(DateTime pLastUpdate)
        {
            LogManager.Record($"REQUESTING MOBILE DISCOUNT GROUPS RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileDiscountGroups");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileDiscountGroup> resultList = Common.ResolveSAPViewODBC<MobileDiscountGroup>(contextODBC,
                    new Dictionary<string, object>()
                    {
                        {"@LastUpdate", $"{pLastUpdate.ToCustomTimeSpan()}"}
                    });

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<List<MobileDiscountGroup>>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileDiscountGroup>>()
                    {
                        Data = resultList
                    },
                    value = resultList
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileDiscountGroups").Get(new DiscountGroupSyncFilter()
                {
                    LastUpdate = pLastUpdate.ToCustomTimeSpan()
                });

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<List<MobileDiscountGroup>>();
                #endregion
            }

        }

        /// <summary>
        /// Gets the count of mobile discount groups updated since the specified date.
        /// </summary>
        /// <param name="pLastUpdate">The timestamp to filter updated discount groups.</param>
        /// <returns>
        /// A task that represents the asynchronous operation. The task result contains a <see cref="CLContext{MobileChangeInformation}"/>
        /// with the total count and type of mobile discount group changes.
        /// </returns>
        public static async Task<CLContext<MobileChangeInformation>> GetMobileDiscountGroupsCount(DateTime pLastUpdate)
        {
            CLContext<List<MobileDiscountGroup>> oMobileDiscountGroups = await GetMobileDiscountGroups(pLastUpdate);

            int count = oMobileDiscountGroups.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.Discounts
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Retrieves the mobile discount hierarchies assigned to a user, optionally filtering by active status.
        /// </summary>
        /// <param name="_userAssignId">The ID of the user assignment.</param>
        /// <param name="_activedDiscounts">Flag to indicate whether to retrieve only active discounts.</param>
        /// <returns>
        /// A <see cref="CLContext{IEnumerable{MobileDiscountHierarchy}}"/> containing the filtered discount hierarchies.
        /// </returns>
        public static CLContext<IEnumerable<MobileDiscountHierarchy>> GetMobileDiscountHierarchies(int _userAssignId, bool _activedDiscounts)
        {
            LogManager.Record($"REQUESTING RECORDS");

            MobileDiscountHierarchyFilter filter = new MobileDiscountHierarchyFilter()
            {
                UserAssignId = _userAssignId,
                ActivedDiscounts = _activedDiscounts
            };

            CLContext<IEnumerable<MobileDiscountHierarchy>> oClContext = Services
                .Execute<MobileDiscountHierarchyFilter, MobileDiscountHierarchy, MainDBContext>(
                    "GetMobileDiscountHierarchies", filter).Get();

            LogManager.Record($"REQUESTE COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves mobile blanket agreements based on the specified last update timestamp.
        /// </summary>
        /// <param name="pLastUpdate">The last update timestamp used to retrieve mobile blanket agreements.</param>
        /// <returns>An asynchronous task that returns a context containing a list of MobileBlanketAgreement objects based on the last update timestamp provided.</returns>
        public static async Task<CLContext<List<MobileBlanketAgreement>>> GetMobileBlanketAgreements(DateTime pLastUpdate)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            List<MobileBlanketAgreement> resultList;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetMobileBlanketAgreements");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                resultList = Common.ResolveSAPViewODBC<MobileBlanketAgreement>(
                    contextODBC,
                    new Dictionary<string, object>
                    {
                        { "@LastUpdate", pLastUpdate.ToCustomTimeSpan() }
                    });

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetMobileBlanketAgreements")
                    .Get(new BlanketAgreementSyncFilter()
                    {
                        LastUpdate = pLastUpdate.ToCustomTimeSpan()
                    });
                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                CLContext<List<MobileBlanketAgreement>> slCtx = await requestModel.SendAsync<List<MobileBlanketAgreement>>();

                resultList = slCtx.Response.Data;

                #endregion
            }

            LogManager.Record("REQUEST COMPLETED");

            CLContext<List<MobileBlanketAgreementDetail>> linesCtx = await GetMobileBlanketAgreementDetails();

            foreach (var agreement in resultList)
            {
                agreement.Lines = linesCtx.Response.Data
                    .Where(d => d.AbsID == agreement.AbsID)
                    .ToList();
            }
            LogManager.Record("LINES ATTACHED");

            return new CLContext<List<MobileBlanketAgreement>>
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<MobileBlanketAgreement>>
                {
                    Data = resultList
                },
                value = resultList
            };
        }

        /// <summary>
        /// Retrieves the count of blanket agreements that were modified in an specific date range
        /// </summary>
        public static async Task<CLContext<MobileChangeInformation>> GetMobileBlanketAgreementsCount(DateTime pLastUpdate)
        {
            CLContext<List<MobileBlanketAgreement>> oMobileBlanketAgreement = await GetMobileBlanketAgreements(pLastUpdate);

            int count = oMobileBlanketAgreement.Response.Data?.Count ?? 0;
            
            return new CLContext<MobileChangeInformation>()
            {
                Response = new Response<MobileChangeInformation>()
                {
                    Data = new MobileChangeInformation()
                    {
                        Count = count,
                        Type = MobileChangeInformationType.Agreements
                    },
                    Message = ""
                },
                Code = HttpStatusCode.OK
            };
        }

        /// <summary>
        /// Retrieves details of mobile blanket agreements.
        /// </summary>
        /// <returns>An asynchronous task that returns a context containing a list of MobileBlanketAgreementDetail objects representing the details of mobile blanket agreements.</returns>
        public static async Task<CLContext<List<MobileBlanketAgreementDetail>>> GetMobileBlanketAgreementDetails()
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<MobileBlanketAgreementDetail>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetMobileBlanketAgreementDetails");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileBlanketAgreementDetail> resultList = Common.ResolveSAPViewODBC<MobileBlanketAgreementDetail>(
                    contextODBC, 
                    new Dictionary<string, object>());

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<MobileBlanketAgreementDetail>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobileBlanketAgreementDetail>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetMobileBlanketAgreementDetails").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record("REQUEST COMPLETED");

                oClContext = await requestModel.SendAsync<List<MobileBlanketAgreementDetail>>();
                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of mobile printing document type labels either via ODBC or Service Layer (SL),
        /// depending on the current connection mode.
        /// </summary>
        /// <remarks>
        /// The method determines the SAP connection type and then fetches the document type label data accordingly:
        /// - If ODBC is configured, it executes a view using the configured ODBC resource.
        /// - If SL is configured, it performs a RESTful call to the SAP Service Layer.
        /// </remarks>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing a list of <see cref="MobilePrintDocTypeLabel"/> objects
        /// with associated HTTP response status and context metadata.
        /// </returns>
        public static async Task<CLContext<List<MobilePrintDocTypeLabel>>> GetMobilePrintDocTypeLabels()
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<MobilePrintDocTypeLabel>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetMobilePrintDocTypeLabels");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobilePrintDocTypeLabel> resultList =
                    Common.ResolveSAPViewODBC<MobilePrintDocTypeLabel>(
                        contextODBC,
                        new Dictionary<string, object>());

                LogManager.Record("REQUEST COMPLETED");

                oClContext = new CLContext<List<MobilePrintDocTypeLabel>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobilePrintDocTypeLabel>>
                    {
                        Data = resultList
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetMobilePrintDocTypeLabels").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                oClContext = await requestModel.SendAsync<List<MobilePrintDocTypeLabel>>();

                LogManager.Record("REQUEST COMPLETED");

                #endregion
            }

            return oClContext;
        }

        /// <summary>
        /// Retrieves mobile batch information for a given list of filters using either ODBC or Service Layer (SL) connection modes.
        /// </summary>
        /// <param name="mobileBatchesFilters">
        /// A list of <see cref="MobileBatchesFilter"/> objects, each containing the <c>ItemCode</c> and <c>WhsCode</c>
        /// used to filter the batch data from the backend.
        /// </param>
        /// <returns>
        /// A <see cref="Task"/> that represents the asynchronous operation, containing a <see cref="CLContext{T}"/> 
        /// with a list of <see cref="MobileBatchesList"/> results for each requested item and warehouse combination.
        /// </returns>
        /// <remarks>
        /// - Logs the request and connection mode used.
        /// - Dynamically chooses the data source based on the environment configuration: ODBC or SL.
        /// - Aggregates and filters duplicate batch numbers.
        /// - Maps the batch number and available quantity into <see cref="MobileBatches"/> objects.
        /// </remarks>
        public static async Task<CLContext<List<MobileBatchesList>>> GetMobileBatches(List<MobileBatchesFilter> mobileBatchesFilters)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            var mobileBatchesList = new List<MobileBatchesList>();

            foreach (var filter in mobileBatchesFilters)
            {
                List<BatchsBinCode> batchData;

                if (connectionMode == SapConnectionType.ODBC)
                {
                    var ctxOdbc = GetUserCtxODBC("ODBC_GetBatch");

                    LogManager.Record($"RESOURCE: {ctxOdbc.Resource}");

                    batchData = Common.ResolveSAPViewODBC<BatchsBinCode>(
                        ctxOdbc,
                        new Dictionary<string, object>
                        {
                            { "@ItemCode", filter.ItemCode },
                            { "@WhsCode",  filter.WhsCode  }
                        });
                }
                else
                {
                    var requestModel = GetUserCtx("SL_GetBatch")
                        .Get(new MobileBatchesFilter()
                        {
                            ItemCode = filter.ItemCode,
                            WhsCode = filter.WhsCode
                        });
                    LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                    var slCtx = await requestModel.SendAsync<List<BatchsBinCode>>();

                    batchData = slCtx.Response.Data;
                }

                var batchList = new MobileBatchesList
                {
                    ItemCode = filter.ItemCode,
                    WarehouseCode = filter.WhsCode,
                    BatchNumbers = new List<MobileBatches>()
                };

                foreach (var b in batchData)
                {
                    if (!batchList.BatchNumbers.Exists(x => x.BatchNumber == b.DistNumber))
                    {
                        batchList.BatchNumbers.Add(new MobileBatches
                        {
                            ItemCode = filter.ItemCode,
                            BatchNumber = b.DistNumber,
                            Quantity = b.Disponible
                        });
                    }
                }

                mobileBatchesList.Add(batchList);
            }

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<List<MobileBatchesList>>
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<MobileBatchesList>>
                {
                    Data = mobileBatchesList
                },
                value = mobileBatchesList
            };
        }

        /// <summary>
        /// Method to get batches allocations for mobile
        /// </summary>
        /// <param name="_mobileBatchesFilters">Filters to get batches</param>
        /// <returns></returns>
        public static async Task<CLContext<List<MobileBinAllocation>>> GetMobileBatchesAllocations(List<MobileBatchesAllocationsFilter> _mobileBatchesFilters)
        {
            LogManager.Record("REQUESTING RECORDS");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            ClUserContextODBC contextODBC = null;

            ClUserContext oClUserContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                contextODBC = GetUserCtxODBC($"ODBC_GetMobileBatchAllocation");
            }
            else
            {
                oClUserContext = GetUserCtx("SL_GetMobileBatchAllocation");

            }

            List<MobileBinAllocation> oMobileAllocationsList = new List<MobileBinAllocation>();

            List<IGrouping<string, MobileBatchesAllocationsFilter>> res = _mobileBatchesFilters.GroupBy(x => x.BatchNumber).ToList();

            _mobileBatchesFilters.Clear();

            foreach (IGrouping<string, MobileBatchesAllocationsFilter> group in res)
            {
                foreach (MobileBatchesAllocationsFilter item in group)
                {
                    _mobileBatchesFilters.Add(new MobileBatchesAllocationsFilter()
                    {
                        BatchNumber = group.Key,
                        ItemCode = item.ItemCode,
                        WhsCode = item.WhsCode
                    });
                }
            }

            CLContext<List<MobileBinAllocation>> oClContext = null;

            foreach (MobileBatchesAllocationsFilter batch in _mobileBatchesFilters)
            {
                

                if (connectionMode == SapConnectionType.ODBC)
                {
                    List<MobileBinAllocation> resultList = Common.ResolveSAPViewODBC<MobileBinAllocation>(contextODBC,
                     new Dictionary<string, object>()
                     {
                        {"@ItemCode", $"{batch.ItemCode}"},
                        {"@WhsCode", $"{batch.WhsCode}"},
                        {"@BatchNumber", $"{batch.BatchNumber}"}
                     });

                    oClContext = new CLContext<List<MobileBinAllocation>>()
                    {
                        Code = HttpStatusCode.OK,
                        Response = new Response<List<MobileBinAllocation>>()
                        {
                            Data = resultList
                        },
                        value = resultList
                    };
    }
                else
                {
                    SLRequestObject oRequestObject = oClUserContext.Get(new MobileBatchesAllocationsFilter()
                    {
                        ItemCode = batch.ItemCode,
                        WhsCode = batch.WhsCode,
                        BatchNumber = batch.BatchNumber
                    });
                    oClContext = await oRequestObject.SendAsync<List<MobileBinAllocation>>();

                }

                foreach (MobileBinAllocation oMobileBinAllocation in oClContext.Response.Data)
                {
                    oMobileAllocationsList.Add(oMobileBinAllocation);
                }
            }

            LogManager.Record("REQUEST COMPLETED");

            return new CLContext<List<MobileBinAllocation>>()
            {
                Code = HttpStatusCode.OK,
                Response = new Response<List<MobileBinAllocation>>()
                {
                    Data = oMobileAllocationsList
                }
            };
        }

        /// <summary>
        /// Retrieves mobile-specific company information, including configuration and decimal precision settings.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{MobileCompanyInformation}"/> containing the company's configuration data
        /// tailored for mobile app usage.
        /// </returns>
        public static async Task<CLContext<MobileCompanyInformation>> GetCompanyInformation()
        {
            LogManager.Record($"REQUESTING COMPANY INFORMATION...");

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC
                ClUserContextODBC contextODBC = GetUserCtxODBC($"ODBC_GetMobileCompanyInformation");
                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobileCompanyInformation> resultList = Common.ResolveSAPViewODBC<MobileCompanyInformation>(contextODBC);

                LogManager.Record($"REQUESTING COMPLETED");

                return new CLContext<MobileCompanyInformation>()
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<MobileCompanyInformation>()
                    {
                        Data = resultList.FirstOrDefault()
                    },
                    value = resultList.FirstOrDefault()
                };
                #endregion
            }
            else
            {
                #region Query Via SL
                SLRequestObject requestModel = GetUserCtx($"SL_GetMobileCompanyInformation").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUESTING COMPLETED");

                return await requestModel.SendAsync<MobileCompanyInformation>();
                #endregion
            }
        }



        /// <summary>
        /// Retrieves mobile-specific company information, including configuration and decimal precision settings.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{MobileCompanyInformation}"/> containing the company's configuration data
        /// tailored for mobile app usage.
        /// </returns>
        public static async Task<CLContext<MobileCompanyInformation>> GetMobileCompanyInformation()
        {

            CLContext<MobileCompanyInformation> oClContext = await GetCompanyInformation();

            int currentCompanyId = GetCompanyId();

            MobileAppConfiguration appConfiguration = GetSettingByCode<List<MobileAppConfiguration>>("MobileAppConfiguration").Response.Data?
                .FirstOrDefault(appConfig => appConfig.CompanyId == currentCompanyId);

            DecimalConfiguration decimalConfiguration = GetSettingByCode<List<DecimalConfiguration>>("Decimal").Response
                .Data?.FirstOrDefault(config => config.CompanyId == currentCompanyId);

            Company companyInfo = GetCompanyById(currentCompanyId).Response.Data;

            if (oClContext is object && appConfiguration is object)
            {
                oClContext.Response.Data.BillingRange = appConfiguration.BillingRange;
                oClContext.Response.Data.UseFreight = appConfiguration.UseFreight;
                oClContext.Response.Data.UseBillingRange = appConfiguration.UseBillingRange;
                oClContext.Response.Data.OnlineOnly = appConfiguration.OnlineOnly;
                oClContext.Response.Data.LinePriceDecimals = decimalConfiguration?.LinePrice ?? 2;
                oClContext.Response.Data.LineTotalDecimals = decimalConfiguration?.LineTotal ?? 2;
                oClContext.Response.Data.DocumentTotalDecimals = decimalConfiguration?.DocumentTotal ?? 2;
                oClContext.Response.Data.CompanyId = companyInfo.Id;
                oClContext.Response.Data.ConnectionId = companyInfo.ConnectionId;
                oClContext.Response.Data.DatabaseCode = companyInfo.DatabaseCode;
            }
            
            LogManager.Record($"REQUEST COMPLETED");

            return oClContext;
        }

        /// <summary>
        /// Retrieves a list of mobile payment terms from SAP, either via ODBC or Service Layer (SL), based on the connection mode.
        /// </summary>
        /// <returns>
        /// A <see cref="CLContext{List{MobilePayTerms}}"/> containing the retrieved payment terms and the HTTP response code.
        /// </returns>
        public static async Task<CLContext<List<MobilePayTerms>>> GePayTerms()
        {

            string connectionMode = GetConnectionMode();

            LogManager.Record($"CONNECTION MODE: {connectionMode}");

            CLContext<List<PayTerm>> oClContext = null;

            if (connectionMode == SapConnectionType.ODBC)
            {
                #region Query Via ODBC

                ClUserContextODBC contextODBC = GetUserCtxODBC("ODBC_GetMobilePayTerms");

                LogManager.Record($"RESOURCE: {contextODBC.Resource}");

                List<MobilePayTerms> resultList =
                    Common.ResolveSAPViewODBC<MobilePayTerms>(contextODBC);

                LogManager.Record("REQUEST COMPLETED");

                return new CLContext<List<MobilePayTerms>>
                {
                    Code = HttpStatusCode.OK,
                    Response = new Response<List<MobilePayTerms>>
                    {
                        Data = resultList,
                        Message = "Request completed successfully"
                    },
                    value = resultList
                };

                #endregion
            }
            else
            {
                #region Query Via SL

                SLRequestObject requestModel = GetUserCtx("SL_GetMobilePayTerms").Get();

                LogManager.Record($"RESOURCE: {requestModel.Url_Request}");

                LogManager.Record($"REQUEST COMPLETED");

                return await requestModel.SendAsync<List<MobilePayTerms>>();

                #endregion

            }
           
        }


        /// <summary>
        /// Retrieves mobile user series for the specified user and company, then
        /// enriches each series with its corresponding electronic invoicing series (FESerie).
        /// </summary>
        /// <param name="_userId">User identifier (assignment ID) used to fetch series.</param>
        /// <param name="_companyId">Company identifier used to scope the query.</param>
        /// <returns>
        /// A <see cref="CLContext{T}"/> containing an <see cref="IEnumerable{MobileUserSeries}"/>.
        /// Each item is augmented with its matching <see cref="FESerie"/> when available
        /// (matched by <c>SeriesByUserId</c>).
        /// </returns>
        /// <remarks>
        /// Executes "GetSeriesByUser" with <see cref="SerieByUserFilter"/> and "GetFESeries",
        /// then maps FESeries to user series. Logs start/end of each operation.
        /// </remarks>
        public static CLContext<IEnumerable<MobileUserSeries>> GetMobileUserSeries(int _userId, int _companyId)
        {
            LogManager.Record($"REQUESTING MOBILEUSERSERIES RECORDS... USERID: {_userId} COMPANYID: {_companyId}");


            CLContext<IEnumerable<MobileUserSeries>> oClContextUserSeries =
                Services.Execute<SerieByUserFilter, MobileUserSeries, MainDBContext>("GetSeriesByUser",
                    new SerieByUserFilter()
                    {
                        UserAssingId = _userId,
                        CompanyId = _companyId
                    }).Get();
           LogManager.Record("REQUESTING COMPLETED");

            LogManager.Record($"REQUESTING FESERIES RECORDS");
            CLContext<IEnumerable<FESerie>> oClContextFESeries =
               Services.Execute<FESerie, MainDBContext>("GetFESeries").Get();

            LogManager.Record("REQUESTING COMPLETED");

            foreach (MobileUserSeries userSeries in oClContextUserSeries.Response.Data)
            {
                FESerie feSerie = oClContextFESeries.Response.Data.FirstOrDefault(fs => fs.SeriesByUserId == userSeries.Id);
                if (feSerie != null)
                {
                    userSeries.FESerie = feSerie;
                }
            }

            return oClContextUserSeries;
        }

        #endregion
    }
}
