<section class="main-section">

  <section class="form-section">
    <app-action-buttons
      [actionButtons]="actionButtons"
      [isIntoMatTab]="false"
      (onActionButtonClicked)="OnActionButtonClicked($event)"
      [userPermissions]="permissions"
    >
    <form [formGroup]="routeForm">

      <mat-form-field appearance="outline">
        <mat-label>Nombre de la ruta</mat-label>
        <input matInput formControlName="Name" id="name">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Frecuencia</mat-label>
        <mat-select formControlName="RouteFrequencyId" id="route-frequency-id">
          <mat-option *ngFor="let frequency of frequencies" [value]="frequency.Id">{{frequency.Description}}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="example-form-field">
        <mat-label>Fecha de expiración</mat-label>
        <input matInput formControlName="ExpirationDate" id="expiration-date" [matDatepicker]="datepicker">
        <mat-datepicker-toggle matSuffix id="expiration-date-picker-btn" [for]="datepicker"></mat-datepicker-toggle>
        <mat-datepicker #datepicker id="expiration-date-picker">
          <mat-datepicker-actions>
            <button mat-button matDatepickerCancel>Cancelar</button>
            <button mat-raised-button color="primary" matDatepickerApply>OK</button>
          </mat-datepicker-actions>
        </mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo</mat-label>
        <mat-select formControlName="Type" id="type">
          <mat-option *ngFor="let type of routeTypes" [value]="type.Key">{{type.Description}}</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="example-full-width">
        <div class="flex">
          <mat-form-field appearance="outline" class="input-group"style="margin-bottom: -1em">
            <mat-label>Cliente</mat-label>
            <input readonly placeholder="Buscar cliente" type="text"  formControlName="Customer" type="text" matInput>
          </mat-form-field>
          <button matTooltip="Buscar cliente"
                  type="button"
                  mat-flat-button color="primary"
                  class="e-bill-search"
                  (click)="ShowModalSearchBusinnesPartner()">
            <mat-icon>search</mat-icon>
          </button>
        </div>
      </div>
    </form>
    </app-action-buttons>

    <section class="route-lines-container" cdkDropList (cdkDropListDropped)="OnGroupedRouteLinesPositionChange($event)">
<!--      <p *ngFor="let routeLine of routeLines">{{routeLine.CardCode}} - {{routeLine.Address}}</p>-->

      <fieldset *ngFor="let groupedLine of routeLinesGroupedByCustomer" class="mb-1 bg-white" cdkDrag>
        <div class="drag-drop-custom-placeholder" *cdkDragPlaceholder></div>
        <div class="route-list">
          <p class="route-name"><b>{{groupedLine.CardCode}}</b> {{groupedLine.CardName}}</p>
          <div class="row">
            <button mat-flat-button color="primary" class="route-buttons" (click)="AddNewCustomerLocation(groupedLine)">
              <mat-icon>add</mat-icon>
              Agregar
            </button>
            <button mat-flat-button color="primary" class="route-buttons" (click)="DeleteCustomerRouteLines(groupedLine)">
              <mat-icon>clear</mat-icon>
              Limpiar
            </button>
          </div>
        </div>

        <mat-divider></mat-divider>
        <div cdkDropList (cdkDropListDropped)="OnRouteLinePositionChange($event, groupedLine.CardCode)">
          <div *ngFor="let rtLine of groupedLine.RouteLines" class="route-line-locations bg-white" cdkDrag>
            <div class="drag-drop-custom-placeholder" *cdkDragPlaceholder></div>
            <div class="details-time">
              <mat-icon>library_books</mat-icon>
              <p class="route-details"><strong>{{rtLine.Address}}</strong> {{ rtLine.VisitingTime | hourFormat }} - {{ rtLine.VisitEndTime | hourFormat }}</p>
                <mat-icon class="cursor-pointer" (click)="ZoomToMarker(rtLine)">
                  visibility
                </mat-icon>
            </div>

            <button mat-flat-button color="primary" class="w-1" (click)="OnDeleteRouteLine(rtLine)">
              <mat-icon>delete</mat-icon>
              Eliminar
            </button>
          </div>
        </div>
      </fieldset>
    </section>

  </section>


  <section class="map-section">
<!--    (mapClick)="updateCoords($event)"-->
    <agm-map id="map" #gm [latitude]="mapLatitude" [longitude]="mapLongitude"  [zoom]="mapZoom"
             (mapReady)="OnMapReady($event)">
      <agm-marker *ngFor="let line of routeLines; index as i" [title]="line.CardCode + ' - ' + line.CardName"
                  [latitude]="line.Latitude" [longitude]="line.Longitude" [markerClickable]="true"
                  (markerRightClick)="ZoomToMarker(line)"
                  [id]="'marker-' + i">
        <agm-info-window [disableAutoPan]="false" #infoWindow>
          <div class="iw-container">
            <div class="iw-title">Detalle check point</div>
            <div class="iw-content">
              <label style="display: block">
                <p><b>Código Cliente: </b>{{ line.CardCode }}</p>
              </label>
              <label style="display: block">
                <p><b>Nombre Cliente: </b>{{ line.CardName }}</p>
              </label>
              <label style="display: block">
                <p><b>Latitud: </b>{{ line.Latitude }}</p>
              </label>
              <label style="display: block">
                <p><b>Longitud: </b>{{ line.Longitude }}</p>
              </label>
            </div>
            <div class="iw-bottom-gradient"></div>
          </div>
        </agm-info-window>
      </agm-marker>
    </agm-map>
  </section>
</section>
