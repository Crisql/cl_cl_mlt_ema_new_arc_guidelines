<section class="multi-documentos">
  <div class="multi-documentos-content"
       *ngIf="typeDocument === 'OINV' && typeInvoice === 'Invoice' && !this.actionDocumentFrom">

    <div fxLayout="row" fxLayoutAlign="start" class="span" *ngFor="let document of documentInMemories; index as i"
         (click)="GenerateInvoice(document,i)"
         [ngClass]="i === currentIndex ? 'active' : ''">
    <span class="span-text" matTooltip="Ir a {{memoryInvoice?.Name}}">
      {{ memoryInvoice?.Name }} #{{ (i + 1) }}</span>
      <button class="btn-multi-doc" mat-icon-button (click)="DeleteDocument(i)" matTooltip="Eliminar">
      <span class="material-symbols-outlined">
        do_not_disturb_on
      </span>
      </button>
    </div>

    <button class="btn-multi-doc" mat-icon-button (click)="AddDocument()" matTooltip="Agregar">
      <span class="material-symbols-outlined">
        add_circle
      </span>
    </button>

  </div>


  <div class="multi-documentos-content"
       *ngIf="typeDocument !== 'OINV' || typeInvoice !== 'Invoice' || this.actionDocumentFrom"></div>

  <app-action-buttons [form]="documentForm" [actionButtons]="actionButtons" [isIntoMatTab]="false"
                      (onActionButtonClicked)="OnActionButtonClicked($event)">
  </app-action-buttons>
</section>

<div [ngClass]="typeDocument === 'OINV' ? 'double-margin' : 'doc-margin'">
  <fieldset class="main-container">
    <legend>
      Encabezado
    </legend>
    <form [formGroup]="documentForm" class="grid-container">
      <ng-container *ngIf="!displayTypeInvoice">
        <div class="flex col-lg-2 col-lt-lg-2 col-gt-md-2 col-md-12 col-sm-12">
          <mat-form-field appearance="outline" class="input-group" style="margin-bottom: -1em">
            <mat-label>Tipo factura</mat-label>
            <mat-select matInput formControlName="TipoDocE">
              <mat-option *ngFor="let type of typeDocE" [value]="type.Name">
                {{ type.Description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button matTooltip="Factura electrónica"
                  type="button"
                  mat-flat-button color="primary"
                  class="e-bill"
                  [disabled]="!isCashCustomer"
                  (click)="OpenDialogFE()">
            <mat-icon class="icon-display">receipt</mat-icon>
          </button>
        </div>
      </ng-container>
      <ng-container *ngIf="displayTypeInvoice">
        <div class="inline-flex">
          <button matTooltip="Factura electrónica"
                  type="button"
                  mat-flat-button color="primary"
                  class="button-display-type-doc"
                  [disabled]="!isCashCustomer"
                  (click)="OpenDialogFE()">
            <mat-icon class="icon-display">receipt</mat-icon>
          </button>
        </div>
      </ng-container>
      <div class="col-lg-5 col-lt-lg-5 col-gt-md-5 col-md-5 col-gt-sm-12 col-sm-12">
        <div class="flex">
          <mat-form-field appearance="outline" [class]="GetClassCss()" style="margin-bottom: -1em">
            <mat-label>Código de cliente</mat-label>
            <input readonly matInput formControlName="CardCode">
            <mat-error *ngIf="documentForm.controls['CardCode'].errors?.['required']">
              Campo requerido
            </mat-error>
          </mat-form-field>
          <ng-container *ngIf="hasActiveLoyalty && typeDocument !== 'ODPI'">
            <button matTooltip="Buscar perfil de puntos"
                    type="button"
                    mat-flat-button color="primary"
                    class="e-bill"
                    (click)="OpenLoyalty()">
              <mat-icon class="icon-display">loyalty</mat-icon>
            </button>
          </ng-container>
        </div>
      </div>
      <div class="col-lg-5 col-lt-lg-5 col-gt-md-5 col-md-5  col-gt-sm-12 col-sm-12">
        <div class="flex">
          <mat-form-field appearance="outline" class="input-group" style="margin-bottom: -1em">
            <mat-label>Nombre del cliente</mat-label>
            <input placeholder="Buscar cliente" type="text" [readonly]="isEditDocument || !this.isCashCustomer"
                   formControlName="CardName" type="text" matInput>
            <mat-error *ngIf="documentForm.controls['CardName'].errors?.['required']">
              Campo requerido
            </mat-error>
          </mat-form-field>
          <button matTooltip="Buscar clientes"
                  type="button"
                  mat-flat-button color="primary"
                  class="e-bill"
                  [disabled]="documentForm.controls['CardName'].disabled"
                  (click)="ShowModalSearchBusinnesPartner()">
            <mat-icon class="icon-display">search</mat-icon>
          </button>
        </div>
      </div>
      <mat-form-field appearance="outline" class="col-lg-1 col-lt-lg-5 col-gt-md-5 col-md-5 col-sm-12"
                      style="margin-bottom: -1em">
        <mat-label>Term. de pagos</mat-label>
        <mat-select matInput formControlName="PaymentGroupCode">
          <mat-option *ngFor="let pay of payTerms" [value]="pay.GroupNum">
            {{ pay.PymntGroup }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="documentForm.controls['PaymentGroupCode'].errors?.['required']">
          Campo requerido
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-2 col-lt-lg-6 col-gt-md-6 col-md-6 col-sm-12"
                      style="margin-bottom: -1em">
        <mat-label>Moneda</mat-label>
        <mat-select matInput [disabled]="!isPermissionChangeCurrency" (selectionChange)="SelectCurrency()"
                    formControlName="DocCurrency">
          <mat-option *ngFor="let curr of currencies" [value]="curr.Id">
            {{ curr.Name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="documentForm.controls['DocCurrency'].errors?.['required']">
          Campo requerido
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-5 col-lt-lg-6 col-gt-md-6 col-md-6 col-sm-12"
                      style="margin-bottom: -1em">
        <mat-label>Lista de Precios</mat-label>
        <mat-select (selectionChange)="SelectPriceList()" formControlName="PriceList"
                    [disabled]="this.lines.length > 0 || !canChangePriceList">
          <mat-option *ngFor="let price of priceList" [value]="price.ListNum">
            {{ price.ListName }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="documentForm.controls['PriceList'].errors?.['required']">
          Campo requerido
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-4 col-lt-lg-6 col-gt-md-6 col-md-6 col-sm-12"
                      style="margin-bottom: -1em">
        <mat-label>Vendedor</mat-label>
        <mat-select formControlName="SalesPersonCode">
          <mat-option *ngFor="let person of salesPerson" [value]="person.SlpCode">
            {{ person.SlpName }}
          </mat-option>
          <mat-error *ngIf="documentForm.controls['SalesPersonCode'].errors?.['required']">
            Campo requerido
          </mat-error>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-4 col-gt-md-4 col-lt-lg-4 col-md-4 col-sm-12">
        <mat-label>Fecha de contabilización</mat-label>
        <input matInput [matDatepicker]="pickerDocDate" formControlName="DocDate">
        <mat-datepicker-toggle matSuffix [for]="pickerDocDate"></mat-datepicker-toggle>
        <mat-datepicker #pickerDocDate></mat-datepicker>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-4 col-gt-md-4 col-lt-lg-4 col-md-4 col-sm-12">
        <mat-label>{{ docDueDateLabel }}</mat-label>
        <input matInput [matDatepicker]="pickerDocDueDate" formControlName="DocDueDate">
        <mat-datepicker-toggle matSuffix [for]="pickerDocDueDate"></mat-datepicker-toggle>
        <mat-datepicker #pickerDocDueDate></mat-datepicker>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-4 col-gt-md-4 col-lt-lg-4 col-md-4 col-sm-12">
        <mat-label>Fecha del documento</mat-label>
        <input matInput [matDatepicker]="pickerTaxDate" formControlName="TaxDate">
        <mat-datepicker-toggle matSuffix [for]="pickerTaxDate"></mat-datepicker-toggle>
        <mat-datepicker #pickerTaxDate></mat-datepicker>
      </mat-form-field>
      <div *ngIf="typeDocument === 'OINV' && typeInvoice === 'Invoice' || typeDocument === 'OINV' && typeInvoice === 'ReserveInvoice'" class="col-lg-3 col-gt-md-3 col-lt-lg-3 col-md-3 col-sm-12">
        <mat-checkbox formControlName="IsDownPayment">
          Pago con anticipo
        </mat-checkbox>
      </div>

      <div *ngIf="(typeDocument === 'OINV' && typeInvoice==='Invoice' || typeDocument === 'ODPI' || typeDocument === 'OINV' && typeInvoice === 'ReserveInvoice') && modalProcessEnabled" class="col-lg-3 col-gt-md-3 col-lt-lg-3 col-md-3 col-sm-12">
        <mat-checkbox formControlName="IsModalProcess">
          Aplicar Pago
        </mat-checkbox>
      </div>

      <mat-checkbox [formControl]="IsPartialPay" class="col-lg-2 col-lt-lg-2 col-gt-md-2 col-md-2 col-sm-12" *ngIf="(typeDocument === 'OINV' && typeInvoice==='Invoice' || typeDocument === 'ODPI') &&canChangePartialPrice">
        Pago parcial
      </mat-checkbox>
      <mat-form-field appearance="outline" class="col-lg-7 col-lt-lg-7 col-gt-md-7  col-md-7 col-sm-12"
                      style="margin-bottom: -1em" *ngIf="(typeDocument === 'OINV' && typeInvoice==='Invoice' || typeDocument === 'ODPI') && IsPartialPay.value">
        <mat-label>Monto pago parcial</mat-label>
        <input matInput type="number" min="0" formControlName="PartialAmount">
        <mat-error *ngIf="documentForm.controls['PartialAmount'].errors?.['min']">
          Cantidad permitida mayor a 0
        </mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-12 col-md-12 col-sm-12" style="margin-bottom: -1em">
        <mat-label>Comentario</mat-label>
        <textarea matInput formControlName="Comments" rows="1"></textarea>
      </mat-form-field>
      <mat-form-field appearance="outline" class="col-lg-1 col-lt-lg-1 col-gt-md-1  col-md-1 col-sm-12"
                      style="margin-bottom: -1em">
        <mat-label>Cant.</mat-label>
        <input matInput type="number" min="1" formControlName="Quantity">
        <mat-error *ngIf="documentForm.controls['Quantity'].errors?.['min']">
          Cantidad permitida mayor a 0
        </mat-error>
      </mat-form-field>

      <div class="col-lg-11 col-lt-lg-11 col-gt-md-11 col-md-11 col-sm-12">
        <app-item [display]="false" [items]="items" (onItemSelected)="OnSelectItem($event)"
                  (refresh)="GetItems()"></app-item>
      </div>
    </form>
  </fieldset>
</div>

<fieldset class="top-margin udf-fieldset">
  <mat-tab-group #tabGroup>
    <ng-container *ngFor="let group of udfGroups; let index = index">
      <mat-tab *ngIf="configureUdfGroup && hasUdfsWithGroup[index]" label="{{group.Name}}">
        <cl-dynamics-udfs-presentation
          [Id]="index.toString()"
          [ApiUrl]="ApiUrl"
          [UdfsCategory]="DBODataEndPoint"
          [UdfsGroup]="group.Name"
        >
        </cl-dynamics-udfs-presentation>
      </mat-tab>
    </ng-container>

    <mat-tab *ngIf="hasUdfsWithoutGroup" label="Udfs">
      <cl-dynamics-udfs-presentation
        [Id]="UdfWithoutGroupId"
        [ApiUrl]="ApiUrl"
        [UdfsCategory]="DBODataEndPoint"
        UdfsGroup="null"
      >
      </cl-dynamics-udfs-presentation>
    </mat-tab>

    <mat-tab label="Adjuntos" *ngIf="this.IsVisibleAttachTable">

      <div style="display: flex; justify-content: flex-end; align-content: center; padding: 5px;">
        <button mat-flat-button color="primary" (click)="attach_file.click()">
          <mat-icon>
            attach_file
          </mat-icon>
          Adjuntar
        </button>
      </div>

      <input multiple style="display: none;" #attach_file type="file"
             accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.xls,.ppt,.xlsx,.pptx" (change)="OnAttachFile($event)">
      <cl-table [Id]="attachmentTableId"
                [ShouldPaginateRequest]="false"
                [HasStandardHeaders]="true"
                [ShouldSplitPascal]="false"
                [MappedColumns]="attachmentLineMappedColumns"
                [Records]="documentAttachment.Attachments2_Lines"
                [RecordsCount]="documentAttachment.Attachments2_Lines.length"
                [Buttons]="attachmentTableButtons"
                [ItemsPeerPage]="5"
                [PageSizeOptions]="[5, 10, 20]"
                [BackgroundTransparent]="true"
                ScrollHeight="400px">
      </cl-table>
    </mat-tab>

    <mat-tab label="Logística">
      <app-logistics 
      [businessPartner]="DefaultBusinessPartner" 
      [isPermissionChangeAdressardCode]="canChangeDeliveryAddres" 
      [preloadedShipCode]="preloadedDocument?.ShipToCode ?? ''"
      (selectedAddress)="AdressSelected($event)">
    </app-logistics>
    </mat-tab>
  </mat-tab-group>

</fieldset>


<fieldset class="top-margin">
  <legend>
    Artículos
  </legend>
  <cl-table [Id]="lineTableId"
            [HasStandardHeaders]="hasStandardHeaders"
            [ShouldSplitPascal]="shouldSplitPascal"
            [MappedColumns]="lineMappedColumns"
            [Records]="lines"
            [RecordsCount]="lines.length"
            [DropdownColumns]="dropdownColumns"
            [DropdownList]="dropdownList"
            [HasItemsSelection]="hasItemsSelection"
            [Buttons]="buttons"
            [CheckboxColumns]="checkboxColumns"
            [DropdownDiffBy]="dropdownDiffBy"
            [DropdownDiffList]="dropdownDiffList"
            [ShouldPaginateRequest]="shouldPaginateRequest"
            [DisableDragAndDrop]="disableDragAndDrop"
            [BackgroundTransparent]="true"></cl-table>
  <section>
    <div class="flex-container">

      <div class="flex-items">
        <table class="table-totales">
          <tr>
            <td class="bg-subtotal">Subtotal:</td>
            <td class="bg-montos">
              <span>{{ GetSymbol() }} {{ DisplaySubtotal()  | number: TO_FIXED_TOTALDOCUMENT }}</span>
            </td>
          </tr>
          <tr>
            <td class="bg-subtotal">Descuento</td>
            <td class="bg-montos">
              <span>{{ GetSymbol() }} {{ DisplayDiscount() | number: TO_FIXED_TOTALDOCUMENT }}</span>
            </td>
          </tr>
          <tr>
            <td class="bg-subtotal">Impuesto</td>
            <td class="bg-montos">
              <span>{{ GetSymbol() }} {{ DisplayTaxes() | number: TO_FIXED_TOTALDOCUMENT }}</span>
            </td>
          </tr>
          <tr *ngIf="retentionProcessEnabled">
            <td class="bg-subtotal">Retención</td>
            <td class="bg-montos total-retention-container">
              <span>
                  {{ GetSymbol() }} {{ DisplayRetention() | number: TO_FIXED_TOTALDOCUMENT }}
                </span>
              <button matTooltip="Total de Retenciones" type="button" mat-flat-button color="primary"
                      class="btn-info-retention" (click)="ShowInformationModalForCurrentRetentions()">
                <mat-icon class="icon-retention">info</mat-icon>
              </button>
            </td>
          </tr>
          <tr *ngIf="controllerToSendRequest === 'DownPayments'">
            <td class="bg-subtotal">Anticipo
              <span class="span-downPaymentPercentage">
              <input [readOnly]="!isPermissionChangeDowntPercentage" class="DownPaymentPercentage"
                     (change)="GetTotals()"
                     [formControl]="DownPaymentPercentage" type="number" max="100" min="0">
              %
              </span>
            </td>
            <td class="bg-montos">
              <span>{{ GetSymbol() }} {{ DisplayDownPayments() | number: TO_FIXED_TOTALDOCUMENT }}</span>
            </td>
          </tr>
          <tr *ngIf="DownPaymentsToDraw && DownPaymentsToDraw.length > 0">
            <td class="bg-subtotal">Anticipo
            </td>
            <td class="bg-montos">
              <span>{{ GetSymbol() }} {{ DisplayDownPaymentsPartial() | number: TO_FIXED_TOTALDOCUMENT }}</span>
            </td>
          </tr>
        </table>
      </div>

      <div class="flex-items total-align">
        <div class="label-total">
          <label>Total</label>
        </div>
        <div class="div-total">
          <span class="hover-content">
                <span
                  class="conversion-tooltip">{{ GetConversionSymbol() }} {{ DisplayTotal(1) | number: TO_FIXED_TOTALDOCUMENT }}</span>
            {{ GetSymbol() }} {{ DisplayTotal(2) | number: TO_FIXED_TOTALDOCUMENT }}
              </span>
        </div>
      </div>

    </div>
  </section>
</fieldset>
